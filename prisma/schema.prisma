generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  schemas  = ["app_v3", "auth"]
}

/// Perfil base do utilizador ORYA (1-1 com auth.users)
model Profile {
  id                                                               String                  @id @db.Uuid
  env                                                              String                  @default("prod")
  username                                                         String?                 @unique @db.Citext
  fullName                                                         String?                 @map("full_name")
  avatarUrl                                                        String?                 @map("avatar_url")
  coverUrl                                                         String?                 @map("cover_url")
  bio                                                              String?
  gender                                                           Gender?
  padelLevel                                                       String?                 @map("padel_level")
  padelPreferredSide                                               PadelPreferredSide?     @map("padel_preferred_side")
  padelClubName                                                    String?                 @map("padel_club_name")
  favouriteCategories                                              String[]                @default([]) @map("favourite_categories")
  onboardingDone                                                   Boolean                 @default(false) @map("onboarding_done")
  /// roles do user: ["user"], ["user","organization"], ["user","admin"], etc.
  roles                                                            String[]                @default(["user"])
  activeOrganizationId                                             Int?                    @map("active_organization_id")
  createdAt                                                        DateTime                @default(now()) @map("created_at")
  updatedAt                                                        DateTime                @default(now()) @updatedAt @map("updated_at")
  deletedAt                                                        DateTime?               @map("deleted_at") @db.Timestamp(6)
  isDeleted                                                        Boolean                 @default(false) @map("is_deleted")
  visibility                                                       Visibility              @default(PUBLIC)
  is_verified                                                      Boolean                 @default(false)
  contactPhone                                                     String?                 @map("contact_phone")
  locationConsent                                                  LocationConsent         @default(PENDING) @map("location_consent")
  locationGranularity                                              LocationGranularity     @default(COARSE) @map("location_granularity")
  locationSource                                                   UserLocationSource?     @map("location_source")
  locationUpdatedAt                                                DateTime?               @map("location_updated_at") @db.Timestamptz(6)
  status                                                           AccountStatus?          @default(ACTIVE)
  deletionRequestedAt                                              DateTime?               @map("deletion_requested_at") @db.Timestamptz(6)
  deletionScheduledFor                                             DateTime?               @map("deletion_scheduled_for") @db.Timestamptz(6)
  deletedAtFinal                                                   DateTime?               @map("deleted_at_final") @db.Timestamptz(6)
  follows_follows_follower_idToprofiles                            follows[]               @relation("follows_follower_idToprofiles")
  follows_follows_following_idToprofiles                           follows[]               @relation("follows_following_idToprofiles")
  followRequestsSent                                               follow_requests[]       @relation("follow_requests_requester")
  followRequestsReceived                                           follow_requests[]       @relation("follow_requests_target")
  userCloseFriends                                                 UserCloseFriend[]       @relation("UserCloseFriendUser")
  userCloseFriendOf                                                UserCloseFriend[]       @relation("UserCloseFriendFriend")
  organization_follows_organization_follows_follower_idToprofiles        organization_follows[]     @relation("organization_follows_follower_idToprofiles")
  notificationsSent                                                Notification[]          @relation("NotificationSender")
  notifications                                                    Notification[]
  notificationMutes                                                NotificationMute[]
  notificationPreference                                           NotificationPreference?
  crmCustomers                                                     CrmCustomer[]
  crmContacts                                                      CrmContact[]
  crmInteractions                                                  CrmInteraction[]
  crmCustomerNotesAuthored                                         CrmCustomerNote[]
  crmContactNotesAuthored                                          CrmContactNote[]
  crmSegmentsCreated                                               CrmSegment[]
  crmCampaignsCreated                                              CrmCampaign[]
  crmCampaignDeliveries                                            CrmCampaignDelivery[]
  userConsents                                                     UserConsent[]
  loyaltyLedgerEntries                                             LoyaltyLedger[]
  organizationInvitesSent                                             OrganizationMemberInvite[] @relation("OrganizationMemberInviteInviter")
  organizationInvitesReceived                                         OrganizationMemberInvite[] @relation("OrganizationMemberInviteTarget")
  bookingInvitesSent                                                  BookingInvite[]          @relation("BookingInviteInvitedBy")
  bookingChargesCreated                                               BookingCharge[]          @relation("BookingChargeCreatedBy")
  bookingParticipants                                                 BookingParticipant[]     @relation("BookingParticipantUser")
  bookingSplitsCreated                                                BookingSplit[]           @relation("BookingSplitCreatedBy")
  bookingSplitParticipants                                            BookingSplitParticipant[] @relation("BookingSplitParticipantUser")
  scheduleDelaysCreated                                               ScheduleDelay[]          @relation("ScheduleDelayCreatedBy")
  eventInvitesSent                                                 EventInvite[]           @relation("EventInviteInviter")
  eventInvitesReceived                                             EventInvite[]           @relation("EventInviteTarget")
  organizationGroupMembers                                            OrganizationGroupMember[]
  organizationMemberPermissions                                       OrganizationMemberPermission[]
  userActivities                                                   UserActivity[]
  bookings                                                         Booking[]
  serviceCreditBalances                                             ServiceCreditBalance[]
  serviceCreditLedger                                               ServiceCreditLedger[]
  serviceReviews                                                    ServiceReview[]
  padelPairingSlots                                                PadelPairingSlot[]      @relation("PadelPairingSlotProfile")
  padelPairingInvites                                              PadelPairingSlot[]      @relation("PadelPairingSlotInvitedUser")
  padelPairingsPlayer1                                             PadelPairing[]          @relation("PadelPairingPlayer1")
  padelPairingsPlayer2                                             PadelPairing[]          @relation("PadelPairingPlayer2")
  padelWaitlistEntries                                             PadelWaitlistEntry[]
  padelTeamMembers                                                 PadelTeamMember[]
  padelCommunityPosts                                              PadelCommunityPost[]
  padelCommunityReactions                                          PadelCommunityReaction[]
  padelCommunityComments                                           PadelCommunityComment[]
  padelTournamentRoleAssignments                                  PadelTournamentRoleAssignment[]
  tournamentEntries                                                TournamentEntry[]
  organizationFormSubmissions                                      OrganizationFormSubmission[]
  tournamentsGenerated                                             Tournament[]            @relation("TournamentGeneratedBy")
  tournamentAuditLogs                                              TournamentAuditLog[]    @relation("TournamentAuditLogUser")
  userIdentities                                                  UserIdentity[]
  pushDeviceTokens                                                PushDeviceToken[]
  adminMfa                                                       AdminMfa?
  users                                                            users                   @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  notificationOutbox                                               NotificationOutbox[]
  eventFavorites                                                   EventFavorite[]
  userEventSignals                                                 UserEventSignal[]
  servicesInstructing                                              Service[]               @relation("ServiceInstructor")
  reservationProfessionals                                         ReservationProfessional[]
  trainerProfiles                                                  TrainerProfile[]
  chatMembers                                                      ChatMember[]
  chatMessages                                                     ChatMessage[]           @relation("ChatMessageUser")
  chatReadStates                                                   ChatReadState[]
  chatModerationLogs                                               ChatModerationLog[]
  chatInvites                                                      ChatInvite[]
  chatEventInvites                                                 ChatEventInvite[]
  chatConversationRequestsRequested                                ChatConversationRequest[] @relation("ChatConversationRequestRequester")
  chatConversationRequestsTargeted                                 ChatConversationRequest[] @relation("ChatConversationRequestTargetUser")
  chatChannelRequests                                              ChatChannelRequest[]    @relation("ChatChannelRequestRequester")
  chatChannelRequestsResolved                                      ChatChannelRequest[]    @relation("ChatChannelRequestResolver")
  chatConversationsCreated                                        ChatConversation[]      @relation("ChatConversationCreator")
  chatConversationMembers                                         ChatConversationMember[] @relation("ChatConversationMemberUser")
  chatConversationMessages                                        ChatConversationMessage[] @relation("ChatConversationMessageSender")
  chatMessageReportsAuthored                                      ChatMessageReport[]     @relation("ChatMessageReportReporter")
  chatMessageReactions                                           ChatMessageReaction[]
  chatMessagePins                                                ChatMessagePin[]
  chatUserBlocks                                                  ChatUserBlock[]         @relation("ChatUserBlockBlocker")
  chatUserBlockedBy                                               ChatUserBlock[]         @relation("ChatUserBlockBlocked")
  chatUserPresence                                                ChatUserPresence?        @relation("ChatUserPresenceUser")
  storeCarts                                                       StoreCart[]
  storeOrders                                                      StoreOrder[]
  storeDigitalGrants                                               StoreDigitalGrant[]
  dsarCases                                                        DsarCase[]
  promoCodesPromoted                                               PromoCode[]            @relation("PromoCodePromoter")
  activeOrganization                                               Organization?          @relation("ProfileActiveOrganization", fields: [activeOrganizationId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([activeOrganizationId], map: "profiles_active_org_idx")
  @@map("profiles")
  @@schema("app_v3")
}

model UserIdentity {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  env             String   @default("prod")
  userId          String   @map("user_id") @db.Uuid
  provider        String   @db.Text
  providerUserId  String   @map("provider_user_id") @db.Text
  email           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId], map: "user_identities_provider_unique")
  @@index([userId], map: "user_identities_user_idx")
  @@map("user_identities")
  @@schema("app_v3")
}

model PushDeviceToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  env       String   @default("prod")
  userId    String   @map("user_id") @db.Uuid
  platform  String   @db.Text
  token     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz(6)

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([platform, token], map: "push_device_tokens_platform_token_unique")
  @@index([userId], map: "push_device_tokens_user_idx")
  @@map("push_device_tokens")
  @@schema("app_v3")
}

/// Entidade organização (marca, página de eventos)
model Organization {
  env                     String                         @default("prod")
  id                      Int                             @id @default(autoincrement())
  groupId                 Int                             @map("group_id")
  stripeAccountId         String?                         @map("stripe_account_id")
  status                  OrganizationStatus                 @default(PENDING)
  createdAt               DateTime                        @default(now()) @map("created_at")
  updatedAt               DateTime                        @default(now()) @updatedAt @map("updated_at")
  feeMode                 FeeMode                         @default(ADDED) @map("fee_mode")
  platformFeeBps          Int                             @default(200) @map("platform_fee_bps")
  platformFeeFixedCents   Int                             @default(0) @map("platform_fee_fixed_cents")
  stripeChargesEnabled    Boolean                         @default(false) @map("stripe_charges_enabled")
  stripePayoutsEnabled    Boolean                         @default(false) @map("stripe_payouts_enabled")
  entityType              String?                         @map("entity_type")
  businessName            String?                         @map("business_name")
  payoutIban              String?                         @map("payout_iban")
  username                String?                         @unique @db.Citext
  language                String?                         @default("pt")
  timezone                String                          @default("Europe/Lisbon")
  alertsEmail             String?                         @map("alerts_email")
  alertsSalesEnabled      Boolean?                        @default(true) @map("alerts_sales_enabled")
  alertsPayoutEnabled     Boolean?                        @default(false) @map("alerts_payout_enabled")
  brandingAvatarUrl       String?                         @map("branding_avatar_url")
  brandingCoverUrl        String?                         @map("branding_cover_url")
  brandingPrimaryColor    String?                         @map("branding_primary_color")
  brandingSecondaryColor  String?                         @map("branding_secondary_color")
  organizationKind        OrganizationKind                @default(PESSOA_SINGULAR) @map("organization_kind")
  primaryModule           OrganizationModule              @default(EVENTOS) @map("primary_module")
  reservationAssignmentMode ReservationAssignmentMode     @default(PROFESSIONAL) @map("reservation_assignment_mode")
  padelDefaultShortName   String?                         @map("padel_default_short_name")
  padelDefaultCourts      Int                             @default(0) @map("padel_default_courts")
  padelDefaultHours       String?                         @map("padel_default_hours")
  padelDefaultRuleSetId   Int?                            @map("padel_default_rule_set_id")
  padelFavoriteCategories Int[]                           @default([]) @map("padel_favorite_categories")
  publicName              String                          @map("public_name")
  addressId               String?                         @map("address_id") @db.Uuid
  showAddressPublicly     Boolean                         @default(false) @map("show_address_publicly")
  publicWebsite           String?                         @map("public_website")
  publicInstagram         String?                         @map("public_instagram")
  publicYoutube           String?                         @map("public_youtube")
  publicDescription       String?                         @map("public_description")
  publicHours             String?                         @map("public_hours")
  publicProfileLayout     Json?                           @map("public_profile_layout")
  infoRules               String?                         @map("info_rules")
  infoFaq                 String?                         @map("info_faq")
  infoRequirements        String?                         @map("info_requirements")
  infoPolicies            String?                         @map("info_policies")
  infoLocationNotes       String?                         @map("info_location_notes")
  orgType                 OrgType                         @default(EXTERNAL) @map("org_type")
  officialEmail           String?                         @map("official_email")
  officialEmailVerifiedAt DateTime?                       @map("official_email_verified_at") @db.Timestamptz(6)
  officialEmailRequests   OrganizationOfficialEmailRequest[]
  eventLogs               EventLog[]
  activityFeedItems       ActivityFeedItem[]
  agendaItems             AgendaItem[]
  mediaAssets             MediaAsset[]
  softBlocks              SoftBlock[]
  searchIndexItems        SearchIndexItem[]
  events                  Event[]
  promoCodes              PromoCode[]
  payments                Payment[]
  notifications           Notification[]                  @relation("NotificationOrganization")
  notificationMutes       NotificationMute[]
  memberInvites           OrganizationMemberInvite[]
  memberPermissions       OrganizationMemberPermission[]
  organizationModules     OrganizationModuleEntry[]
  organizationForms       OrganizationForm[]
  organizationAuditLogs   OrganizationAuditLog[]
  publicApiKeys           PublicApiKey[]
  settings                OrganizationSettings?
  ownerTransfers          OrganizationOwnerTransfer[]
  addressRef              Address?                        @relation(fields: [addressId], references: [id], onDelete: SetNull)
  trainerProfiles         TrainerProfile[]
  padelDefaultRuleSet     PadelRuleSet?                   @relation("OrganizationPadelDefaultRuleSet", fields: [padelDefaultRuleSetId], references: [id], onUpdate: NoAction, map: "organizations_padel_default_rule_set_fk")
  padelCategories         PadelCategory[]
  padelClubs              PadelClub[]
  padelPairings           PadelPairing[]
  padelTeams              PadelTeam[]
  padelCommunityPosts     PadelCommunityPost[]
  padelPlayers            PadelPlayerProfile[]
  padelRankingEntries     PadelRankingEntry[]
  reservationProfessionals ReservationProfessional[]
  reservationResources    ReservationResource[]
  padelRuleSets           PadelRuleSet[]                  @relation("OrganizationPadelRuleSets")
  padelTournaments        PadelTournamentConfig[]
  padelTournamentRoleAssignments PadelTournamentRoleAssignment[]
  padelCourtBlocks        CalendarBlock[]
  padelAvailabilities     CalendarAvailability[]
  padelWaitlistEntries    PadelWaitlistEntry[]
  organizationPolicies    OrganizationPolicy[]
  userEventSignals        UserEventSignal[]
  refundPolicyVersions    RefundPolicyVersion[]
  services                Service[]
  bookings                Booking[]
  bookingChangeRequests   BookingChangeRequest[]
  bookingInvites          BookingInvite[]
  bookingCharges          BookingCharge[]
  bookingSplits           BookingSplit[]
  scheduleDelays          ScheduleDelay[]
  chatThreads             ChatThread[]
  chatConversations       ChatConversation[]
  chatConversationRequests ChatConversationRequest[]
  chatChannelRequests     ChatChannelRequest[]
  classSeries             ClassSeries[]
  classSessions           ClassSession[]
  weeklyAvailabilityTemplates WeeklyAvailabilityTemplate[]
  analyticsRollups        AnalyticsRollup[]
  availabilityOverrides   AvailabilityOverride[]
  serviceReviews           ServiceReview[]
  crmCustomers            CrmCustomer[]
  crmCustomerNotes        CrmCustomerNote[]
  crmContacts             CrmContact[]
  crmContactNotes         CrmContactNote[]
  crmContactConsents      CrmContactConsent[]
  crmContactPadel         CrmContactPadel[]
  crmInteractions         CrmInteraction[]
  crmSegments             CrmSegment[]
  crmCampaigns            CrmCampaign[]
  crmCampaignDeliveries   CrmCampaignDelivery[]
  userConsents            UserConsent[]
  invoices                Invoice[]
  payouts                 Payout[]
  loyaltyProgram          LoyaltyProgram?
  activeProfiles          Profile[]                    @relation("ProfileActiveOrganization")
  group                   OrganizationGroup               @relation(fields: [groupId], references: [id], onDelete: Restrict, onUpdate: NoAction)
  memberOverrides          OrganizationGroupMemberOrganizationOverride[]
  loyaltyLedger           LoyaltyLedger[]
  store                   Store?
  organization_follows_organization_follows_organization_idToorganizations organization_follows[] @relation("organization_follows_organization_idToorganizations")

  @@index([addressId], map: "organizations_address_idx")
  @@map("organizations")
  @@schema("app_v3")
}

model OrganizationSettings {
  env                     String                         @default("prod")
  organizationId                  Int           @id @map("organization_id")
  invoicingMode                   InvoicingMode? @map("invoicing_mode")
  invoicingSoftwareName           String?       @map("invoicing_software_name")
  invoicingNotes                  String?       @map("invoicing_notes")
  invoicingAcknowledgedAt         DateTime?     @map("invoicing_acknowledged_at") @db.Timestamptz(6)
  invoicingAcknowledgedByIdentityId String?     @map("invoicing_acknowledged_by_identity_id") @db.Uuid
  createdAt                       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
  @@schema("app_v3")
}

model OrganizationGroup {
  env                     String                         @default("prod")
  id         Int                      @id @default(autoincrement())
  createdAt  DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organizations Organization[]
  members    OrganizationGroupMember[]

  @@map("organization_groups")
  @@schema("app_v3")
}

model OrganizationGroupMember {
  env                     String                         @default("prod")
  id           String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId      Int                     @map("group_id")
  userId       String                  @map("user_id") @db.Uuid
  role         OrganizationMemberRole
  rolePack     OrganizationRolePack?   @map("role_pack")
  scopeAllOrgs Boolean                 @default(false) @map("scope_all_orgs")
  scopeOrgIds  Int[]                   @default([]) @map("scope_org_ids")
  createdAt    DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  group        OrganizationGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user         Profile                 @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  overrides    OrganizationGroupMemberOrganizationOverride[]

  @@unique([groupId, userId], map: "organization_group_members_group_user_uniq")
  @@index([groupId], map: "organization_group_members_group_idx")
  @@index([userId], map: "organization_group_members_user_idx")
  @@map("organization_group_members")
  @@schema("app_v3")
}

model OrganizationGroupMemberOrganizationOverride {
  env                     String                         @default("prod")
  id            String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupMemberId String                  @map("group_member_id") @db.Uuid
  organizationId Int                    @map("organization_id")
  roleOverride  OrganizationMemberRole? @map("role_override")
  revokedAt     DateTime?               @map("revoked_at") @db.Timestamptz(6)
  createdAt     DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  groupMember   OrganizationGroupMember @relation(fields: [groupMemberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization  Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([groupMemberId, organizationId], map: "organization_member_overrides_group_org_uniq")
  @@index([organizationId], map: "organization_member_overrides_org_idx")
  @@map("organization_member_overrides")
  @@schema("app_v3")
}

model AdminMfa {
  env           String   @default("prod")
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  secretEnc     String   @map("secret_enc")
  secretIv      String   @map("secret_iv")
  secretTag     String   @map("secret_tag")
  recoveryCodes Json?    @map("recovery_codes") @db.JsonB
  enabledAt     DateTime? @map("enabled_at") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user          Profile  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId], map: "admin_mfa_user_uniq")
  @@map("admin_mfa")
  @@schema("app_v3")
}

model Store {
  env                     String                         @default("prod")
  id                         Int              @id @default(autoincrement())
  ownerOrganizationId        Int              @map("owner_organization_id")
  status                     StoreStatus      @default(CLOSED)
  showOnProfile              Boolean          @default(false) @map("show_on_profile")
  catalogLocked              Boolean          @default(true) @map("catalog_locked")
  checkoutEnabled            Boolean          @default(false) @map("checkout_enabled")
  currency                   String           @default("EUR")
  supportEmail               String?          @map("support_email")
  supportPhone               String?          @map("support_phone")
  returnPolicy               String?          @map("return_policy")
  privacyPolicy              String?          @map("privacy_policy")
  termsUrl                   String?          @map("terms_url")
  freeShippingThresholdCents Int?             @map("free_shipping_threshold_cents")
  createdAt                  DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                  DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization  @relation(fields: [ownerOrganizationId], references: [id], onDelete: Cascade)
  categories   StoreCategory[]
  products     StoreProduct[]
  bundles      StoreBundle[]
  carts        StoreCart[]
  orders       StoreOrder[]
  shippingZones StoreShippingZone[]

  @@unique([ownerOrganizationId], map: "stores_owner_org_unique")
  @@map("stores")
  @@schema("app_v3")
}

model StoreCategory {
  env                     String                         @default("prod")
  id            Int      @id @default(autoincrement())
  storeId       Int      @map("store_id")
  name          String
  slug          String
  description   String?
  sortOrder     Int      @default(0) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  coverImageUrl String?  @map("cover_image_url")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products      StoreProduct[]

  @@unique([storeId, slug], map: "store_categories_store_slug_unique")
  @@index([storeId], map: "store_categories_store_idx")
  @@map("store_categories")
  @@schema("app_v3")
}

model StoreProduct {
  env                     String                         @default("prod")
  id                   Int                 @id @default(autoincrement())
  storeId              Int                 @map("store_id")
  categoryId           Int?                @map("category_id")
  name                 String
  slug                 String
  shortDescription     String?             @map("short_description")
  description          String?
  visibility           StoreVisibility     @default(HIDDEN)
  priceCents           Int                 @map("price_cents")
  compareAtPriceCents  Int?                @map("compare_at_price_cents")
  currency             String              @default("EUR")
  sku                  String?
  stockPolicy          StoreStockPolicy    @default(NONE) @map("stock_policy")
  stockQty             Int?                @map("stock_qty")
  requiresShipping     Boolean             @default(true) @map("requires_shipping")
  tags                 String[]            @default([]) @map("tags")
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store                Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category             StoreCategory?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants             StoreProductVariant[]
  images               StoreProductImage[]
  options              StoreProductOption[]
  bundles              StoreBundleItem[]
  digitalAssets        StoreDigitalAsset[]
  cartItems            StoreCartItem[]
  orderLines           StoreOrderLine[]
  orderBundleItems     StoreOrderBundleItem[]
  inventoryMovements   StoreInventoryMovement[]

  @@unique([storeId, slug], map: "store_products_store_slug_unique")
  @@index([storeId], map: "store_products_store_idx")
  @@index([categoryId], map: "store_products_category_idx")
  @@index([visibility], map: "store_products_visibility_idx")
  @@map("store_products")
  @@schema("app_v3")
}

model StoreProductVariant {
  env                     String                         @default("prod")
  id           Int      @id @default(autoincrement())
  productId    Int      @map("product_id")
  label        String
  sku          String?
  priceCents   Int?     @map("price_cents")
  stockQty     Int?     @map("stock_qty")
  isActive     Boolean  @default(true) @map("is_active")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  product      StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  bundles      StoreBundleItem[]
  cartItems    StoreCartItem[]
  orderLines   StoreOrderLine[]
  orderBundleItems StoreOrderBundleItem[]
  inventoryMovements StoreInventoryMovement[]

  @@unique([productId, label], map: "store_product_variants_product_label_unique")
  @@index([productId], map: "store_product_variants_product_idx")
  @@map("store_product_variants")
  @@schema("app_v3")
}

model StoreProductImage {
  env                     String                         @default("prod")
  id         Int      @id @default(autoincrement())
  productId  Int      @map("product_id")
  url        String
  altText    String?  @map("alt_text")
  sortOrder  Int      @default(0) @map("sort_order")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product    StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "store_product_images_product_idx")
  @@map("store_product_images")
  @@schema("app_v3")
}

model StoreProductOption {
  env                     String                         @default("prod")
  id              Int                    @id @default(autoincrement())
  productId       Int                    @map("product_id")
  optionType      StoreProductOptionType @map("option_type")
  label           String
  required        Boolean                @default(false)
  maxLength       Int?                   @map("max_length")
  minValue        Int?                   @map("min_value")
  maxValue        Int?                   @map("max_value")
  priceDeltaCents Int                    @default(0) @map("price_delta_cents")
  sortOrder       Int                    @default(0) @map("sort_order")
  createdAt       DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  product         StoreProduct           @relation(fields: [productId], references: [id], onDelete: Cascade)
  values          StoreProductOptionValue[]

  @@index([productId], map: "store_product_options_product_idx")
  @@map("store_product_options")
  @@schema("app_v3")
}

model StoreProductOptionValue {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  optionId        Int      @map("option_id")
  value           String
  label           String?
  priceDeltaCents Int      @default(0) @map("price_delta_cents")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  option          StoreProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([optionId, value], map: "store_product_option_values_option_value_unique")
  @@index([optionId], map: "store_product_option_values_option_idx")
  @@map("store_product_option_values")
  @@schema("app_v3")
}

model StoreDigitalAsset {
  env                     String                         @default("prod")
  id           Int      @id @default(autoincrement())
  productId    Int      @map("product_id")
  storagePath  String   @map("storage_path")
  filename     String
  sizeBytes    Int      @map("size_bytes")
  mimeType     String   @map("mime_type")
  maxDownloads Int?     @map("max_downloads")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product      StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "store_digital_assets_product_idx")
  @@map("store_digital_assets")
  @@schema("app_v3")
}

model StoreDigitalGrant {
  env                     String                         @default("prod")
  id             Int      @id @default(autoincrement())
  orderLineId    Int      @map("order_line_id")
  userId         String?  @map("user_id") @db.Uuid
  downloadToken  String   @map("download_token")
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  downloadsCount Int      @default(0) @map("downloads_count")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  orderLine      StoreOrderLine @relation(fields: [orderLineId], references: [id], onDelete: Cascade)
  user           Profile? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([downloadToken], map: "store_digital_grants_token_unique")
  @@index([orderLineId], map: "store_digital_grants_line_idx")
  @@index([userId], map: "store_digital_grants_user_idx")
  @@map("store_digital_grants")
  @@schema("app_v3")
}

model StoreBundle {
  env                     String                         @default("prod")
  id          Int                  @id @default(autoincrement())
  storeId     Int                  @map("store_id")
  name        String
  slug        String
  description String?
  pricingMode StoreBundlePricingMode @map("pricing_mode")
  priceCents  Int?                 @map("price_cents")
  percentOff  Int?                 @map("percent_off")
  visibility  StoreVisibility      @default(HIDDEN)
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store       Store                @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items       StoreBundleItem[]
  orderBundles StoreOrderBundle[]
  cartItems   StoreCartItem[]

  @@unique([storeId, slug], map: "store_bundles_store_slug_unique")
  @@index([storeId], map: "store_bundles_store_idx")
  @@map("store_bundles")
  @@schema("app_v3")
}

model StoreBundleItem {
  env                     String                         @default("prod")
  id        Int      @id @default(autoincrement())
  bundleId  Int      @map("bundle_id")
  productId Int      @map("product_id")
  variantId Int?     @map("variant_id")
  quantity  Int      @default(1)
  bundle    StoreBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product   StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   StoreProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([bundleId], map: "store_bundle_items_bundle_idx")
  @@index([productId], map: "store_bundle_items_product_idx")
  @@index([variantId], map: "store_bundle_items_variant_idx")
  @@map("store_bundle_items")
  @@schema("app_v3")
}

model StoreCart {
  env                     String                         @default("prod")
  id        String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId   Int             @map("store_id")
  userId    String?         @map("user_id") @db.Uuid
  sessionId String?         @map("session_id")
  status    StoreCartStatus @default(ACTIVE)
  currency  String          @default("EUR")
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store     Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user      Profile?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  items     StoreCartItem[]

  @@index([storeId], map: "store_carts_store_idx")
  @@index([userId], map: "store_carts_user_idx")
  @@index([sessionId], map: "store_carts_session_idx")
  @@map("store_carts")
  @@schema("app_v3")
}

model StoreCartItem {
  env                     String                         @default("prod")
  id             Int      @id @default(autoincrement())
  cartId         String   @map("cart_id") @db.Uuid
  productId      Int      @map("product_id")
  variantId      Int?     @map("variant_id")
  bundleId       Int?     @map("bundle_id")
  bundleKey      String?  @map("bundle_key") @db.Text
  quantity       Int
  unitPriceCents Int      @map("unit_price_cents")
  personalization Json    @default("{}")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  cart           StoreCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product        StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant        StoreProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  bundle         StoreBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)

  @@index([cartId], map: "store_cart_items_cart_idx")
  @@index([productId], map: "store_cart_items_product_idx")
  @@index([variantId], map: "store_cart_items_variant_idx")
  @@index([bundleId], map: "store_cart_items_bundle_idx")
  @@index([bundleKey], map: "store_cart_items_bundle_key_idx")
  @@map("store_cart_items")
  @@schema("app_v3")
}

model StoreOrder {
  env                     String                         @default("prod")
  id              Int            @id @default(autoincrement())
  storeId         Int            @map("store_id")
  userId          String?        @map("user_id") @db.Uuid
  orderNumber     String?        @map("order_number")
  status          StoreOrderStatus @default(PENDING)
  paymentIntentId String?        @map("payment_intent_id")
  purchaseId      String?        @map("purchase_id") @db.Text
  subtotalCents   Int            @map("subtotal_cents")
  discountCents   Int            @default(0) @map("discount_cents")
  shippingCents   Int            @default(0) @map("shipping_cents")
  shippingZoneId  Int?           @map("shipping_zone_id")
  shippingMethodId Int?          @map("shipping_method_id")
  totalCents      Int            @map("total_cents")
  currency        String         @default("EUR")
  customerEmail   String?        @map("customer_email") @db.Citext
  customerName    String?        @map("customer_name")
  customerPhone   String?        @map("customer_phone")
  notes           String?
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store           Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user            Profile?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  shippingZone    StoreShippingZone?   @relation("StoreOrderShippingZone", fields: [shippingZoneId], references: [id], onDelete: SetNull)
  shippingMethod  StoreShippingMethod? @relation("StoreOrderShippingMethod", fields: [shippingMethodId], references: [id], onDelete: SetNull)
  lines           StoreOrderLine[]
  bundles         StoreOrderBundle[]
  addresses       StoreOrderAddress[]
  shipments       StoreShipment[]

  @@unique([orderNumber], map: "store_orders_order_number_unique")
  @@index([storeId], map: "store_orders_store_idx")
  @@index([userId], map: "store_orders_user_idx")
  @@index([status], map: "store_orders_status_idx")
  @@index([paymentIntentId], map: "store_orders_payment_intent_idx")
  @@index([purchaseId], map: "store_orders_purchase_idx")
  @@index([shippingZoneId], map: "store_orders_shipping_zone_idx")
  @@index([shippingMethodId], map: "store_orders_shipping_method_idx")
  @@map("store_orders")
  @@schema("app_v3")
}

model StoreOrderLine {
  env                     String                         @default("prod")
  id               Int      @id @default(autoincrement())
  orderId          Int      @map("order_id")
  productId        Int?     @map("product_id")
  variantId        Int?     @map("variant_id")
  orderBundleId    Int?     @map("order_bundle_id")
  nameSnapshot     String   @map("name_snapshot")
  skuSnapshot      String?  @map("sku_snapshot")
  quantity         Int
  unitPriceCents   Int      @map("unit_price_cents")
  discountCents    Int      @default(0) @map("discount_cents")
  totalCents       Int      @map("total_cents")
  requiresShipping Boolean  @default(true) @map("requires_shipping")
  personalization  Json    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  order            StoreOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          StoreProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant          StoreProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  orderBundle      StoreOrderBundle? @relation(fields: [orderBundleId], references: [id], onDelete: SetNull)
  digitalGrants    StoreDigitalGrant[]
  entitlements     Entitlement[]

  @@index([orderId], map: "store_order_lines_order_idx")
  @@index([productId], map: "store_order_lines_product_idx")
  @@index([variantId], map: "store_order_lines_variant_idx")
  @@index([orderBundleId], map: "store_order_lines_bundle_idx")
  @@map("store_order_lines")
  @@schema("app_v3")
}

model StoreOrderBundle {
  env                     String                         @default("prod")
  id             Int                   @id @default(autoincrement())
  orderId        Int                   @map("order_id")
  bundleId       Int?                  @map("bundle_id")
  nameSnapshot   String                @map("name_snapshot")
  pricingMode    StoreBundlePricingMode @map("pricing_mode")
  priceCents     Int?                  @map("price_cents")
  percentOff     Int?                  @map("percent_off")
  bundleQuantity Int                   @default(1) @map("bundle_quantity")
  totalCents     Int                   @map("total_cents")
  createdAt      DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  order          StoreOrder            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  bundle         StoreBundle?          @relation(fields: [bundleId], references: [id], onDelete: SetNull)
  items          StoreOrderBundleItem[]
  orderLines     StoreOrderLine[]

  @@index([orderId], map: "store_order_bundles_order_idx")
  @@index([bundleId], map: "store_order_bundles_bundle_idx")
  @@map("store_order_bundles")
  @@schema("app_v3")
}

model StoreOrderBundleItem {
  env                     String                         @default("prod")
  id            Int      @id @default(autoincrement())
  orderBundleId Int      @map("order_bundle_id")
  productId     Int?     @map("product_id")
  variantId     Int?     @map("variant_id")
  quantity      Int
  nameSnapshot  String   @map("name_snapshot")
  skuSnapshot   String?  @map("sku_snapshot")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  orderBundle   StoreOrderBundle @relation(fields: [orderBundleId], references: [id], onDelete: Cascade)
  product       StoreProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant       StoreProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderBundleId], map: "store_order_bundle_items_bundle_idx")
  @@index([productId], map: "store_order_bundle_items_product_idx")
  @@index([variantId], map: "store_order_bundle_items_variant_idx")
  @@map("store_order_bundle_items")
  @@schema("app_v3")
}

model StoreOrderAddress {
  env                     String                         @default("prod")
  id          Int             @id @default(autoincrement())
  orderId     Int             @map("order_id")
  addressType StoreAddressType @map("address_type")
  fullName    String          @map("full_name")
  addressId   String          @map("address_id") @db.Uuid
  nif         String?         @map("nif") @db.Text
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  order       StoreOrder      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  addressRef  Address         @relation(fields: [addressId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "store_order_addresses_order_idx")
  @@index([addressId], map: "store_order_addresses_address_idx")
  @@map("store_order_addresses")
  @@schema("app_v3")
}

model StoreShipment {
  env                     String                         @default("prod")
  id             Int               @id @default(autoincrement())
  orderId        Int               @map("order_id")
  carrier        String?
  trackingNumber String?           @map("tracking_number")
  trackingUrl    String?           @map("tracking_url")
  status         StoreShipmentStatus @default(PENDING)
  shippedAt      DateTime?         @map("shipped_at") @db.Timestamptz(6)
  deliveredAt    DateTime?         @map("delivered_at") @db.Timestamptz(6)
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  order          StoreOrder        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "store_shipments_order_idx")
  @@map("store_shipments")
  @@schema("app_v3")
}

model StoreShippingZone {
  env                     String                         @default("prod")
  id        Int      @id @default(autoincrement())
  storeId   Int      @map("store_id")
  name      String
  countries String[] @default([]) @map("countries")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  methods   StoreShippingMethod[]
  orders    StoreOrder[] @relation("StoreOrderShippingZone")

  @@index([storeId], map: "store_shipping_zones_store_idx")
  @@map("store_shipping_zones")
  @@schema("app_v3")
}

model StoreShippingMethod {
  env                     String                         @default("prod")
  id            Int               @id @default(autoincrement())
  zoneId        Int               @map("zone_id")
  name          String
  description   String?
  baseRateCents Int               @map("base_rate_cents")
  mode          StoreShippingMode @default(FLAT)
  freeOverCents Int?              @map("free_over_cents")
  isDefault     Boolean           @default(false) @map("is_default")
  etaMinDays    Int?              @map("eta_min_days")
  etaMaxDays    Int?              @map("eta_max_days")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  zone          StoreShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  tiers         StoreShippingTier[]
  orders        StoreOrder[] @relation("StoreOrderShippingMethod")

  @@index([zoneId], map: "store_shipping_methods_zone_idx")
  @@map("store_shipping_methods")
  @@schema("app_v3")
}

model StoreShippingTier {
  env                     String                         @default("prod")
  id               Int      @id @default(autoincrement())
  methodId         Int      @map("method_id")
  minSubtotalCents Int      @map("min_subtotal_cents")
  maxSubtotalCents Int?     @map("max_subtotal_cents")
  rateCents        Int      @map("rate_cents")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  method           StoreShippingMethod @relation(fields: [methodId], references: [id], onDelete: Cascade)

  @@index([methodId], map: "store_shipping_tiers_method_idx")
  @@map("store_shipping_tiers")
  @@schema("app_v3")
}

model StoreInventoryMovement {
  env                     String                         @default("prod")
  id            Int                       @id @default(autoincrement())
  productId     Int                       @map("product_id")
  variantId     Int?                      @map("variant_id")
  movementType  StoreInventoryMovementType @map("movement_type")
  quantity      Int
  reason        String?
  createdAt     DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  product       StoreProduct              @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant       StoreProductVariant?      @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([productId], map: "store_inventory_movements_product_idx")
  @@index([variantId], map: "store_inventory_movements_variant_idx")
  @@map("store_inventory_movements")
  @@schema("app_v3")
}

model OrganizationForm {
  env                     String                         @default("prod")
  id              Int                             @id @default(autoincrement())
  organizationId     Int                             @map("organization_id")
  title           String
  description     String?
  status          OrganizationFormStatus          @default(DRAFT)
  capacity        Int?
  waitlistEnabled Boolean                         @default(true) @map("waitlist_enabled")
  startAt         DateTime?                       @map("start_at") @db.Timestamptz(6)
  endAt           DateTime?                       @map("end_at") @db.Timestamptz(6)
  createdAt       DateTime                        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization       Organization                       @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "organization_forms_organization_fk")
  fields          OrganizationFormField[]
  submissions     OrganizationFormSubmission[]

  @@index([organizationId])
  @@map("organization_forms")
  @@schema("app_v3")
}

model OrganizationFormField {
  env                     String                         @default("prod")
  id          Int                         @id @default(autoincrement())
  formId      Int                         @map("form_id")
  label       String
  fieldType   OrganizationFormFieldType   @map("field_type")
  required    Boolean                     @default(false)
  helpText    String?                     @map("help_text")
  placeholder String?
  options     Json?
  order       Int                         @default(0)
  createdAt   DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  form        OrganizationForm            @relation(fields: [formId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "organization_form_fields_form_fk")

  @@index([formId])
  @@map("organization_form_fields")
  @@schema("app_v3")
}

model OrganizationFormSubmission {
  env                     String                         @default("prod")
  id         Int                               @id @default(autoincrement())
  formId     Int                               @map("form_id")
  userId     String?                           @map("user_id") @db.Uuid
  guestEmail String?                           @map("guest_email")
  status     OrganizationFormSubmissionStatus  @default(SUBMITTED)
  answers    Json                              @default("{}")
  createdAt  DateTime                          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime                          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  form       OrganizationForm                  @relation(fields: [formId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "organization_form_submissions_form_fk")
  user       Profile?                          @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([formId])
  @@index([userId])
  @@map("organization_form_submissions")
  @@schema("app_v3")
}

model OrganizationModuleEntry {
  env                     String                         @default("prod")
  organizationId Int                @map("organization_id")
  moduleKey   OrganizationModule @map("module_key")
  enabled     Boolean            @default(true)
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([organizationId, moduleKey])
  @@map("organization_modules")
  @@schema("app_v3")
}

model OrganizationOfficialEmailRequest {
  env                     String                         @default("prod")
  id                Int       @id @default(autoincrement())
  organizationId       Int       @map("organization_id")
  requestedByUserId String?   @map("requested_by_user_id") @db.Uuid
  newEmail          String    @map("new_email")
  token             String    @unique
  status            String    @default("PENDING")
  expiresAt         DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  confirmedAt       DateTime? @map("confirmed_at") @db.Timestamptz(6)
  cancelledAt       DateTime? @map("cancelled_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "organization_official_email_requests_organization_fk")

  @@index([organizationId], map: "organization_official_email_requests_org_idx")
  @@map("organization_official_email_requests")
  @@schema("app_v3")
}

model GlobalUsername {
  username  String   @id @db.Citext
  env       String   @default("prod")
  ownerType String   @map("owner_type")
  ownerId   String   @map("owner_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([ownerType, ownerId], map: "global_usernames_owner_unique")
  @@map("global_usernames")
  @@schema("app_v3")
}

model Notification {
  env                     String                         @default("prod")
  id          String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String                 @map("user_id") @db.Uuid
  type        NotificationType
  title       String?
  body        String?
  payload     Json?                  @default("{}")
  ctaUrl      String?                @map("cta_url")
  ctaLabel    String?                @map("cta_label")
  priority    NotificationPriority   @default(NORMAL)
  fromUserId  String?                @map("from_user_id") @db.Uuid
  organizationId Int?                   @map("organization_id")
  eventId     Int?                   @map("event_id")
  ticketId    String?                @map("ticket_id")
  inviteId    String?                @map("invite_id") @db.Uuid
  isRead      Boolean                @default(false) @map("is_read")
  readAt      DateTime?              @map("read_at") @db.Timestamptz(6)
  sourceEventId String?              @map("source_event_id")
  expiresAt   DateTime?              @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  event       Event?                 @relation("NotificationEvent", fields: [eventId], references: [id], onUpdate: NoAction)
  fromUser    Profile?               @relation("NotificationSender", fields: [fromUserId], references: [id], onUpdate: NoAction)
  invite      OrganizationMemberInvite? @relation("NotificationInvite", fields: [inviteId], references: [id], onUpdate: NoAction)
  organization   Organization?             @relation("NotificationOrganization", fields: [organizationId], references: [id], onUpdate: NoAction)
  ticket      Ticket?                @relation("NotificationTicket", fields: [ticketId], references: [id], onUpdate: NoAction)
  crmCampaignDeliveries CrmCampaignDelivery[]
  user        Profile                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([userId, type, fromUserId], map: "notifications_user_type_sender_idx")
  @@index([fromUserId])
  @@index([organizationId])
  @@index([eventId])
  @@index([ticketId])
  @@index([inviteId])
  @@unique([sourceEventId], map: "notifications_source_event_id_unique")
  @@map("notifications")
  @@schema("app_v3")
}

/// Locks simples para operações concorrentes (drag/edit)
model Lock {
  key       String   @id
  env       String   @default("prod")
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)

  @@map("locks")
  @@schema("app_v3")
}

model NotificationPreference {
  env                     String                         @default("prod")
  userId                   String   @id @map("userId") @db.Uuid
  allowEmailNotifications  Boolean  @default(true) @map("allow_email_notifications")
  allowSocialNotifications Boolean  @default(true) @map("allow_social_notifications")
  allowEventNotifications  Boolean  @default(true) @map("allow_event_notifications")
  allowSystemNotifications Boolean  @default(true) @map("allow_system_notifications")
  allowMarketingNotifications Boolean @default(true) @map("allow_marketing_notifications")
  allowEventReminders      Boolean  @default(true) @map("allow_event_reminders")
  allowFollowRequests      Boolean  @default(true) @map("allow_follow_requests")
  allowSalesAlerts         Boolean  @default(true) @map("allow_sales_alerts")
  allowSystemAnnouncements Boolean  @default(true) @map("allow_system_announcements")
  allowMarketingCampaigns  Boolean  @default(true) @map("allow_marketing_campaigns")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @default(now()) @updatedAt @map("updated_at")
  user                     Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
  @@schema("app_v3")
}

model NotificationMute {
  env            String        @default("prod")
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  organizationId Int?          @map("organization_id")
  eventId        Int?          @map("event_id")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  user           Profile       @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  event          Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, eventId])
  @@index([userId])
  @@index([organizationId])
  @@index([eventId])
  @@map("notification_mutes")
  @@schema("app_v3")
}

model NotificationOutbox {
  env                     String                         @default("prod")
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String?   @map("user_id") @db.Uuid
  notificationType String    @map("notification_type")
  templateVersion  String?   @map("template_version")
  dedupeKey        String    @unique @map("dedupe_key")
  status           String    @default("PENDING")
  payload          Json      @default("{}")
  retries          Int       @default(0)
  lastError        String?   @map("last_error")
  nextAttemptAt    DateTime? @map("next_attempt_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  sentAt           DateTime? @map("sent_at") @db.Timestamptz(6)
  user             Profile?  @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@index([status], map: "notification_outbox_status_idx")
  @@index([userId], map: "notification_outbox_user_idx")
  @@map("notification_outbox")
  @@schema("app_v3")
}

model ChatThread {
  env                     String                         @default("prod")
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entityType     ChatEntityType   @map("entity_type")
  entityId       Int              @map("entity_id")
  organizationId Int              @map("organization_id")
  openAt         DateTime         @map("open_at") @db.Timestamptz(6)
  readOnlyAt     DateTime         @map("read_only_at") @db.Timestamptz(6)
  closeAt        DateTime         @map("close_at") @db.Timestamptz(6)
  deleteAfter    DateTime?        @map("delete_after") @db.Timestamptz(6)
  legalHoldUntil DateTime?        @map("legal_hold_until") @db.Timestamptz(6)
  openNotifiedAt DateTime?        @map("open_notified_at") @db.Timestamptz(6)
  status         ChatThreadStatus @default(ANNOUNCEMENTS)
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        ChatMember[]
  messages       ChatMessage[]
  reads          ChatReadState[]
  moderationLogs ChatModerationLog[]
  invites        ChatInvite[]
  eventInvites   ChatEventInvite[]

  @@unique([entityType, entityId], map: "chat_threads_entity_unique")
  @@index([organizationId], map: "chat_threads_org_idx")
  @@index([status], map: "chat_threads_status_idx")
  @@index([openAt], map: "chat_threads_open_idx")
  @@index([closeAt], map: "chat_threads_close_idx")
  @@index([deleteAfter], map: "chat_threads_delete_after_idx")
  @@map("chat_threads")
  @@schema("app_v3")
}

model ChatMember {
  env                     String                         @default("prod")
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId   String         @map("thread_id") @db.Uuid
  userId     String         @map("user_id") @db.Uuid
  role       ChatMemberRole @default(PARTICIPANT)
  joinedAt   DateTime       @default(now()) @map("joined_at") @db.Timestamptz(6)
  leftAt     DateTime?      @map("left_at") @db.Timestamptz(6)
  accessRevokedAt DateTime? @map("access_revoked_at") @db.Timestamptz(6)
  mutedUntil DateTime?      @map("muted_until") @db.Timestamptz(6)
  bannedAt   DateTime?      @map("banned_at") @db.Timestamptz(6)
  createdAt  DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  thread     ChatThread     @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user       Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId], map: "chat_members_thread_user_unique")
  @@index([threadId], map: "chat_members_thread_idx")
  @@index([userId], map: "chat_members_user_idx")
  @@index([threadId, leftAt], map: "chat_members_thread_active_idx")
  @@map("chat_members")
  @@schema("app_v3")
}

model ChatMessage {
  env                     String                         @default("prod")
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId     String           @map("thread_id") @db.Uuid
  userId       String?          @map("user_id") @db.Uuid
  kind         ChatMessageKind  @default(USER)
  body         String
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt    DateTime?        @map("deleted_at") @db.Timestamptz(6)
  thread       ChatThread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user         Profile?         @relation("ChatMessageUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([threadId, createdAt(sort: Desc)], map: "chat_messages_thread_created_idx")
  @@index([userId], map: "chat_messages_user_idx")
  @@map("chat_messages")
  @@schema("app_v3")
}

model ChatReadState {
  env                     String                         @default("prod")
  threadId   String     @map("thread_id") @db.Uuid
  userId     String     @map("user_id") @db.Uuid
  lastReadAt DateTime   @default(now()) @map("last_read_at") @db.Timestamptz(6)
  thread     ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user       Profile    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([threadId, userId])
  @@index([userId], map: "chat_read_state_user_idx")
  @@map("chat_read_state")
  @@schema("app_v3")
}

model ChatModerationLog {
  env                     String                         @default("prod")
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId    String     @map("thread_id") @db.Uuid
  actorUserId String?    @map("actor_user_id") @db.Uuid
  action      String
  metadata    Json?      @default("{}")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  thread      ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  actor       Profile?   @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([threadId], map: "chat_moderation_thread_idx")
  @@index([actorUserId], map: "chat_moderation_actor_idx")
  @@map("chat_moderation_log")
  @@schema("app_v3")
}

model ChatInvite {
  env                     String                         @default("prod")
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId        String            @map("thread_id") @db.Uuid
  eventId         Int               @map("event_id")
  userId          String?           @map("user_id") @db.Uuid
  ownerIdentityId String?           @map("owner_identity_id") @db.Uuid
  status          ChatInviteStatus  @default(PENDING)
  expiresAt       DateTime          @map("expires_at") @db.Timestamptz(6)
  acceptedAt      DateTime?         @map("accepted_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  thread          ChatThread        @relation(fields: [threadId], references: [id], onDelete: Cascade)
  event           Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            Profile?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  ownerIdentity   EmailIdentity?    @relation(fields: [ownerIdentityId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId], map: "chat_invites_thread_user_unique")
  @@unique([threadId, ownerIdentityId], map: "chat_invites_thread_identity_unique")
  @@index([eventId], map: "chat_invites_event_idx")
  @@index([userId], map: "chat_invites_user_idx")
  @@index([ownerIdentityId], map: "chat_invites_identity_idx")
  @@index([status], map: "chat_invites_status_idx")
  @@index([expiresAt], map: "chat_invites_expires_idx")
  @@map("chat_invites")
  @@schema("app_v3")
}

model ChatEventInvite {
  env                     String                         @default("prod")
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId         Int                @map("event_id")
  threadId        String             @map("thread_id") @db.Uuid
  entitlementId   String             @map("entitlement_id") @db.Uuid
  userId          String?            @map("user_id") @db.Uuid
  status          ChatEventInviteStatus @default(PENDING)
  invitedAt       DateTime           @default(now()) @map("invited_at") @db.Timestamptz(6)
  acceptedAt      DateTime?          @map("accepted_at") @db.Timestamptz(6)
  expiresAt       DateTime           @map("expires_at") @db.Timestamptz(6)
  revokedAt       DateTime?          @map("revoked_at") @db.Timestamptz(6)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  thread      ChatThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  entitlement Entitlement @relation(fields: [entitlementId], references: [id], onDelete: Cascade)
  user        Profile?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, entitlementId], map: "chat_event_invites_event_entitlement_unique")
  @@index([userId, status], map: "chat_event_invites_user_status_idx")
  @@index([threadId, status], map: "chat_event_invites_thread_status_idx")
  @@index([status], map: "chat_event_invites_status_idx")
  @@map("chat_event_invites")
  @@schema("app_v3")
}

model ChatConversation {
  env                     String                         @default("prod")
  id              String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  Int?                 @map("organization_id")
  type            ChatConversationType
  contextType     ChatConversationContextType @map("context_type")
  contextId       String?              @map("context_id") @db.Text
  customerId      String?              @map("customer_id") @db.Uuid
  professionalId  String?              @map("professional_id") @db.Uuid
  title           String?
  description     String?
  createdByUserId String?              @map("created_by_user_id") @db.Uuid
  openAt          DateTime?            @map("open_at") @db.Timestamptz(6)
  readOnlyAt      DateTime?            @map("read_only_at") @db.Timestamptz(6)
  closeAt         DateTime?            @map("close_at") @db.Timestamptz(6)
  createdAt       DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastMessageAt   DateTime?            @map("last_message_at") @db.Timestamptz(6)
  lastMessageId   String?              @unique @map("last_message_id") @db.Uuid

  organization Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    Profile?                @relation("ChatConversationCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  lastMessage  ChatConversationMessage? @relation("ChatConversationLastMessage", fields: [lastMessageId], references: [id], onDelete: SetNull)
  members      ChatConversationMember[]
  messages     ChatConversationMessage[] @relation("ChatConversationMessages")
  requests     ChatConversationRequest[]

  @@index([organizationId], map: "chat_conversations_org_idx")
  @@index([lastMessageAt], map: "chat_conversations_last_message_idx")
  @@index([contextType, contextId], map: "chat_conversations_context_idx")
  @@index([customerId], map: "chat_conversations_customer_idx")
  @@index([professionalId], map: "chat_conversations_professional_idx")
  @@map("chat_conversations")
  @@schema("app_v3")
}

model ChatConversationMember {
  env                     String                         @default("prod")
  conversationId    String                   @map("conversation_id") @db.Uuid
  organizationId    Int?                     @map("organization_id")
  userId            String                   @map("user_id") @db.Uuid
  role              ChatConversationMemberRole @default(MEMBER)
  joinedAt          DateTime                 @default(now()) @map("joined_at") @db.Timestamptz(6)
  leftAt            DateTime?                @map("left_at") @db.Timestamptz(6)
  accessRevokedAt   DateTime?                @map("access_revoked_at") @db.Timestamptz(6)
  bannedAt          DateTime?                @map("banned_at") @db.Timestamptz(6)
  mutedUntil        DateTime?                @map("muted_until") @db.Timestamptz(6)
  notifLevel        ChatConversationNotificationLevel @default(ALL) @map("notif_level")
  lastReadMessageId String?                  @map("last_read_message_id") @db.Uuid
  lastReadAt        DateTime?                @map("last_read_at") @db.Timestamptz(6)
  displayAs         ChatMemberDisplayAs      @default(ORGANIZATION) @map("display_as")
  hiddenFromCustomer Boolean                 @default(false) @map("hidden_from_customer")

  conversation   ChatConversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           Profile                  @relation("ChatConversationMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  lastReadMessage ChatConversationMessage? @relation("ChatConversationMemberLastRead", fields: [lastReadMessageId], references: [id], onDelete: SetNull)

  @@id([conversationId, userId])
  @@index([userId], map: "chat_conversation_members_user_idx")
  @@index([conversationId], map: "chat_conversation_members_conversation_idx")
  @@map("chat_conversation_members")
  @@schema("app_v3")
}

model ChatConversationMessage {
  env                     String                         @default("prod")
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId  String    @map("conversation_id") @db.Uuid
  organizationId  Int?      @map("organization_id")
  senderId        String?   @map("sender_id") @db.Uuid
  body            String?   @db.Text
  clientMessageId String    @map("client_message_id")
  kind            ChatConversationMessageKind @default(TEXT)
  metadata        Json?     @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  editedAt        DateTime? @map("edited_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)
  replyToId       String?   @map("reply_to_id") @db.Uuid

  conversation ChatConversation       @relation("ChatConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  sender       Profile?               @relation("ChatConversationMessageSender", fields: [senderId], references: [id], onDelete: SetNull)
  replyTo      ChatConversationMessage? @relation("ChatConversationMessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      ChatConversationMessage[] @relation("ChatConversationMessageReplies")
  attachments  ChatConversationAttachment[]
  reactions    ChatMessageReaction[]
  pins         ChatMessagePin[]
  lastReadByMembers ChatConversationMember[] @relation("ChatConversationMemberLastRead")
  lastMessageOf ChatConversation?     @relation("ChatConversationLastMessage")
  reports      ChatMessageReport[]

  @@unique([conversationId, senderId, clientMessageId], map: "chat_conversation_messages_sender_client_unique")
  @@index([conversationId, createdAt(sort: Desc)], map: "chat_conversation_messages_conversation_created_idx")
  @@index([conversationId], map: "chat_conversation_messages_conversation_idx")
  @@index([senderId], map: "chat_conversation_messages_sender_idx")
  @@map("chat_conversation_messages")
  @@schema("app_v3")
}

model ChatConversationAttachment {
  env                     String                         @default("prod")
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId String             @map("message_id") @db.Uuid
  type      ChatAttachmentType
  url       String             @db.Text
  storagePath String?          @map("storage_path") @db.Text
  mime      String             @db.Text
  size      Int
  width     Int?
  height    Int?
  metadata  Json?              @default("{}")
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)

  message ChatConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId], map: "chat_conversation_attachments_message_idx")
  @@map("chat_conversation_attachments")
  @@schema("app_v3")
}

model ChatMessageReaction {
  env                     String                         @default("prod")
  messageId String   @map("message_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  emoji     String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  message ChatConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    Profile                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([messageId, userId, emoji])
  @@index([messageId], map: "chat_message_reactions_message_idx")
  @@map("chat_message_reactions")
  @@schema("app_v3")
}

model ChatMessagePin {
  env                     String                         @default("prod")
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId String  @map("message_id") @db.Uuid
  pinnedBy  String  @map("pinned_by") @db.Uuid
  pinnedAt  DateTime @default(now()) @map("pinned_at") @db.Timestamptz(6)

  message ChatConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    Profile                 @relation(fields: [pinnedBy], references: [id], onDelete: Cascade)

  @@unique([messageId], map: "chat_message_pins_message_unique")
  @@index([messageId], map: "chat_message_pins_message_idx")
  @@map("chat_message_pins")
  @@schema("app_v3")
}

model ChatUserPresence {
  env                     String                         @default("prod")
  userId     String   @id @map("user_id") @db.Uuid
  lastSeenAt DateTime @map("last_seen_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user Profile @relation("ChatUserPresenceUser", fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_user_presence")
  @@schema("app_v3")
}

model ChatMessageReport {
  env                     String                         @default("prod")
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId  String    @map("message_id") @db.Uuid
  reporterId String    @map("reporter_id") @db.Uuid
  reason     String?
  metadata   Json?     @default("{}")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  message  ChatConversationMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporter Profile                @relation("ChatMessageReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([messageId], map: "chat_message_reports_message_idx")
  @@index([reporterId], map: "chat_message_reports_reporter_idx")
  @@map("chat_message_reports")
  @@schema("app_v3")
}

model ChatUserBlock {
  env                     String                         @default("prod")
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  blockerId  String   @map("blocker_id") @db.Uuid
  blockedId  String   @map("blocked_id") @db.Uuid
  reason     String?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  blocker Profile @relation("ChatUserBlockBlocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked Profile @relation("ChatUserBlockBlocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId], map: "chat_user_blocks_unique")
  @@index([blockedId], map: "chat_user_blocks_blocked_idx")
  @@map("chat_user_blocks")
  @@schema("app_v3")
}

model ChatConversationRequest {
  env                     String                         @default("prod")
  id               String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requesterId      String                     @map("requester_id") @db.Uuid
  targetUserId     String?                    @map("target_user_id") @db.Uuid
  targetOrganizationId Int?                   @map("target_organization_id")
  contextType      ChatConversationContextType @map("context_type")
  contextId        String?                    @map("context_id") @db.Text
  status           ChatConversationRequestStatus @default(PENDING)
  conversationId   String?                    @map("conversation_id") @db.Uuid
  createdAt        DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  resolvedAt       DateTime?                  @map("resolved_at") @db.Timestamptz(6)

  requester Profile @relation("ChatConversationRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  targetUser Profile? @relation("ChatConversationRequestTargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  targetOrganization Organization? @relation(fields: [targetOrganizationId], references: [id], onDelete: Cascade)
  conversation ChatConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([requesterId, status], map: "chat_conversation_requests_requester_status_idx")
  @@index([targetUserId, status], map: "chat_conversation_requests_target_user_status_idx")
  @@index([targetOrganizationId, status], map: "chat_conversation_requests_target_org_status_idx")
  @@index([contextType, contextId], map: "chat_conversation_requests_context_idx")
  @@map("chat_conversation_requests")
  @@schema("app_v3")
}

model ChatChannelRequest {
  env                     String                         @default("prod")
  id               String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId   Int                        @map("organization_id")
  requesterId      String                     @map("requester_id") @db.Uuid
  title            String
  status           ChatChannelRequestStatus    @default(PENDING)
  createdAt        DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  resolvedAt       DateTime?                  @map("resolved_at") @db.Timestamptz(6)
  resolvedByUserId String?                    @map("resolved_by_user_id") @db.Uuid

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requester Profile @relation("ChatChannelRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  resolvedBy Profile? @relation("ChatChannelRequestResolver", fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status], map: "chat_channel_requests_org_status_idx")
  @@index([requesterId, status], map: "chat_channel_requests_requester_status_idx")
  @@map("chat_channel_requests")
  @@schema("app_v3")
}

model ChatAccessGrant {
  env                  String                     @default("prod")
  id                   String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kind                 ChatAccessGrantKind
  status               ChatAccessGrantStatus      @default(PENDING)
  contextType          ChatConversationContextType? @map("context_type")
  contextId            String?                    @map("context_id") @db.Text
  conversationId       String?                    @map("conversation_id") @db.Uuid
  organizationId       Int?                       @map("organization_id")
  requesterId          String?                    @map("requester_id") @db.Uuid
  targetUserId         String?                    @map("target_user_id") @db.Uuid
  targetOrganizationId Int?                       @map("target_organization_id")
  eventId              Int?                       @map("event_id")
  entitlementId        String?                    @map("entitlement_id") @db.Uuid
  threadId             String?                    @map("thread_id") @db.Uuid
  title                String?
  sourceTable          String?                    @map("source_table")
  sourceId             String?                    @map("source_id") @db.Uuid
  expiresAt            DateTime?                  @map("expires_at") @db.Timestamptz(6)
  resolvedAt           DateTime?                  @map("resolved_at") @db.Timestamptz(6)
  resolvedByUserId     String?                    @map("resolved_by_user_id") @db.Uuid
  acceptedAt           DateTime?                  @map("accepted_at") @db.Timestamptz(6)
  declinedAt           DateTime?                  @map("declined_at") @db.Timestamptz(6)
  cancelledAt          DateTime?                  @map("cancelled_at") @db.Timestamptz(6)
  revokedAt            DateTime?                  @map("revoked_at") @db.Timestamptz(6)
  metadata             Json?                      @default("{}")
  createdAt            DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime                   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status], map: "chat_access_grants_status_idx")
  @@index([kind, status], map: "chat_access_grants_kind_status_idx")
  @@index([requesterId, status], map: "chat_access_grants_requester_status_idx")
  @@index([targetUserId, status], map: "chat_access_grants_target_user_status_idx")
  @@index([targetOrganizationId, status], map: "chat_access_grants_target_org_status_idx")
  @@index([contextType, contextId], map: "chat_access_grants_context_idx")
  @@unique([sourceTable, sourceId], map: "chat_access_grants_source_unique")
  @@map("chat_access_grants")
  @@schema("app_v3")
}

model MatchNotification {
  env                     String                         @default("prod")
  id        Int      @id @default(autoincrement())
  matchId   Int      @map("match_id")
  dedupeKey String   @unique @map("dedupe_key")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  payload   Json?

  @@index([matchId], map: "match_notifications_match_idx")
  @@map("match_notifications")
  @@schema("app_v3")
}

model EmailIdentity {
  env                     String                         @default("prod")
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  emailNormalized String   @unique @map("email_normalized") @db.Citext
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)
  userId         String?   @map("user_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  chatInvites    ChatInvite[]
  crmContacts    CrmContact[]

  @@map("email_identities")
  @@schema("app_v3")
}

model EmailOutbox {
  env                     String                         @default("prod")
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  templateKey   String    @map("template_key")
  recipient     String    @db.Citext
  purchaseId    String    @map("purchase_id") @db.Text
  entitlementId String?   @map("entitlement_id") @db.Uuid
  dedupeKey     String    @unique @map("dedupe_key")
  status        String    @default("PENDING")
  payload       Json      @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  sentAt        DateTime? @map("sent_at") @db.Timestamptz(6)
  failedAt      DateTime? @map("failed_at") @db.Timestamptz(6)
  errorCode     String?   @map("error_code")

  @@index([purchaseId], map: "email_outbox_purchase_idx")
  @@index([recipient], map: "email_outbox_recipient_idx")
  @@map("email_outbox")
  @@schema("app_v3")
}

model OrganizationMemberPermission {
  env                     String                         @default("prod")
  id              Int                          @id @default(autoincrement())
  organizationId  Int                          @map("organization_id")
  userId          String                       @map("user_id") @db.Uuid
  moduleKey       OrganizationModule           @map("module_key")
  accessLevel     OrganizationPermissionLevel  @default(VIEW) @map("access_level")
  scopeType       String?                      @map("scope_type")
  scopeId         String?                      @map("scope_id")
  createdAt       DateTime                     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization    Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            Profile                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, moduleKey, scopeType, scopeId], map: "org_member_permission_unique")
  @@index([organizationId, userId], map: "org_member_permissions_org_user_idx")
  @@index([organizationId, moduleKey], map: "org_member_permissions_org_module_idx")
  @@map("organization_member_permissions")
  @@schema("app_v3")
}

model OrganizationMemberInvite {
  env                     String                         @default("prod")
  id               String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId      Int                 @map("organization_id")
  invitedByUserId  String              @map("invited_by_user_id") @db.Uuid
  targetIdentifier String              @map("target_identifier") @db.Citext
  targetUserId     String?             @map("target_user_id") @db.Uuid
  role             OrganizationMemberRole
  rolePack         OrganizationRolePack? @map("role_pack")
  token            String              @unique @db.Uuid
  expiresAt        DateTime            @map("expires_at") @db.Timestamptz(6)
  acceptedAt       DateTime?           @map("accepted_at") @db.Timestamptz(6)
  declinedAt       DateTime?           @map("declined_at") @db.Timestamptz(6)
  cancelledAt      DateTime?           @map("cancelled_at") @db.Timestamptz(6)
  createdAt        DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime?           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  notifications    Notification[]      @relation("NotificationInvite")
  invitedBy        Profile             @relation("OrganizationMemberInviteInviter", fields: [invitedByUserId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization        Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  targetUser       Profile?            @relation("OrganizationMemberInviteTarget", fields: [targetUserId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([targetIdentifier], map: "organization_member_invites_identifier_idx")
  @@index([organizationId], map: "organization_member_invites_org_idx")
  @@index([targetUserId], map: "organization_member_invites_target_idx")
  @@map("organization_member_invites")
  @@schema("app_v3")
}

model OrganizationAuditLog {
  env                     String                         @default("prod")
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int      @map("organization_id")
  groupId     Int?     @map("group_id")
  actorUserId String?  @map("actor_user_id") @db.Uuid
  action      String
  entityType  String?  @map("entity_type")
  entityId    String?  @map("entity_id")
  correlationId String? @map("correlation_id")
  fromUserId  String?  @map("from_user_id") @db.Uuid
  toUserId    String?  @map("to_user_id") @db.Uuid
  metadata    Json?    @default("{}")
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "organization_audit_logs_org_idx")
  @@index([actorUserId], map: "organization_audit_logs_actor_idx")
  @@map("organization_audit_logs")
  @@schema("app_v3")
}

model PublicApiKey {
  env                     String                         @default("prod")
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int              @map("organization_id")
  keyPrefix      String           @map("key_prefix")
  keyHash        String           @unique @map("key_hash")
  scopes         PublicApiScope[] @map("scopes")
  revokedAt      DateTime?        @map("revoked_at") @db.Timestamptz(6)
  lastUsedAt     DateTime?        @map("last_used_at") @db.Timestamptz(6)
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "public_api_keys_org_idx")
  @@map("public_api_keys")
  @@schema("app_v3")
}

model OrganizationOwnerTransfer {
  env                     String                         @default("prod")
  id          String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int                          @map("organization_id")
  fromUserId  String                       @map("from_user_id") @db.Uuid
  toUserId    String                       @map("to_user_id") @db.Uuid
  status      OrganizationOwnerTransferStatus @default(PENDING)
  token       String                       @unique
  expiresAt   DateTime                     @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime?                    @default(now()) @map("created_at") @db.Timestamptz(6)
  confirmedAt DateTime?                    @map("confirmed_at") @db.Timestamptz(6)
  cancelledAt DateTime?                    @map("cancelled_at") @db.Timestamptz(6)
  organization   Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "organization_owner_transfers_org_idx")
  @@index([fromUserId], map: "organization_owner_transfers_from_idx")
  @@index([toUserId], map: "organization_owner_transfers_to_idx")
  @@map("organization_owner_transfers")
  @@schema("app_v3")
}




/// Evento — todo o conteúdo público é tratado como evento de organização
model Event {
  env                     String                         @default("prod")
  id                                Int                     @id @default(autoincrement())
  slug                              String                  @unique
  title                             String
  description                       String
  /// Tipo interno (mantido por compatibilidade)
  type                              EventType               @default(ORGANIZATION_EVENT)
  /// Template de apoio (padel, evento padrão)
  templateType                      EventTemplateType?      @map("template_type")
  interestTags                       String[]                @default([]) @map("interest_tags")
  liveHubVisibility                 LiveHubVisibility       @default(PUBLIC) @map("live_hub_visibility")
  /// Liga ao Organization quando é evento de organização
  organizationId                       Int?                    @map("organization_id")
  startsAt                          DateTime                @map("starts_at")
  endsAt                            DateTime                @map("ends_at")
  addressId                         String?                 @map("address_id") @db.Uuid
  pricingMode                       EventPricingMode        @default(STANDARD) @map("pricing_mode")
  status                            EventStatus             @default(DRAFT)
  timezone                          String                  @default("Europe/Lisbon")
  coverImageUrl                     String?                 @map("cover_image_url")
  liveStreamUrl                     String?                 @map("live_stream_url")
  createdAt                         DateTime                @default(now()) @map("created_at")
  updatedAt                         DateTime                @updatedAt @map("updated_at")
  /// auth.users.id de quem criou (user base)
  ownerUserId                       String                  @map("owner_user_id") @db.Uuid
  deletedAt                         DateTime?               @map("deleted_at") @db.Timestamp(6)
  isDeleted                         Boolean                 @default(false) @map("is_deleted")
  resaleMode                        ResaleMode              @default(ALWAYS) @map("resale_mode")
  feeMode                           FeeMode                 @default(INCLUDED) @map("fee_mode")
  payoutMode                        PayoutMode              @default(ORGANIZATION) @map("payout_mode")
  organization                         Organization?              @relation(fields: [organizationId], references: [id])
  addressRef                          Address?                   @relation(fields: [addressId], references: [id], onDelete: SetNull)
  notifications                     Notification[]          @relation("NotificationEvent")
  notificationMutes                 NotificationMute[]
  eventMatchSlots                  EventMatchSlot[]
  padelPairings                     PadelPairing[]
  padelRankingEntries               PadelRankingEntry[]
  padelTournamentConfig             PadelTournamentConfig?
  padelTournamentRoleAssignments    PadelTournamentRoleAssignment[]
  padelCategoryLinks                PadelEventCategoryLink[]
  padelCourtBlocks                  CalendarBlock[]
  padelAvailabilities               CalendarAvailability[]
  padelWaitlistEntries              PadelWaitlistEntry[]
  padelTeamEntries                  PadelTeamEntry[]
  tournamentEntries                 TournamentEntry[]
  tournament                        Tournament?             @relation("EventTournament")
  promoCodes                        PromoCode[]
  reservations                      TicketReservation[]
  ticketTypes                       TicketType[]
  tickets                           Ticket[]
  invites                           EventInvite[]
  accessPolicies                    EventAccessPolicy[]
  inviteTokens                      InviteToken[]
  ticketOrders                      TicketOrder[]
  padelRegistrations                PadelRegistration[]
  saleSummaries                     SaleSummary[]
  saleLines                         SaleLine[]
  refundPolicyVersions              RefundPolicyVersion[]
  favorites                         EventFavorite[]
  userEventSignals                  UserEventSignal[]
  chatInvites                       ChatInvite[]
  chatEventInvites                  ChatEventInvite[]
  guestTicketAccessTokens           GuestTicketAccessToken[]

  @@index([type, status])
  @@index([ownerUserId])
  @@index([organizationId])
  @@index([organizationId, status, isDeleted, createdAt(sort: Desc)], map: "events_org_status_deleted_created_idx")
  @@index([addressId], map: "events_address_idx")
  @@map("events")
  @@schema("app_v3")
}

model EventFavorite {
  env        String   @default("prod")
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  eventId    Int      @map("event_id")
  notify     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
  @@map("event_favorites")
  @@schema("app_v3")
}

model EventAccessPolicy {
  env                     String                         @default("prod")
  id                        Int                 @id @default(autoincrement())
  eventId                   Int                 @map("event_id")
  policyVersion             Int                 @map("policy_version")
  mode                      EventAccessMode
  guestCheckoutAllowed      Boolean             @map("guest_checkout_allowed")
  inviteTokenAllowed        Boolean             @map("invite_token_allowed")
  inviteIdentityMatch       InviteIdentityMatch @map("invite_identity_match")
  inviteTokenTtlSeconds     Int?                @map("invite_token_ttl_seconds")
  requiresEntitlementForEntry Boolean           @map("requires_entitlement_for_entry")
  checkinMethods            CheckinMethod[]     @default([]) @map("checkin_methods")
  scannerRequired           Boolean             @default(false) @map("scanner_required")
  allowReentry              Boolean             @default(false) @map("allow_reentry")
  reentryWindowMinutes      Int                 @default(15) @map("reentry_window_minutes")
  maxEntries                Int                 @default(1) @map("max_entries")
  undoWindowMinutes         Int                 @default(10) @map("undo_window_minutes")
  createdAt                 DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event                     Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, policyVersion], map: "event_access_policies_event_version_uq")
  @@index([eventId], map: "event_access_policies_event_idx")
  @@map("event_access_policies")
  @@schema("app_v3")
}

model EventInvite {
  env                     String                         @default("prod")
  id               Int      @id @default(autoincrement())
  eventId          Int      @map("event_id")
  invitedByUserId  String   @map("invited_by_user_id") @db.Uuid
  targetIdentifier String   @map("target_identifier") @db.Citext
  targetUserId     String?  @map("target_user_id") @db.Uuid
  scope            EventInviteScope @default(PUBLIC) @map("scope")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  invitedBy        Profile  @relation("EventInviteInviter", fields: [invitedByUserId], references: [id], onDelete: Cascade)
  targetUser       Profile? @relation("EventInviteTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@unique([eventId, targetIdentifier, scope], map: "event_invites_event_identifier_uq")
  @@index([eventId], map: "event_invites_event_idx")
  @@index([eventId, scope], map: "event_invites_event_scope_idx")
  @@index([targetUserId], map: "event_invites_target_idx")
  @@map("event_invites")
  @@schema("app_v3")
}

model InviteToken {
  env                     String                         @default("prod")
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tokenHash       String    @unique @map("token_hash")
  eventId         Int       @map("event_id")
  ticketTypeId    Int?      @map("ticket_type_id")
  emailNormalized String    @map("email_normalized") @db.Citext
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt          DateTime? @map("used_at") @db.Timestamptz(6)
  usedByIdentityId String?  @map("used_by_identity_id") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType      TicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: SetNull)

  @@index([eventId], map: "invite_tokens_event_idx")
  @@index([ticketTypeId], map: "invite_tokens_ticket_type_idx")
  @@index([expiresAt], map: "invite_tokens_expires_idx")
  @@index([usedAt], map: "invite_tokens_used_idx")
  @@map("invite_tokens")
  @@schema("app_v3")
}

/// Tipos de bilhete (antigas "waves")
model TicketType {
  env                     String                         @default("prod")
  id            Int                 @id @default(autoincrement())
  eventId       Int                 @map("event_id")
  padelEventCategoryLinkId Int?     @map("padel_event_category_link_id")
  name          String
  description   String?
  price         Int
  currency      String              @default("EUR")
  totalQuantity Int?                @map("total_quantity")
  soldQuantity  Int                 @default(0) @map("sold_quantity")
  status        TicketTypeStatus    @default(ON_SALE)
  startsAt      DateTime?           @map("starts_at")
  endsAt        DateTime?           @map("ends_at")
  sortOrder     Int                 @default(0) @map("sort_order")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  reservations  TicketReservation[]
  event         Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets       Ticket[]
  padelEventCategoryLink PadelEventCategoryLink? @relation(fields: [padelEventCategoryLinkId], references: [id], onDelete: SetNull)
  inviteTokens  InviteToken[]
  ticketOrderLines TicketOrderLine[]
  saleLines     SaleLine[]

  @@index([eventId])
  @@index([padelEventCategoryLinkId], map: "ticket_types_padel_category_link_idx")
  @@map("ticket_types")
  @@schema("app_v3")
}

/// Bilhete individual (por utilizador)
model Ticket {
  env                     String                         @default("prod")
  id                    String            @id @default(cuid())
  eventId               Int               @map("event_id")
  ticketTypeId          Int               @map("ticket_type_id")
  purchasedAt           DateTime          @default(now()) @map("purchased_at")
  status                TicketStatus      @default(ACTIVE)
  qrSecret              String            @unique @map("qr_secret")
  rotatingSeed          String?           @map("rotating_seed") @db.Uuid
  pricePaid             Int               @map("price_paid")
  currency              String            @default("EUR")
  userId                String?           @map("user_id") @db.Uuid
  platformFeeCents      Int               @default(0) @map("platform_fee_cents")
  totalPaidCents        Int               @default(0) @map("total_paid_cents")
  purchaseId            String?           @map("purchase_id") @db.Text
  stripePaymentIntentId String?           @map("stripe_payment_intent_id")
  emissionIndex         Int               @default(0) @map("emission_index")
  saleSummaryId         Int?              @map("sale_summary_id")
  guestLink             GuestTicketLink?
  notifications         Notification[]    @relation("NotificationTicket")
  entitlement           Entitlement?      @relation("TicketEntitlement")
  resales               TicketResale[]
  event                 Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType            TicketType        @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  ownerUserId           String?           @map("owner_user_id") @db.Uuid
  ownerIdentityId       String?           @map("owner_identity_id") @db.Uuid
  saleSummary           SaleSummary?      @relation(fields: [saleSummaryId], references: [id], onDelete: SetNull)

  @@unique([purchaseId, ticketTypeId, emissionIndex], map: "tickets_purchase_ticket_idx")
  @@index([eventId])
  @@index([userId])
  @@index([userId, status, eventId], map: "tickets_user_status_event_idx")
  @@index([ticketTypeId])
  @@index([stripePaymentIntentId], map: "tickets_stripe_intent_idx")
  @@index([saleSummaryId], map: "tickets_sale_summary_idx")
  @@map("tickets")
  @@schema("app_v3")
}

/// Ligação de bilhetes comprados como convidado
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model GuestTicketLink {
  env                     String                         @default("prod")
  ticketId         String    @id @map("ticket_id")
  guestEmail       String    @map("guest_email")
  guestName        String    @map("guest_name")
  guestPhone       String?   @map("guest_phone")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  ticket           Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("guest_ticket_links")
  @@schema("app_v3")
}

model GuestTicketAccessToken {
  env                     String                         @default("prod")
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purchaseId  String   @map("purchase_id") @db.Text
  eventId     Int      @map("event_id")
  guestEmail  String   @map("guest_email") @db.Citext
  tokenHash   String   @unique @map("token_hash")
  expiresAt   DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([purchaseId, guestEmail], map: "guest_ticket_access_purchase_email_uq")
  @@index([eventId], map: "guest_ticket_access_event_idx")
  @@index([guestEmail], map: "guest_ticket_access_email_idx")
  @@index([expiresAt], map: "guest_ticket_access_expires_idx")
  @@map("guest_ticket_access_tokens")
  @@schema("app_v3")
}

/// Reservas temporárias de stock de bilhetes
model TicketReservation {
  env                     String                         @default("prod")
  id           String            @id @default(cuid())
  eventId      Int               @map("event_id")
  ticketTypeId Int               @map("ticket_type_id")
  quantity     Int
  status       ReservationStatus @default(ACTIVE)
  expiresAt    DateTime          @map("expires_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  userId       String?           @map("user_id") @db.Uuid
  event        Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType   TicketType        @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([ticketTypeId])
  @@index([userId])
  @@index([status, expiresAt])
  @@map("ticket_reservations")
  @@schema("app_v3")
}

/// Checkout source (TICKET_ORDER)
model TicketOrder {
  env                     String                         @default("prod")
  id             String            @id @default(uuid()) @db.Uuid
  organizationId Int               @map("organization_id")
  eventId        Int               @map("event_id")
  buyerIdentityId String?          @map("buyer_identity_id") @db.Uuid
  currency       String            @default("EUR")
  status         TicketOrderStatus @default(DRAFT)
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  lines          TicketOrderLine[]
  event          Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "ticket_orders_org_idx")
  @@index([eventId], map: "ticket_orders_event_idx")
  @@map("ticket_orders")
  @@schema("app_v3")
}

/// Linhas do TicketOrder (para pricing snapshot)
model TicketOrderLine {
  env                     String                         @default("prod")
  id            Int         @id @default(autoincrement())
  ticketOrderId String      @map("ticket_order_id") @db.Uuid
  ticketTypeId  Int         @map("ticket_type_id")
  qty           Int         @map("qty")
  unitAmount    Int         @map("unit_amount")
  totalAmount   Int         @map("total_amount")
  ticketOrder   TicketOrder @relation(fields: [ticketOrderId], references: [id], onDelete: Cascade)
  ticketType    TicketType  @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  @@index([ticketOrderId], map: "ticket_order_lines_order_idx")
  @@index([ticketTypeId], map: "ticket_order_lines_ticket_type_idx")
  @@map("ticket_order_lines")
  @@schema("app_v3")
}

/// Revenda de bilhetes pelo utilizador
model TicketResale {
  env                     String                         @default("prod")
  id           String       @id @default(cuid())
  ticketId     String       @map("ticket_id")
  price        Int
  currency     String       @default("EUR")
  status       ResaleStatus @default(LISTED)
  createdAt    DateTime     @default(now()) @map("created_at")
  completedAt  DateTime?    @map("completed_at")
  sellerUserId String       @map("seller_user_id") @db.Uuid
  ticket       Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([sellerUserId])
  @@map("ticket_resales")
  @@schema("app_v3")
}

/// SSOT financeiro (Payment) conforme blueprint v7
model Payment {
  env                     String                         @default("prod")
  id                   String              @id
  organizationId       Int                 @map("organization_id")
  sourceType           SourceType          @map("source_type")
  sourceId             String              @map("source_id") @db.Text
  customerIdentityId   String?             @map("customer_identity_id") @db.Uuid
  status               PaymentStatus       @default(CREATED)
  feePolicyVersion     String              @map("fee_policy_version")
  pricingSnapshotJson  Json                @map("pricing_snapshot_json")
  pricingSnapshotHash  String?             @map("pricing_snapshot_hash")
  processorFeesStatus  ProcessorFeesStatus @default(PENDING) @map("processor_fees_status")
  processorFeesActual  Int?                @map("processor_fees_actual")
  idempotencyKey       String              @map("idempotency_key")
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization         Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ledgerEntries        LedgerEntry[]

  @@unique([idempotencyKey], map: "payments_idempotency_key_unique")
  @@index([organizationId], map: "payments_org_idx")
  @@index([sourceType, sourceId], map: "payments_source_idx")
  @@index([organizationId, sourceType, sourceId], map: "payments_org_source_idx")
  @@map("payments")
  @@schema("app_v3")
}

/// Ledger append-only conforme blueprint v7
model LedgerEntry {
  env                     String                         @default("prod")
  id            Int             @id @default(autoincrement())
  paymentId     String          @map("payment_id")
  entryType     LedgerEntryType @map("entry_type")
  amount        Int             @map("amount")
  currency      String          @map("currency")
  sourceType    SourceType      @map("source_type")
  sourceId      String          @map("source_id") @db.Text
  causationId   String          @map("causation_id")
  correlationId String          @map("correlation_id")
  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  payment       Payment         @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId], map: "ledger_entries_payment_idx")
  @@index([sourceType, sourceId], map: "ledger_entries_source_idx")
  @@index([causationId], map: "ledger_entries_causation_idx")
  @@unique([paymentId, causationId], map: "ledger_entries_payment_causation_unique")
  @@map("ledger_entries")
  @@schema("app_v3")
}

/// Read-model financeiro (snapshot derivado) — gerado via consumer
model PaymentSnapshot {
  env                     String                         @default("prod")
  paymentId          String        @id @map("payment_id")
  organizationId     Int           @map("organization_id")
  sourceType         SourceType    @map("source_type")
  sourceId           String        @map("source_id") @db.Text
  status             PaymentStatus @map("status")
  currency           String        @map("currency")
  grossCents         Int?          @map("gross_cents")
  platformFeeCents   Int?          @map("platform_fee_cents")
  processorFeesCents Int?          @map("processor_fees_cents")
  netToOrgCents      Int?          @map("net_to_org_cents")
  lastEventId        String?       @map("last_event_id")
  createdAt          DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([organizationId], map: "payment_snapshots_org_idx")
  @@index([sourceType, sourceId], map: "payment_snapshots_source_idx")
  @@index([organizationId, sourceType, sourceId], map: "payment_snapshots_org_source_idx")
  @@map("payment_snapshots")
  @@schema("app_v3")
}

/// Registo de eventos de pagamento (auditoria webhooks/intent)
model PaymentEvent {
  env                     String                         @default("prod")
  id                    Int                @id @default(autoincrement())
  status                String             @default("PROCESSING")
  stripePaymentIntentId String?            @unique @map("stripe_payment_intent_id") @db.Text
  stripeEventId         String?            @unique @map("stripe_event_id")
  purchaseId            String?            @unique @map("purchase_id") @db.Text
  source                PaymentEventSource @default(WEBHOOK)
  dedupeKey             String?            @map("dedupe_key")
  attempt               Int                @default(1)
  eventId               Int?               @map("event_id")
  userId                String?            @map("user_id") @db.Uuid
  amountCents           Int?               @map("amount_cents")
  platformFeeCents      Int?               @map("platform_fee_cents")
  stripeFeeCents        Int?               @map("stripe_fee_cents")
  errorMessage          String?            @map("error_message")
  createdAt             DateTime?          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime?          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  mode                  PaymentMode        @default(LIVE)
  isTest                Boolean            @default(false) @map("is_test")

  @@index([stripeEventId])
  @@index([stripePaymentIntentId])
  @@index([purchaseId])
  @@index([purchaseId, stripePaymentIntentId], map: "payment_events_purchase_intent_idx")
  @@index([eventId])
  @@map("payment_events")
  @@schema("app_v3")
}

/// Read-model financeiro (derivado) — resumo por compra
model SaleSummary {
  env                     String                         @default("prod")
  id                    Int               @id @default(autoincrement())
  eventId               Int               @map("event_id")
  userId                String?           @map("user_id") @db.Uuid
  ownerUserId           String?           @map("owner_user_id") @db.Uuid
  ownerIdentityId       String?           @map("owner_identity_id") @db.Uuid
  purchaseId            String?           @unique @map("purchase_id") @db.Text
  paymentIntentId       String?           @unique @map("payment_intent_id")
  promoCodeId           Int?              @map("promo_code_id")
  promoCodeSnapshot     String?           @map("promo_code_snapshot")
  promoLabelSnapshot    String?           @map("promo_label_snapshot")
  promoTypeSnapshot     PromoType?        @map("promo_type_snapshot")
  promoValueSnapshot    Int?              @map("promo_value_snapshot")
  subtotalCents         Int?              @map("subtotal_cents")
  discountCents         Int?              @map("discount_cents")
  platformFeeCents      Int?              @map("platform_fee_cents")
  cardPlatformFeeCents  Int?              @map("card_platform_fee_cents")
  stripeFeeCents        Int?              @map("stripe_fee_cents")
  totalCents            Int?              @map("total_cents")
  netCents              Int?              @map("net_cents")
  feeMode               FeeMode?          @map("fee_mode")
  paymentMethod         String?           @map("payment_method")
  currency              String            @default("EUR")
  status                SaleSummaryStatus @default(PAID)
  createdAt             DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event                 Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  promoCode             PromoCode?        @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  lines                 SaleLine[]
  tickets               Ticket[]

  @@index([eventId], map: "sale_summaries_event_idx")
  @@index([status], map: "sale_summaries_status_idx")
  @@index([promoCodeId], map: "sale_summaries_promo_idx")
  @@map("sale_summaries")
  @@schema("app_v3")
}

/// Linhas por venda (read-model financeiro)
model SaleLine {
  env                     String                         @default("prod")
  id                   Int        @id @default(autoincrement())
  saleSummaryId        Int        @map("sale_summary_id")
  eventId              Int        @map("event_id")
  ticketTypeId         Int?       @map("ticket_type_id")
  padelRegistrationLineId Int?    @map("padel_registration_line_id")
  promoCodeId          Int?       @map("promo_code_id")
  promoCodeSnapshot    String?    @map("promo_code_snapshot")
  promoLabelSnapshot   String?    @map("promo_label_snapshot")
  promoTypeSnapshot    PromoType? @map("promo_type_snapshot")
  promoValueSnapshot   Int?       @map("promo_value_snapshot")
  quantity             Int        @default(1)
  unitPriceCents       Int?       @map("unit_price_cents")
  discountPerUnitCents Int?       @map("discount_per_unit_cents")
  grossCents           Int?       @map("gross_cents")
  netCents             Int?       @map("net_cents")
  platformFeeCents     Int?       @map("platform_fee_cents")
  createdAt            DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  saleSummary          SaleSummary @relation(fields: [saleSummaryId], references: [id], onDelete: Cascade)
  event                Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType           TicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: SetNull)
  padelRegistrationLine PadelRegistrationLine? @relation(fields: [padelRegistrationLineId], references: [id], onDelete: SetNull)
  promoCode            PromoCode?  @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)
  entitlements         Entitlement[]

  @@index([saleSummaryId], map: "sale_lines_summary_idx")
  @@index([eventId], map: "sale_lines_event_idx")
  @@index([ticketTypeId], map: "sale_lines_ticket_type_idx")
  @@index([padelRegistrationLineId], map: "sale_lines_padel_reg_line_idx")
  @@index([promoCodeId], map: "sale_lines_promo_idx")
  @@map("sale_lines")
  @@schema("app_v3")
}

model Operation {
  env                     String                         @default("prod")
  id              Int             @id @default(autoincrement())
  operationType   String          @map("operation_type")
  dedupeKey       String          @unique(map: "operations_dedupe_key_unique") @map("dedupe_key")
  status          OperationStatus @default(PENDING)
  attempts        Int             @default(0)
  lastError       String?         @map("last_error")
  reasonCode      String?         @map("reason_code")
  errorClass      String?         @map("error_class")
  errorStack      String?         @map("error_stack")
  firstSeenAt     DateTime?       @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt      DateTime?       @map("last_seen_at") @db.Timestamptz(6)
  lockedAt        DateTime?       @map("locked_at") @db.Timestamptz(6)
  nextRetryAt     DateTime?       @map("next_retry_at") @db.Timestamptz(6)
  payload         Json?           @default("{}")
  purchaseId      String?         @map("purchase_id") @db.Text
  paymentIntentId String?         @map("payment_intent_id")
  stripeEventId   String?         @map("stripe_event_id")
  eventId         Int?            @map("event_id")
  organizationId     Int?            @map("organization_id")
  pairingId       Int?            @map("pairing_id")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status], map: "operations_status_idx")
  @@index([purchaseId], map: "operations_purchase_idx")
  @@index([paymentIntentId], map: "operations_payment_intent_idx")
  @@index([stripeEventId], map: "operations_stripe_event_idx")
  @@map("operations")
  @@schema("app_v3")
}

model OutboxEvent {
  env                     String                         @default("prod")
  eventId        String   @id @db.Uuid @map("event_id")
  eventType      String   @map("event_type")
  dedupeKey      String   @unique(map: "outbox_events_dedupe_key_unique") @map("dedupe_key") @db.Text
  payload        Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  publishedAt    DateTime? @map("published_at") @db.Timestamptz(6)
  claimedAt      DateTime? @map("claimed_at") @db.Timestamptz(6)
  processingToken String?  @map("processing_token") @db.Uuid
  attempts       Int      @default(0)
  nextAttemptAt  DateTime? @map("next_attempt_at") @db.Timestamptz(6)
  reasonCode     String?  @map("reason_code")
  errorClass     String?  @map("error_class")
  errorStack     String?  @map("error_stack")
  firstSeenAt    DateTime? @map("first_seen_at") @db.Timestamptz(6)
  lastSeenAt     DateTime? @map("last_seen_at") @db.Timestamptz(6)
  causationId    String?  @map("causation_id")
  correlationId  String?  @map("correlation_id")
  deadLetteredAt DateTime? @map("dead_lettered_at") @db.Timestamptz(6)

  @@index([publishedAt, nextAttemptAt], map: "outbox_events_publish_idx")
  @@index([deadLetteredAt], map: "outbox_events_dead_letter_idx")
  @@index([claimedAt], map: "outbox_events_claimed_idx")
  @@index([createdAt, eventId], map: "outbox_events_created_at_event_idx")
  @@map("outbox_events")
  @@schema("app_v3")
}

model CronHeartbeat {
  jobKey        String   @id @map("job_key") @db.Text
  env           String   @default("prod")
  lastRunAt     DateTime @map("last_run_at") @db.Timestamptz(6)
  lastSuccessAt DateTime? @map("last_success_at") @db.Timestamptz(6)
  lastErrorAt   DateTime? @map("last_error_at") @db.Timestamptz(6)
  lastError     String?  @map("last_error") @db.Text
  runCount      Int      @default(0) @map("run_count")
  successCount  Int      @default(0) @map("success_count")
  errorCount    Int      @default(0) @map("error_count")
  lastDurationMs Int?     @map("last_duration_ms")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([lastRunAt], map: "cron_heartbeats_last_run_idx")
  @@map("cron_heartbeats")
  @@schema("app_v3")
}

model EventLog {
  env                     String                         @default("prod")
  id             String      @id @db.Uuid
  organizationId Int         @map("organization_id")
  eventType      String      @map("event_type")
  eventVersion   String      @map("event_version")
  idempotencyKey String      @map("idempotency_key")
  payload        Json        @default("{}")
  actorUserId    String?     @map("actor_user_id") @db.Uuid
  sourceType     SourceType? @map("source_type")
  sourceId       String?     @map("source_id") @db.Text
  subjectType    String      @map("subject_type") @db.Text
  subjectId      String      @map("subject_id") @db.Text
  correlationId  String?     @map("correlation_id")
  causationId    String      @map("causation_id") @db.Text
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  activityItem ActivityFeedItem?

  @@unique([organizationId, eventType, idempotencyKey], map: "event_logs_org_event_idempotency_unique")
  @@index([organizationId, createdAt], map: "event_logs_org_time_idx")
  @@index([eventType, createdAt], map: "event_logs_event_time_idx")
  @@map("event_logs")
  @@schema("app_v3")
}

model ActivityFeedItem {
  env                     String                         @default("prod")
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int         @map("organization_id")
  eventId        String      @unique @map("event_id") @db.Uuid
  eventType      String      @map("event_type")
  actorUserId    String?     @map("actor_user_id") @db.Uuid
  sourceType     SourceType? @map("source_type")
  sourceId       String?     @map("source_id") @db.Text
  correlationId  String?     @map("correlation_id")
  createdAt      DateTime    @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  eventLog      EventLog     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt], map: "activity_feed_org_time_idx")
  @@index([organizationId, eventType], map: "activity_feed_org_type_idx")
  @@map("activity_feed_items")
  @@schema("app_v3")
}

model MediaAsset {
  env               String         @default("prod")
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    Int?           @map("organization_id")
  ownerType         MediaOwnerType @map("owner_type")
  ownerId           String         @map("owner_id") @db.Text
  uploadedByUserId  String?        @map("uploaded_by_user_id") @db.Uuid
  scope             String         @map("scope") @db.Text
  bucket            String         @map("bucket") @db.Text
  objectPath        String         @map("object_path") @db.Text
  mimeType          String         @map("mime_type")
  sizeBytes         Int            @map("size_bytes")
  checksumSha256    String         @map("checksum_sha256") @db.Text
  originalFilename  String?        @map("original_filename") @db.Text
  isPublic          Boolean        @default(false) @map("is_public")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt         DateTime?      @map("deleted_at") @db.Timestamptz(6)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt], map: "media_assets_org_time_idx")
  @@index([ownerType, ownerId], map: "media_assets_owner_idx")
  @@unique([bucket, objectPath], map: "media_assets_bucket_path_unique")
  @@map("media_assets")
  @@schema("app_v3")
}

model SoftBlock {
  env                     String                         @default("prod")
  id             Int             @id @default(autoincrement())
  organizationId Int             @map("organization_id")
  scopeType      SoftBlockScope  @default(ORGANIZATION) @map("scope_type")
  scopeId        Int             @default(0) @map("scope_id")
  startsAt       DateTime        @map("starts_at") @db.Timestamptz(6)
  endsAt         DateTime        @map("ends_at") @db.Timestamptz(6)
  reason         String?         @map("reason")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "soft_blocks_org_idx")
  @@index([organizationId, scopeType, scopeId], map: "soft_blocks_scope_idx")
  @@index([organizationId, startsAt], map: "soft_blocks_org_start_idx")
  @@map("soft_blocks")
  @@schema("app_v3")
}

model AgendaItem {
  env                     String                         @default("prod")
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int              @map("organization_id")
  sourceType     SourceType       @map("source_type")
  sourceId       String           @map("source_id") @db.Text
  padelClubId    Int?             @map("padel_club_id")
  courtId        Int?             @map("court_id")
  resourceId     Int?             @map("resource_id")
  professionalId Int?             @map("professional_id")
  title          String
  startsAt       DateTime         @map("starts_at") @db.Timestamptz(6)
  endsAt         DateTime         @map("ends_at") @db.Timestamptz(6)
  status         String           @db.Text
  lastEventId    String           @map("last_event_id") @db.Uuid
  updatedAt      DateTime         @map("updated_at") @db.Timestamptz(6)

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  padelClub    PadelClub?     @relation(fields: [padelClubId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  court        PadelClubCourt? @relation(fields: [courtId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([organizationId, sourceType, sourceId], map: "agenda_items_unique")
  @@index([organizationId, startsAt], map: "agenda_items_org_start_idx")
  @@index([organizationId, padelClubId, startsAt], map: "agenda_items_org_club_start_idx")
  @@index([organizationId, courtId, startsAt], map: "agenda_items_org_court_start_idx")
  @@index([organizationId, resourceId, startsAt], map: "agenda_items_org_resource_start_idx")
  @@index([organizationId, professionalId, startsAt], map: "agenda_items_org_professional_start_idx")
  @@map("agenda_items")
  @@schema("app_v3")
}

model SearchIndexItem {
  env                     String                         @default("prod")
  id                       String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId           Int                   @map("organization_id")
  sourceType               SourceType            @map("source_type")
  sourceId                 String                @map("source_id") @db.Text
  slug                     String
  title                    String
  description              String?
  startsAt                 DateTime              @map("starts_at") @db.Timestamptz(6)
  endsAt                   DateTime              @map("ends_at") @db.Timestamptz(6)
  templateType             EventTemplateType?    @map("template_type")
  interestTags             String[]               @default([]) @map("interest_tags")
  pricingMode              EventPricingMode?     @map("pricing_mode")
  isGratis                 Boolean               @default(false) @map("is_gratis")
  priceFromCents           Int?                  @map("price_from_cents")
  coverImageUrl            String?               @map("cover_image_url")
  hostName                 String?               @map("host_name")
  hostUsername             String?               @map("host_username")
  addressId                String?               @map("address_id") @db.Uuid
  status                   EventStatus           @map("status")
  visibility               SearchIndexVisibility @map("visibility")
  lastEventId              String                @map("last_event_id") @db.Uuid
  updatedAt                DateTime              @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  addressRef   Address?     @relation(fields: [addressId], references: [id], onDelete: SetNull)

  @@unique([organizationId, sourceType, sourceId], map: "search_index_items_unique")
  @@index([visibility, startsAt, id], map: "search_index_items_visibility_start_idx")
  @@index([addressId], map: "search_index_items_address_idx")
  @@index([organizationId, startsAt, id], map: "search_index_items_org_start_idx")
  @@map("search_index_items")
  @@schema("app_v3")
}

/// Configurações simples chave-valor (taxas, etc.)
model PlatformSetting {
  id        Int       @id @default(autoincrement())
  env       String    @default("prod")
  key       String    @unique(map: "platform_settings_key_idx")
  value     String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("platform_settings")
  @@schema("app_v3")
}

/// Códigos promocionais simples
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model PromoCode {
  env                     String                         @default("prod")
  id            Int               @id @default(autoincrement())
  code          String
  type          PromoType
  value         Int
  organizationId   Int?              @map("organization_id")
  promoterUserId   String?           @map("promoter_user_id") @db.Uuid
  maxUses       Int?              @map("max_uses")
  perUserLimit  Int?              @map("per_user_limit")
  validFrom     DateTime?         @map("valid_from") @db.Timestamptz(6)
  validUntil    DateTime?         @map("valid_until") @db.Timestamptz(6)
  active        Boolean           @default(true)
  eventId       Int?              @map("event_id")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  autoApply     Boolean?          @default(false) @map("auto_apply")
  minQuantity   Int?              @map("min_quantity")
  minTotalCents Int?              @map("min_total_cents")
  event         Event?            @relation(fields: [eventId], references: [id], onUpdate: NoAction, map: "promo_codes_event_fk")
  organization     Organization?        @relation(fields: [organizationId], references: [id], onUpdate: NoAction)
  promoter      Profile?          @relation("PromoCodePromoter", fields: [promoterUserId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  redemptions   PromoRedemption[]
  saleSummaries SaleSummary[]
  saleLines     SaleLine[]

  @@index([eventId])
  @@index([organizationId])
  @@index([promoterUserId], map: "promo_codes_promoter_idx")
  @@index([eventId, active], map: "promo_codes_event_active_idx")
  @@index([validFrom, validUntil], map: "promo_codes_valid_idx")
  @@map("promo_codes")
  @@schema("app_v3")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model PromoRedemption {
  env                     String                         @default("prod")
  id          Int       @id @default(autoincrement())
  promoCodeId Int       @map("promo_code_id")
  userId      String?   @map("user_id") @db.Uuid
  guestEmail  String?   @map("guest_email")
  usedAt      DateTime  @default(now()) @map("used_at") @db.Timestamptz(6)
  purchaseId  String?   @map("purchase_id") @db.Text
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([purchaseId, promoCodeId], map: "promo_redemptions_purchase_code_unique")
  @@index([promoCodeId], map: "promo_redemptions_code_idx")
  @@index([promoCodeId], map: "promo_redemptions_promo_idx")
  @@index([userId], map: "promo_redemptions_user_idx")
  @@index([purchaseId], map: "promo_redemptions_purchase_idx")
  @@map("promo_redemptions")
  @@schema("app_v3")
}

model Refund {
  env                     String                         @default("prod")
  id                Int          @id @default(autoincrement())
  dedupeKey         String       @unique(map: "refunds_dedupe_key_unique") @map("dedupe_key")
  purchaseId        String?      @map("purchase_id") @db.Text
  paymentIntentId   String?      @map("payment_intent_id")
  eventId           Int          @map("event_id")
  baseAmountCents   Int          @map("base_amount_cents")
  feesExcludedCents Int          @map("fees_excluded_cents")
  reason            RefundReason
  refundedBy        String?      @map("refunded_by")
  refundedAt        DateTime?    @default(now()) @map("refunded_at") @db.Timestamptz(6)
  stripeRefundId    String?      @map("stripe_refund_id")
  auditPayload      Json?        @map("audit_payload")
  createdAt         DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([eventId], map: "refunds_event_idx")
  @@index([purchaseId], map: "refunds_purchase_idx")
  @@index([paymentIntentId], map: "refunds_payment_intent_idx")
  @@map("refunds")
  @@schema("app_v3")
}

/// Endereço normalizado (SSOT) — usado por todos os módulos via Address Service
model Address {
  env                     String                         @default("prod")
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  formattedAddress       String                   @map("formatted_address")
  canonical              Json                     @map("canonical")
  latitude               Float                    @map("lat")
  longitude              Float                    @map("lng")
  sourceProvider         AddressSourceProvider    @map("source_provider")
  sourceProviderPlaceId  String?                  @map("source_provider_place_id")
  confidenceScore        Int                      @default(0) @map("confidence_score")
  validationStatus       AddressValidationStatus  @default(NORMALIZED) @map("validation_status")
  addressHash            String                   @unique @map("address_hash")
  createdAt              DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime                 @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  lookups                AddressLookup[]
  padelClubs             PadelClub[]
  events                 Event[]
  organizations          Organization[]
  storeOrderAddresses    StoreOrderAddress[]
  searchIndexItems       SearchIndexItem[]
  services               Service[]
  bookings               Booking[]

  @@index([sourceProvider], map: "addresses_provider_idx")
  @@map("addresses")
  @@schema("app_v3")
}

/// Cache persistente para providerId -> addressId
model AddressLookup {
  env                     String                         @default("prod")
  id                     Int                    @id @default(autoincrement())
  addressId              String                 @map("address_id") @db.Uuid
  sourceProvider         AddressSourceProvider  @map("source_provider")
  sourceProviderPlaceId  String                 @map("source_provider_place_id")
  resolvedAt             DateTime               @default(now()) @map("resolved_at") @db.Timestamptz(6)
  address                Address                @relation(fields: [addressId], references: [id], onDelete: Cascade)

  @@unique([sourceProvider, sourceProviderPlaceId], map: "address_lookups_provider_place_uq")
  @@index([addressId], map: "address_lookups_address_idx")
  @@map("address_lookups")
  @@schema("app_v3")
}

/// Política de reembolso versionada (auditável)
model RefundPolicyVersion {
  env                     String                         @default("prod")
  id             Int           @id @default(autoincrement())
  organizationId Int           @map("organization_id")
  eventId        Int?          @map("event_id")
  policyVersion  String        @map("policy_version")
  feeBps         Int           @default(0) @map("fee_bps")
  feeFixedCents  Int           @default(0) @map("fee_fixed_cents")
  feePayer       RefundFeePayer @default(CUSTOMER) @map("fee_payer")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  createdByUserId String?      @map("created_by_user_id") @db.Uuid
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  event          Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([organizationId, eventId, policyVersion], map: "refund_policy_versions_org_event_version_uq")
  @@index([organizationId, eventId], map: "refund_policy_versions_org_event_idx")
  @@map("refund_policy_versions")
  @@schema("app_v3")
}

/// Venda agregada por PaymentIntent (fonte de verdade de valores)
/// Padel MVP: perfis de jogadores do clube
model PadelPlayerProfile {
  env                     String                         @default("prod")
  id            Int                 @id @default(autoincrement())
  organizationId   Int                 @map("organization_id")
  userId        String?             @map("user_id") @db.Uuid
  crmContactId  String?             @map("crm_contact_id") @db.Uuid
  fullName      String              @map("full_name")
  email         String?             @db.Citext
  phone         String?
  gender        String?
  level         String?
  isActive      Boolean             @default(true) @map("is_active")
  notes         String?
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  displayName   String?             @map("display_name")
  preferredSide PadelPreferredSide? @map("preferred_side")
  clubName      String?             @map("club_name")
  birthDate     DateTime?           @map("birth_date") @db.Timestamp(6)
  pairingSlots  PadelPairingSlot[]
  organization     Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  crmContact       CrmContact?            @relation(fields: [crmContactId], references: [id], onDelete: SetNull)
  users         users?              @relation(fields: [userId], references: [id], onUpdate: NoAction)
  rankings      PadelRankingEntry[]
  availabilities CalendarAvailability[]
  crmContactPadelLinks CrmContactPadel[]

  @@index([organizationId, crmContactId], map: "padel_player_profiles_org_crm_contact_idx")
  @@map("padel_player_profiles")
  @@schema("app_v3")
}

/// Clubes de Padel por organização
model PadelClub {
  env                     String                         @default("prod")
  id                  Int                     @id @default(autoincrement())
  organizationId         Int                     @map("organization_id")
  name                String
  shortName           String?                 @map("short_name")
  addressId           String                 @map("address_id") @db.Uuid
  kind                PadelClubKind           @default(OWN) @map("kind")
  sourceClubId        Int?                    @map("source_club_id")
  courtsCount         Int                     @default(1) @map("courts_count")
  hours               String?
  favoriteCategoryIds Int[]                   @default([]) @map("favorite_category_ids")
  slug                String?                 @unique
  isActive            Boolean                 @default(true) @map("is_active")
  createdAt           DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDefault           Boolean                 @default(false) @map("is_default")
  deletedAt           DateTime?               @map("deleted_at") @db.Timestamptz(6)
  courts              PadelClubCourt[]
  staff               PadelClubStaff[]
  calendarBlocks      CalendarBlock[]
  agendaItems         AgendaItem[]
  organization           Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tournaments         PadelTournamentConfig[]
  teams               PadelTeam[]
  communityPosts      PadelCommunityPost[]
  addressRef          Address            @relation(fields: [addressId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId], map: "padel_clubs_organization_idx")
  @@index([addressId], map: "padel_clubs_address_idx")
  @@map("padel_clubs")
  @@schema("app_v3")
}

model PadelClubCourt {
  env                     String                         @default("prod")
  id           Int       @id @default(autoincrement())
  padelClubId  Int       @map("padel_club_id")
  name         String
  description  String?
  surface      String?
  indoor       Boolean   @default(false)
  isActive     Boolean   @default(true) @map("is_active")
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)
  displayOrder Int       @default(0) @map("display_order")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  club         PadelClub @relation(fields: [padelClubId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  calendarBlocks CalendarBlock[]
  eventMatchSlots EventMatchSlot[]     @relation("EventMatchSlotCourt")
  availabilities Availability[]
  bookings       Booking[]
  bookingChangeRequestsProposed BookingChangeRequest[]
  classSeries   ClassSeries[]
  classSessions ClassSession[]
  agendaItems    AgendaItem[]

  @@index([padelClubId], map: "padel_club_courts_club_idx")
  @@map("padel_club_courts")
  @@schema("app_v3")
}

model PadelClubStaff {
  env                     String                         @default("prod")
  id              Int       @id @default(autoincrement())
  padelClubId     Int       @map("padel_club_id")
  userId          String?   @map("user_id") @db.Uuid
  email           String?   @db.Citext
  role            String
  inheritToEvents Boolean   @default(true) @map("inherit_to_events")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive        Boolean   @default(true) @map("is_active")
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)
  club            PadelClub @relation(fields: [padelClubId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([padelClubId], map: "padel_club_staff_club_idx")
  @@map("padel_club_staff")
  @@schema("app_v3")
}

/// Categorias / níveis de Padel
model PadelCategory {
  env                     String                         @default("prod")
  id                Int                     @id @default(autoincrement())
  organizationId       Int                     @map("organization_id")
  label             String
  genderRestriction String?                 @map("gender_restriction")
  minLevel          String?                 @map("min_level")
  maxLevel          String?                 @map("max_level")
  isDefault         Boolean                 @default(false) @map("is_default")
  isActive          Boolean                 @default(true) @map("is_active")
  season            String?
  year              Int?
  createdAt         DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization         Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  matchSlots        EventMatchSlot[]
  pairings          PadelPairing[]
  tournamentConfigs PadelTournamentConfig[]
  tournamentEntries TournamentEntry[]
  eventLinks        PadelEventCategoryLink[]
  waitlistEntries   PadelWaitlistEntry[]
  padelTeams        PadelTeam[]
  padelTeamEntries  PadelTeamEntry[]

  @@map("padel_categories")
  @@schema("app_v3")
}

/// Categorias de Padel por evento (multi-categoria)
model PadelEventCategoryLink {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  eventId         Int           @map("event_id")
  padelCategoryId Int           @map("padel_category_id")
  format          padel_format?
  capacityTeams   Int?          @map("capacity_teams")
  capacityPlayers Int?          @map("capacity_players")
  pricePerPlayerCents Int        @default(0) @map("price_per_player_cents")
  currency         String        @default("EUR")
  liveStreamUrl   String?       @map("live_stream_url")
  isEnabled       Boolean       @default(true) @map("is_enabled")
  isHidden        Boolean       @default(false) @map("is_hidden")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  category        PadelCategory @relation(fields: [padelCategoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ticketTypes     TicketType[]

  @@unique([eventId, padelCategoryId], map: "padel_event_category_links_unique")
  @@index([eventId], map: "padel_event_category_links_event_idx")
  @@index([padelCategoryId], map: "padel_event_category_links_category_idx")
  @@map("padel_event_category_links")
  @@schema("app_v3")
}

/// Regras base + tabela de pontos por clube
model PadelRuleSet {
  env                     String                         @default("prod")
  id                   Int                     @id @default(autoincrement())
  organizationId          Int                     @map("organization_id")
  name                 String
  tieBreakRules        Json                    @default("{}") @map("tie_break_rules")
  pointsTable          Json                    @default("{}") @map("points_table")
  enabledFormats       String[]                @default(["TODOS_CONTRA_TODOS", "QUADRO_ELIMINATORIO"]) @map("enabled_formats")
  season               String?
  year                 Int?
  createdAt            DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  defaultForOrganizations Organization[]             @relation("OrganizationPadelDefaultRuleSet")
  organization            Organization               @relation("OrganizationPadelRuleSets", fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tournaments          PadelTournamentConfig[]
  versions             PadelRuleSetVersion[]

  @@map("padel_rule_sets")
  @@schema("app_v3")
}

/// Snapshot/versionamento de regras por torneio (congela regras no evento)
model PadelRuleSetVersion {
  env                     String                         @default("prod")
  id                 Int          @id @default(autoincrement())
  tournamentConfigId Int          @map("tournament_config_id")
  version            Int          @default(1)
  sourceRuleSetId    Int?         @map("source_rule_set_id")
  name               String
  tieBreakRules      Json         @default("{}") @map("tie_break_rules")
  pointsTable        Json         @default("{}") @map("points_table")
  enabledFormats     String[]     @default(["TODOS_CONTRA_TODOS", "QUADRO_ELIMINATORIO"]) @map("enabled_formats")
  season             String?
  year               Int?
  createdAt          DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  createdByUserId    String?      @map("created_by_user_id") @db.Uuid
  tournamentConfig   PadelTournamentConfig @relation("PadelTournamentRuleSetVersions", fields: [tournamentConfigId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sourceRuleSet      PadelRuleSet? @relation(fields: [sourceRuleSetId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  currentForTournaments PadelTournamentConfig[] @relation("PadelTournamentRuleSetVersionCurrent")

  @@unique([tournamentConfigId, version], map: "padel_rule_set_versions_config_version_uq")
  @@index([tournamentConfigId], map: "padel_rule_set_versions_config_idx")
  @@index([sourceRuleSetId], map: "padel_rule_set_versions_source_idx")
  @@map("padel_rule_set_versions")
  @@schema("app_v3")
}

/// Configuração específica do torneio Padel (por evento)
model PadelTournamentConfig {
  env                     String                         @default("prod")
  id                 Int                  @id @default(autoincrement())
  eventId            Int                  @unique(map: "padel_tournament_configs_event_unique") @map("event_id")
  organizationId        Int                  @map("organization_id")
  format             padel_format
  numberOfCourts     Int                  @default(1) @map("number_of_courts")
  ruleSetId          Int?                 @map("rule_set_id")
  ruleSetVersionId   Int?                 @map("rule_set_version_id")
  defaultCategoryId  Int?                 @map("default_category_id")
  enabledFormats     String[]             @default([]) @map("enabled_formats")
  isInterclub        Boolean              @default(false) @map("is_interclub")
  teamSize           Int?                 @map("team_size")
  createdAt          DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  padelV2Enabled     Boolean              @default(false) @map("padel_v2_enabled")
  splitDeadlineHours Int?                 @map("split_deadline_hours")
  padelClubId        Int?                 @map("padel_club_id")
  partnerClubIds     Int[]                @default([]) @map("partner_club_ids")
  advancedSettings   Json?                @map("advanced_settings")
  lifecycleStatus    PadelTournamentLifecycleStatus @default(DRAFT) @map("lifecycle_status")
  publishedAt        DateTime?            @map("published_at") @db.Timestamptz(6)
  lockedAt           DateTime?            @map("locked_at") @db.Timestamptz(6)
  liveAt             DateTime?            @map("live_at") @db.Timestamptz(6)
  completedAt        DateTime?            @map("completed_at") @db.Timestamptz(6)
  cancelledAt        DateTime?            @map("cancelled_at") @db.Timestamptz(6)
  lifecycleUpdatedAt DateTime?            @map("lifecycle_updated_at") @db.Timestamptz(6)
  eligibilityType    PadelEligibilityType @default(OPEN) @map("eligibility_type")
  category           PadelCategory?       @relation(fields: [defaultCategoryId], references: [id], onUpdate: NoAction)
  event              Event                @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  club               PadelClub?           @relation(fields: [padelClubId], references: [id], onUpdate: NoAction)
  ruleSet            PadelRuleSet?        @relation(fields: [ruleSetId], references: [id], onUpdate: NoAction)
  ruleSetVersion     PadelRuleSetVersion? @relation("PadelTournamentRuleSetVersionCurrent", fields: [ruleSetVersionId], references: [id], onUpdate: NoAction)
  ruleSetVersions    PadelRuleSetVersion[] @relation("PadelTournamentRuleSetVersions")

  @@index([padelClubId], map: "padel_tournament_configs_padel_club_idx")
  @@index([ruleSetVersionId], map: "padel_tournament_configs_rule_set_version_idx")
  @@index([lifecycleStatus], map: "padel_tournament_configs_lifecycle_idx")
  @@map("padel_tournament_configs")
  @@schema("app_v3")
}

/// Atribuições de roles específicas por torneio (árbitro, diretor, etc.)
model PadelTournamentRoleAssignment {
  env                     String                         @default("prod")
  id             Int                  @id @default(autoincrement())
  eventId        Int                  @map("event_id")
  organizationId Int                  @map("organization_id")
  userId         String               @map("user_id") @db.Uuid
  role           PadelTournamentRole  @map("role")
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event          Event                @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           Profile              @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eventId, role, userId], map: "padel_tournament_roles_event_role_user_uq")
  @@index([eventId], map: "padel_tournament_roles_event_idx")
  @@index([organizationId], map: "padel_tournament_roles_org_idx")
  @@index([userId], map: "padel_tournament_roles_user_idx")
  @@map("padel_tournament_roles")
  @@schema("app_v3")
}

/// Equipas/Interclubes
model PadelTeam {
  env                     String                         @default("prod")
  id              Int       @id @default(autoincrement())
  organizationId  Int       @map("organization_id")
  padelClubId     Int?      @map("padel_club_id")
  categoryId      Int?      @map("category_id")
  name            String
  level           String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  club            PadelClub?    @relation(fields: [padelClubId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  category        PadelCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  members         PadelTeamMember[]
  entries         PadelTeamEntry[]

  @@index([organizationId], map: "padel_teams_org_idx")
  @@index([padelClubId], map: "padel_teams_club_idx")
  @@map("padel_teams")
  @@schema("app_v3")
}

model PadelTeamMember {
  env                     String                         @default("prod")
  id          Int               @id @default(autoincrement())
  teamId      Int               @map("team_id")
  userId      String            @map("user_id") @db.Uuid
  role        PadelTeamRole     @default(PLAYER)
  status      PadelTeamMemberStatus @default(ACTIVE)
  joinedAt    DateTime?         @map("joined_at") @db.Timestamptz(6)
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  team        PadelTeam         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId], map: "padel_team_members_team_user_uq")
  @@index([teamId], map: "padel_team_members_team_idx")
  @@index([userId], map: "padel_team_members_user_idx")
  @@map("padel_team_members")
  @@schema("app_v3")
}

model PadelTeamEntry {
  env                     String                         @default("prod")
  id          Int                 @id @default(autoincrement())
  eventId     Int                 @map("event_id")
  teamId      Int                 @map("team_id")
  categoryId  Int?                @map("category_id")
  status      PadelTeamEntryStatus @default(PENDING)
  createdAt   DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event       Event               @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  team        PadelTeam            @relation(fields: [teamId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  category    PadelCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([eventId, teamId, categoryId], map: "padel_team_entries_event_team_category_uq")
  @@index([eventId], map: "padel_team_entries_event_idx")
  @@index([teamId], map: "padel_team_entries_team_idx")
  @@map("padel_team_entries")
  @@schema("app_v3")
}

/// Comunidade do clube
model PadelCommunityPost {
  env                     String                         @default("prod")
  id            Int       @id @default(autoincrement())
  organizationId Int      @map("organization_id")
  padelClubId   Int?      @map("padel_club_id")
  authorUserId  String?   @map("author_user_id") @db.Uuid
  title         String?
  body          String
  kind          PadelCommunityPostKind @default(ANNOUNCEMENT)
  visibility    PadelCommunityVisibility @default(CLUB_MEMBERS)
  isPinned      Boolean   @default(false) @map("is_pinned")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  club          PadelClub?    @relation(fields: [padelClubId], references: [id], onDelete: SetNull)
  author        Profile?      @relation(fields: [authorUserId], references: [id], onDelete: SetNull)
  reactions     PadelCommunityReaction[]
  comments      PadelCommunityComment[]

  @@index([organizationId], map: "padel_community_posts_org_idx")
  @@index([padelClubId], map: "padel_community_posts_club_idx")
  @@map("padel_community_posts")
  @@schema("app_v3")
}

model PadelCommunityReaction {
  env                     String                         @default("prod")
  id          Int       @id @default(autoincrement())
  postId      Int       @map("post_id")
  userId      String    @map("user_id") @db.Uuid
  reaction    String    @map("reaction")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  post        PadelCommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user        Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, reaction], map: "padel_community_reactions_post_user_uq")
  @@index([postId], map: "padel_community_reactions_post_idx")
  @@index([userId, createdAt], map: "padel_community_reactions_user_time_idx")
  @@map("padel_community_reactions")
  @@schema("app_v3")
}

model PadelCommunityComment {
  env                     String                         @default("prod")
  id          Int       @id @default(autoincrement())
  postId      Int       @map("post_id")
  authorUserId String?  @map("author_user_id") @db.Uuid
  body        String
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  post        PadelCommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      Profile?  @relation(fields: [authorUserId], references: [id], onDelete: SetNull)

  @@index([postId], map: "padel_community_comments_post_idx")
  @@index([authorUserId, createdAt], map: "padel_community_comments_author_time_idx")
  @@map("padel_community_comments")
  @@schema("app_v3")
}

/// Bloqueios de court para calendário de padel (bloqueios administrativos)
model CalendarBlock {
  env                     String                         @default("prod")
  id           Int       @id @default(autoincrement())
  organizationId  Int       @map("organization_id")
  eventId      Int       @map("event_id")
  padelClubId  Int?      @map("padel_club_id")
  courtId      Int?      @map("court_id")
  startAt      DateTime  @map("start_at") @db.Timestamptz(6)
  endAt        DateTime  @map("end_at") @db.Timestamptz(6)
  label        String?
  kind         String    @default("BLOCK")
  note         String?
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  event        Event     @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  club         PadelClub? @relation(fields: [padelClubId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  court        PadelClubCourt? @relation(fields: [courtId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([organizationId], map: "padel_court_blocks_org_idx")
  @@index([eventId], map: "padel_court_blocks_event_idx")
  @@index([padelClubId], map: "padel_court_blocks_club_idx")
  @@index([courtId], map: "padel_court_blocks_court_idx")
  @@map("padel_court_blocks")
  @@schema("app_v3")
}

/// Indisponibilidade de jogadores/duplas para o calendário
model CalendarAvailability {
  env                     String                         @default("prod")
  id               Int                 @id @default(autoincrement())
  organizationId      Int                 @map("organization_id")
  eventId          Int                 @map("event_id")
  playerProfileId  Int?                @map("player_profile_id")
  playerName       String?             @map("player_name")
  playerEmail      String?             @map("player_email")
  startAt          DateTime            @map("start_at") @db.Timestamptz(6)
  endAt            DateTime            @map("end_at") @db.Timestamptz(6)
  note             String?
  createdAt        DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization        Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  event            Event               @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  playerProfile    PadelPlayerProfile? @relation(fields: [playerProfileId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([organizationId], map: "padel_availabilities_org_idx")
  @@index([eventId], map: "padel_availabilities_event_idx")
  @@index([playerProfileId], map: "padel_availabilities_profile_idx")
  @@map("padel_availabilities")
  @@schema("app_v3")
}

/// Pairings (duplas) para Padel v2
model PadelPairing {
  env                     String                         @default("prod")
  id                          Int                         @id @default(autoincrement())
  eventId                     Int                         @map("event_id")
  organizationId                 Int                         @map("organization_id")
  categoryId                  Int?                        @map("category_id")
  player1UserId               String?                     @map("player1_user_id") @db.Uuid
  player2UserId               String?                     @map("player2_user_id") @db.Uuid
  payment_mode                PadelPaymentMode
  pairingStatus               PadelPairingStatus          @default(INCOMPLETE) @map("pairing_status")
  pairingJoinMode             PadelPairingJoinMode        @default(INVITE_PARTNER) @map("pairing_join_mode")
  createdByUserId             String?                     @map("created_by_user_id") @db.Uuid
  partnerInviteToken          String?                     @unique @map("invite_token")
  partnerInviteUsedAt         DateTime?                   @map("partner_invite_used_at") @db.Timestamptz(6)
  partnerLinkToken            String?                     @map("partner_link_token")
  partnerLinkExpiresAt        DateTime?                   @map("invite_expires_at") @db.Timestamptz(6)
  lockedUntil                 DateTime?                   @map("locked_until") @db.Timestamptz(6)
  isPublicOpen                Boolean                     @default(false) @map("is_public_open")
  deadlineAt                  DateTime?                   @map("deadline_at") @db.Timestamptz(6)
  partnerSwapAllowedUntilAt   DateTime?                   @map("partner_swap_allowed_until_at") @db.Timestamptz(6)
  graceUntilAt                DateTime?                   @map("grace_until_at") @db.Timestamptz(6)
  partnerInvitedAt            DateTime?                   @map("partner_invited_at") @db.Timestamptz(6)
  partnerAcceptedAt           DateTime?                   @map("partner_accepted_at") @db.Timestamptz(6)
  partnerPaidAt               DateTime?                   @map("partner_paid_at") @db.Timestamptz(6)
  captainSecondChargedAt      DateTime?                   @map("captain_second_charged_at") @db.Timestamptz(6)
  guaranteeStatus             PadelPairingGuaranteeStatus @default(NONE) @map("guarantee_status")
  paymentMethodId             String?                     @map("payment_method_id")
  secondChargePaymentIntentId String?                     @map("second_charge_payment_intent_id")
  createdAt                   DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                   DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  matchSlotsA                 EventMatchSlot[]            @relation("MatchPairingA")
  matchSlotsB                 EventMatchSlot[]            @relation("MatchPairingB")
  matchSlotsWinner            EventMatchSlot[]            @relation("MatchWinnerPairing")
  slots                       PadelPairingSlot[]
  category                    PadelCategory?              @relation(fields: [categoryId], references: [id])
  event                       Event                       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organization                   Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  player1                     Profile?                    @relation("PadelPairingPlayer1", fields: [player1UserId], references: [id], onUpdate: NoAction)
  player2                     Profile?                    @relation("PadelPairingPlayer2", fields: [player2UserId], references: [id], onUpdate: NoAction)
  waitlistPromotions          PadelWaitlistEntry[]
  holds                       PadelPairingHold[]
  tournamentEntries           TournamentEntry[]
  registration                PadelRegistration?          @relation("PadelPairingRegistration")

  @@index([eventId])
  @@index([organizationId])
  @@index([categoryId])
  @@index([player1UserId])
  @@index([player2UserId])
  @@map("padel_pairings")
  @@schema("app_v3")
}

model PadelPairingHold {
  env                     String                         @default("prod")
  id        Int                    @id @default(autoincrement())
  pairingId Int                    @map("pairing_id")
  eventId   Int                    @map("event_id")
  holds     Int                    @default(2)
  status    PadelPairingHoldStatus @default(ACTIVE)
  expiresAt DateTime?              @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  pairing   PadelPairing           @relation(fields: [pairingId], references: [id], onDelete: Cascade)

  @@unique([pairingId, status], map: "padel_pairing_holds_active_unique")
  @@index([pairingId])
  @@index([eventId])
  @@map("padel_pairing_holds")
  @@schema("app_v3")
}

/// Checkout source (PADEL_REGISTRATION)
model PadelRegistration {
  env                     String                         @default("prod")
  id             String                 @id @default(uuid()) @db.Uuid
  organizationId Int                    @map("organization_id")
  eventId        Int                    @map("event_id")
  buyerIdentityId String?               @map("buyer_identity_id") @db.Uuid
  pairingId      Int?                   @map("pairing_id")
  currency       String                 @default("EUR")
  status         PadelRegistrationStatus @default(PENDING_PARTNER)
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")
  lines          PadelRegistrationLine[]
  event          Event                  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  pairing        PadelPairing?          @relation("PadelPairingRegistration", fields: [pairingId], references: [id], onDelete: SetNull)

  @@index([organizationId], map: "padel_registrations_org_idx")
  @@index([eventId], map: "padel_registrations_event_idx")
  @@unique([pairingId], map: "padel_registrations_pairing_unique")
  @@map("padel_registrations")
  @@schema("app_v3")
}

/// Linhas da PadelRegistration (para pricing snapshot)
model PadelRegistrationLine {
  env                     String                         @default("prod")
  id                  Int               @id @default(autoincrement())
  padelRegistrationId String            @map("padel_registration_id") @db.Uuid
  pairingSlotId       Int?              @map("pairing_slot_id")
  label               String            @map("label")
  qty                 Int               @map("qty")
  unitAmount          Int               @map("unit_amount")
  totalAmount         Int               @map("total_amount")
  padelRegistration   PadelRegistration @relation(fields: [padelRegistrationId], references: [id], onDelete: Cascade)
  pairingSlot         PadelPairingSlot? @relation(fields: [pairingSlotId], references: [id], onDelete: SetNull)
  saleLines           SaleLine[]

  @@index([padelRegistrationId], map: "padel_registration_lines_reg_idx")
  @@index([pairingSlotId], map: "padel_registration_lines_slot_idx")
  @@map("padel_registration_lines")
  @@schema("app_v3")
}

/// Lista de espera para inscricoes de Padel
model PadelWaitlistEntry {
  env                     String                         @default("prod")
  id               Int                   @id @default(autoincrement())
  eventId          Int                   @map("event_id")
  organizationId   Int                   @map("organization_id")
  categoryId       Int?                  @map("category_id")
  userId           String                @map("user_id") @db.Uuid
  paymentMode      PadelPaymentMode      @map("payment_mode")
  pairingJoinMode  PadelPairingJoinMode  @map("pairing_join_mode")
  invitedContact   String?               @map("invited_contact")
  status           PadelWaitlistStatus   @default(PENDING)
  promotedPairingId Int?                 @map("promoted_pairing_id")
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event            Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organization     Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  category         PadelCategory?        @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  user             Profile               @relation(fields: [userId], references: [id], onDelete: Cascade)
  promotedPairing  PadelPairing?         @relation(fields: [promotedPairingId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([eventId, categoryId, userId], map: "padel_waitlist_event_category_user_uq")
  @@index([eventId, status], map: "padel_waitlist_event_status_idx")
  @@index([organizationId], map: "padel_waitlist_org_idx")
  @@map("padel_waitlist_entries")
  @@schema("app_v3")
}

model TournamentEntry {
  env                     String                         @default("prod")
  id              Int                   @id @default(autoincrement())
  eventId         Int                   @map("event_id")
  userId          String                @map("user_id") @db.Uuid
  categoryId      Int?                  @map("category_id")
  pairingId       Int?                  @map("pairing_id")
  role            TournamentEntryRole   @default(PARTNER)
  status          TournamentEntryStatus @default(PENDING)
  ownerUserId     String?               @map("owner_user_id") @db.Uuid
  ownerIdentityId String?               @map("owner_identity_id") @db.Uuid
  purchaseId      String?               @map("purchase_id") @db.Text
  emissionIndex   Int                   @default(0) @map("emission_index")
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  event           Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            Profile               @relation(fields: [userId], references: [id], onDelete: Cascade)
  pairing         PadelPairing?         @relation(fields: [pairingId], references: [id], onDelete: Cascade)
  category        PadelCategory?        @relation(fields: [categoryId], references: [id], onUpdate: NoAction)

  @@unique([eventId, categoryId, userId], map: "tournament_entries_event_category_user_unique")
  @@unique([purchaseId, emissionIndex], map: "tournament_entries_purchase_idx")
  @@index([pairingId])
  @@index([categoryId], map: "tournament_entries_category_idx")
  @@map("tournament_entries")
  @@schema("app_v3")
}

/// Slots de cada pairing (um por jogador)
model PadelPairingSlot {
  env                     String                         @default("prod")
  id              Int                       @id @default(autoincrement())
  pairingId       Int                       @map("pairing_id")
  profileId       String?                   @map("profile_id") @db.Uuid
  invitedUserId   String?                   @map("invited_user_id") @db.Uuid
  slot_role       PadelPairingSlotRole
  slotStatus      PadelPairingSlotStatus    @default(PENDING) @map("slot_status")
  paymentStatus   PadelPairingPaymentStatus @default(UNPAID) @map("payment_status")
  invitedContact  String?                   @map("invited_contact")
  isPublicOpen    Boolean                   @default(false) @map("is_public_open")
  createdAt       DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  playerProfileId Int?                      @map("player_profile_id")
  pairing         PadelPairing              @relation(fields: [pairingId], references: [id], onDelete: Cascade)
  playerProfile   PadelPlayerProfile?       @relation(fields: [playerProfileId], references: [id], onUpdate: NoAction, map: "padel_pairing_slots_player_profile_fk")
  profile         Profile?                  @relation("PadelPairingSlotProfile", fields: [profileId], references: [id])
  invitedUser     Profile?                  @relation("PadelPairingSlotInvitedUser", fields: [invitedUserId], references: [id], onDelete: SetNull)
  registrationLines PadelRegistrationLine[]

  @@index([pairingId])
  @@index([profileId])
  @@index([invitedUserId], map: "padel_pairing_slots_invited_user_idx")
  @@index([playerProfileId], map: "padel_pairing_slots_player_profile_idx")
  @@map("padel_pairing_slots")
  @@schema("app_v3")
}

/// Jogos
model EventMatchSlot {
  env                     String                         @default("prod")
  id              Int                @id @default(autoincrement())
  eventId         Int                @map("event_id")
  categoryId      Int?               @map("category_id")
  courtId         Int?               @map("court_id")
  courtNumber     Int?               @map("court_number")
  startTime       DateTime?          @map("start_time") @db.Timestamptz(6)
  plannedStartAt  DateTime?          @map("planned_start_at") @db.Timestamptz(6)
  plannedEndAt    DateTime?          @map("planned_end_at") @db.Timestamptz(6)
  plannedDurationMinutes Int?        @map("planned_duration_minutes")
  actualStartAt   DateTime?          @map("actual_start_at") @db.Timestamptz(6)
  actualEndAt     DateTime?          @map("actual_end_at") @db.Timestamptz(6)
  roundLabel      String?            @map("round_label")
  score           Json               @default("{}")
  status          padel_match_status @default(PENDING)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  pairingAId      Int?               @map("pairing_a_id")
  pairingBId      Int?               @map("pairing_b_id")
  groupLabel      String?            @map("group_label")
  roundType       String?            @map("round_type")
  winnerPairingId Int?               @map("winner_pairing_id")
  scoreSets       Json?              @map("score_sets")
  courtName       String?            @map("court_name")
  category        PadelCategory?     @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  event           Event              @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  court           PadelClubCourt?    @relation("EventMatchSlotCourt", fields: [courtId], references: [id], onUpdate: NoAction, onDelete: SetNull, map: "padel_matches_court_fk")
  pairingA        PadelPairing?      @relation("MatchPairingA", fields: [pairingAId], references: [id], onUpdate: NoAction, map: "padel_matches_pairing_a_fk")
  pairingB        PadelPairing?      @relation("MatchPairingB", fields: [pairingBId], references: [id], onUpdate: NoAction, map: "padel_matches_pairing_b_fk")
  winnerPairing   PadelPairing?      @relation("MatchWinnerPairing", fields: [winnerPairingId], references: [id], onUpdate: NoAction, map: "padel_matches_winner_fk")

  @@index([pairingAId, pairingBId], map: "padel_matches_pairings_idx")
  @@index([courtId], map: "padel_matches_court_idx")
  @@map("padel_matches")
  @@schema("app_v3")
}

/// Ranking básico por torneio/clube
model PadelRankingEntry {
  env                     String                         @default("prod")
  id          Int                @id @default(autoincrement())
  organizationId Int                @map("organization_id")
  playerId    Int                @map("player_id")
  eventId     Int                @map("event_id")
  points      Int                @default(0)
  position    Int?
  level       String?
  season      String?
  year        Int?
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  event       Event              @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  player      PadelPlayerProfile @relation(fields: [playerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("padel_ranking_entries")
  @@schema("app_v3")
}

/// Estrutura base de torneios (formatos/chaves)
model Tournament {
  env                     String                         @default("prod")
  id                    Int                  @id @default(autoincrement())
  eventId               Int                  @unique @map("event_id")
  format                TournamentFormat
  generationSeed        String?              @map("generation_seed")
  generatedAt           DateTime?            @map("generated_at") @db.Timestamptz(6)
  generatedByUserId     String?              @map("generated_by_user_id") @db.Uuid
  inscriptionDeadlineAt DateTime?            @map("inscription_deadline_at") @db.Timestamptz(6)
  tieBreakRules         Json                 @default("{}") @map("tie_break_rules")
  config                Json                 @default("{}")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @default(now()) @updatedAt @map("updated_at")
  stages                TournamentStage[]
  auditLogs             TournamentAuditLog[]
  generatedBy           Profile?             @relation("TournamentGeneratedBy", fields: [generatedByUserId], references: [id], onUpdate: NoAction, onDelete: SetNull)
  event                 Event                @relation("EventTournament", fields: [eventId], references: [id], onDelete: Cascade)

  @@map("tournaments")
  @@schema("app_v3")
}

model TournamentStage {
  env                     String                         @default("prod")
  id           Int                 @id @default(autoincrement())
  tournamentId Int                 @map("tournament_id")
  name         String?
  stageType    TournamentStageType @default(GROUPS) @map("stage_type")
  order        Int                 @default(0)
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @default(now()) @updatedAt @map("updated_at")
  tournament   Tournament          @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  groups       TournamentGroup[]
  matches      TournamentMatch[]

  @@index([tournamentId])
  @@map("tournament_stages")
  @@schema("app_v3")
}

model TournamentGroup {
  env                     String                         @default("prod")
  id        Int               @id @default(autoincrement())
  stageId   Int               @map("stage_id")
  name      String
  order     Int               @default(0)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @default(now()) @updatedAt @map("updated_at")
  stage     TournamentStage   @relation(fields: [stageId], references: [id], onDelete: Cascade)
  matches   TournamentMatch[]

  @@index([stageId])
  @@map("tournament_groups")
  @@schema("app_v3")
}

model TournamentMatch {
  env                     String                         @default("prod")
  id          Int                   @id @default(autoincrement())
  stageId     Int                   @map("stage_id")
  groupId     Int?                  @map("group_id")
  pairing1Id  Int?                  @map("pairing1_id")
  pairing2Id  Int?                  @map("pairing2_id")
  round       Int?                  @map("round_number")
  roundLabel  String?               @map("round_label")
  nextMatchId Int?                  @map("next_match_id")
  nextSlot    Int?                  @map("next_slot")
  courtId     Int?                  @map("court_id")
  startAt     DateTime?             @map("start_at") @db.Timestamptz(6)
  score       Json                  @default("{}")
  status      TournamentMatchStatus @default(PENDING)
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @default(now()) @updatedAt @map("updated_at")
  stage       TournamentStage       @relation(fields: [stageId], references: [id], onDelete: Cascade)
  group       TournamentGroup?      @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([stageId])
  @@index([groupId])
  @@map("tournament_matches")
  @@schema("app_v3")
}

model TournamentAuditLog {
  env                     String                         @default("prod")
  id            Int        @id @default(autoincrement())
  tournamentId  Int        @map("tournament_id")
  userId        String?    @map("user_id") @db.Uuid
  action        String
  payloadBefore Json?      @map("payload_before")
  payloadAfter  Json?      @map("payload_after")
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user          Profile?   @relation("TournamentAuditLogUser", fields: [userId], references: [id], onUpdate: NoAction, onDelete: SetNull)

  @@index([tournamentId])
  @@index([userId])
  @@map("tournament_audit_logs")
  @@schema("app_v3")
}

model follows {
  id                                      Int      @id @default(autoincrement())
  env                                     String   @default("prod")
  follower_id                             String   @db.Uuid
  following_id                            String   @db.Uuid
  created_at                              DateTime @default(now()) @db.Timestamptz(6)
  profiles_follows_follower_idToprofiles  Profile  @relation("follows_follower_idToprofiles", fields: [follower_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_follows_following_idToprofiles Profile  @relation("follows_following_idToprofiles", fields: [following_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([follower_id, following_id], map: "follows_unique")
  @@index([follower_id], map: "idx_follows_follower")
  @@index([following_id], map: "idx_follows_following")
  @@schema("app_v3")
}

model UserCloseFriend {
  env          String   @default("prod")
  userId       String   @map("user_id") @db.Uuid
  friendUserId String   @map("friend_user_id") @db.Uuid
  score        Int      @default(0)
  rank         Int      @default(0)
  computedAt   DateTime @map("computed_at") @db.Timestamptz(6)
  expiresAt    DateTime @map("expires_at") @db.Timestamptz(6)

  user   Profile @relation("UserCloseFriendUser", fields: [userId], references: [id], onDelete: Cascade)
  friend Profile @relation("UserCloseFriendFriend", fields: [friendUserId], references: [id], onDelete: Cascade)

  @@id([userId, friendUserId])
  @@index([userId, expiresAt], map: "user_close_friends_user_exp_idx")
  @@index([friendUserId], map: "user_close_friends_friend_idx")
  @@map("user_close_friends")
  @@schema("app_v3")
}

model follow_requests {
  id                                 Int      @id @default(autoincrement())
  env                                String   @default("prod")
  requester_id                       String   @db.Uuid
  target_id                          String   @db.Uuid
  created_at                         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  profiles_follow_requests_requester Profile  @relation("follow_requests_requester", fields: [requester_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_follow_requests_target    Profile  @relation("follow_requests_target", fields: [target_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([requester_id, target_id], map: "follow_requests_unique")
  @@index([requester_id], map: "idx_follow_requests_requester")
  @@index([target_id], map: "idx_follow_requests_target")
  @@map("follow_requests")
  @@schema("app_v3")
}

model organization_follows {
  id                                                      Int      @id @default(autoincrement())
  env                                                     String   @default("prod")
  follower_id                                             String   @db.Uuid
  organization_id                                            Int
  created_at                                              DateTime @default(now()) @db.Timestamptz(6)
  profiles_organization_follows_follower_idToprofiles        Profile  @relation("organization_follows_follower_idToprofiles", fields: [follower_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization_organization_follows_organization_idToorganizations    Organization @relation("organization_follows_organization_idToorganizations", fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([follower_id, organization_id], map: "organization_follows_unique")
  @@index([follower_id], map: "idx_organization_follows_follower")
  @@index([organization_id], map: "idx_organization_follows_organization")
  @@map("organization_follows")
  @@schema("app_v3")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model users {
  id                   String               @id @db.Uuid
  email                String?              @db.VarChar(255)
  profiles             Profile?
  padel_player_profiles PadelPlayerProfile[]

  @@schema("auth")
}

model Entitlement {
  env                     String                         @default("prod")
  id               String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type             EntitlementType
  status           EntitlementStatus     @default(ACTIVE)
  ownerUserId      String?               @map("owner_user_id") @db.Uuid
  ownerIdentityId  String?               @map("owner_identity_id") @db.Uuid
  ownerKey         String                @map("owner_key")
  purchaseId       String                @map("purchase_id") @db.Text
  saleLineId       Int?                  @map("sale_line_id")
  bookingId        Int?                  @map("booking_id")
  storeOrderLineId Int?                  @map("store_order_line_id")
  ticketId         String?               @unique @map("ticket_id")
  lineItemIndex    Int                   @default(0) @map("line_item_index")
  eventId          Int?                  @map("event_id")
  tournamentId     Int?                  @map("tournament_id")
  seasonId         Int?                  @map("season_id")
  snapshotTitle    String                @map("snapshot_title")
  snapshotCoverUrl String?               @map("snapshot_cover_url")
  snapshotVenueName String?              @map("snapshot_venue_name")
  snapshotStartAt  DateTime              @map("snapshot_start_at") @db.Timestamptz(6)
  snapshotTimezone String                @map("snapshot_timezone")
  policyVersionApplied Int               @default(0) @map("policy_version_applied")
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  saleLine         SaleLine?             @relation(fields: [saleLineId], references: [id], onDelete: Cascade)
  booking          Booking?              @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  storeOrderLine   StoreOrderLine?       @relation(fields: [storeOrderLineId], references: [id], onDelete: SetNull)
  ticket           Ticket?               @relation("TicketEntitlement", fields: [ticketId], references: [id], onDelete: SetNull)
  checkins         EntitlementCheckin[]
  qrTokens         EntitlementQrToken[]
  chatEventInvites ChatEventInvite[]

  @@unique([purchaseId, saleLineId, lineItemIndex, ownerKey, type], map: "entitlements_purchase_sale_owner_type_idx")
  @@unique([bookingId, lineItemIndex, ownerKey, type], map: "entitlements_booking_owner_line_idx")
  @@unique([storeOrderLineId, lineItemIndex, ownerKey, type], map: "entitlements_store_line_owner_idx")
  @@index([ownerKey, snapshotStartAt], map: "entitlements_owner_start_idx")
  @@index([ownerUserId, snapshotStartAt], map: "entitlements_owner_user_start_idx")
  @@index([eventId], map: "entitlements_event_idx")
  @@index([tournamentId], map: "entitlements_tournament_idx")
  @@index([seasonId], map: "entitlements_season_idx")
  @@index([bookingId], map: "entitlements_booking_idx")
  @@index([storeOrderLineId], map: "entitlements_store_line_idx")
  @@index([status], map: "entitlements_status_idx")
  @@index([eventId, policyVersionApplied], map: "entitlements_event_policy_idx")
  @@map("entitlements")
  @@schema("app_v3")
}

model EntitlementCheckin {
  env                     String                         @default("prod")
  id             Int                @id @default(autoincrement())
  entitlementId  String             @map("entitlement_id") @db.Uuid
  eventId        Int                @map("event_id")
  deviceId       String             @map("device_id")
  resultCode     CheckinResultCode  @map("result_code")
  checkedInAt    DateTime           @default(now()) @map("checked_in_at") @db.Timestamptz(6)
  checkedInBy    String?            @map("checked_in_by") @db.Uuid
  purchaseId     String             @map("purchase_id") @db.Text
  idempotencyKey String?            @map("idempotency_key") @db.Text
  causationId    String?            @map("causation_id") @db.Text
  correlationId  String?            @map("correlation_id") @db.Text
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  entitlement    Entitlement        @relation(fields: [entitlementId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "entitlement_checkins_entitlement_fkey")

  @@unique([eventId, entitlementId], map: "entitlement_checkins_event_entitlement_key")
  @@index([eventId], map: "entitlement_checkins_event_idx")
  @@index([purchaseId], map: "entitlement_checkins_purchase_idx")
  @@index([idempotencyKey], map: "entitlement_checkins_idempotency_idx")
  @@map("entitlement_checkins")
  @@schema("app_v3")
}

model EntitlementQrToken {
  env                     String                         @default("prod")
  id            BigInt      @id @default(autoincrement())
  tokenHash     String      @map("token_hash") @unique
  entitlementId String      @map("entitlement_id") @db.Uuid
  expiresAt     DateTime?   @map("expires_at") @db.Timestamptz(6)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  entitlement   Entitlement @relation(fields: [entitlementId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "entitlement_qr_tokens_entitlement_fkey")

  @@index([entitlementId], map: "entitlement_qr_tokens_entitlement_idx")
  @@map("entitlement_qr_tokens")
  @@schema("app_v3")
}

model UserActivity {
  env                     String                         @default("prod")
  id         Int              @id @default(autoincrement())
  userId     String           @map("user_id") @db.Uuid
  type       UserActivityType
  visibility Visibility       @default(PUBLIC)
  metadata   Json?            @default("{}")
  createdAt  DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  user       Profile          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@map("user_activities")
  @@schema("app_v3")
}

model UserEventSignal {
  env            String              @default("prod")
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String              @map("user_id") @db.Uuid
  eventId        Int?                @map("event_id")
  organizationId Int?                @map("organization_id")
  signalType     UserEventSignalType @map("signal_type")
  signalValue    Int?                @map("signal_value")
  metadata       Json?               @default("{}")
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)

  user         Profile       @relation(fields: [userId], references: [id], onDelete: Cascade)
  event        Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt], map: "user_event_signals_user_time_idx")
  @@index([eventId], map: "user_event_signals_event_idx")
  @@index([organizationId], map: "user_event_signals_org_idx")
  @@index([signalType], map: "user_event_signals_type_idx")
  @@map("user_event_signals")
  @@schema("app_v3")
}

model OrganizationPolicy {
  env                     String                         @default("prod")
  id                          Int                     @id @default(autoincrement())
  organizationId                 Int                     @map("organization_id")
  name                        String
  policyType                  OrganizationPolicyType  @map("policy_type")
  allowCancellation           Boolean                 @default(true) @map("allow_cancellation")
  cancellationWindowMinutes   Int?                    @map("cancellation_window_minutes")
  cancellationPenaltyBps      Int                     @default(0) @map("cancellation_penalty_bps")
  allowReschedule             Boolean                 @default(true) @map("allow_reschedule")
  rescheduleWindowMinutes     Int?                    @map("reschedule_window_minutes")
  guestBookingAllowed         Boolean                 @default(false) @map("guest_booking_allowed")
  noShowFeeCents              Int                     @default(0) @map("no_show_fee_cents")
  createdAt                   DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                   DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization                   Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookingPolicyRefs           BookingPolicyRef[]
  services                    Service[]

  @@index([organizationId])
  @@index([policyType])
  @@map("organization_policies")
  @@schema("app_v3")
}

model ReservationProfessional {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  organizationId  Int           @map("organization_id")
  userId          String?       @map("user_id") @db.Uuid
  name            String
  roleTitle       String?       @map("role_title")
  isActive        Boolean       @default(true) @map("is_active")
  priority        Int           @default(0)
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            Profile?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  bookings        Booking[]
  serviceLinks    ServiceProfessionalLink[]
  bookingChangeRequestsProposed BookingChangeRequest[]
  classSeries     ClassSeries[]
  classSessions   ClassSession[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([userId])
  @@map("reservation_professionals")
  @@schema("app_v3")
}

model ReservationResource {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  organizationId  Int           @map("organization_id")
  label           String
  capacity        Int           @default(1)
  isActive        Boolean       @default(true) @map("is_active")
  priority        Int           @default(0)
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  serviceLinks    ServiceResourceLink[]
  bookingChangeRequestsProposed BookingChangeRequest[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([capacity])
  @@map("reservation_resources")
  @@schema("app_v3")
}

model Service {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  organizationId     Int           @map("organization_id")
  policyId        Int?          @map("policy_id")
  kind            ServiceKind   @default(GENERAL)
  instructorId    String?       @map("instructor_id") @db.Uuid
  title           String        @map("name")
  description     String?
  durationMinutes Int           @map("duration_minutes")
  unitPriceCents  Int           @map("price")
  currency        String        @default("EUR")
  isActive        Boolean       @default(true) @map("is_active")
  categoryTag     String?       @map("category_tag")
  coverImageUrl   String?       @map("cover_image_url")
  locationMode    ServiceLocationMode @default(FIXED) @map("location_mode")
  addressId       String?       @map("address_id") @db.Uuid
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  addressRef      Address?      @relation(fields: [addressId], references: [id], onDelete: SetNull)
  policy          OrganizationPolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)
  instructor      Profile?       @relation("ServiceInstructor", fields: [instructorId], references: [id], onDelete: SetNull)
  packs           ServicePack[]
  packages        ServicePackage[]
  availabilities  Availability[]
  bookings        Booking[]
  classSeries     ClassSeries[]
  classSessions   ClassSession[]
  professionalLinks ServiceProfessionalLink[]
  resourceLinks    ServiceResourceLink[]
  addons           ServiceAddon[]
  creditBalances  ServiceCreditBalance[]
  creditLedger    ServiceCreditLedger[]
  reviews         ServiceReview[]
  @@index([organizationId])
  @@index([policyId])
  @@index([isActive])
  @@index([instructorId])
  @@index([categoryTag])
  @@index([addressId], map: "services_address_idx")
  @@map("services")
  @@schema("app_v3")
}

model ServicePack {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  serviceId       Int      @map("service_id")
  quantity        Int
  packPriceCents  Int      @map("pack_price_cents")
  label           String?
  recommended     Boolean  @default(false)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([isActive])
  @@map("service_packs")
  @@schema("app_v3")
}

model ServicePackage {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  serviceId       Int      @map("service_id")
  label           String
  description     String?
  durationMinutes Int      @map("duration_minutes")
  priceCents      Int      @map("price_cents")
  recommended     Boolean  @default(false)
  sortOrder       Int      @default(0) @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookingPackages BookingPackage[]

  @@index([serviceId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("service_packages")
  @@schema("app_v3")
}

model ServiceAddon {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  serviceId       Int      @map("service_id")
  label           String
  description     String?
  deltaMinutes    Int      @default(0) @map("delta_minutes")
  deltaPriceCents Int      @default(0) @map("delta_price_cents")
  maxQty          Int?     @map("max_qty")
  category        String?  @map("category")
  sortOrder       Int      @default(0) @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookingAddons   BookingAddon[]

  @@index([serviceId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("service_addons")
  @@schema("app_v3")
}

model ServiceCreditBalance {
  env                     String                         @default("prod")
  id             Int                        @id @default(autoincrement())
  userId         String                     @map("user_id") @db.Uuid
  serviceId      Int                        @map("service_id")
  remainingUnits Int                        @map("remaining_units")
  expiresAt      DateTime?                  @map("expires_at") @db.Timestamptz(6)
  status         ServiceCreditBalanceStatus @default(ACTIVE)
  createdAt      DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime                   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user           Profile                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service        Service                    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  ledger         ServiceCreditLedger[]

  @@unique([userId, serviceId], map: "service_credit_balance_user_service_unique")
  @@index([serviceId])
  @@index([expiresAt])
  @@map("service_credit_balances")
  @@schema("app_v3")
}

model ServiceCreditLedger {
  env                     String                         @default("prod")
  id             Int                      @id @default(autoincrement())
  userId         String                   @map("user_id") @db.Uuid
  serviceId      Int                      @map("service_id")
  bookingId      Int?                     @map("booking_id")
  paymentIntentId String?                 @map("payment_intent_id")
  changeUnits    Int                      @map("change_units")
  type           ServiceCreditLedgerType
  metadata       Json?                    @default("{}")
  expiresAt      DateTime?                @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  user           Profile                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  service        Service                  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  booking        Booking?                 @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  balance        ServiceCreditBalance?    @relation(fields: [userId, serviceId], references: [userId, serviceId], onDelete: Cascade)

  @@index([userId, serviceId])
  @@index([bookingId])
  @@index([paymentIntentId])
  @@map("service_credit_ledger")
  @@schema("app_v3")
}

model WeeklyAvailabilityTemplate {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  organizationId  Int      @map("organization_id")
  scopeType       AvailabilityScopeType @default(ORGANIZATION) @map("scope_type")
  scopeId         Int      @default(0) @map("scope_id")
  dayOfWeek       Int      @map("day_of_week")
  intervals       Json     @default("[]")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, scopeType, scopeId, dayOfWeek], map: "weekly_availability_scope_day_unique")
  @@index([organizationId])
  @@index([organizationId, scopeType, scopeId])
  @@map("weekly_availability_templates")
  @@schema("app_v3")
}

model AvailabilityOverride {
  env                     String                         @default("prod")
  id              Int                     @id @default(autoincrement())
  organizationId  Int                     @map("organization_id")
  scopeType       AvailabilityScopeType   @default(ORGANIZATION) @map("scope_type")
  scopeId         Int                     @default(0) @map("scope_id")
  date            DateTime                @db.Date
  kind            AvailabilityOverrideKind
  intervals       Json?                   @default("[]")
  createdAt       DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, date])
  @@index([organizationId, scopeType, scopeId, date])
  @@map("availability_overrides")
  @@schema("app_v3")
}

model ServiceProfessionalLink {
  env                     String                         @default("prod")
  id             Int                     @id @default(autoincrement())
  serviceId      Int                     @map("service_id")
  professionalId Int                     @map("professional_id")
  createdAt      DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  service        Service                 @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  professional   ReservationProfessional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([serviceId, professionalId], map: "service_professional_unique")
  @@index([professionalId])
  @@map("service_professionals")
  @@schema("app_v3")
}

model ServiceResourceLink {
  env                     String                         @default("prod")
  id         Int                 @id @default(autoincrement())
  serviceId  Int                 @map("service_id")
  resourceId Int                 @map("resource_id")
  createdAt  DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  service    Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  resource   ReservationResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, resourceId], map: "service_resource_unique")
  @@index([resourceId])
  @@map("service_resources")
  @@schema("app_v3")
}

model TrainerProfile {
  env                     String                         @default("prod")
  id               Int          @id @default(autoincrement())
  organizationId   Int          @map("organization_id")
  userId           String       @map("user_id") @db.Uuid
  title            String?
  bio              String?
  specialties      String[]     @default([])
  certifications   String?
  experienceYears  Int?         @map("experience_years")
  coverImageUrl    String?      @map("cover_image_url")
  isPublished      Boolean      @default(false) @map("is_published")
  reviewStatus     TrainerProfileReviewStatus @default(DRAFT) @map("review_status")
  reviewNote       String?      @map("review_note")
  reviewRequestedAt DateTime?   @map("review_requested_at") @db.Timestamptz(6)
  reviewedAt       DateTime?    @map("reviewed_at") @db.Timestamptz(6)
  reviewedByUserId String?      @map("reviewed_by_user_id") @db.Uuid
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             Profile      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId], map: "trainer_profiles_org_user_unique")
  @@index([organizationId, isPublished], map: "trainer_profiles_org_published_idx")
  @@index([userId], map: "trainer_profiles_user_idx")
  @@map("trainer_profiles")
  @@schema("app_v3")
}

model Availability {
  env                     String                         @default("prod")
  id              Int                @id @default(autoincrement())
  serviceId       Int                @map("service_id")
  courtId         Int?               @map("court_id")
  startsAt        DateTime           @map("starts_at") @db.Timestamptz(6)
  durationMinutes Int                @map("duration_minutes")
  capacity        Int                @default(1)
  status          AvailabilityStatus @default(OPEN)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  service         Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  court           PadelClubCourt?    @relation(fields: [courtId], references: [id], onDelete: SetNull)
  bookings        Booking[]

  @@index([serviceId])
  @@index([courtId])
  @@index([startsAt])
  @@index([status])
  @@map("availabilities")
  @@schema("app_v3")
}

model Booking {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  serviceId       Int           @map("service_id")
  organizationId     Int           @map("organization_id")
  userId          String?       @map("user_id") @db.Uuid
  guestEmail      String?       @map("guest_email") @db.Citext
  guestName       String?       @map("guest_name")
  guestPhone      String?       @map("guest_phone")
  availabilityId  Int?          @map("availability_id")
  courtId         Int?          @map("court_id")
  assignmentMode  ReservationAssignmentMode @default(PROFESSIONAL) @map("assignment_mode")
  professionalId  Int?          @map("professional_id")
  resourceId      Int?          @map("resource_id")
  partySize       Int?          @map("party_size")
  paymentIntentId String?       @unique @map("payment_intent_id")
  startsAt        DateTime      @map("starts_at") @db.Timestamptz(6)
  durationMinutes Int           @map("duration_minutes")
  price           Int
  currency        String        @default("EUR")
  status          BookingStatus @default(PENDING_CONFIRMATION)
  pendingExpiresAt DateTime?    @map("pending_expires_at") @db.Timestamptz(6)
  snapshotTimezone String       @default("Europe/Lisbon") @map("snapshot_timezone")
  confirmationSnapshot Json?    @map("confirmation_snapshot")
  confirmationSnapshotVersion Int? @map("confirmation_snapshot_version")
  confirmationSnapshotCreatedAt DateTime? @map("confirmation_snapshot_created_at") @db.Timestamptz(6)
  locationMode    ServiceLocationMode @default(FIXED) @map("location_mode")
  addressId       String?       @map("address_id") @db.Uuid
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            Profile?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  availability    Availability? @relation(fields: [availabilityId], references: [id], onDelete: SetNull)
  court           PadelClubCourt? @relation(fields: [courtId], references: [id], onDelete: SetNull)
  professional    ReservationProfessional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)
  resource        ReservationResource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)
  addressRef      Address?      @relation(fields: [addressId], references: [id], onDelete: SetNull)
  policyRef       BookingPolicyRef?
  bookingPackage  BookingPackage?
  addons          BookingAddon[]
  invites         BookingInvite[]
  charges         BookingCharge[]
  participants    BookingParticipant[]
  splitPayment    BookingSplit?
  review          ServiceReview?
  creditLedger    ServiceCreditLedger[]
  entitlements    Entitlement[]
  changeRequests  BookingChangeRequest[]

  @@index([serviceId])
  @@index([organizationId])
  @@index([userId])
  @@index([availabilityId])
  @@index([courtId])
  @@index([professionalId])
  @@index([resourceId])
  @@index([partySize])
  @@index([status])
  @@index([pendingExpiresAt])
  @@index([addressId], map: "bookings_address_idx")
  @@index([guestEmail], map: "bookings_guest_email_idx")
  @@map("bookings")
  @@schema("app_v3")
}

model BookingChangeRequest {
  env                     String                         @default("prod")
  id              Int                       @id @default(autoincrement())
  bookingId       Int                       @map("booking_id")
  organizationId  Int                       @map("organization_id")
  requestedBy     BookingChangeRequestedBy  @map("requested_by")
  requestedByUserId String?                 @map("requested_by_user_id") @db.Uuid
  status          BookingChangeRequestStatus @default(PENDING)
  proposedStartsAt DateTime                 @map("proposed_starts_at") @db.Timestamptz(6)
  proposedCourtId  Int?                     @map("proposed_court_id")
  proposedProfessionalId Int?               @map("proposed_professional_id")
  proposedResourceId Int?                   @map("proposed_resource_id")
  priceDeltaCents Int                       @map("price_delta_cents")
  currency        String                    @default("EUR")
  expiresAt       DateTime                  @map("expires_at") @db.Timestamptz(6)
  respondedAt     DateTime?                 @map("responded_at") @db.Timestamptz(6)
  respondedByUserId String?                 @map("responded_by_user_id") @db.Uuid
  createdAt       DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking                   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  organization    Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  proposedCourt   PadelClubCourt?           @relation(fields: [proposedCourtId], references: [id], onDelete: SetNull)
  proposedProfessional ReservationProfessional? @relation(fields: [proposedProfessionalId], references: [id], onDelete: SetNull)
  proposedResource ReservationResource?     @relation(fields: [proposedResourceId], references: [id], onDelete: SetNull)

  @@index([bookingId], map: "booking_change_requests_booking_idx")
  @@index([organizationId, status], map: "booking_change_requests_org_status_idx")
  @@index([expiresAt], map: "booking_change_requests_expires_idx")
  @@map("booking_change_requests")
  @@schema("app_v3")
}

model ClassSeries {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  organizationId  Int           @map("organization_id")
  serviceId       Int           @map("service_id")
  courtId         Int?          @map("court_id")
  professionalId  Int?          @map("professional_id")
  dayOfWeek       Int           @map("day_of_week")
  startMinute     Int           @map("start_minute")
  durationMinutes Int           @map("duration_minutes")
  capacity        Int           @default(1)
  validFrom       DateTime      @map("valid_from") @db.Date
  validUntil      DateTime?     @map("valid_until") @db.Date
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  court           PadelClubCourt? @relation(fields: [courtId], references: [id], onDelete: SetNull)
  professional    ReservationProfessional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)
  sessions        ClassSession[]

  @@index([organizationId], map: "class_series_org_idx")
  @@index([serviceId], map: "class_series_service_idx")
  @@index([courtId], map: "class_series_court_idx")
  @@index([isActive], map: "class_series_active_idx")
  @@map("class_series")
  @@schema("app_v3")
}

model ClassSession {
  env                     String                         @default("prod")
  id              Int           @id @default(autoincrement())
  seriesId        Int           @map("series_id")
  organizationId  Int           @map("organization_id")
  serviceId       Int           @map("service_id")
  courtId         Int?          @map("court_id")
  professionalId  Int?          @map("professional_id")
  startsAt        DateTime      @map("starts_at") @db.Timestamptz(6)
  endsAt          DateTime      @map("ends_at") @db.Timestamptz(6)
  capacity        Int           @default(1)
  status          ClassSessionStatus @default(SCHEDULED)
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  series          ClassSeries   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  court           PadelClubCourt? @relation(fields: [courtId], references: [id], onDelete: SetNull)
  professional    ReservationProfessional? @relation(fields: [professionalId], references: [id], onDelete: SetNull)

  @@unique([seriesId, startsAt], map: "class_sessions_series_start_unique")
  @@index([organizationId, startsAt], map: "class_sessions_org_start_idx")
  @@index([courtId, startsAt], map: "class_sessions_court_start_idx")
  @@index([status], map: "class_sessions_status_idx")
  @@map("class_sessions")
  @@schema("app_v3")
}

model BookingPackage {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @unique @map("booking_id")
  packageId       Int?     @map("package_id")
  label           String
  durationMinutes Int      @map("duration_minutes")
  priceCents      Int      @map("price_cents")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  package         ServicePackage? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@index([packageId])
  @@map("booking_packages")
  @@schema("app_v3")
}

model BookingAddon {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @map("booking_id")
  addonId         Int?     @map("addon_id")
  label           String
  deltaMinutes    Int      @default(0) @map("delta_minutes")
  deltaPriceCents Int      @default(0) @map("delta_price_cents")
  quantity        Int      @default(1)
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  addon           ServiceAddon? @relation(fields: [addonId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@index([addonId])
  @@map("booking_addons")
  @@schema("app_v3")
}

model BookingInvite {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @map("booking_id")
  organizationId  Int      @map("organization_id")
  invitedByUserId String   @map("invited_by_user_id") @db.Uuid
  token           String   @unique @map("token")
  targetName      String?  @map("target_name")
  targetContact   String?  @map("target_contact") @db.Citext
  message         String?  @map("message")
  status          BookingInviteStatus @default(PENDING)
  respondedAt     DateTime? @map("responded_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy       Profile  @relation("BookingInviteInvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)
  participant     BookingParticipant?
  splitParticipants BookingSplitParticipant[] @relation("BookingSplitParticipantInvite")

  @@index([bookingId])
  @@index([organizationId])
  @@index([status])
  @@map("booking_invites")
  @@schema("app_v3")
}

model BookingCharge {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @map("booking_id")
  organizationId  Int      @map("organization_id")
  createdByUserId String?  @map("created_by_user_id") @db.Uuid
  token           String   @unique @map("token") @db.Text
  kind            BookingChargeKind @default(EXTRA)
  payerKind       BookingChargePayerKind @default(ORGANIZER) @map("payer_kind")
  status          BookingChargeStatus @default(OPEN)
  label           String?
  amountCents     Int      @map("amount_cents")
  currency        String   @default("EUR")
  paymentIntentId String?  @map("payment_intent_id")
  paymentId       String?  @map("payment_id")
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       Profile? @relation("BookingChargeCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@index([organizationId])
  @@index([status])
  @@index([paymentIntentId])
  @@map("booking_charges")
  @@schema("app_v3")
}

model BookingParticipant {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @map("booking_id")
  inviteId        Int?     @unique @map("invite_id")
  userId          String?  @map("user_id") @db.Uuid
  name            String?  @map("name")
  contact         String?  @map("contact") @db.Citext
  status          BookingParticipantStatus @default(CONFIRMED)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  invite          BookingInvite? @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  user            Profile? @relation("BookingParticipantUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([bookingId])
  @@index([inviteId])
  @@index([userId])
  @@index([status])
  @@map("booking_participants")
  @@schema("app_v3")
}

model BookingSplit {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @unique @map("booking_id")
  organizationId  Int      @map("organization_id")
  createdByUserId String?  @map("created_by_user_id") @db.Uuid
  pricingMode     BookingSplitPricingMode @default(FIXED) @map("pricing_mode")
  status          BookingSplitStatus @default(OPEN)
  currency        String   @default("EUR")
  totalCents      Int      @map("total_cents")
  shareCents      Int?     @map("share_cents")
  deadlineAt      DateTime? @map("deadline_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       Profile?  @relation("BookingSplitCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  participants    BookingSplitParticipant[]

  @@index([organizationId])
  @@index([status])
  @@map("booking_splits")
  @@schema("app_v3")
}

model BookingSplitParticipant {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  splitId         Int      @map("split_id")
  inviteId        Int?     @unique @map("invite_id")
  userId          String?  @map("user_id") @db.Uuid
  name            String?  @map("name")
  contact         String?  @map("contact") @db.Citext
  baseShareCents  Int      @map("base_share_cents")
  shareCents      Int      @map("share_cents")
  platformFeeCents Int     @default(0) @map("platform_fee_cents")
  status          BookingSplitParticipantStatus @default(PENDING)
  paymentIntentId String?  @map("payment_intent_id")
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  split           BookingSplit @relation(fields: [splitId], references: [id], onDelete: Cascade)
  invite          BookingInvite? @relation("BookingSplitParticipantInvite", fields: [inviteId], references: [id], onDelete: SetNull)
  user            Profile? @relation("BookingSplitParticipantUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([splitId])
  @@index([inviteId])
  @@index([userId])
  @@index([status])
  @@index([paymentIntentId])
  @@map("booking_split_participants")
  @@schema("app_v3")
}

model ScheduleDelay {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  organizationId  Int      @map("organization_id")
  scopeType       AvailabilityScopeType @map("scope_type")
  scopeId         Int      @default(0) @map("scope_id")
  delayMinutes    Int      @default(0) @map("delay_minutes")
  reason          String?  @map("reason")
  effectiveFrom   DateTime @default(now()) @map("effective_from") @db.Timestamptz(6)
  createdByUserId String?  @map("created_by_user_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       Profile?     @relation("ScheduleDelayCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, scopeType, scopeId])
  @@index([organizationId, effectiveFrom])
  @@map("schedule_delays")
  @@schema("app_v3")
}

model ServiceReview {
  env                     String                         @default("prod")
  id              Int      @id @default(autoincrement())
  bookingId       Int      @unique @map("booking_id")
  serviceId       Int      @map("service_id")
  organizationId  Int      @map("organization_id")
  userId          String   @map("user_id") @db.Uuid
  rating          Int
  comment         String?
  isVerified      Boolean  @default(true) @map("is_verified")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([organizationId])
  @@index([userId])
  @@map("service_reviews")
  @@schema("app_v3")
}

model BookingPolicyRef {
  env                     String                         @default("prod")
  id        Int                @id @default(autoincrement())
  bookingId Int                @unique @map("booking_id")
  policyId  Int                @map("policy_id")
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  booking   Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  policy    OrganizationPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([policyId])
  @@map("booking_policy_refs")
  @@schema("app_v3")
}

model CrmCustomer {
  env                     String                         @default("prod")
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId     Int               @map("organization_id")
  userId             String            @map("user_id") @db.Uuid
  status             CrmCustomerStatus @default(ACTIVE)
  displayName        String?           @map("display_name")
  contactEmail       String?           @map("contact_email") @db.Citext
  contactPhone       String?           @map("contact_phone")
  marketingOptIn     Boolean           @default(false) @map("marketing_opt_in")
  marketingOptInAt   DateTime?         @map("marketing_opt_in_at") @db.Timestamptz(6)
  firstInteractionAt DateTime?         @map("first_interaction_at") @db.Timestamptz(6)
  lastActivityAt     DateTime?         @map("last_activity_at") @db.Timestamptz(6)
  lastPurchaseAt     DateTime?         @map("last_purchase_at") @db.Timestamptz(6)
  totalSpentCents    Int               @default(0) @map("total_spent_cents")
  totalOrders        Int               @default(0) @map("total_orders")
  totalBookings      Int               @default(0) @map("total_bookings")
  totalAttendances   Int               @default(0) @map("total_attendances")
  totalTournaments   Int               @default(0) @map("total_tournaments")
  totalStoreOrders   Int               @default(0) @map("total_store_orders")
  tags               String[]          @default([])
  notesCount         Int               @default(0) @map("notes_count")
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes        CrmCustomerNote[]

  @@unique([organizationId, userId], map: "crm_customers_org_user_unique")
  @@index([organizationId, lastActivityAt], map: "crm_customers_org_last_activity_idx")
  @@index([organizationId, totalSpentCents], map: "crm_customers_org_spent_idx")
  @@map("crm_customers")
  @@schema("app_v3")
}

model CrmContact {
  env                     String                         @default("prod")
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId     Int                 @map("organization_id")
  userId             String?             @map("user_id") @db.Uuid
  emailIdentityId    String?             @map("email_identity_id") @db.Uuid
  status             CrmContactStatus    @default(ACTIVE)
  contactType        CrmContactType      @default(LEAD) @map("contact_type")
  displayName        String?             @map("display_name")
  contactEmail       String?             @map("contact_email") @db.Citext
  contactPhone       String?             @map("contact_phone")
  legalBasis         CrmContactLegalBasis? @map("legal_basis")
  marketingEmailOptIn Boolean            @default(false) @map("marketing_email_opt_in")
  marketingPushOptIn  Boolean            @default(false) @map("marketing_push_opt_in")
  firstInteractionAt DateTime?           @map("first_interaction_at") @db.Timestamptz(6)
  lastActivityAt     DateTime?           @map("last_activity_at") @db.Timestamptz(6)
  lastPurchaseAt     DateTime?           @map("last_purchase_at") @db.Timestamptz(6)
  totalSpentCents    Int                 @default(0) @map("total_spent_cents")
  totalOrders        Int                 @default(0) @map("total_orders")
  totalBookings      Int                 @default(0) @map("total_bookings")
  totalAttendances   Int                 @default(0) @map("total_attendances")
  totalTournaments   Int                 @default(0) @map("total_tournaments")
  totalStoreOrders   Int                 @default(0) @map("total_store_orders")
  tags               String[]            @default([])
  notesCount         Int                 @default(0) @map("notes_count")
  sourceType         String?             @map("source_type")
  sourceId           String?             @map("source_id") @db.Text
  externalId         String?             @map("external_id") @db.Text
  customFields       Json?               @default("{}") @map("custom_fields")
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         Profile?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  emailIdentity EmailIdentity?    @relation(fields: [emailIdentityId], references: [id], onDelete: SetNull)
  interactions CrmInteraction[]
  consents     CrmContactConsent[]
  notes        CrmContactNote[]
  padelProfile CrmContactPadel?
  campaignDeliveries CrmCampaignDelivery[]
  padelPlayerProfiles PadelPlayerProfile[]

  @@unique([organizationId, userId], map: "crm_contacts_org_user_unique")
  @@unique([organizationId, emailIdentityId], map: "crm_contacts_org_identity_unique")
  @@index([organizationId, lastActivityAt], map: "crm_contacts_org_last_activity_idx")
  @@index([organizationId, totalSpentCents], map: "crm_contacts_org_spent_idx")
  @@index([organizationId, contactType], map: "crm_contacts_org_type_idx")
  @@map("crm_contacts")
  @@schema("app_v3")
}

model CrmContactConsent {
  env                     String                         @default("prod")
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int           @map("organization_id")
  contactId      String        @map("contact_id") @db.Uuid
  type           ConsentType
  status         ConsentStatus
  source         String?       @map("source")
  grantedAt      DateTime?     @map("granted_at") @db.Timestamptz(6)
  revokedAt      DateTime?     @map("revoked_at") @db.Timestamptz(6)
  expiresAt      DateTime?     @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      CrmContact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([organizationId, contactId, type], map: "crm_contact_consents_org_contact_type_unique")
  @@index([organizationId, contactId], map: "crm_contact_consents_org_contact_idx")
  @@map("crm_contact_consents")
  @@schema("app_v3")
}

model CrmContactNote {
  env                     String                         @default("prod")
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int      @map("organization_id")
  contactId      String   @map("contact_id") @db.Uuid
  authorUserId   String   @map("author_user_id") @db.Uuid
  body           String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      CrmContact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  author       Profile      @relation(fields: [authorUserId], references: [id], onDelete: NoAction)

  @@index([organizationId, contactId, createdAt], map: "crm_contact_notes_org_contact_idx")
  @@map("crm_contact_notes")
  @@schema("app_v3")
}

model CrmContactPadel {
  env                     String                         @default("prod")
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int                 @map("organization_id")
  contactId      String              @map("contact_id") @db.Uuid
  playerProfileId Int?               @map("player_profile_id")
  level          String?
  preferredSide  PadelPreferredSide? @map("preferred_side")
  clubName       String?             @map("club_name")
  tournamentsCount Int               @default(0) @map("tournaments_count")
  noShowCount    Int                 @default(0) @map("no_show_count")
  updatedAt      DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      CrmContact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  playerProfile PadelPlayerProfile? @relation(fields: [playerProfileId], references: [id], onDelete: SetNull)

  @@unique([contactId], map: "crm_contact_padel_contact_unique")
  @@index([organizationId, contactId], map: "crm_contact_padel_org_contact_idx")
  @@map("crm_contact_padel")
  @@schema("app_v3")
}

model CrmInteraction {
  env                     String                         @default("prod")
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int                 @map("organization_id")
  contactId      String              @map("contact_id") @db.Uuid
  userId         String?             @map("user_id") @db.Uuid
  eventId        String?             @map("event_id") @db.Uuid
  externalId     String?             @map("external_id") @db.Text
  type           CrmInteractionType
  sourceType     CrmInteractionSource @map("source_type")
  sourceId       String?             @map("source_id") @db.Text
  occurredAt     DateTime            @map("occurred_at") @db.Timestamptz(6)
  amountCents    Int?                @map("amount_cents")
  currency       String?             @default("EUR")
  metadata       Json?               @default("{}")
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      CrmContact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user         Profile?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([eventId], map: "crm_interactions_event_unique")
  @@unique([organizationId, externalId], map: "crm_interactions_org_external_unique")
  @@index([organizationId, contactId, occurredAt], map: "crm_interactions_org_contact_time_idx")
  @@index([organizationId, type, occurredAt], map: "crm_interactions_org_type_time_idx")
  @@index([sourceType, sourceId], map: "crm_interactions_source_idx")
  @@map("crm_interactions")
  @@schema("app_v3")
}

model CrmCustomerNote {
  env                     String                         @default("prod")
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int      @map("organization_id")
  customerId     String   @map("customer_id") @db.Uuid
  authorUserId   String   @map("author_user_id") @db.Uuid
  body           String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     CrmCustomer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  author       Profile      @relation(fields: [authorUserId], references: [id], onDelete: NoAction)

  @@index([organizationId, customerId, createdAt], map: "crm_customer_notes_org_customer_idx")
  @@map("crm_customer_notes")
  @@schema("app_v3")
}

model CrmSegment {
  env                     String                         @default("prod")
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  Int               @map("organization_id")
  name            String
  description     String?
  rules           Json              @default("{}")
  status          CrmSegmentStatus  @default(ACTIVE)
  sizeCache       Int?              @map("size_cache")
  lastComputedAt  DateTime?         @map("last_computed_at") @db.Timestamptz(6)
  createdByUserId String?           @map("created_by_user_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      Profile?     @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  campaigns    CrmCampaign[]

  @@index([organizationId, status], map: "crm_segments_org_status_idx")
  @@map("crm_segments")
  @@schema("app_v3")
}

model CrmCampaign {
  env                     String                         @default("prod")
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  Int                @map("organization_id")
  segmentId       String?            @map("segment_id") @db.Uuid
  name            String
  description     String?
  channel         CrmCampaignChannel @default(IN_APP)
  status          CrmCampaignStatus  @default(DRAFT)
  payload         Json               @default("{}")
  scheduledAt     DateTime?          @map("scheduled_at") @db.Timestamptz(6)
  sentAt          DateTime?          @map("sent_at") @db.Timestamptz(6)
  sentCount       Int                @default(0) @map("sent_count")
  openedCount     Int                @default(0) @map("opened_count")
  clickedCount    Int                @default(0) @map("clicked_count")
  failedCount     Int                @default(0) @map("failed_count")
  createdByUserId String?            @map("created_by_user_id") @db.Uuid
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  segment      CrmSegment?  @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  creator      Profile?     @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  deliveries   CrmCampaignDelivery[]

  @@index([organizationId, status], map: "crm_campaigns_org_status_idx")
  @@map("crm_campaigns")
  @@schema("app_v3")
}

model CrmCampaignDelivery {
  env                     String                         @default("prod")
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int               @map("organization_id")
  campaignId     String            @map("campaign_id") @db.Uuid
  contactId      String            @map("contact_id") @db.Uuid
  userId         String?           @map("user_id") @db.Uuid
  notificationId String?           @map("notification_id") @db.Uuid
  status         CrmDeliveryStatus @default(SENT)
  sentAt         DateTime?         @map("sent_at") @db.Timestamptz(6)
  openedAt       DateTime?         @map("opened_at") @db.Timestamptz(6)
  clickedAt      DateTime?         @map("clicked_at") @db.Timestamptz(6)
  errorCode      String?           @map("error_code")
  errorMessage   String?           @map("error_message")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     CrmCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact      CrmContact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user         Profile?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  notification Notification? @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  @@unique([campaignId, contactId], map: "crm_campaign_deliveries_campaign_contact_unique")
  @@index([organizationId, campaignId], map: "crm_campaign_deliveries_org_campaign_idx")
  @@map("crm_campaign_deliveries")
  @@schema("app_v3")
}

model UserConsent {
  env                     String                         @default("prod")
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int           @map("organization_id")
  userId         String        @map("user_id") @db.Uuid
  type           ConsentType
  status         ConsentStatus
  source         String?       @map("source")
  grantedAt      DateTime?     @map("granted_at") @db.Timestamptz(6)
  revokedAt      DateTime?     @map("revoked_at") @db.Timestamptz(6)
  expiresAt      DateTime?     @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         Profile      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, type], map: "user_consents_org_user_type_unique")
  @@index([organizationId, type, status], map: "user_consents_org_type_status_idx")
  @@map("user_consents")
  @@schema("app_v3")
}

model DsarCase {
  env                     String                         @default("prod")
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String         @map("user_id") @db.Uuid
  type         DsarCaseType
  status       DsarCaseStatus @default(REQUESTED)
  requestedAt  DateTime       @default(now()) @map("requested_at") @db.Timestamptz(6)
  dueAt        DateTime?      @map("due_at") @db.Timestamptz(6)
  completedAt  DateTime?      @map("completed_at") @db.Timestamptz(6)
  metadata     Json?          @map("metadata")
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user         Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status], map: "dsar_cases_user_status_idx")
  @@map("dsar_cases")
  @@schema("app_v3")
}

model LoyaltyProgram {
  env                     String                         @default("prod")
  id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId   Int                  @map("organization_id")
  status           LoyaltyProgramStatus @default(ACTIVE)
  name             String               @default("Pontos ORYA")
  pointsName       String               @default("Pontos")
  pointsExpiryDays Int?                 @map("points_expiry_days")
  termsUrl         String?              @map("terms_url")
  createdAt        DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rules        LoyaltyRule[]
  rewards      LoyaltyReward[]
  ledger       LoyaltyLedger[]

  @@unique([organizationId], map: "loyalty_programs_org_unique")
  @@map("loyalty_programs")
  @@schema("app_v3")
}

model LoyaltyRule {
  env                     String                         @default("prod")
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  programId        String             @map("program_id") @db.Uuid
  name             String
  trigger          LoyaltyRuleTrigger
  points           Int
  maxPointsPerDay  Int?               @map("max_points_per_day")
  maxPointsPerUser Int?               @map("max_points_per_user")
  conditions       Json?              @default("{}")
  isActive         Boolean            @default(true) @map("is_active")
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  program LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  ledgerEntries LoyaltyLedger[]

  @@index([programId, trigger], map: "loyalty_rules_program_trigger_idx")
  @@map("loyalty_rules")
  @@schema("app_v3")
}

model LoyaltyReward {
  env                     String                         @default("prod")
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  programId  String             @map("program_id") @db.Uuid
  name       String
  type       LoyaltyRewardType
  pointsCost Int                @map("points_cost")
  stock      Int?               @map("stock")
  payload    Json?              @default("{}")
  isActive   Boolean            @default(true) @map("is_active")
  createdAt  DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime           @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  program LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  ledgerEntries LoyaltyLedger[]

  @@index([programId, isActive], map: "loyalty_rewards_program_active_idx")
  @@map("loyalty_rewards")
  @@schema("app_v3")
}

model LoyaltyLedger {
  env                     String                         @default("prod")
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId Int               @map("organization_id")
  programId      String            @map("program_id") @db.Uuid
  userId         String            @map("user_id") @db.Uuid
  ruleId         String?           @map("rule_id") @db.Uuid
  entryType      LoyaltyEntryType  @map("entry_type")
  points         Int
  balanceAfter   Int?              @map("balance_after")
  sourceType     LoyaltySourceType @map("source_type")
  sourceId       String?           @map("source_id") @db.Text
  rewardId       String?           @map("reward_id") @db.Uuid
  dedupeKey      String?           @unique @map("dedupe_key")
  note           String?           @db.Text
  expiresAt      DateTime?         @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  program      LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  user         Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)
  rule         LoyaltyRule?   @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  reward       LoyaltyReward? @relation(fields: [rewardId], references: [id], onDelete: SetNull)

  @@index([organizationId, userId, createdAt], map: "loyalty_ledger_org_user_time_idx")
  @@index([programId, createdAt], map: "loyalty_ledger_program_time_idx")
  @@index([programId, ruleId], map: "loyalty_ledger_program_rule_idx")
  @@index([sourceType, sourceId], map: "loyalty_ledger_source_idx")
  @@map("loyalty_ledger")
  @@schema("app_v3")
}

enum NotificationType {
  ORGANIZATION_INVITE
  ORGANIZATION_TRANSFER
  PAIRING_INVITE
  EVENT_SALE
  EVENT_PAYOUT_STATUS
  STRIPE_STATUS
  BOOKING_CHANGE_REQUEST
  BOOKING_CHANGE_RESPONSE
  FOLLOW_REQUEST
  FOLLOW_ACCEPT
  EVENT_REMINDER
  EVENT_INVITE
  FRIEND_GOING_TO_EVENT
  CHECKIN_READY
  TICKET_SHARED
  MARKETING_PROMO_ALERT
  CRM_CAMPAIGN
  SYSTEM_ANNOUNCE
  FOLLOWED_YOU
  TICKET_TRANSFER_RECEIVED
  TICKET_TRANSFER_ACCEPTED
  TICKET_TRANSFER_DECLINED
  CLUB_INVITE
  NEW_EVENT_FROM_FOLLOWED_ORGANIZATION
  CHAT_AVAILABLE
  CHAT_OPEN
  CHAT_ANNOUNCEMENT
  CHAT_MESSAGE

  @@schema("app_v3")
}

enum ChatEntityType {
  EVENT
  BOOKING

  @@schema("app_v3")
}

enum ChatThreadStatus {
  ANNOUNCEMENTS
  OPEN
  READ_ONLY
  CLOSED

  @@schema("app_v3")
}

enum ChatMemberRole {
  PARTICIPANT
  ORG
  PLATFORM_ADMIN

  @@schema("app_v3")
}

enum ChatMessageKind {
  USER
  ANNOUNCEMENT
  SYSTEM

  @@schema("app_v3")
}

enum ChatInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED

  @@schema("app_v3")
}

enum ChatEventInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED

  @@schema("app_v3")
}

enum ChatConversationContextType {
  ORG_CHANNEL
  ORG_CONTACT
  EVENT
  BOOKING
  SERVICE
  USER_DM
  USER_GROUP

  @@schema("app_v3")
}

enum ChatConversationRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED

  @@schema("app_v3")
}

enum ChatMemberDisplayAs {
  ORGANIZATION
  PROFESSIONAL

  @@schema("app_v3")
}

enum ChatConversationType {
  DIRECT
  GROUP
  CHANNEL

  @@schema("app_v3")
}

enum ChatChannelRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED

  @@schema("app_v3")
}

enum ChatConversationNotificationLevel {
  ALL
  MENTIONS_ONLY
  OFF

  @@schema("app_v3")
}

enum ChatConversationMessageKind {
  TEXT
  SYSTEM
  ANNOUNCEMENT

  @@schema("app_v3")
}

enum ChatAccessGrantKind {
  EVENT_INVITE
  USER_DM_REQUEST
  ORG_CONTACT_REQUEST
  SERVICE_REQUEST
  CHANNEL_CREATE_REQUEST

  @@schema("app_v3")
}

enum ChatAccessGrantStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  EXPIRED
  REVOKED
  AUTO_ACCEPTED

  @@schema("app_v3")
}

enum ChatConversationMemberRole {
  MEMBER
  ADMIN

  @@schema("app_v3")
}

enum ChatAttachmentType {
  IMAGE
  VIDEO
  FILE

  @@schema("app_v3")
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH

  @@schema("app_v3")
}

enum PaymentStatus {
  CREATED
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  PARTIAL_REFUND
  REFUNDED
  DISPUTED
  CHARGEBACK_WON
  CHARGEBACK_LOST

  @@schema("app_v3")
}

enum SaleSummaryStatus {
  PAID
  REFUNDED
  DISPUTED
  PARTIAL_REFUND
  FAILED
  CANCELLED

  @@schema("app_v3")
}

enum ProcessorFeesStatus {
  PENDING
  FINAL

  @@schema("app_v3")
}

enum LedgerEntryType {
  GROSS
  PLATFORM_FEE
  PROCESSOR_FEES_FINAL
  PROCESSOR_FEES_ADJUSTMENT
  DISPUTE_FEE
  DISPUTE_FEE_REVERSAL
  REFUND_GROSS
  REFUND_PLATFORM_FEE_REVERSAL
  REFUND_PROCESSOR_FEES_REVERSAL
  CHARGEBACK_GROSS
  CHARGEBACK_PLATFORM_FEE_REVERSAL

  @@schema("app_v3")
}

enum TicketOrderStatus {
  DRAFT
  READY_FOR_CHECKOUT
  CANCELLED

  @@schema("app_v3")
}

enum PadelRegistrationStatus {
  PENDING_PARTNER
  PENDING_PAYMENT
  MATCHMAKING
  CONFIRMED
  EXPIRED
  CANCELLED
  REFUNDED

  @@schema("app_v3")
}

enum SourceType {
  TICKET_ORDER
  BOOKING
  PADEL_REGISTRATION
  STORE_ORDER
  SUBSCRIPTION
  MEMBERSHIP
  EVENT
  TOURNAMENT
  MATCH
  CLASS_SESSION
  LOYALTY_TX
  SOFT_BLOCK
  HARD_BLOCK

  @@schema("app_v3")
}

enum MediaOwnerType {
  USER
  ORGANIZATION
  SYSTEM

  @@schema("app_v3")
}

enum SoftBlockScope {
  ORGANIZATION
  PROFESSIONAL
  RESOURCE
  COURT

  @@schema("app_v3")
}

enum SearchIndexVisibility {
  PUBLIC
  HIDDEN

  @@schema("app_v3")
}

enum PublicApiScope {
  EVENTS_READ
  TOURNAMENTS_READ
  AGENDA_READ
  ANALYTICS_READ
  OPS_READ

  @@schema("app_v3")
}

enum OrgType {
  PLATFORM
  EXTERNAL

  @@schema("app_v3")
}


enum OrganizationMemberRole {
  OWNER
  CO_OWNER
  ADMIN
  STAFF
  TRAINER
  PROMOTER
  VIEWER

  @@schema("app_v3")
}

enum OrganizationRolePack {
  CLUB_MANAGER
  TOURNAMENT_DIRECTOR
  FRONT_DESK
  COACH
  REFEREE

  @@schema("app_v3")
}

enum OrganizationPermissionLevel {
  NONE
  VIEW
  EDIT

  @@schema("app_v3")
}

enum OrganizationOwnerTransferStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED

  @@schema("app_v3")
}

enum TrainerProfileReviewStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED

  @@schema("app_v3")
}

enum PaymentMode {
  LIVE
  TEST

  @@schema("app_v3")
}

enum PaymentEventSource {
  WEBHOOK
  JOB
  API

  @@schema("app_v3")
}

enum OperationStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  DEAD_LETTER

  @@schema("app_v3")
}

enum PadelPreferredSide {
  ESQUERDA
  DIREITA
  QUALQUER

  @@schema("app_v3")
}

enum PadelClubKind {
  OWN
  PARTNER

  @@schema("app_v3")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
enum OrganizationStatus {
  PENDING
  ACTIVE
  SUSPENDED

  @@schema("app_v3")
}

enum EventType {
  ORGANIZATION_EVENT

  @@schema("app_v3")
}

enum Visibility {
  PUBLIC
  FOLLOWERS
  PRIVATE

  @@schema("app_v3")
}


enum LiveHubVisibility {
  PUBLIC
  PRIVATE
  DISABLED

  @@schema("app_v3")
}

enum EventInviteScope {
  PUBLIC
  PARTICIPANT

  @@schema("app_v3")
}

enum AccountStatus {
  ACTIVE
  PENDING_DELETE
  DELETED

  @@schema("app_v3")
}

enum EventTemplateType {
  PARTY
  VOLUNTEERING
  TALK
  OTHER
  PADEL

  @@schema("app_v3")
}

enum LocationSource {
  APPLE_MAPS
  MANUAL

  @@schema("app_v3")
}

enum LocationConsent {
  PENDING
  GRANTED
  DENIED

  @@schema("app_v3")
}

enum LocationGranularity {
  PRECISE
  COARSE

  @@schema("app_v3")
}

enum UserLocationSource {
  GPS
  WIFI
  IP
  MANUAL

  @@schema("app_v3")
}


enum OrganizationModule {
  EVENTOS
  RESERVAS
  TORNEIOS
  STAFF
  FINANCEIRO
  MENSAGENS
  CRM
  MARKETING
  LOJA
  ANALYTICS
  DEFINICOES
  PERFIL_PUBLICO
  INSCRICOES

  @@schema("app_v3")
}

enum InvoicingMode {
  EXTERNAL_SOFTWARE
  MANUAL_OUTSIDE_ORYA

  @@schema("app_v3")
}

enum OrganizationFormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@schema("app_v3")
}

enum AnalyticsMetricKey {
  GROSS
  PLATFORM_FEES
  PROCESSOR_FEES
  NET_TO_ORG

  @@schema("app_v3")
}

enum AnalyticsDimensionKey {
  MODULE
  SOURCE_TYPE
  PAYMENT_PROVIDER
  CURRENCY

  @@schema("app_v3")
}

model AnalyticsRollup {
  env                     String                         @default("prod")
  id             Int                  @id @default(autoincrement())
  organizationId Int                  @map("organization_id")
  bucketDate     DateTime             @map("bucket_date") @db.Date
  metricKey      AnalyticsMetricKey   @map("metric_key")
  dimensionKey   AnalyticsDimensionKey @map("dimension_key")
  dimensionValue String               @map("dimension_value")
  value          Int                  @map("value")
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, bucketDate, metricKey, dimensionKey, dimensionValue], map: "analytics_rollup_unique")
  @@index([organizationId, bucketDate], map: "analytics_rollup_org_bucket_idx")
  @@map("analytics_rollups")
  @@schema("app_v3")
}

enum StoreStatus {
  DRAFT
  CLOSED
  ACTIVE

  @@schema("app_v3")
}

enum StoreShippingMode {
  FLAT
  VALUE_TIERS

  @@schema("app_v3")
}

enum StoreVisibility {
  PUBLIC
  HIDDEN
  ARCHIVED

  @@schema("app_v3")
}

enum StoreStockPolicy {
  NONE
  TRACKED

  @@schema("app_v3")
}

enum StoreProductOptionType {
  TEXT
  SELECT
  NUMBER
  CHECKBOX

  @@schema("app_v3")
}

enum StoreBundlePricingMode {
  FIXED
  PERCENT_DISCOUNT

  @@schema("app_v3")
}

enum EventPricingMode {
  STANDARD
  FREE_ONLY

  @@schema("app_v3")
}

enum StoreCartStatus {
  ACTIVE
  CHECKOUT_LOCKED
  ABANDONED

  @@schema("app_v3")
}

enum StoreOrderStatus {
  PENDING
  PAID
  FULFILLED
  CANCELLED
  REFUNDED
  PARTIAL_REFUND

  @@schema("app_v3")
}

enum StoreAddressType {
  SHIPPING
  BILLING

  @@schema("app_v3")
}

enum StoreShipmentStatus {
  PENDING
  SHIPPED
  DELIVERED

  @@schema("app_v3")
}

enum StoreInventoryMovementType {
  ADJUST
  SALE
  REFUND
  RETURN

  @@schema("app_v3")
}

enum OrganizationFormFieldType {
  TEXT
  TEXTAREA
  EMAIL
  PHONE
  NUMBER
  DATE
  SELECT
  CHECKBOX

  @@schema("app_v3")
}

enum OrganizationFormSubmissionStatus {
  SUBMITTED
  IN_REVIEW
  ACCEPTED
  WAITLISTED
  INVITED
  REJECTED

  @@schema("app_v3")
}



enum OrganizationKind {
  CLUBE_PADEL
  RESTAURANTE
  EMPRESA_EVENTOS
  ASSOCIACAO
  PESSOA_SINGULAR

  @@schema("app_v3")
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  FINISHED
  DATE_CHANGED

  @@schema("app_v3")
}

enum EventPublicAccessMode {
  OPEN
  TICKET
  INVITE

  @@schema("app_v3")
}

enum EventParticipantAccessMode {
  NONE
  TICKET
  INSCRIPTION
  INVITE

  @@schema("app_v3")
}

enum ResaleMode {
  ALWAYS
  AFTER_SOLD_OUT
  DISABLED

  @@schema("app_v3")
}

enum AddressSourceProvider {
  APPLE_MAPS
  MANUAL

  @@schema("app_v3")
}

enum AddressValidationStatus {
  RAW
  NORMALIZED
  VERIFIED

  @@schema("app_v3")
}

enum RefundFeePayer {
  ORGANIZATION
  CUSTOMER

  @@schema("app_v3")
}

enum RefundReason {
  CANCELLED
  DELETED
  DATE_CHANGED

  @@schema("app_v3")
}

enum PadelPaymentMode {
  FULL
  SPLIT

  @@schema("app_v3")
}

// Enum legacy removido (SSOT = PadelRegistration.status)

enum PadelPairingJoinMode {
  INVITE_PARTNER
  LOOKING_FOR_PARTNER

  @@schema("app_v3")
}

enum PadelEligibilityType {
  OPEN
  MALE_ONLY
  FEMALE_ONLY
  MIXED

  @@schema("app_v3")
}

enum PadelTournamentLifecycleStatus {
  DRAFT
  PUBLISHED
  LOCKED
  LIVE
  COMPLETED
  CANCELLED

  @@schema("app_v3")
}

enum PadelTournamentRole {
  DIRECTOR
  REFEREE
  SCOREKEEPER
  STREAMER

  @@schema("app_v3")
}

enum PadelTeamRole {
  CAPTAIN
  PLAYER
  COACH
  MANAGER

  @@schema("app_v3")
}

enum PadelTeamMemberStatus {
  ACTIVE
  INVITED
  REMOVED

  @@schema("app_v3")
}

enum PadelTeamEntryStatus {
  PENDING
  CONFIRMED
  CANCELLED

  @@schema("app_v3")
}

enum PadelCommunityPostKind {
  ANNOUNCEMENT
  HIGHLIGHT
  QUESTION

  @@schema("app_v3")
}

enum PadelCommunityVisibility {
  CLUB_MEMBERS
  PUBLIC

  @@schema("app_v3")
}

enum PadelPairingStatus {
  INCOMPLETE
  COMPLETE
  CANCELLED

  @@schema("app_v3")
}

enum PadelPairingGuaranteeStatus {
  NONE
  ARMED
  SCHEDULED
  SUCCEEDED
  REQUIRES_ACTION
  FAILED
  EXPIRED

  @@schema("app_v3")
}

enum PadelPairingSlotStatus {
  PENDING
  FILLED
  CANCELLED

  @@schema("app_v3")
}

enum PadelPairingHoldStatus {
  ACTIVE
  CANCELLED
  EXPIRED

  @@schema("app_v3")
}

enum PadelWaitlistStatus {
  PENDING
  PROMOTED
  CANCELLED
  EXPIRED

  @@schema("app_v3")
}

enum TournamentEntryRole {
  CAPTAIN
  PARTNER

  @@schema("app_v3")
}

enum TournamentEntryStatus {
  PENDING
  CONFIRMED
  CANCELLED

  @@schema("app_v3")
}

enum TournamentFormat {
  GROUPS_PLUS_PLAYOFF
  DRAW_A_B
  GROUPS_PLUS_FINALS_ALL_PLACES
  CHAMPIONSHIP_ROUND_ROBIN
  NONSTOP_ROUND_ROBIN
  MANUAL

  @@schema("app_v3")
}

enum TournamentStageType {
  GROUPS
  PLAYOFF
  CONSOLATION
  NONSTOP

  @@schema("app_v3")
}

enum TournamentMatchStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  DONE
  DISPUTED
  CANCELLED

  @@schema("app_v3")
}

enum PadelPairingPaymentStatus {
  UNPAID
  PAID

  @@schema("app_v3")
}

enum PadelPairingSlotRole {
  CAPTAIN
  PARTNER

  @@schema("app_v3")
}

enum FeeMode {
  INCLUDED
  ADDED
  ON_TOP

  @@schema("app_v3")
}

enum PayoutMode {
  ORGANIZATION
  PLATFORM

  @@schema("app_v3")
}


enum PromoType {
  PERCENTAGE
  FIXED

  @@schema("app_v3")
}

enum TicketTypeStatus {
  ON_SALE
  UPCOMING
  CLOSED
  SOLD_OUT

  @@schema("app_v3")
}

enum TicketStatus {
  ACTIVE
  REFUNDED
  TRANSFERRED
  RESALE_LISTED
  DISPUTED
  CHARGEBACK_LOST
  CANCELLED

  @@schema("app_v3")
}

enum ReservationStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELED

  @@schema("app_v3")
}

enum ResaleStatus {
  LISTED
  SOLD
  CANCELLED

  @@schema("app_v3")
}

enum padel_format {
  TODOS_CONTRA_TODOS
  QUADRO_ELIMINATORIO
  GRUPOS_ELIMINATORIAS
  CAMPEONATO_LIGA
  QUADRO_AB
  DUPLA_ELIMINACAO
  NON_STOP

  @@schema("app_v3")
}

enum padel_match_status {
  PENDING
  IN_PROGRESS
  DONE
  CANCELLED

  @@schema("app_v3")
}

enum EntitlementStatus {
  PENDING
  ACTIVE
  REVOKED
  EXPIRED
  SUSPENDED

  @@map("entitlement_status")
  @@schema("app_v3")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
  CANCELLED

  @@schema("app_v3")
}

enum InvoiceKind {
  CONSUMER
  PLATFORM_FEE

  @@schema("app_v3")
}

enum PayoutStatus {
  PENDING
  RELEASED
  FAILED
  CANCELLED

  @@schema("app_v3")
}

model Invoice {
  env                     String                         @default("prod")
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    Int                 @map("organization_id")
  customerIdentityId String?            @map("customer_identity_id") @db.Uuid
  sourceType        SourceType          @map("source_type")
  sourceId          String              @map("source_id") @db.Text
  kind              InvoiceKind         @default(CONSUMER)
  status            InvoiceStatus       @default(ISSUED)
  invoiceNumber     String?             @map("invoice_number")
  currency          String              @default("EUR")
  amountCents       Int                 @map("amount_cents")
  issuedAt          DateTime?           @map("issued_at") @db.Timestamptz(6)
  paidAt            DateTime?           @map("paid_at") @db.Timestamptz(6)
  metadata          Json?               @default("{}")
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "invoices_org_idx")
  @@index([sourceType, sourceId], map: "invoices_source_idx")
  @@index([invoiceNumber], map: "invoices_number_idx")
  @@map("invoices")
  @@schema("app_v3")
}

model Payout {
  env                     String                         @default("prod")
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    Int                 @map("organization_id")
  sourceType        String?             @map("source_type")
  sourceId          String?             @map("source_id")
  paymentId         String?             @map("payment_id")
  paymentIntentId   String?             @map("payment_intent_id")
  transferId        String?             @map("transfer_id")
  currency          String              @default("EUR")
  grossAmountCents  Int?                @map("gross_amount_cents")
  platformFeeCents  Int?                @map("platform_fee_cents")
  feeMode           FeeMode?            @map("fee_mode")
  amountCents       Int                 @map("amount_cents")
  status            PayoutStatus        @default(PENDING)
  releasedAt        DateTime?           @map("released_at") @db.Timestamptz(6)
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId], map: "payouts_org_idx")
  @@index([paymentIntentId], map: "payouts_pi_idx")
  @@map("payouts")
  @@schema("app_v3")
}

enum EntitlementType {
  EVENT_TICKET
  PADEL_ENTRY
  SERVICE_BOOKING
  STORE_ITEM
  PASS
  SUBSCRIPTION_ACCESS
  FUTURE_TYPE

  @@map("entitlement_type")
  @@schema("app_v3")
}

enum CheckinResultCode {
  OK
  ALREADY_USED
  INVALID
  REVOKED
  SUSPENDED
  NOT_ALLOWED
  OUTSIDE_WINDOW

  @@map("checkin_result_code")
  @@schema("app_v3")
}

enum CheckinMethod {
  QR_TICKET
  QR_REGISTRATION
  QR_BOOKING
  MANUAL

  @@map("checkin_method")
  @@schema("app_v3")
}

enum EventAccessMode {
  PUBLIC
  INVITE_ONLY
  UNLISTED

  @@map("event_access_mode")
  @@schema("app_v3")
}

enum InviteIdentityMatch {
  EMAIL
  USERNAME
  BOTH

  @@map("invite_identity_match")
  @@schema("app_v3")
}

enum Gender {
  MALE
  FEMALE

  @@schema("app_v3")
}

enum UserActivityType {
  RSVP
  TICKET_PURCHASE
  PADEL_ACHIEVEMENT
  BOOKING_CREATED

  @@schema("app_v3")
}

enum UserEventSignalType {
  CLICK
  VIEW
  DWELL
  FAVORITE
  PURCHASE
  HIDE_EVENT
  HIDE_CATEGORY
  HIDE_ORG

  @@schema("app_v3")
}

enum OrganizationPolicyType {
  FLEXIBLE
  MODERATE
  RIGID
  CUSTOM

  @@schema("app_v3")
}

enum AvailabilityStatus {
  OPEN
  FULL
  CANCELLED

  @@schema("app_v3")
}

enum BookingStatus {
  PENDING_CONFIRMATION
  PENDING
  CONFIRMED
  CANCELLED
  CANCELLED_BY_CLIENT
  CANCELLED_BY_ORG
  COMPLETED
  NO_SHOW
  DISPUTED

  @@schema("app_v3")
}

enum BookingChangeRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED

  @@schema("app_v3")
}

enum BookingChangeRequestedBy {
  ORG
  USER

  @@schema("app_v3")
}

enum ClassSessionStatus {
  SCHEDULED
  CANCELLED
  COMPLETED

  @@schema("app_v3")
}

enum BookingInviteStatus {
  PENDING
  ACCEPTED
  DECLINED

  @@schema("app_v3")
}

enum BookingParticipantStatus {
  CONFIRMED
  CANCELLED

  @@schema("app_v3")
}

enum BookingSplitStatus {
  OPEN
  COMPLETED
  EXPIRED
  CANCELLED

  @@schema("app_v3")
}

enum BookingSplitPricingMode {
  FIXED
  DYNAMIC

  @@schema("app_v3")
}

enum BookingChargeStatus {
  OPEN
  PAID
  CANCELLED

  @@schema("app_v3")
}

enum BookingChargeKind {
  BASE
  DEPOSIT
  EXTRA
  SPLIT_PART

  @@schema("app_v3")
}

enum BookingChargePayerKind {
  ORGANIZER
  INVITEE

  @@schema("app_v3")
}

enum BookingSplitParticipantStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED

  @@schema("app_v3")
}

enum ReservationAssignmentMode {
  PROFESSIONAL
  RESOURCE

  @@schema("app_v3")
}

enum AvailabilityScopeType {
  ORGANIZATION
  PROFESSIONAL
  RESOURCE

  @@schema("app_v3")
}

enum ServiceLocationMode {
  FIXED
  CHOOSE_AT_BOOKING

  @@schema("app_v3")
}

enum ServiceCreditBalanceStatus {
  ACTIVE
  DEPLETED
  EXPIRED

  @@schema("app_v3")
}

enum ServiceCreditLedgerType {
  PURCHASE
  CONSUME
  REFUND_CREDIT
  EXPIRE
  ADMIN_ADJUST

  @@schema("app_v3")
}

enum AvailabilityOverrideKind {
  CLOSED
  OPEN
  BLOCK

  @@schema("app_v3")
}

enum ServiceKind {
  GENERAL
  COURT
  CLASS

  @@schema("app_v3")
}

enum CrmCustomerStatus {
  ACTIVE
  SUPPRESSED
  DELETED

  @@schema("app_v3")
}

enum CrmContactStatus {
  ACTIVE
  SUPPRESSED
  DELETED

  @@schema("app_v3")
}

enum CrmContactType {
  CUSTOMER
  FOLLOWER
  LEAD
  GUEST
  STAFF

  @@schema("app_v3")
}

enum CrmContactLegalBasis {
  CONSENT
  CONTRACT
  LEGITIMATE_INTEREST

  @@schema("app_v3")
}

enum CrmInteractionType {
  EVENT_TICKET
  EVENT_CHECKIN
  PADEL_TOURNAMENT_ENTRY
  PADEL_MATCH_PAYMENT
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_COMPLETED
  STORE_ORDER_PAID
  STORE_ORDER_REFUNDED
  MEMBERSHIP_STARTED
  MEMBERSHIP_RENEWED
  MEMBERSHIP_CANCELLED
  MANUAL_ADJUSTMENT
  ORG_FOLLOWED
  ORG_UNFOLLOWED
  PROFILE_VIEWED
  EVENT_VIEWED
  EVENT_SAVED
  FORM_SUBMITTED

  @@schema("app_v3")
}

enum CrmInteractionSource {
  EVENT
  TICKET
  CHECKIN
  BOOKING
  STORE_ORDER
  TOURNAMENT_ENTRY
  MEMBERSHIP
  TRANSACTION
  MANUAL
  ORGANIZATION
  PROFILE
  FORM
  SOCIAL

  @@schema("app_v3")
}

enum CrmSegmentStatus {
  ACTIVE
  PAUSED
  ARCHIVED

  @@schema("app_v3")
}

enum CrmCampaignChannel {
  IN_APP

  @@schema("app_v3")
}

enum CrmCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED

  @@schema("app_v3")
}

enum CrmDeliveryStatus {
  SENT
  OPENED
  CLICKED
  FAILED

  @@schema("app_v3")
}

enum ConsentType {
  MARKETING
  CONTACT_EMAIL
  CONTACT_SMS
  DATA_SHARING

  @@schema("app_v3")
}

enum ConsentStatus {
  GRANTED
  REVOKED
  EXPIRED

  @@schema("app_v3")
}

enum DsarCaseType {
  EXPORT
  DELETE

  @@schema("app_v3")
}

enum DsarCaseStatus {
  REQUESTED
  IN_PROGRESS
  COMPLETED
  REJECTED

  @@schema("app_v3")
}

enum LoyaltyProgramStatus {
  ACTIVE
  PAUSED
  DISABLED

  @@schema("app_v3")
}

enum LoyaltyRuleTrigger {
  STORE_ORDER_PAID
  BOOKING_COMPLETED
  EVENT_CHECKIN
  TOURNAMENT_PARTICIPATION
  MEMBERSHIP_RENEWAL

  @@schema("app_v3")
}

enum LoyaltyRewardType {
  DISCOUNT
  FREE_CLASS
  FREE_EVENT
  STORE_CREDIT
  PRODUCT
  EARLY_ACCESS

  @@schema("app_v3")
}

enum LoyaltyEntryType {
  EARN
  SPEND
  ADJUST
  EXPIRE

  @@schema("app_v3")
}

enum LoyaltySourceType {
  ORDER
  BOOKING
  CHECKIN
  TOURNAMENT
  MEMBERSHIP
  REWARD
  MANUAL

  @@schema("app_v3")
}
