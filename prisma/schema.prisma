datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Event {
  id            Int       @id @default(autoincrement())
  slug          String    @unique
  title         String
  description   String
  startDate     DateTime
  endDate       DateTime
  locationName  String
  address       String
  isFree        Boolean   @default(false)
  basePrice     Int?
  timezone      String    @default("Europe/Lisbon")
  coverImageUrl String?
  organizerName String?

  /// ðŸ‘‡ NOVO CAMPO â€“ quem criou o evento (Supabase user id)
  organizerId   String?   // id do utilizador do Supabase que criou o evento

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tickets   Ticket[]
  purchases TicketPurchase[]
  reservations TicketReservation[]
  interests   EventInterest[]
}

model Ticket {
  id      String @id @default(cuid())
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId Int

  name        String
  description String?
  price       Int
  currency    String  @default("EUR")
  available   Boolean @default(true)

  // Waves / stock
  isVisible     Boolean   @default(true)
  totalQuantity Int?      // null = stock ilimitado
  soldQuantity  Int       @default(0)
  startsAt      DateTime?
  endsAt        DateTime?
  sortOrder     Int       @default(0)

  purchases TicketPurchase[]
  reservations TicketReservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketPurchase {
  id        String  @id @default(cuid())

  ticket    Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId  String

  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   Int

  // ðŸ‘‡ id do utilizador Supabase (opcional)
  userId    String? // Supabase auth user id (nullable)

  quantity  Int
  pricePaid Int
  currency  String @default("EUR")

  /// Stripe PaymentIntent ID (para reconciliar pagamentos)
  stripePaymentIntentId String? @unique

  /// Token Ãºnico para gerar e validar QR Codes
  qrToken   String?  @unique

  createdAt DateTime @default(now())
}

enum ReservationStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELED
}

model TicketReservation {
  id        String            @id @default(cuid())

  ticket    Ticket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId  String

  event     Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   Int

  userId    String?           // Supabase user id (nullable)

  quantity  Int

  status    ReservationStatus @default(ACTIVE)
  expiresAt DateTime

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([ticketId])
  @@index([eventId])
  @@index([userId])
  @@index([status, expiresAt])
}

model EventInterest {
  id        String   @id @default(cuid())

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   Int

  userId    String   // Supabase auth user id (obrigatÃ³rio para interesse)

  createdAt DateTime @default(now())

  @@unique([eventId, userId])
  @@index([userId])
}