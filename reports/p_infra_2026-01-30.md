# P1 Infra Progress — 2026-01-30

## Status
PARTIAL — hosted zone + ACM + S3/CloudFront created. BLOCKED on CodeBuild Next.js build failure (module `tls` in client bundle).

## Autodiscovery (eu-west-1)
- VPC: vpc-034a95d2f825f22dd (default, 172.31.0.0/16)
- Subnets (public, no NAT):
  - subnet-040edfb7592af78d3 (eu-west-1a)
  - subnet-0febbb37d114cdf1d (eu-west-1b)
  - subnet-08161dd803de79bbd (eu-west-1c)
- NAT gateways: none (default VPC)
- Service subnets (picked): subnet-040edfb7592af78d3, subnet-0febbb37d114cdf1d

## Route53 Hosted Zone
- HostedZoneId: Z01063466077T62XP3HQ
- NS (delegation set):
  - ns-633.awsdns-15.net
  - ns-430.awsdns-53.com
  - ns-1234.awsdns-26.org
  - ns-1742.awsdns-25.co.uk

## ACM Certificates
- eu-west-1 ARN: arn:aws:acm:eu-west-1:495219734037:certificate/ad0e6d9f-cbb2-41a4-a2f7-6f8c27e0885e (Status: PENDING_VALIDATION)
- us-east-1 ARN: arn:aws:acm:us-east-1:495219734037:certificate/ca75794b-551c-4c4c-9597-6255df3239d8 (Status: PENDING_VALIDATION)
- Validation CNAMEs (Route53):
  - _ae9e91c61b9ec7d94ca973c6466ec7ad.orya.pt → _1c009cc8041583cd07fa90a5566800bd.jkddzztszm.acm-validations.aws.
  - _acdc8a05c284dcdef34d95ba71b699f5.admin.orya.pt → _e59c5765592287ad511bdeb724a95dea.jkddzztszm.acm-validations.aws.
  - _2b7ba3446c5e758232d9421e403a731f.app.orya.pt → _fd639cb4169f5d10456fdb8fe5903aa6.jkddzztszm.acm-validations.aws.

## /.well-known (AASA / Apple Pay)
- S3 bucket: orya-app-well-known-prod (eu-west-1)
- CloudFront distribution: E3B1FR4NMF6N3P
- CloudFront domain: d1rmccunresrvd.cloudfront.net (Status: InProgress)
- URLs (after deploy):
  - https://d1rmccunresrvd.cloudfront.net/.well-known/apple-app-site-association
  - https://d1rmccunresrvd.cloudfront.net/.well-known/apple-developer-merchantid-domain-association

## Secrets
Created/confirmed dev groups (updated):
- orya/dev/app
- orya/dev/supabase
- orya/dev/payments
- orya/dev/apple
- orya/dev/email
- orya/dev/admin

Created/confirmed prod groups (previous step):
- orya/prod/app
- orya/prod/supabase
- orya/prod/payments
- orya/prod/apple
- orya/prod/email
- orya/prod/admin

## ECR
- Repos: orya-web, orya-worker
- Lifecycle policy (keep last 5) applied to both.
- Images: none (CodeBuild failed during `npm run build`).

## CodeBuild (build-and-push via BUILD_GENERAL1_LARGE)
- S3 source bucket: orya-codebuild-src-495219734037-eu-west-1 (object: orya-codebuild-src.zip)
- IAM role: arn:aws:iam::495219734037:role/orya-codebuild-role
- Project: orya-build-push
- Build attempts:
  - orya-build-push:a2fedf6b-3896-472c-92dc-073abc0a5f16 (FAILED: profile codex missing)
  - orya-build-push:cf0001ae-2279-43dc-875e-7ab7855c8e82 (FAILED: Next.js build error: `Module not found: Can't resolve 'tls'`)

## AWS Operations (requestId/correlationId)
- sts:get-caller-identity (using AWS_PROFILE=codex) — OK
- ec2:describe-vpcs — requestId 22c4957f-d609-4fe6-a59a-5315c02b6183
- ec2:describe-subnets — requestId 13f5d596-1d0e-416f-ab37-39b1af89f1ab
- ec2:describe-nat-gateways — requestId efe36e73-1182-40ce-a3de-00c135f2500c
- route53:create-hosted-zone — requestId 3c80710b-033c-4e26-8f30-273545bf81ea
- route53:get-hosted-zone — requestId 54db1f54-4445-40ae-aa26-526be5e4be90
- acm:request-certificate (eu-west-1) — requestId 907e7189-8530-423d-b0f0-000749db0682
- acm:request-certificate (us-east-1) — requestId 88c77af2-14e2-44a6-a811-c425b03fcd10
- acm:describe-certificate (eu-west-1) — requestId 6454ae4e-b708-4244-8ff3-6dd6825b1985
- acm:describe-certificate (us-east-1) — requestId 3503a593-bb74-4a8e-9a39-fa42fe6dde2e
- route53:change-resource-record-sets (ACM CNAMEs) — requestIds 8fd7dc24-c928-4a55-95fd-864043c75c3a, 11b6318c-061f-4214-b9a3-c003f852df4e, e59bb841-35e8-4069-9b69-6a81c82187f8, c74256ff-7289-432d-8176-3333821fac5d, 43ffda9d-ee8b-48df-b545-eed2e78350e9, 62e288b0-fcfd-4f45-8e5c-400e601821bb
- s3:put-public-access-block — requestId Z0TQ9MA7CXGKCAX7
- s3:put-object (AASA) — requestId PXN8D1RDXP5TFNEQ
- s3:put-object (Apple Pay) — requestId PXNERTS75SH8E6WX
- cloudfront:create-origin-access-control — requestId 321e548e-9b3c-4696-ba4f-6fe377ac48db
- cloudfront:create-distribution — requestId 2e9d9967-0d1e-4798-ae8c-cbf0c866f69c
- s3:put-bucket-policy — requestId 8ZF3V54MM0JYZ0TE
- cloudfront:get-distribution — requestId a3cf45b6-5389-4d8f-82fc-33b9a3ea99a5
- secretsmanager:create-secret (dev delete test) — requestId aa78e38a-d1f4-42f6-b2b8-36b7f0e9e0dd
- secretsmanager:get-secret-value (dev delete test) — requestId 43a59b0a-d85d-4560-9422-30a6a1eed835
- secretsmanager:delete-secret (dev delete test) — requestId d5ca7dde-6ab9-45d7-b89a-bc84558060cb
- codebuild:create-project — requestId aa31897b-822b-4942-846d-27ae43887a66
- codebuild:start-build (attempt 1) — requestId 403f82e8-a036-486d-ac2f-ced43e7b45f5
- codebuild:start-build (attempt 2) — requestId ef6d1d12-4fd4-47b5-9730-1e066fe18df8

## Notes
- /etc/orya/codex_env returned InvalidClientTokenId. Used AWS_PROFILE=codex fallback to proceed.

## Blockers
1) CodeBuild failed: Next.js build error `Module not found: Can't resolve 'tls'` from `pg` import in client component (see build logs for `orya-build-push:cf0001ae-2279-43dc-875e-7ab7855c8e82`).
2) Budgets/alerts require BudgetNotificationEmail (not provided) if we want CFN to create budgets.

## Next steps once unblocked
- Fix Next.js build error (`pg`/`tls` in client bundle): move `lib/prisma` usage to server-only or remove client import chain from `app/organizacao/(dashboard)/eventos/novo/page.tsx`.
- Re-run CodeBuild to publish ECR images.
- Deploy dev stack (`scripts/deploy-dev.sh` with ImageUri from ECR) and prod CFN (`scripts/deploy-cf.sh --with-alb true`).
- Run migrations + healthcheck + E2E; update reports/p1_closeout_2026-01-30.md.
