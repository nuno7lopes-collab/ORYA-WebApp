# P1 Infra Progress — 2026-01-30

## Status
DONE — Route53 hosted zone + ACM (eu-west-1/us-east-1) issued, CloudFront deployed, ECR images pushed via CodeBuild, CFN stack deployed with ALB, healthcheck OK (/api/internal/ops/health).

## Autodiscovery (eu-west-1)
- VPC: vpc-034a95d2f825f22dd (default, 172.31.0.0/16)
- Subnets (public, no NAT):
  - subnet-040edfb7592af78d3 (eu-west-1a)
  - subnet-0febbb37d114cdf1d (eu-west-1b)
  - subnet-08161dd803de79bbd (eu-west-1c)
- NAT gateways: none (default VPC)
- Service subnets (picked): subnet-040edfb7592af78d3, subnet-0febbb37d114cdf1d

## Route53 Hosted Zone
- HostedZoneId: Z01063466077T62XP3HQ
- NS (delegation set):
  - ns-633.awsdns-15.net
  - ns-430.awsdns-53.com
  - ns-1234.awsdns-26.org
  - ns-1742.awsdns-25.co.uk

## ACM Certificates
- eu-west-1 ARN: arn:aws:acm:eu-west-1:495219734037:certificate/ad0e6d9f-cbb2-41a4-a2f7-6f8c27e0885e (Status: ISSUED)
- us-east-1 ARN: arn:aws:acm:us-east-1:495219734037:certificate/ca75794b-551c-4c4c-9597-6255df3239d8 (Status: ISSUED)
- Validation CNAMEs (Route53):
  - _ae9e91c61b9ec7d94ca973c6466ec7ad.orya.pt → _1c009cc8041583cd07fa90a5566800bd.jkddzztszm.acm-validations.aws.
  - _acdc8a05c284dcdef34d95ba71b699f5.admin.orya.pt → _e59c5765592287ad511bdeb724a95dea.jkddzztszm.acm-validations.aws.
  - _2b7ba3446c5e758232d9421e403a731f.app.orya.pt → _fd639cb4169f5d10456fdb8fe5903aa6.jkddzztszm.acm-validations.aws.

## /.well-known (AASA / Apple Pay)
- S3 bucket: orya-app-well-known-prod (eu-west-1)
- CloudFront distribution: E3B1FR4NMF6N3P (Status: Deployed)
- CloudFront domain: d1rmccunresrvd.cloudfront.net
- URLs:
  - https://d1rmccunresrvd.cloudfront.net/.well-known/apple-app-site-association
  - https://d1rmccunresrvd.cloudfront.net/.well-known/apple-developer-merchantid-domain-association

## Secrets
Groups confirmed/updated (prod):
- orya/prod/app (added: ICS_SECRET_KEY, MAPKIT_JS_KEY_ID, MAPKIT_JS_PRIVATE_KEY_BASE64, SENTRY_DSN, ALERTS_SNS_TOPIC_ARN)
- orya/prod/apple (added: APPLE_PAY_CERTIFICATE_BASE64, APPLE_PAY_DOMAIN_VERIFICATION_FILE, APPLE_PAY_MERCHANT_ID)
- orya/prod/email (added: SES_SMTP_USERNAME, SES_SMTP_PASSWORD)
- orya/prod/admin (added: STAGING_ADMIN_SESSION, DEVICE_FARM_USER, DEVICE_FARM_KEY)
- orya/prod/supabase
- orya/prod/payments

Groups confirmed (dev):
- orya/dev/app
- orya/dev/supabase
- orya/dev/payments
- orya/dev/apple
- orya/dev/email
- orya/dev/admin

## ECR
- Repos: orya-web, orya-worker (lifecycle keep last 5)
- Images (CodeBuild):
  - 495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-web:20260130212036
  - 495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-worker:20260130212036

## CodeBuild (build-and-push via BUILD_GENERAL1_LARGE)
- S3 source bucket: orya-codebuild-src-495219734037-eu-west-1 (object: orya-codebuild-src.zip)
- IAM role: arn:aws:iam::495219734037:role/orya-codebuild-role
- Project: orya-build-push
- Build attempts:
  - orya-build-push:7e364eb9-fa80-46a8-826b-17909718ed43 (FAILED: old source zip — pg/tls in client bundle)
  - orya-build-push:c804c972-4dd1-42af-a42f-46137c58bef3 (FAILED: env missing during Next build)
  - orya-build-push:c9964591-3f96-436f-97d2-dd3ba3ad5da1 (SUCCEEDED)

## CFN / ECS (prod)
- Stack: orya-prod (CREATE_COMPLETE)
- ALB DNS: orya-prod-alb-353292592.eu-west-1.elb.amazonaws.com
- Web URL: https://orya-prod-alb-353292592.eu-west-1.elb.amazonaws.com
- Cluster: orya-prod
- Web service: orya-prod-web
- Healthcheck (ops): OK 200 at `/api/internal/ops/health` (via ALB DNS, TLS verify disabled)

## AWS Operations (requestId/correlationId)
- ecs:CreateCluster failure (initial) — Request ID 551f34fc-f5a1-428a-b58a-1982b3aff1c3 (service-linked role missing)
- iam:get-role AWSServiceRoleForECS — OK
- cloudformation:create-stack (orya-prod) — stack id arn:aws:cloudformation:eu-west-1:495219734037:stack/orya-prod/cb6eba20-fe22-11f0-952b-0697982cf3cf
- ecs:update-service --force-new-deployment — executed after secret fixes

## Notes
- Healthcheck path updated to `/api/internal/ops/health` and passed through deploy script.
- Secrets Manager group JSON keys were aligned with CFN task definition references to unblock ECS task startup.

