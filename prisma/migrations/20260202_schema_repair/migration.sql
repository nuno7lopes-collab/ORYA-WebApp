-- Schema repair: APPLE_MAPS + env isolation + address SSOT

-- Location source enum update
ALTER TYPE app_v3.location_source ADD VALUE IF NOT EXISTS 'APPLE_MAPS';

-- Ensure env column exists across app_v3 tables (idempotent)
DO $$
DECLARE r record;
BEGIN
  FOR r IN SELECT tablename FROM pg_tables WHERE schemaname = 'app_v3' LOOP
    EXECUTE format('ALTER TABLE app_v3.%I ADD COLUMN IF NOT EXISTS env text NOT NULL DEFAULT ''prod'';', r.tablename);
    EXECUTE format('CREATE INDEX IF NOT EXISTS %I ON app_v3.%I (env);', 'env_idx_' || substr(md5(r.tablename), 1, 8), r.tablename);
  END LOOP;
END $$;

-- Optional: enable RLS + env policy for app_v3 tables (idempotent)
DO $$
DECLARE r record;
DECLARE policy_exists boolean;
BEGIN
  FOR r IN SELECT tablename FROM pg_tables WHERE schemaname = 'app_v3' LOOP
    EXECUTE format('ALTER TABLE app_v3.%I ENABLE ROW LEVEL SECURITY;', r.tablename);
    SELECT EXISTS(
      SELECT 1 FROM pg_policies
      WHERE schemaname = 'app_v3'
        AND tablename = r.tablename
        AND policyname = 'env_isolation'
    ) INTO policy_exists;
    IF NOT policy_exists THEN
      EXECUTE format(
        'CREATE POLICY env_isolation ON app_v3.%I USING (env = current_setting(''app.env'', true)) WITH CHECK (env = current_setting(''app.env'', true));',
        r.tablename
      );
    END IF;
  END LOOP;
END $$;

CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Enums for addresses
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_type t
    JOIN pg_namespace n ON n.oid = t.typnamespace
    WHERE n.nspname = 'app_v3' AND t.typname = 'address_source_provider'
  ) THEN
    CREATE TYPE app_v3.address_source_provider AS ENUM (
      'APPLE_MAPS',
      'OSM_PHOTON',
      'OSM_NOMINATIM',
      'MANUAL'
    );
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_type t
    JOIN pg_namespace n ON n.oid = t.typnamespace
    WHERE n.nspname = 'app_v3' AND t.typname = 'address_validation_status'
  ) THEN
    CREATE TYPE app_v3.address_validation_status AS ENUM (
      'RAW',
      'NORMALIZED',
      'VERIFIED'
    );
  END IF;
END $$;

-- Addresses table
CREATE TABLE IF NOT EXISTS app_v3.addresses (
  env text NOT NULL DEFAULT 'prod',
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  formatted_address text NOT NULL,
  canonical jsonb NOT NULL,
  lat double precision NOT NULL,
  lng double precision NOT NULL,
  source_provider app_v3.address_source_provider NOT NULL,
  source_provider_place_id text,
  confidence_score integer NOT NULL DEFAULT 0,
  validation_status app_v3.address_validation_status NOT NULL DEFAULT 'NORMALIZED',
  address_hash text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS addresses_address_hash_uq ON app_v3.addresses(address_hash);
CREATE INDEX IF NOT EXISTS addresses_provider_idx ON app_v3.addresses(source_provider);
CREATE INDEX IF NOT EXISTS addresses_env_idx ON app_v3.addresses(env);

-- Address lookups table
CREATE TABLE IF NOT EXISTS app_v3.address_lookups (
  env text NOT NULL DEFAULT 'prod',
  id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  address_id uuid NOT NULL,
  source_provider app_v3.address_source_provider NOT NULL,
  source_provider_place_id text NOT NULL,
  resolved_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS address_lookups_provider_place_uq ON app_v3.address_lookups(source_provider, source_provider_place_id);
CREATE INDEX IF NOT EXISTS address_lookups_address_idx ON app_v3.address_lookups(address_id);
CREATE INDEX IF NOT EXISTS address_lookups_env_idx ON app_v3.address_lookups(env);

ALTER TABLE app_v3.addresses ENABLE ROW LEVEL SECURITY;
ALTER TABLE app_v3.address_lookups ENABLE ROW LEVEL SECURITY;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname = 'app_v3' AND tablename = 'addresses' AND policyname = 'env_isolation'
  ) THEN
    CREATE POLICY env_isolation ON app_v3.addresses
      USING (env = current_setting('app.env', true))
      WITH CHECK (env = current_setting('app.env', true));
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE schemaname = 'app_v3' AND tablename = 'address_lookups' AND policyname = 'env_isolation'
  ) THEN
    CREATE POLICY env_isolation ON app_v3.address_lookups
      USING (env = current_setting('app.env', true))
      WITH CHECK (env = current_setting('app.env', true));
  END IF;
END $$;

-- Link to events and padel clubs
ALTER TABLE app_v3.events ADD COLUMN IF NOT EXISTS address_id uuid;
ALTER TABLE app_v3.padel_clubs ADD COLUMN IF NOT EXISTS address_id uuid;

CREATE INDEX IF NOT EXISTS events_address_idx ON app_v3.events(address_id);
CREATE INDEX IF NOT EXISTS padel_clubs_address_idx ON app_v3.padel_clubs(address_id);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'padel_clubs_address_fk'
  ) THEN
    ALTER TABLE app_v3.padel_clubs
      ADD CONSTRAINT padel_clubs_address_fk
      FOREIGN KEY (address_id) REFERENCES app_v3.addresses(id)
      ON DELETE NO ACTION
      NOT VALID;
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'events_address_fk'
  ) THEN
    ALTER TABLE app_v3.events
      ADD CONSTRAINT events_address_fk
      FOREIGN KEY (address_id) REFERENCES app_v3.addresses(id)
      ON DELETE SET NULL
      NOT VALID;
  END IF;
END $$;
