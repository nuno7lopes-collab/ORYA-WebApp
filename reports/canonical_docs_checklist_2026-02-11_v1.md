# Canonical Docs Checklist (Generated)

Generated: 2026-02-11
Regenerate with: `node scripts/v9_generate_checklist.mjs`

## Source: docs/ssot_registry_v1.md
- [N/A] L1: # ORYA SSOT Registry
- [N/A] L3: Atualizado: 2026-02-11
- [N/A] L5: ## 00 Authority
- [N/A] L7: ### 00.1 Metadata
- [N/A] L8: - `ssotVersion`: v10.0.0-reorg
- [N/A] L9: - `effectiveDate`: 2026-02-11
- [N/A] L10: - `owner`: Nuno (repo owner)
- [N/A] L11: - `languagePolicy`: PT (inglês apenas para termos técnicos/rotas/identificadores)
- [N/A] L13: ### 00.2 Autoridade e Governação (NORMATIVO)
- [N/A] L14: - Este é o **único** documento normativo da ORYA para arquitetura, regras, contratos e decisões fechadas.
- [N/A] L15: - Este SSOT substitui **todas** as versões anteriores, incluindo drafts.
- [N/A] L16: - Em caso de conflito entre documentos, prevalece este SSOT.
- [N/A] L17: - Dentro deste SSOT, a ordem de precedência é: secções/regras **FECHADO** e, se persistir ambiguidade, a secção mais específica do domínio.
- [N/A] L18: - Aprovação de alterações: **Nuno (owner do repositório)**.
- [N/A] L19: - Sem aprovação explícita do owner, alterações ao SSOT são proibidas.
- [N/A] L20: - Este documento não contém estado de implementação/runtime; contém apenas norma.
- [N/A] L22: ### 00.3 Escopo (NORMATIVO)
- [N/A] L23: - Inclui invariantes globais, decisões fechadas, contratos C-G e C01..C18, tenancy, segurança, observabilidade, cut-line e produção.
- [N/A] L24: - Todos os módulos (app, repo, server, jobs, DB) devem conformar-se a este SSOT.
- [N/A] L25: - Planeamento, backlog e itens “a fazer” vivem em `docs/planning_registry_v1.md` (**NÃO-NORMATIVO**).
- [N/A] L27: ### 00.4 Ambiente & DB Única (NORMATIVO)
- [N/A] L28: - ORYA opera com **uma única DB** quando `SINGLE_DB_MODE=1`.
- [N/A] L29: - Nesse modo, `APP_ENV` é **forçado a `prod`** (sem “duplas verdades” na DB).
- [N/A] L30: - Stripe pode ser **forçado localmente para teste** via `STRIPE_MODE=test` e `NEXT_PUBLIC_STRIPE_MODE=test` **sem alterar o ambiente da DB**.
- [N/A] L31: - Em produção, **não** definir `STRIPE_MODE`; usa sempre chaves e webhooks **LIVE**.
- [N/A] L33: ### 00.5 Changelog Normativo Consolidado
- [N/A] L34: - Check‑in: normalizado para `requiresEntitlementForEntry` (ticket = entitlement) e removida ambiguidade em torneios (QR_REGISTRATION).
- [N/A] L35: - QR offline assinado: fechado como Fase 3 . PassKit na V1.5 mantém validação **online** (lookup por tokenHash).
- [N/A] L36: - PricingSnapshot/fees: **estimates proibidas** (qualquer estimate é legado e não canónico); `processorFeesStatus=PENDING|FINAL` + `processorFeesActual` nullable até reconciliação. Net final deriva sempre do Ledger (append‑only).
- [N/A] L37: - Ledger append‑only: tipos explícitos `PROCESSOR_FEES_FINAL` e `PROCESSOR_FEES_ADJUSTMENT`; net final = soma de entries por payment.
- [N/A] L38: - Entitlements: `policyVersionApplied` alinhado e obrigatório para entitlements ligados a eventos.
- [N/A] L39: - Contratos: Finanças passa a usar `customerIdentityId` (Identity SSOT) e snapshot fields alinhados.
- [N/A] L40: - Address: removido conflito D11 vs D17 (Apple Maps como provider único).
- [N/A] L41: - Domínio: mapa declarado “não exaustivo” + entidades mínimas adicionadas (Promoções/Notificações/Perfil/Pesquisa).
- [N/A] L42: - Revenda: removidas referências a estado `USED`; consumo é metadata (`consumedAt`).
- [N/A] L43: - Ticket: adicionado estado `DISPUTED` ao enum mínimo para consistência com chargebacks.
- [N/A] L44: - Editorial: numeração 15.1 corrigida + referência SSOT alinhada para v9.
- [N/A] L45: - Production Readiness: gate de go‑live + compliance/ops/DSAR/retention/release gates (Secção 19).
- [N/A] L46: - Stripe: Connect Standard + funds flow FECHADO + onboarding Standard (D04.00.01 / C02.X01).
- [N/A] L47: - Infra: backups Supabase→S3 + isolamento multi‑tenant (12.6.2 / 19.3.1).
- [N/A] L48: - Check‑in: modo recinto (8.6) para fallback operacional sem offline QR.
- [N/A] L49: - Policy Defaults v1 FECHADO (Apêndice A).
- [N/A] L50: - Legal: sign‑off/versionamento FECHADO (19.1).
- [N/A] L51: - Stripe Standard: mitigação operacional clarificada (sem controlo directo de payouts).
- [N/A] L52: ---
- [N/A] L54: ## 01 Global Invariants (I*)
- [N/A] L56: Esta secção define os invariantes imutáveis da plataforma ORYA.
- [N/A] L57: Estas regras DEVEM ser cumpridas em todos os momentos. Qualquer implementação
- [N/A] L58: que viole um ou mais invariantes é considerada incorreta, mesmo que funcional.
- [N/A] L60: ### I01 — Fonte Única de Verdade (SSOT)
- [N/A] L61: Cada domínio tem exatamente uma fonte autoritativa de verdade:
- [N/A] L62: - Payments & money state → `Payment` + `LedgerEntry`
- [N/A] L63: - Access rights → `Entitlement`
- [N/A] L64: - Identity → `Identity` (USER or GUEST_EMAIL)
- [N/A] L65: - Organization context → `Organization`
- [N/A] L67: Dados derivados, caches, projeções e estado de UI NÃO PODEM ser
- [N/A] L68: tratados como autoritativos.
- [N/A] L70: ---
- [N/A] L72: ### I02 — Ledger é Append-Only e Determinístico
- [N/A] L73: Registos `LedgerEntry` são imutáveis e append-only.
- [N/A] L74: DEVEM:
- [N/A] L75: - nunca ser atualizados ou apagados
- [N/A] L76: - referenciar sempre um evento causador
- [N/A] L77: - ser suficientes para recomputar integralmente saldos e montantes líquidos
- [N/A] L79: Qualquer correção é expressa por entries compensatórias, nunca por mutação.
- [N/A] L81: ---
- [N/A] L83: ### I03 — Payments são Máquinas de Estado, não Saldos
- [N/A] L84: `Payment` representa ciclo de vida e intenção, não a verdade monetária.
- [N/A] L85: A verdade financeira final deriva exclusivamente do ledger.
- [N/A] L87: Fees do processor PODEM ser desconhecidas na criação e DEVEM ser reconciliadas
- [N/A] L88: depois, sem mutar entries históricas.
- [N/A] L90: ---
- [N/A] L92: ### I04 — Entitlement é a Prova Canónica de Acesso
- [N/A] L93: Um `Entitlement` é a única prova de que um utilizador (ou guest) tem acesso
- [N/A] L94: a um recurso (evento, bilhete, lugar, experiência).
- [N/A] L96: Estado de UI, QR codes, logs de check-in ou ecrãs de sucesso de pagamento NÃO
- [N/A] L97: são prova de acesso.
- [N/A] L99: ---
- [N/A] L101: ### I05 — Contexto Explícito de Organização (Multi-Tenancy)
- [N/A] L102: Todos os dados de domínio DEVEM estar scoped a um `orgId` explícito, por:
- [N/A] L103: - via direta (row-level), ou
- [N/A] L104: - via indireta por entidade dona
- [N/A] L106: Nenhuma query, job, webhook ou tarefa assíncrona pode operar sem contexto
- [N/A] L107: explícito de organização.
- [N/A] L109: ---
- [N/A] L111: ### I06 — Idempotência é Obrigatória para Operações com Side Effects
- [N/A] L112: Qualquer operação que:
- [N/A] L113: - cria movimento de dinheiro
- [N/A] L114: - emite entitlements
- [N/A] L115: - envia emails ou webhooks
- [N/A] L116: - altera estado irreversível
- [N/A] L118: DEVE ser idempotente e segura para retry.
- [N/A] L120: ---
- [N/A] L122: ### I07 — Assíncrono é Explícito e Observável
- [N/A] L123: Todo o trabalho assíncrono DEVE:
- [N/A] L124: - ser acionado via outbox ou queue durável
- [N/A] L125: - ser observável por metrics e logs
- [N/A] L126: - ser retryable sem side effects
- [N/A] L128: Execução fire-and-forget é proibida.
- [N/A] L130: ---
- [N/A] L132: ### I08 — Sistemas Externos Não São Confiáveis
- [N/A] L133: Sistemas externos (payment processors, providers de email, scanners,
- [N/A] L134: integrações) são tratados como:
- [N/A] L135: - não confiáveis
- [N/A] L136: - duplicativos
- [N/A] L137: - out-of-order
- [N/A] L139: Todos os sinais de entrada DEVEM ser validados, deduplicados e reconciliados
- [N/A] L140: contra a verdade interna.
- [N/A] L142: ---
- [N/A] L144: ### I09 — Fail Closed em Autorização e Acesso
- [N/A] L145: Em caso de incerteza, falta de dados ou lag de reconciliação:
- [N/A] L146: - acesso é negado
- [N/A] L147: - payouts são atrasados
- [N/A] L148: - ações irreversíveis são bloqueadas
- [N/A] L150: O sistema falha sempre em fail-closed, nunca em fail-open.
- [N/A] L152: ---
- [N/A] L154: ### I10 — Decisões FECHADO São Vinculativas
- [N/A] L155: Qualquer secção ou regra marcada como FECHADO é final.
- [N/A] L156: As escolhas de implementação DEVEM adaptar-se a este SSOT, nunca o inverso.
- [N/A] L158: Qualquer desvio exige revisão explícita do SSOT.
- [N/A] L160: ---
- [N/A] L162: ⸻
- [N/A] L164: ## 02 Security / Tenancy / Compliance (T*, Threat Model, RGPD)
- [N/A] L166: ### 02.1 Tenancy & Isolation Enforcement
- [N/A] L167: This section defines the mandatory enforcement rules for multi-tenant
- [N/A] L168: isolation across the ORYA platform.
- [N/A] L170: Any violation of these rules is considered a critical security defect.
- [N/A] L172: ---
- [N/A] L174: ### T01 — Explicit Organization Scoping (MANDATORY)
- [N/A] L175: All domain entities MUST be scoped to an organization via:
- [N/A] L176: - a direct `orgId` field, or
- [N/A] L177: - an immutable reference to an entity that contains `orgId`
- [N/A] L179: No entity that represents customer, operational, or financial data may
- [N/A] L180: exist without an organization context.
- [N/A] L182: ---
- [N/A] L184: ### T02 — Query Enforcement
- [N/A] L185: All read and write queries MUST:
- [N/A] L186: - include `orgId` as a mandatory filter, OR
- [N/A] L187: - derive `orgId` from a parent entity already scoped
- [N/A] L189: Queries without explicit organization scoping are forbidden.
- [N/A] L191: ---
- [N/A] L193: ### T03 — Global Tables (Explicit Exceptions)
- [N/A] L194: Only the following categories MAY exist without `orgId`:
- [N/A] L195: - identity registries (e.g., username, email uniqueness)
- [N/A] L196: - configuration metadata explicitly marked as GLOBAL
- [N/A] L198: Global tables MUST:
- [N/A] L199: - never contain customer-sensitive data
- [N/A] L200: - be read-only in customer flows
- [N/A] L201: - be explicitly documented as GLOBAL
- [N/A] L203: ---
- [N/A] L205: ### T04 — Background Jobs & Async Processing
- [N/A] L206: All background jobs, workers, and outbox processors MUST:
- [N/A] L207: - execute within a resolved `orgId` context
- [N/A] L208: - include `orgId` in logs, metrics, and traces
- [N/A] L210: Jobs operating across multiple organizations MUST process one
- [N/A] L211: organization at a time.
- [N/A] L213: ---
- [N/A] L215: ### T05 — Webhooks & External Callbacks
- [N/A] L216: Inbound webhooks MUST:
- [N/A] L217: - be resolved to an internal entity
- [N/A] L218: - derive the owning `orgId`
- [N/A] L219: - fail if organization context cannot be resolved
- [N/A] L221: Webhook handling without organization resolution is forbidden.
- [N/A] L223: ---
- [N/A] L225: ### T06 — Authorization Is Org-Bound
- [N/A] L226: Authorization checks MUST always evaluate:
- [N/A] L227: - actor identity
- [N/A] L228: - organization membership
- [N/A] L229: - role / permission within that organization
- [N/A] L231: Cross-organization access is forbidden unless explicitly designed
- [N/A] L232: and documented as such.
- [N/A] L234: ---
- [N/A] L236: ### T07 — Service Roles & Elevated Access
- [N/A] L237: Service roles MAY bypass user-level RBAC but MUST NOT bypass
- [N/A] L238: organization isolation.
- [N/A] L240: All service-role access MUST:
- [N/A] L241: - be auditable
- [N/A] L242: - be logged with `orgId`
- [N/A] L243: - have a documented justification
- [N/A] L245: ---
- [N/A] L247: ### T08 — Testing & Verification
- [N/A] L248: The platform MUST include automated tests that:
- [N/A] L249: - attempt cross-org access
- [N/A] L250: - verify hard failure on isolation violations
- [N/A] L251: - cover API, jobs, and webhook paths
- [N/A] L253: Tenancy enforcement MUST be continuously tested.
- [N/A] L255: ---
- [N/A] L257: ### T09 — Failure Mode
- [N/A] L258: On any ambiguity or missing organization context:
- [N/A] L259: - the operation MUST fail
- [N/A] L260: - no partial data may be returned
- [N/A] L261: - no side effects may be executed
- [N/A] L263: The system always fails closed.
- [N/A] L265: ---
- [N/A] L267: ### 02.1.1 Authentication Security Controls (legacy auth spec migrated)
- [N/A] L268: These controls are normative and apply to public authentication flows.
- [N/A] L270: - Public auth endpoints MUST avoid account enumeration:
- [N/A] L271:   - responses for existence-sensitive flows (signup/check-email/reset) MUST be generic.
- [N/A] L272:   - endpoint behavior MAY branch internally (`signup` -> `magiclink`), but external disclosure is forbidden.
- [N/A] L273: - Mutable auth requests MUST enforce origin protections:
- [N/A] L274:   - browser cross-site mutable requests are blocked by default.
- [N/A] L275:   - signed internal requests (`Authorization`, `ORYA_APP_SECRET`, `ORYA_CRON_SECRET`) are exempt when explicitly trusted by policy.
- [N/A] L276: - Canonical auth/session reads and writes:
- [N/A] L277:   - `GET /api/auth/me` is the canonical read of auth/profile session state.
- [N/A] L278:   - `POST /api/auth/refresh` is the canonical token->HttpOnly cookie synchronization path.
- [N/A] L279: - Auth errors exposed to clients MUST comply with `errorCode` envelope rules in `03 Canonical Vocabulary`.
- [N/A] L281: ---
- [N/A] L283: ### 02.2 RGPD Retention e Isolamento DB
- [N/A] L284: 12.2.1 Retenção RGPD (defaults v1) — **FECHADO**
- [N/A] L285: 	•	EventLog: 180 dias
- [N/A] L286: 	•	OutboxEvent: 30 dias após `publishedAt`
- [N/A] L287: 	•	NotificationDeliveryLog: 180 dias
- [N/A] L288: 	•	Job/JobAttempt/DLQ: 30–90 dias (depende de debug/ops)
- [N/A] L289: 	•	AuditLog: 5 anos (payload minimizado; sem PII desnecessária)
- [N/A] L291: Unicidade:
- [N/A] L292: 	•	(organizationId, eventType, idempotencyKey)
- [N/A] L294: 12.6.2 Isolamento multi-tenant (DB) — **FECHADO**
- [N/A] L295: Objetivo: garantir que falhas na camada API não criam fuga de dados entre organizações.
- [N/A] L296: - Todas as tabelas B2B têm `organizationId` obrigatório.
- [N/A] L297: - Queries na API são sempre filtradas por `organizationId` (orgContext + RBAC).
- [N/A] L298: - Base de segurança (quando aplicável):
- [N/A] L299:   - RLS no Supabase para tabelas críticas multi‑tenant (Finanças, Reservas, RBAC, CRM, Check‑in),
- [N/A] L300:   - policies mínimas: “só lê/escreve se organizationId ∈ memberships do user”.
- [N/A] L301: - Logs e exports respeitam minimização de PII (12.2/19.4).
- [N/A] L303: ### 02.3 Legal, Trust & Safety, Data Governance, Account Security
- [N/A] L304: 19.1 Legal & Compliance (Portugal + App Stores) — **FECHADO**
- [N/A] L305: - Documentos obrigatórios (publicados e versionados):
- [N/A] L306:   - Termos de Utilização (Utilizadores)
- [N/A] L307:   - Termos para Organizações (B2B)
- [N/A] L308:   - Política de Privacidade (RGPD)
- [N/A] L309:   - Política de Cookies / Tracking (web)
- [N/A] L310:   - Política de Conteúdo/Conduta + Política de Denúncias (Trust & Safety)
- [N/A] L311: - Links obrigatórios na app e website:
- [N/A] L312:   - Privacy Policy + Terms **sempre acessíveis sem login** (iOS/Android/Web).
- [N/A] L313: - Organizações com vendas/payouts (pré‑requisito para activar pagamentos):
- [N/A] L314:   - Identificação legal e fiscal (NIF, representante, morada, dados da empresa).
- [N/A] L315:   - Aceitação explícita:
- [N/A] L316:     - Organização é responsável pelo evento/serviço (conteúdo, segurança, cumprimento legal, IVA/faturação).
- [N/A] L317:     - ORYA é plataforma (fee) e pode suspender funcionalidades e vendas (bloquear checkouts) por risco/abuso.
- [N/A] L318:   - Disputes/chargebacks:
- [N/A] L319:     - Processo formalizado de evidência e resposta (SLA interno) + auditoria.
- [N/A] L320: - Cookies (web):
- [N/A] L321:   - Consentimento por categoria (essenciais / analytics / marketing) + gestão de preferências.
- [N/A] L322:   - Tracking de marketing **apenas com opt‑in** (salvo base legal documentada).
- [N/A] L324: Legal Sign-off e Versionamento (FECHADO)
- [N/A] L325: - Todos os documentos legais (Termos, Privacidade, Cookies) são versionados:
- [N/A] L326:   - `legalDocsVersion` (ex.: 1.0.0) + `effectiveAt`
- [N/A] L327: - Go‑Live Gate:
- [N/A] L328:   - não se lança produção sem `legalDocsVersion` aprovado/revisto e links publicados no produto (web/app).
- [N/A] L329: - Alterações legais:
- [N/A] L330:   - criam nova versão + changelog + data de entrada em vigor
- [N/A] L331:   - utilizadores são notificados quando aplicável (Notificações + registo de aceitação)
- [N/A] L332: - Ownership:
- [N/A] L333:   - responsável interno: Owner/Legal (nome/role no repositório de decisão) + registo de aprovação.
- [N/A] L335: 19.2 Trust & Safety (abuso inevitável) — **FECHADO**
- [N/A] L336: - Sistema de denúncias (in‑app + web):
- [N/A] L337:   - Categorias normativas: fraude/pagamentos, evento falso, spam, assédio, conteúdo ilegal, risco físico, menores, violação de direitos, revenda abusiva.
- [N/A] L338:   - SLA normativo:
- [N/A] L339:     - triagem ≤ 24h
- [N/A] L340:     - decisão inicial ≤ 72h (ou “investigação” com estado + motivo)
- [N/A] L341:   - Registo obrigatório: `SafetyCase` (caseId, entidade alvo, motivo, evidência, decisão, auditoria).
- [N/A] L343: 19.2.1 Políticas de Conteúdo & Idade — **FECHADO**
- [N/A] L344: - Proibido:
- [N/A] L345:   - fraude, eventos falsos, venda de bens/serviços ilegais, doxxing, assédio grave, incitação ao ódio/violência.
- [N/A] L346: - Eventos sensíveis (ex.: álcool/noite):
- [N/A] L347:   - exigem sinalização e age-gate quando aplicável.
- [N/A] L348: - Responsabilidade:
- [N/A] L349:   - a Organização é responsável por licenças/segurança/conduta no local.
- [N/A] L350:   - ORYA pode suspender o evento e bloquear novas vendas/checkouts por risco/abuso (com `SafetyCase`).
- [N/A] L351: - Medidas (escalonadas e auditáveis):
- [N/A] L352:   - Aviso → Limitação (shadow‑limit) → Suspensão temporária → Ban
- [N/A] L353:   - Cancelamento de evento (soft‑cancel) + refunds idempotentes quando aplicável
- [N/A] L355: 19.2.2 Thresholds & Ações Automáticas — **FECHADO**
- [N/A] L356: ADITAMENTO FECHADO: thresholds mínimos (valores default; ajustáveis por política).
- [N/A] L357: - Chargeback rate por Organização (janela móvel 30d, mínimo 100 pagamentos):
- [N/A] L358:   - **Sinaliza** > 0.8% → `SafetyCase` + `reasonCode=RISK_CHARGEBACK_RATE_ORG_HIGH`
- [N/A] L359:   - **Bloqueia** > 1.5% → bloquear novos checkouts da org até revisão + `reasonCode=RISK_CHARGEBACK_RATE_ORG_BLOCK`
- [N/A] L360: - Chargeback rate por Evento (janela móvel 30d desde 1ª venda até 30d pós‑evento, mínimo 30 pagamentos):
- [N/A] L361:   - **Sinaliza** > 1.0% **e** ≥ 2 disputes → `reasonCode=RISK_CHARGEBACK_RATE_EVENT_HIGH`
- [N/A] L362:   - **Bloqueia** > 2.0% **e** ≥ 3 disputes → bloquear novos checkouts do evento + `reasonCode=RISK_CHARGEBACK_RATE_EVENT_BLOCK`
- [N/A] L363: - Picos anómalos de vendas (org/event, baseline 7d):
- [N/A] L364:   - **Sinaliza** ≥ 3× baseline **e** ≥ 20 compras/min por ≥ 3 min → step‑up/captcha + rate‑limit + `reasonCode=RISK_SALES_SPIKE`
- [N/A] L365:   - **Bloqueia** ≥ 6× baseline **e** ≥ 50 compras/min por ≥ 3 min → bloquear novos checkouts + `reasonCode=RISK_SALES_SPIKE_BLOCK`
- [N/A] L366: - Revenda suspeita (por identidade):
- [N/A] L367:   - **Sinaliza** ≥ 5 falhas de transfer/claim por 1h **ou** ≥ 8 transferências/24h → step‑up + rate‑limit + `reasonCode=RISK_RESALE_SUSPECTED`
- [N/A] L368:   - **Bloqueia** ≥ 10 falhas/1h **ou** ≥ 12 transferências/24h → bloquear transferências/claims + `reasonCode=RISK_RESALE_BLOCK`
- [N/A] L369: - Check‑in anómalo (por evento/scanner):
- [N/A] L370:   - **Sinaliza** (`checkin.denied` + `checkin.duplicate`) ≥ 10% em 10 min com ≥ 30 scans → aviso + modo recinto + `reasonCode=RISK_CHECKIN_ANOMALY`
- [N/A] L371:   - **Bloqueia** ≥ 20% em 10 min com ≥ 30 scans → bloquear novos scans desse scanner + fallback + `reasonCode=RISK_CHECKIN_ANOMALY_BLOCK`
- [N/A] L373: 19.2.3 Tooling mínimo de moderação — **FECHADO**
- [N/A] L374: ADITAMENTO FECHADO: estado e campos mínimos do `SafetyCase`.
- [N/A] L375: - Queue / estados: `NEW → TRIAGED → INVESTIGATING → DECIDED → (APPEALED) → CLOSED`
- [N/A] L376: - Campos mínimos:
- [N/A] L377:   - `decision = ALLOW | LIMIT | SUSPEND | BAN | SOFT_CANCEL_EVENT`
- [N/A] L378:   - `scope = USER | ORG | EVENT`
- [N/A] L379:   - `duration`/`expiresAt` (quando aplicável)
- [N/A] L380:   - `decidedBy` (userId/role)
- [N/A] L381:   - `evidenceLinks[]`
- [N/A] L382:   - timestamps: `createdAt`, `triagedAt`, `decidedAt`, `closedAt`
- [N/A] L383: - Safety Inbox (Backoffice):
- [N/A] L384:   - lista + pesquisa + filtros por severidade/estado/entidade
- [N/A] L385:   - SLA timers (triagem/decisão)
- [N/A] L386:   - templates de decisão (com reasonCode)
- [N/A] L387:   - audit log completo por caso
- [N/A] L389: 19.2.4 Kill Switches — **FECHADO**
- [N/A] L390: ADITAMENTO FECHADO: switches operacionais compatíveis com Stripe Connect Standard.
- [N/A] L391: - A) Kill switch por **EVENTO**
- [N/A] L392:   - aplica: bloquear novos checkouts + ocultar da descoberta
- [N/A] L393:   - mantém: suporte + gestão de refunds
- [N/A] L394:   - guardrail: API `createCheckout` + discovery gated
- [N/A] L395:   - reversão: decisão em `SafetyCase` + expiração definida
- [N/A] L396:   - audit: EventLog `safety.kill_switch.event` + `reasonCode=KILL_SWITCH_EVENT`
- [N/A] L397: - B) Kill switch por **ORG**
- [N/A] L398:   - aplica: bloquear criação/publicação + bloquear checkouts + travar revenda
- [N/A] L399:   - guardrail: API org/event + checkout + transfer
- [N/A] L400:   - reversão: decisão em `SafetyCase` + expiração definida
- [N/A] L401:   - audit: EventLog `safety.kill_switch.org` + `reasonCode=KILL_SWITCH_ORG`
- [N/A] L402: - C) Kill switch por **IDENTITY**
- [N/A] L403:   - aplica: bloquear compras/transferências, exigir step‑up, suspender sessão
- [N/A] L404:   - guardrail: auth + createCheckout + transfer
- [N/A] L405:   - reversão: decisão em `SafetyCase` + expiração definida
- [N/A] L406:   - audit: EventLog `safety.kill_switch.identity` + `reasonCode=KILL_SWITCH_IDENTITY`
- [N/A] L408: Nota (FECHADO): em Stripe Connect Standard, a ORYA não controla directamente payouts do Connected Account.
- [N/A] L409: As medidas de mitigação são operacionais: bloquear novas vendas/checkouts, desactivar eventos, aplicar step‑up,
- [N/A] L410: limitar acções de risco e, quando aplicável, iniciar refunds/chargeback workflows.
- [N/A] L411: Qualquer controlo fino de transferências/payout holds é fora do v1.x e requer revisão do funds flow/account type.
- [N/A] L413: - Risk flags automáticos (motor mínimo v1):
- [N/A] L414:   - Chargeback rate acima de threshold (por organização e por evento)
- [N/A] L415:   - Padrões anómalos de venda (picos, múltiplas compras por identidades correlacionadas, repetição de IP/device)
- [N/A] L416:   - Revenda suspeita (tentativas repetidas, padrões de scalping, abuso de 0€)
- [N/A] L417:   - Check‑in anómalo (múltiplos denies/duplicates por scanner/evento)
- [N/A] L418: - Integração com Finanças:
- [N/A] L419:   - `risk.flagged` pode activar: step‑up, limits, bloqueio temporário de criação de eventos/checkouts e revisão manual (D04/D09).
- [N/A] L421: 19.4 Governança de Dados (RGPD / DSAR) — **FECHADO**
- [N/A] L422: 19.4.0 Data Classification & Purpose Binding (NORMATIVE)
- [N/A] L423: All data within the ORYA platform is classified and handled according to its sensitivity and purpose.
- [N/A] L425: ### Data Classes
- [N/A] L426: - **PII:** personal identifiers (email, name, phone)
- [N/A] L427: - **FINANCIAL:** ledger entries, payouts, fees, invoices
- [N/A] L428: - **AUDIT:** immutable logs, access trails, reconciliation records
- [N/A] L429: - **OPERATIONAL:** configs, schedules, availability
- [N/A] L430: - **PUBLIC:** content explicitly marked as public
- [N/A] L432: ### Purpose Binding
- [N/A] L433: Each data class MUST:
- [N/A] L434: - be collected for an explicit purpose
- [N/A] L435: - not be reused for unrelated purposes
- [N/A] L436: - respect least-retention necessary for that purpose
- [N/A] L438: Access outside declared purpose is forbidden.
- [N/A] L440: - Direitos do titular (DSAR) — fluxos obrigatórios:
- [N/A] L441:   - Exportar dados (“download my data”) em formato portátil.
- [N/A] L442:   - Eliminar conta (“delete account”) com:
- [N/A] L443:     - apagamento/anonymize de PII onde permitido
- [N/A] L444:     - preservação legal do que for obrigatório (ex.: registos contabilísticos/financeiros)
- [N/A] L445:   - Prazos e tracking:
- [N/A] L446:     - pedidos registados com `dsarCaseId`, status, datas, evidência de cumprimento.
- [N/A] L447: - Retenção por categoria:
- [N/A] L448:   - Ledger/finanças/auditoria: retenção legal (Portugal) + minimização de PII.
- [N/A] L449:   - EventLog técnico e logs: conforme 12.2.1 (sem PII directa).
- [N/A] L450:   - PII: apenas enquanto necessário para prestação do serviço + base legal documentada.
- [N/A] L451: - Minimização / pseudonimização:
- [N/A] L452:   - IDs/pseudónimos em logs; emails/telefones apenas em sistemas próprios e protegidos.
- [N/A] L453:   - Hashes para dedupe e anti‑abuso (sem reidentificação indevida).
- [N/A] L454: - Segurança:
- [N/A] L455:   - Encryption at rest e in transit.
- [N/A] L456:   - Segredos em Secrets Manager/SSM; rotação; acesso mínimo.
- [N/A] L458: 19.4.1 Tabela de Retenção (normativa) — **FECHADO**
- [N/A] L459: ADITAMENTO FECHADO: valores default e tratamento no delete account.
- [N/A] L461: | Categoria de dados | Exemplos (entidades/tabelas) | Retenção | Base legal | Tratamento no delete account |
- [N/A] L462: |---|---|---|---|---|
- [N/A] L463: | Ledger/financeiro | `LedgerEntry`, `Payment`, `Refund`, `Dispute`, `Invoice` | 10 anos | obrigação contabilística/fiscal | **Preservar**; remover PII directa + `identityRef` → pseudónimo |
- [N/A] L464: | Aceites legais/consentimentos | `LegalAcceptance`, `PrivacyConsent` | 10 anos | obrigação legal / defesa jurídica | **Preservar** pseudonimizado |
- [N/A] L465: | Identidade & perfil | `Identity`, `UserProfile`, `OrganizationGroupMember` | duração da conta + 30 dias | contrato / consentimento | **Anonymize** (remover PII) |
- [N/A] L466: | Tickets/Entitlements/Check‑in | `Ticket`, `Entitlement`, `CheckinLog` | 2 anos após evento | contrato / legítimo interesse | **Anonymize** `identityRef`, manter integridade |
- [N/A] L467: | Safety/Abuso | `SafetyCase`, `risk.flag` | 5 anos | legítimo interesse / defesa jurídica | **Preservar** pseudonimizado |
- [N/A] L468: | EventLog/Audit | `EventLog`, `AuditLog` | 2 anos | legítimo interesse / segurança | **Preservar** pseudonimizado |
- [N/A] L469: | Notificações/Support | `NotificationLog`, `SupportTicket` | 12 meses | contrato / legítimo interesse | **Anonymize** PII |
- [N/A] L470: | Logs técnicos | access logs, IP/device | 90 dias | segurança | **Preservar** apenas hashes |
- [N/A] L471: | Ficheiros/uploads | anexos, imagens | até fim do evento + 30 dias | contrato | **Apagar** |
- [N/A] L473: Regra: se existir **legal hold** (dispute/obrigação legal), o delete account **não** remove dados bloqueados; apenas minimiza PII e regista motivo no `dsarCaseId`.
- [N/A] L475: 19.4.2 Regras de Anonymize / Detach — **FECHADO**
- [N/A] L476: ADITAMENTO FECHADO: procedimento técnico mínimo.
- [N/A] L477: - Remover/limpar PII directa: `email`, `phone`, `fullName`, `address`, `dob`, `documentId`, `avatarUrl`.
- [N/A] L478: - Detach de referências externas: remover `stripeCustomerId` quando permitido; manter apenas referências financeiras legalmente obrigatórias.
- [N/A] L479: - Pseudónimos e hashes:
- [N/A] L480:   - `emailHash`/`phoneHash` via HMAC com segredo rotativo; uso exclusivo para dedupe/anti‑abuso.
- [N/A] L481:   - hashes **não** são reidentificáveis sem segredo; acesso restrito.
- [N/A] L482: - Integridade referencial:
- [N/A] L483:   - substituir `identityRef` por `anonymizedIdentityRef` em `LedgerEntry`, `Ticket`, `Entitlement`, `CheckinLog`, `EventLog`.
- [N/A] L484:   - manter `subjectType`/`subjectId` para auditoria sem PII.
- [N/A] L485: - DSAR export (“download my data”) **inclui**:
- [N/A] L486:   - perfil/conta, memberships, compras, tickets/entitlements, refunds, histórico de check‑in, consentimentos, notificações enviadas, pedidos de suporte.
- [N/A] L487: - DSAR export **exclui**:
- [N/A] L488:   - segredos, chaves, regras internas de risco, notas internas de moderação, evidência sensível de terceiros.
- [N/A] L490: 19.5 Account Security (ATO / Account Takeover) — **FECHADO**
- [N/A] L491: 19.5.0 Threat Model (NORMATIVE)
- [N/A] L492: The platform explicitly defends against the following primary threats:
- [N/A] L493: - Account Takeover (ATO)
- [N/A] L494: - Cross-organization data leakage
- [N/A] L495: - Replay and duplicate execution
- [N/A] L496: - Webhook spoofing
- [N/A] L497: - Privilege escalation via RBAC
- [N/A] L498: - Financial double-spend or reconciliation drift
- [N/A] L500: Mitigations include:
- [N/A] L501: - strict org isolation
- [N/A] L502: - idempotency at all side-effect boundaries
- [N/A] L503: - append-only ledger
- [N/A] L504: - fail-closed authorization
- [N/A] L505: - audit trails for all sensitive actions
- [N/A] L507: Any new feature MUST be evaluated against this threat model.
- [N/A] L509: - Email verificado obrigatório para acções de risco:
- [N/A] L510:   - comprar, revender/transferir, alterar email, alterar payout settings (org), aceder a Finanças (org).
- [N/A] L511: - Rate limit global por IP/device/identity em:
- [N/A] L512:   - login, reset password, magic links, invite token, QR token, createCheckout.
- [N/A] L513: - Sessões:
- [N/A] L514:   - refresh tokens rotativos + revogação em logout e mudança de password.
- [N/A] L515: - Step‑up de segurança:
- [N/A] L516:   - comportamento suspeito → captcha/turnstile + re‑auth obrigatório.
- [N/A] L517: - Auditoria:
- [N/A] L518:   - `security.alert` (EventLog) para logins suspeitos e acções de risco.
- [N/A] L520: ## 03 Canonical Vocabulary (termos, enums, sourceType, error envelope)
- [N/A] L522: ### 03.1 Error Envelope Canónico
- [N/A] L523: ### C-G05 — Padrão de Envelope de Erro
- [N/A] L524: Todos os contratos DEVEM usar uma estrutura de erro consistente contendo:
- [N/A] L525: - errorCode (stable, machine-readable)
- [N/A] L526: - message (human-readable)
- [N/A] L527: - retryable (boolean)
- [N/A] L528: - correlationId
- [N/A] L530: Erros sem classificação são proibidos.
- [N/A] L532: ---
- [N/A] L534: ### 03.2 sourceType Canónico e Separação de Enums
- [N/A] L535: D07) sourceType canónico (Finanças/ledger/check-in)
- [N/A] L537: Todos os checkouts e entitlements usam sourceType canónico e unificado (Secção 7).
- [N/A] L539: 7.5 sourceType canónico (FECHADO)
- [N/A] L540: Lista oficial:
- [N/A] L541: - `TICKET_ORDER`
- [N/A] L542: - `BOOKING`
- [N/A] L543: - `PADEL_REGISTRATION`
- [N/A] L544: - `STORE_ORDER`
- [N/A] L545: - (fase 2) `SUBSCRIPTION`, `MEMBERSHIP`
- [N/A] L547: Regra:
- [N/A] L548: - Ledger e check‑in guardam apenas `sourceType` canónico.
- [N/A] L549: - Não criar “sourceType por módulo” fora desta lista; se precisares, adiciona aqui com versionamento.
- [N/A] L551: Separação de enums (SSOT D07):
- [N/A] L552: - `FinanceSourceType` = lista acima (SSOT para Finanças/ledger/check‑in).
- [N/A] L553: - `AgendaSourceType` = `EVENT`, `TOURNAMENT`, `MATCH`, `SOFT_BLOCK`, `HARD_BLOCK` (apenas agenda/check‑in).
- [N/A] L554: - Normalização deve escolher o enum certo por domínio (finance vs agenda).
- [N/A] L556: ### 03.3 Estados Canónicos de Entitlement
- [N/A] L557: 7.2 Entitlement states (FECHADO)
- [N/A] L558: `PENDING | ACTIVE | REVOKED | EXPIRED | SUSPENDED`
- [N/A] L559: - `PENDING`: criado mas ainda não “válido” (ex.: pagamento em processamento, hold de reserva).
- [N/A] L560: - `ACTIVE`: válido para uso (entrada/consumo).
- [N/A] L561: - `REVOKED`: invalidado por política (refund concluído, cancelamento, ação admin, violação).
- [N/A] L562: - `EXPIRED`: passou a janela temporal (evento já ocorreu / reserva já passou / TTL).
- [N/A] L563: - `SUSPENDED`: bloqueado temporariamente (chargeback, fraude, investigação, disputa).
- [N/A] L565: > **Regra:** “USADO/CONSUMIDO” não é um estado. Consumo é metadata (ver 7.3) para evitar drift e conflitos.
- [N/A] L567: ### 03.4 Contract Signatures (shape canónico)
- [N/A] L568: 12.6.1 Contract Signatures (MVP) (FECHADO)
- [N/A] L569: Objetivo: reduzir drift FE/BE e entre módulos. Assinaturas mínimas (shape), sem impor transporte (REST/GRPC).
- [N/A] L571: - Finanças.createCheckout(input)
- [N/A] L572:   - input: {orgId, sourceType, sourceId, customerIdentityId?, pricingSnapshotHash?, idempotencyKey}
- [N/A] L573:   - output: {paymentId, status, clientSecret?, pricingSnapshotHash}
- [N/A] L575: - Finanças.getPayment(paymentId)
- [N/A] L576:   - output: {paymentId, status, amounts, currency, pricingSnapshotHash, processorFeesStatus, processorFeesActual?}
- [N/A] L578: - Eventos.validateInviteToken(input)
- [N/A] L579:   - input: {eventId, inviteToken, identityRef?}
- [N/A] L580:   - output: {allow, reasonCode?, constraints:{expiresAt, requiresIdentityMatch}}
- [N/A] L582: - UsernameRegistry.resolveUsername(username)
- [N/A] L583:   - output: {ownerType, ownerId, canonicalUsername}
- [N/A] L585: - Checkin.consume(input)
- [N/A] L586:   - input: {qrPayload, scannerIdentityRef, eventId, deviceId?}
- [N/A] L587:   - output: {allow, reasonCode?, entitlementId?, consumedAt?, policyVersionApplied, duplicate?:{duplicateOfConsumedAt, duplicateCount?}}
- [N/A] L589: - Address.searchAutocomplete(query, context?)
- [N/A] L590:   - output: {items:[{placeId, label, lat?, lng?}]}
- [N/A] L592: - Address.resolvePlace(placeId)
- [N/A] L593:   - output: {placeId, label, lat, lng, components?}
- [N/A] L595: ### 03.5 Auth `errorCode` Canonical Set (legacy auth spec migrated)
- [N/A] L596: Conjunto canónico mínimo para endpoints de autenticação:
- [N/A] L597: - `FORBIDDEN`
- [N/A] L598: - `INVALID_EMAIL`
- [N/A] L599: - `RATE_LIMITED`
- [N/A] L600: - `UNAUTHENTICATED`
- [N/A] L601: - `MISSING_CREDENTIALS`
- [N/A] L602: - `INVALID_CREDENTIALS`
- [N/A] L603: - `EMAIL_NOT_CONFIRMED`
- [N/A] L604: - `EMAIL_EXISTS`
- [N/A] L605: - `WEAK_PASSWORD`
- [N/A] L606: - `USERNAME_INVALID`
- [N/A] L607: - `USERNAME_TAKEN`
- [N/A] L608: - `OTP_GENERATION_FAILED`
- [N/A] L609: - `RESET_LINK_FAILED`
- [N/A] L610: - `EMAIL_SEND_FAILED`
- [N/A] L611: - `MISSING_TOKENS`
- [N/A] L612: - `INVALID_SESSION`
- [N/A] L613: - `APPLE_IDENTITY_MISSING`
- [N/A] L614: - `APPLE_IDENTITY_INVALID`
- [N/A] L615: - `ALREADY_LINKED`
- [N/A] L616: - `LOGOUT_FAILED`
- [N/A] L617: - `CLEAR_FAILED`
- [N/A] L618: - `SERVER_ERROR`
- [N/A] L620: Regra:
- [N/A] L621: - Producers MAY acrescentar novos `errorCode` sem breaking change (minor), desde que mantenham backward compatibility.
- [N/A] L622: - Consumers MUST tolerar códigos desconhecidos e usar fallback de UX seguro.
- [N/A] L624: ⸻
- [N/A] L626: ## 04 Contracts (C-G*, C01..C18, CAUTH.01, C02 addons)
- [N/A] L628: 6) Contratos de Integração v3.0 (mínimos obrigatórios)
- [N/A] L630: Regra: módulos verticais consomem horizontais via contratos. Contratos são tratados como APIs internas versionadas.
- [N/A] L632: ---
- [N/A] L634: ## Regras de Execução de Contratos (GLOBAL, NORMATIVE)
- [N/A] L636: Esta secção define as regras de execução e compatibilidade que se aplicam
- [N/A] L637: a todos os contratos internos e externos (C01–C18, CAUTH.01, C02.X01 e futuras adições).
- [N/A] L639: Estas regras são obrigatórias e sobrepõem preferências locais de implementação.
- [N/A] L641: ---
- [N/A] L643: ### C-G01 — Ownership Explícito de Contrato
- [N/A] L644: Todo contrato DEVE definir:
- [N/A] L645: - um único domínio/equipa owner
- [N/A] L646: - um ou mais consumers conhecidos
- [N/A] L648: O owner é responsável por compatibilidade, versionamento e ciclo de vida.
- [N/A] L650: ---
- [N/A] L652: ### C-G02 — Versionamento de Contrato
- [N/A] L653: Contratos usam versionamento semântico:
- [N/A] L655: - MAJOR: breaking change
- [N/A] L656: - MINOR: alteração aditiva backward-compatible
- [N/A] L657: - PATCH: clarificação não comportamental ou bug fix
- [N/A] L659: A versão é explícita e nunca inferida.
- [N/A] L661: ---
- [N/A] L663: ### C-G03 — Compatibilidade Retroativa é Obrigatória
- [N/A] L664: Consumers DEVEM:
- [N/A] L665: - tolerar unknown fields
- [N/A] L666: - não depender da ordem dos fields
- [N/A] L667: - não assumir default values sem documentação explícita
- [N/A] L669: Producers NÃO PODEM:
- [N/A] L670: - remover fields em versões minor
- [N/A] L671: - alterar semântica de field sem major version
- [N/A] L673: ---
- [N/A] L675: ### C-G04 — Semântica de Idempotência
- [N/A] L676: Se um contrato aciona side effects, DEVE definir:
- [N/A] L677: - a idempotency key
- [N/A] L678: - o comportamento de retry
- [N/A] L679: - as garantias de tratamento de duplicados
- [N/A] L681: Idempotência aplica-se a retries, crashes e falhas de rede.
- [N/A] L683: ---
- [N/A] L685: ### C-G05 — Padrão de Envelope de Erro
- [N/A] L686: Todos os contratos DEVEM usar uma estrutura de erro consistente contendo:
- [N/A] L687: - errorCode (stable, machine-readable)
- [N/A] L688: - message (human-readable)
- [N/A] L689: - retryable (boolean)
- [N/A] L690: - correlationId
- [N/A] L692: Erros sem classificação são proibidos.
- [N/A] L694: ---
- [N/A] L696: ### C-G06 — Premissas de Tempo e Ordenação
- [N/A] L697: Contratos NÃO PODEM assumir:
- [N/A] L698: - entrega in-order
- [N/A] L699: - single delivery
- [N/A] L700: - clocks sincronizados
- [N/A] L702: Se ordenação importar, o contrato DEVE definir explicitamente chaves de
- [N/A] L703: ordenação ou lógica de reconciliação.
- [N/A] L705: ---
- [N/A] L707: ### C-G07 — Obrigações de Observabilidade
- [N/A] L708: Cada contrato DEVE emitir:
- [N/A] L709: - metrics de sucesso/falha
- [N/A] L710: - metrics de latência (p50, p95)
- [N/A] L711: - logs estruturados com correlationId
- [N/A] L713: Falha silenciosa é proibida.
- [N/A] L715: ---
- [N/A] L717: ### C-G08 — Testes de Compatibilidade
- [N/A] L718: Qualquer alteração de contrato DEVE incluir:
- [N/A] L719: - testes de backward compatibility
- [N/A] L720: - replay de pelo menos um payload histórico
- [N/A] L721: - validação explícita do comportamento de idempotência
- [N/A] L723: ---
- [N/A] L725: ### C-G09 — Documentação é Executável
- [N/A] L726: Cada contrato DEVE incluir:
- [N/A] L727: - payloads de exemplo
- [N/A] L728: - casos de erro de exemplo
- [N/A] L729: - transições de estado explícitas (quando aplicável)
- [N/A] L731: Contratos ambíguos são considerados incompletos.
- [N/A] L733: ---
- [N/A] L735: C01) Reservas ↔ Padel (agenda e slots)
- [N/A] L737: Padel cria slots/bloqueios via contrato; Reservas responde com conflitos/sugestões.
- [N/A] L739: Representação canónica de MatchSlot
- [N/A] L740: 	•	CalendarBlock/Override: kind=BLOCK, reason=MATCH_SLOT, resourceId=courtId, start/end
- [N/A] L741: 	•	Padel nunca escreve no calendário diretamente
- [N/A] L743: Resposta do contrato
- [N/A] L744: 	•	conflitos hard detectados
- [N/A] L745: 	•	sugestões de horários alternativos (Fase 1)
- [N/A] L746: 	•	optimização/yield (Fase 3)
- [N/A] L748: ---
- [N/A] L750: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L752: **Contract ID:** C01
- [N/A] L753: **Contract Name:** Reservas ↔ Padel (agenda e slots)
- [N/A] L754: **Current Version:** v3.0.0
- [N/A] L755: **Owner:** Domain: Reservas (Agenda Engine)
- [N/A] L756: **Primary Consumers:** Padel (Torneios), ORYA-WebApp (org dashboard), internal workers
- [N/A] L758: ---
- [N/A] L760: #### Purpose
- [N/A] L761: Define a interface canónica para criação/atualização de slots/bloqueios na agenda a partir do domínio Padel, com deteção de conflitos.
- [N/A] L763: ---
- [N/A] L765: #### Idempotency
- [N/A] L766: - **Idempotency Key:** idempotencyKey
- [N/A] L767: - **Scope:** per orgId + sourceType/sourceId
- [N/A] L768: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L769:   duplicate side effects.
- [N/A] L771: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L773: ---
- [N/A] L775: #### Input Payload (Example)
- [N/A] L776: ```json
- [N/A] L777: {
- [N/A] L778:   "orgId": "org_123",
- [N/A] L779:   "resourceId": "court_45",
- [N/A] L780:   "startAt": "2026-02-01T10:00:00Z",
- [N/A] L781:   "endAt": "2026-02-01T11:30:00Z",
- [N/A] L782:   "reason": "MATCH_SLOT",
- [N/A] L783:   "sourceType": "PADEL_MATCH",
- [N/A] L784:   "sourceId": "match_789",
- [N/A] L785:   "idempotencyKey": "slot:match_789"
- [N/A] L786: }
- [N/A] L787: ```
- [N/A] L789: #### Output / Response (Example)
- [N/A] L790: ```json
- [N/A] L791: {
- [N/A] L792:   "accepted": true,
- [N/A] L793:   "conflicts": [],
- [N/A] L794:   "correlationId": "corr_abc"
- [N/A] L795: }
- [N/A] L796: ```
- [N/A] L798: #### Error Cases
- [N/A] L799: All errors follow the global error envelope.
- [N/A] L800: Example:
- [N/A] L801: ```json
- [N/A] L802: {
- [N/A] L803:   "errorCode": "SCHEDULE_CONFLICT",
- [N/A] L804:   "message": "Requested slot conflicts with an existing block",
- [N/A] L805:   "retryable": false,
- [N/A] L806:   "correlationId": "corr_abc"
- [N/A] L807: }
- [N/A] L808: ```
- [N/A] L810: ---
- [N/A] L812: #### Ordering & Duplication
- [N/A] L813: This contract MUST tolerate:
- [N/A] L814: - duplicate delivery
- [N/A] L815: - out-of-order delivery
- [N/A] L817: If ordering is required, the following key is authoritative:
- [N/A] L818: startAt
- [N/A] L820: ---
- [N/A] L822: #### Side Effects
- [N/A] L823: This contract MAY trigger:
- [N/A] L824: ☐ ledger entries
- [N/A] L825: ☐ entitlement issuance
- [N/A] L826: ☐ emails / notifications
- [N/A] L827: ☐ downstream async jobs
- [N/A] L829: All side effects MUST be idempotent and observable.
- [N/A] L831: ---
- [N/A] L833: #### Observability
- [N/A] L834: This contract MUST emit:
- [N/A] L835: - success/failure counters
- [N/A] L836: - latency metrics (p50, p95)
- [N/A] L837: - structured logs with correlationId and orgId
- [N/A] L839: ---
- [N/A] L841: #### Compatibility Rules
- [N/A] L842: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L843: - Fields may only be removed or redefined in major versions.
- [N/A] L844: - Consumers MUST tolerate unknown fields.
- [N/A] L846: ---
- [N/A] L848: #### Failure Mode
- [N/A] L849: On uncertainty or partial failure:
- [N/A] L850: - the contract MUST fail closed
- [N/A] L851: - no irreversible side effects may be committed
- [N/A] L853: ---
- [N/A] L855: #### Notes
- [N/A] L856: N/A
- [N/A] L857: C02) Finanças ↔ Todos (checkout/refunds) — gateway único
- [N/A] L859: Todos criam checkout via Finanças; estado pago/refund/chargeback/payout vem sempre de Finanças.
- [N/A] L861: Obrigatório:
- [N/A] L862: 	•	organizationId
- [N/A] L863: 	•	sourceType (canónico)
- [N/A] L864: 	•	sourceId
- [N/A] L865: 	•	amount, currency
- [N/A] L866: 	•	customerIdentityId (Identity SSOT)
- [N/A] L867: 	•	idempotencyKey
- [N/A] L868: 	•	feePolicyVersion
- [N/A] L869: 	• pricingSnapshotJson (imutável) no Payment + pricingSnapshotHash
- [N/A] L870: 	• Conteúdo mínimo do snapshot: feeMode, feeBps, feeFixed, currency, totals (gross/discounts/taxes/platformFee/total/netToOrgPending)
- [N/A] L871: 	•	Processor fees: `processorFeesStatus=PENDING|FINAL` + `processorFeesActual` (nullable até reconciliação Stripe).
- [N/A] L872: 	• O snapshot é congelado no createCheckout e nunca muda após CREATED.
- [N/A] L873: 	• feePolicyVersion continua obrigatório e referencia a política usada para gerar o snapshot.
- [N/A] L875: C02.01) Eventos ↔ Finanças (convites) — resolução determinística
- [N/A] L876: • Objetivo: evitar UI/backend drift em convites e tornar o checkout por convite 100% contratual.
- [N/A] L877: • Entrada: { eventId, inviteToken?, email?, username? }
- [N/A] L878: • Saída: { allowCheckout, constraints: { guestCheckoutAllowed, inviteIdentityMatch, ticketTypeScope? }, resolvedIdentity }
- [N/A] L879: • Regra: Eventos define a policy e Finanças valida/impõe as constraints no createCheckout.
- [N/A] L881: C02.02) Checkout Compatibility Adapters (legacy checkout spec migrated) — **FECHADO**
- [N/A] L882: - Endpoints canónicos:
- [N/A] L883:   - `POST /api/payments/intent`
- [N/A] L884:   - `GET /api/checkout/status`
- [N/A] L885: - Endpoints de compatibilidade (adapters) são permitidos quando:
- [N/A] L886:   - mantêm path legado para clients existentes, e
- [N/A] L887:   - delegam orquestração de pagamento ao domínio Finanças (`C02`) sem bypass.
- [N/A] L888: - Campos de resposta compatíveis (`checkoutId`, `statusV1`, `freeCheckout`, `final`) são aditivos e não substituem o estado canónico do `Payment`.
- [N/A] L889: - Divergência resolvida por SSOT:
- [N/A] L890:   - aliases de status como `PAID` pertencem à camada de compatibilidade de API;
- [N/A] L891:   - verdade financeira canónica continua no state machine de `Payment` (`SUCCEEDED`, etc.) e no ledger append-only.
- [N/A] L892: - Regras de free checkout:
- [N/A] L893:   - `amountCents=0` não cria Stripe intent;
- [N/A] L894:   - finalização deve ser determinística, idempotente, auditável.
- [N/A] L895: - Mobile guardrail:
- [N/A] L896:   - checkout mobile é login-only (sem guest checkout).
- [N/A] L898: ---
- [N/A] L900: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L902: **Contract ID:** C02
- [N/A] L903: **Contract Name:** Finanças ↔ Todos (checkout/refunds) — gateway único
- [N/A] L904: **Current Version:** v3.0.0
- [N/A] L905: **Owner:** Domain: Finanças
- [N/A] L906: **Primary Consumers:** Events, Reservations, Padel, Store, ORYA-WebApp, internal workers
- [N/A] L908: ---
- [N/A] L910: #### Purpose
- [N/A] L911: Define o gateway único para criar checkouts e refunds, garantindo Payment state machine e ledger determinístico.
- [N/A] L913: ---
- [N/A] L915: #### Idempotency
- [N/A] L916: - **Idempotency Key:** idempotencyKey
- [N/A] L917: - **Scope:** per orgId + sourceType + sourceId
- [N/A] L918: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L919:   duplicate side effects.
- [N/A] L921: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L923: ---
- [N/A] L925: #### Input Payload (Example)
- [N/A] L926: ```json
- [N/A] L927: {
- [N/A] L928:   "orgId": "org_123",
- [N/A] L929:   "sourceType": "TICKET_ORDER",
- [N/A] L930:   "sourceId": "to_456",
- [N/A] L931:   "amount": 5000,
- [N/A] L932:   "currency": "EUR",
- [N/A] L933:   "customerIdentityId": "id_789",
- [N/A] L934:   "idempotencyKey": "checkout:to_456"
- [N/A] L935: }
- [N/A] L936: ```
- [N/A] L938: #### Output / Response (Example)
- [N/A] L939: ```json
- [N/A] L940: {
- [N/A] L941:   "paymentId": "pay_123",
- [N/A] L942:   "status": "CREATED",
- [N/A] L943:   "clientSecret": "secret_abc",
- [N/A] L944:   "correlationId": "corr_abc"
- [N/A] L945: }
- [N/A] L946: ```
- [N/A] L948: #### Error Cases
- [N/A] L949: All errors follow the global error envelope.
- [N/A] L950: Example:
- [N/A] L951: ```json
- [N/A] L952: {
- [N/A] L953:   "errorCode": "FINANCE_CONNECT_NOT_READY",
- [N/A] L954:   "message": "Organization Connect account is not ready",
- [N/A] L955:   "retryable": false,
- [N/A] L956:   "correlationId": "corr_abc"
- [N/A] L957: }
- [N/A] L958: ```
- [N/A] L960: ---
- [N/A] L962: #### Ordering & Duplication
- [N/A] L963: This contract MUST tolerate:
- [N/A] L964: - duplicate delivery
- [N/A] L965: - out-of-order delivery
- [N/A] L967: If ordering is required, the following key is authoritative:
- [N/A] L968: NONE
- [N/A] L970: ---
- [N/A] L972: #### Side Effects
- [N/A] L973: This contract MAY trigger:
- [N/A] L974: ☑ ledger entries
- [N/A] L975: ☐ entitlement issuance
- [N/A] L976: ☐ emails / notifications
- [N/A] L977: ☑ downstream async jobs
- [N/A] L979: All side effects MUST be idempotent and observable.
- [N/A] L981: ---
- [N/A] L983: #### Observability
- [N/A] L984: This contract MUST emit:
- [N/A] L985: - success/failure counters
- [N/A] L986: - latency metrics (p50, p95)
- [N/A] L987: - structured logs with correlationId and orgId
- [N/A] L989: ---
- [N/A] L991: #### Compatibility Rules
- [N/A] L992: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L993: - Fields may only be removed or redefined in major versions.
- [N/A] L994: - Consumers MUST tolerate unknown fields.
- [N/A] L996: ---
- [N/A] L998: #### Failure Mode
- [N/A] L999: On uncertainty or partial failure:
- [N/A] L1000: - the contract MUST fail closed
- [N/A] L1001: - no irreversible side effects may be committed
- [N/A] L1003: ---
- [N/A] L1005: #### Notes
- [N/A] L1006: Entitlements são emitidos apenas após Payment SUCCEEDED e reconciliação do ledger.
- [N/A] L1007: C03) Check-in ↔ Eventos/Reservas/Padel — via Entitlement unificado
- [N/A] L1009: Check-in valida QR e resolve origem:
- [N/A] L1010: 	•	ticket (Eventos) ou booking (Reservas) ou inscrição Padel (Padel)
- [N/A] L1012: E grava:
- [N/A] L1013: 	•	EntitlementCheckin + EventLog(checkin.*) + presença/no-show conforme política
- [N/A] L1015: ---
- [N/A] L1017: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1019: **Contract ID:** C03
- [N/A] L1020: **Contract Name:** Check-in ↔ Eventos/Reservas/Padel — via Entitlement unificado
- [N/A] L1021: **Current Version:** v3.0.0
- [N/A] L1022: **Owner:** Domain: Check-in
- [N/A] L1023: **Primary Consumers:** Events, Reservations, Padel, ORYA-WebApp, Scanner API
- [N/A] L1025: ---
- [N/A] L1027: #### Purpose
- [N/A] L1028: Define a validação de acesso via Entitlement e o registo de consumo (check-in).
- [N/A] L1030: ---
- [N/A] L1032: #### Idempotency
- [N/A] L1033: - **Idempotency Key:** entitlementId + scannerId + timeWindow
- [N/A] L1034: - **Scope:** per entitlement + scanner
- [N/A] L1035: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1036:   duplicate side effects.
- [N/A] L1038: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1040: ---
- [N/A] L1042: #### Input Payload (Example)
- [N/A] L1043: ```json
- [N/A] L1044: {
- [N/A] L1045:   "qrPayload": "token_hash",
- [N/A] L1046:   "scannerIdentityId": "id_staff",
- [N/A] L1047:   "eventId": "evt_123",
- [N/A] L1048:   "deviceId": "dev_001",
- [N/A] L1049:   "idempotencyKey": "scan:ent_456:dev_001:2026-02-01T10:00Z"
- [N/A] L1050: }
- [N/A] L1051: ```
- [N/A] L1053: #### Output / Response (Example)
- [N/A] L1054: ```json
- [N/A] L1055: {
- [N/A] L1056:   "allow": true,
- [N/A] L1057:   "entitlementId": "ent_456",
- [N/A] L1058:   "consumedAt": "2026-02-01T10:00:05Z",
- [N/A] L1059:   "correlationId": "corr_abc"
- [N/A] L1060: }
- [N/A] L1061: ```
- [N/A] L1063: #### Error Cases
- [N/A] L1064: All errors follow the global error envelope.
- [N/A] L1065: Example:
- [N/A] L1066: ```json
- [N/A] L1067: {
- [N/A] L1068:   "errorCode": "ENTITLEMENT_NOT_ACTIVE",
- [N/A] L1069:   "message": "Entitlement is not active or already consumed",
- [N/A] L1070:   "retryable": false,
- [N/A] L1071:   "correlationId": "corr_abc"
- [N/A] L1072: }
- [N/A] L1073: ```
- [N/A] L1075: ---
- [N/A] L1077: #### Ordering & Duplication
- [N/A] L1078: This contract MUST tolerate:
- [N/A] L1079: - duplicate delivery
- [N/A] L1080: - out-of-order delivery
- [N/A] L1082: If ordering is required, the following key is authoritative:
- [N/A] L1083: NONE
- [N/A] L1085: ---
- [N/A] L1087: #### Side Effects
- [N/A] L1088: This contract MAY trigger:
- [N/A] L1089: ☐ ledger entries
- [N/A] L1090: ☐ entitlement issuance
- [N/A] L1091: ☐ emails / notifications
- [N/A] L1092: ☐ downstream async jobs
- [N/A] L1094: All side effects MUST be idempotent and observable.
- [N/A] L1096: ---
- [N/A] L1098: #### Observability
- [N/A] L1099: This contract MUST emit:
- [N/A] L1100: - success/failure counters
- [N/A] L1101: - latency metrics (p50, p95)
- [N/A] L1102: - structured logs with correlationId and orgId
- [N/A] L1104: ---
- [N/A] L1106: #### Compatibility Rules
- [N/A] L1107: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1108: - Fields may only be removed or redefined in major versions.
- [N/A] L1109: - Consumers MUST tolerate unknown fields.
- [N/A] L1111: ---
- [N/A] L1113: #### Failure Mode
- [N/A] L1114: On uncertainty or partial failure:
- [N/A] L1115: - the contract MUST fail closed
- [N/A] L1116: - no irreversible side effects may be committed
- [N/A] L1118: ---
- [N/A] L1120: #### Notes
- [N/A] L1121: Consumo é metadata (consumedAt), nunca estado.
- [N/A] L1122: C04) CRM ↔ Todos (timeline)
- [N/A] L1124: CRM recebe eventos a partir do EventLog (não ponto-a-ponto).
- [N/A] L1126: ---
- [N/A] L1128: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1130: **Contract ID:** C04
- [N/A] L1131: **Contract Name:** CRM ↔ Todos (timeline)
- [N/A] L1132: **Current Version:** v3.0.0
- [N/A] L1133: **Owner:** Domain: CRM
- [N/A] L1134: **Primary Consumers:** EventLog consumers, ORYA-WebApp, internal workers
- [N/A] L1136: ---
- [N/A] L1138: #### Purpose
- [N/A] L1139: Define a ingestão de eventos para timeline e segmentação CRM.
- [N/A] L1141: ---
- [N/A] L1143: #### Idempotency
- [N/A] L1144: - **Idempotency Key:** eventId
- [N/A] L1145: - **Scope:** global
- [N/A] L1146: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1147:   duplicate side effects.
- [N/A] L1149: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1151: ---
- [N/A] L1153: #### Input Payload (Example)
- [N/A] L1154: ```json
- [N/A] L1155: {
- [N/A] L1156:   "eventId": "evtlog_123",
- [N/A] L1157:   "eventType": "BOOKING_CONFIRMED",
- [N/A] L1158:   "orgId": "org_123",
- [N/A] L1159:   "identityId": "id_456",
- [N/A] L1160:   "correlationId": "corr_abc"
- [N/A] L1161: }
- [N/A] L1162: ```
- [N/A] L1164: #### Output / Response (Example)
- [N/A] L1165: ```json
- [N/A] L1166: {
- [N/A] L1167:   "status": "INGESTED",
- [N/A] L1168:   "correlationId": "corr_abc"
- [N/A] L1169: }
- [N/A] L1170: ```
- [N/A] L1172: #### Error Cases
- [N/A] L1173: All errors follow the global error envelope.
- [N/A] L1174: Example:
- [N/A] L1175: ```json
- [N/A] L1176: {
- [N/A] L1177:   "errorCode": "EVENTLOG_NOT_FOUND",
- [N/A] L1178:   "message": "No event found for the given eventId",
- [N/A] L1179:   "retryable": true,
- [N/A] L1180:   "correlationId": "corr_abc"
- [N/A] L1181: }
- [N/A] L1182: ```
- [N/A] L1184: ---
- [N/A] L1186: #### Ordering & Duplication
- [N/A] L1187: This contract MUST tolerate:
- [N/A] L1188: - duplicate delivery
- [N/A] L1189: - out-of-order delivery
- [N/A] L1191: If ordering is required, the following key is authoritative:
- [N/A] L1192: NONE
- [N/A] L1194: ---
- [N/A] L1196: #### Side Effects
- [N/A] L1197: This contract MAY trigger:
- [N/A] L1198: ☐ ledger entries
- [N/A] L1199: ☐ entitlement issuance
- [N/A] L1200: ☐ emails / notifications
- [N/A] L1201: ☐ downstream async jobs
- [N/A] L1203: All side effects MUST be idempotent and observable.
- [N/A] L1205: ---
- [N/A] L1207: #### Observability
- [N/A] L1208: This contract MUST emit:
- [N/A] L1209: - success/failure counters
- [N/A] L1210: - latency metrics (p50, p95)
- [N/A] L1211: - structured logs with correlationId and orgId
- [N/A] L1213: ---
- [N/A] L1215: #### Compatibility Rules
- [N/A] L1216: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1217: - Fields may only be removed or redefined in major versions.
- [N/A] L1218: - Consumers MUST tolerate unknown fields.
- [N/A] L1220: ---
- [N/A] L1222: #### Failure Mode
- [N/A] L1223: On uncertainty or partial failure:
- [N/A] L1224: - the contract MUST fail closed
- [N/A] L1225: - no irreversible side effects may be committed
- [N/A] L1227: ---
- [N/A] L1229: #### Notes
- [N/A] L1230: Ingestão é idempotente e tolera replays.
- [N/A] L1231: C05) Notificações ↔ Todos
- [N/A] L1233: Triggers por eventos do sistema + templates + opt-in + logs.
- [N/A] L1235: ---
- [N/A] L1237: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1239: **Contract ID:** C05
- [N/A] L1240: **Contract Name:** Notificações ↔ Todos
- [N/A] L1241: **Current Version:** v3.0.0
- [N/A] L1242: **Owner:** Domain: Notificações
- [N/A] L1243: **Primary Consumers:** Events, Finance, CRM, Padel, ORYA-WebApp, internal workers
- [N/A] L1245: ---
- [N/A] L1247: #### Purpose
- [N/A] L1248: Define o disparo e entrega de notificações (in-app/push) a partir de eventos do sistema.
- [N/A] L1250: ---
- [N/A] L1252: #### Idempotency
- [N/A] L1253: - **Idempotency Key:** sourceEventId
- [N/A] L1254: - **Scope:** per identity + eventId
- [N/A] L1255: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1256:   duplicate side effects.
- [N/A] L1258: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1260: ---
- [N/A] L1262: #### Input Payload (Example)
- [N/A] L1263: ```json
- [N/A] L1264: {
- [N/A] L1265:   "eventId": "evtlog_123",
- [N/A] L1266:   "eventType": "payment.succeeded",
- [N/A] L1267:   "orgId": "org_123",
- [N/A] L1268:   "identityId": "id_456",
- [N/A] L1269:   "channel": "PUSH",
- [N/A] L1270:   "templateKey": "PAYMENT_SUCCEEDED",
- [N/A] L1271:   "correlationId": "corr_abc"
- [N/A] L1272: }
- [N/A] L1273: ```
- [N/A] L1275: #### Output / Response (Example)
- [N/A] L1276: ```json
- [N/A] L1277: {
- [N/A] L1278:   "status": "QUEUED",
- [N/A] L1279:   "notificationId": "notif_789",
- [N/A] L1280:   "correlationId": "corr_abc"
- [N/A] L1281: }
- [N/A] L1282: ```
- [N/A] L1284: #### Error Cases
- [N/A] L1285: All errors follow the global error envelope.
- [N/A] L1286: Example:
- [N/A] L1287: ```json
- [N/A] L1288: {
- [N/A] L1289:   "errorCode": "PUSH_TOKEN_NOT_FOUND",
- [N/A] L1290:   "message": "No push token available for identity",
- [N/A] L1291:   "retryable": false,
- [N/A] L1292:   "correlationId": "corr_abc"
- [N/A] L1293: }
- [N/A] L1294: ```
- [N/A] L1296: ---
- [N/A] L1298: #### Ordering & Duplication
- [N/A] L1299: This contract MUST tolerate:
- [N/A] L1300: - duplicate delivery
- [N/A] L1301: - out-of-order delivery
- [N/A] L1303: If ordering is required, the following key is authoritative:
- [N/A] L1304: NONE
- [N/A] L1306: ---
- [N/A] L1308: #### Side Effects
- [N/A] L1309: This contract MAY trigger:
- [N/A] L1310: ☐ ledger entries
- [N/A] L1311: ☐ entitlement issuance
- [N/A] L1312: ☑ emails / notifications
- [N/A] L1313: ☑ downstream async jobs
- [N/A] L1315: All side effects MUST be idempotent and observable.
- [N/A] L1317: ---
- [N/A] L1319: #### Observability
- [N/A] L1320: This contract MUST emit:
- [N/A] L1321: - success/failure counters
- [N/A] L1322: - latency metrics (p50, p95)
- [N/A] L1323: - structured logs with correlationId and orgId
- [N/A] L1325: ---
- [N/A] L1327: #### Compatibility Rules
- [N/A] L1328: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1329: - Fields may only be removed or redefined in major versions.
- [N/A] L1330: - Consumers MUST tolerate unknown fields.
- [N/A] L1332: ---
- [N/A] L1334: #### Failure Mode
- [N/A] L1335: On uncertainty or partial failure:
- [N/A] L1336: - the contract MUST fail closed
- [N/A] L1337: - no irreversible side effects may be committed
- [N/A] L1339: ---
- [N/A] L1341: #### Notes
- [N/A] L1342: Envio real ocorre apenas via consumer idempotente.
- [N/A] L1343: C06) Inscrições Padel vs Bilhetes (coexistência simples e eficaz)
- [N/A] L1344: 	•	inscrição Padel é competitiva (Padel)
- [N/A] L1345: 	•	bilhete é acesso/presença (Eventos)
- [N/A] L1346: 	•	pagamentos sempre via Finanças
- [N/A] L1348: Regras:
- [N/A] L1349: 	1.	Padel nunca cria bilhetes; Eventos nunca cria inscrições
- [N/A] L1350: 	2.	inscrição Padel referencia eventId
- [N/A] L1351: 	3.	pago vem de Finanças
- [N/A] L1352: 	4.	check-in aceita ticket/booking/inscrição conforme policy do evento
- [N/A] L1354: ---
- [N/A] L1356: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1358: **Contract ID:** C06
- [N/A] L1359: **Contract Name:** Inscrições Padel vs Bilhetes (coexistência simples e eficaz)
- [N/A] L1360: **Current Version:** v3.0.0
- [N/A] L1361: **Owner:** Domain: Padel (Torneios)
- [N/A] L1362: **Primary Consumers:** Events, Finance, Check-in, ORYA-WebApp
- [N/A] L1364: ---
- [N/A] L1366: #### Purpose
- [N/A] L1367: Define a coexistência entre inscrições Padel e bilhetes, mantendo pagamentos e check-in canónicos.
- [N/A] L1369: ---
- [N/A] L1371: #### Idempotency
- [N/A] L1372: - **Idempotency Key:** idempotencyKey
- [N/A] L1373: - **Scope:** per padelRegistrationId
- [N/A] L1374: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1375:   duplicate side effects.
- [N/A] L1377: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1379: ---
- [N/A] L1381: #### Input Payload (Example)
- [N/A] L1382: ```json
- [N/A] L1383: {
- [N/A] L1384:   "padelRegistrationId": "reg_123",
- [N/A] L1385:   "eventId": "evt_456",
- [N/A] L1386:   "paymentId": "pay_789",
- [N/A] L1387:   "sourceType": "PADEL_REGISTRATION",
- [N/A] L1388:   "correlationId": "corr_abc"
- [N/A] L1389: }
- [N/A] L1390: ```
- [N/A] L1392: #### Output / Response (Example)
- [N/A] L1393: ```json
- [N/A] L1394: {
- [N/A] L1395:   "status": "LINKED",
- [N/A] L1396:   "correlationId": "corr_abc"
- [N/A] L1397: }
- [N/A] L1398: ```
- [N/A] L1400: #### Error Cases
- [N/A] L1401: All errors follow the global error envelope.
- [N/A] L1402: Example:
- [N/A] L1403: ```json
- [N/A] L1404: {
- [N/A] L1405:   "errorCode": "PAYMENT_NOT_SUCCEEDED",
- [N/A] L1406:   "message": "Payment must be SUCCEEDED before confirmation",
- [N/A] L1407:   "retryable": true,
- [N/A] L1408:   "correlationId": "corr_abc"
- [N/A] L1409: }
- [N/A] L1410: ```
- [N/A] L1412: ---
- [N/A] L1414: #### Ordering & Duplication
- [N/A] L1415: This contract MUST tolerate:
- [N/A] L1416: - duplicate delivery
- [N/A] L1417: - out-of-order delivery
- [N/A] L1419: If ordering is required, the following key is authoritative:
- [N/A] L1420: NONE
- [N/A] L1422: ---
- [N/A] L1424: #### Side Effects
- [N/A] L1425: This contract MAY trigger:
- [N/A] L1426: ☐ ledger entries
- [N/A] L1427: ☐ entitlement issuance
- [N/A] L1428: ☐ emails / notifications
- [N/A] L1429: ☐ downstream async jobs
- [N/A] L1431: All side effects MUST be idempotent and observable.
- [N/A] L1433: ---
- [N/A] L1435: #### Observability
- [N/A] L1436: This contract MUST emit:
- [N/A] L1437: - success/failure counters
- [N/A] L1438: - latency metrics (p50, p95)
- [N/A] L1439: - structured logs with correlationId and orgId
- [N/A] L1441: ---
- [N/A] L1443: #### Compatibility Rules
- [N/A] L1444: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1445: - Fields may only be removed or redefined in major versions.
- [N/A] L1446: - Consumers MUST tolerate unknown fields.
- [N/A] L1448: ---
- [N/A] L1450: #### Failure Mode
- [N/A] L1451: On uncertainty or partial failure:
- [N/A] L1452: - the contract MUST fail closed
- [N/A] L1453: - no irreversible side effects may be committed
- [N/A] L1455: ---
- [N/A] L1457: #### Notes
- [N/A] L1458: Inscrição e bilhete permanecem entidades distintas; Entitlement é o acesso.
- [N/A] L1459: C07) Address Service ↔ Todos (moradas e localizações)
- [N/A] L1460: 	•	criação/normalização de moradas passa pelo Address Service
- [N/A] L1461: 	•	módulos guardam apenas addressId (ou placeId) e nunca strings “soltas” como fonte de verdade
- [N/A] L1462: 	•	migração: adapters para eliminar “várias verdades” existentes
- [N/A] L1464: ---
- [N/A] L1466: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1468: **Contract ID:** C07
- [N/A] L1469: **Contract Name:** Address Service ↔ Todos (moradas e localizações)
- [N/A] L1470: **Current Version:** v3.0.0
- [N/A] L1471: **Owner:** Domain: Address Service
- [N/A] L1472: **Primary Consumers:** Events, Reservations, Store, Services, Padel, ORYA-WebApp
- [N/A] L1474: ---
- [N/A] L1476: #### Purpose
- [N/A] L1477: Define a normalização e resolução de moradas via Address Service (SSOT).
- [N/A] L1479: ---
- [N/A] L1481: #### Idempotency
- [N/A] L1482: - **Idempotency Key:** placeId
- [N/A] L1483: - **Scope:** per placeId
- [N/A] L1484: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1485:   duplicate side effects.
- [N/A] L1487: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1489: ---
- [N/A] L1491: #### Input Payload (Example)
- [N/A] L1492: ```json
- [N/A] L1493: {
- [N/A] L1494:   "placeId": "apple:place_123",
- [N/A] L1495:   "label": "Club ORYA, Lisboa",
- [N/A] L1496:   "correlationId": "corr_abc"
- [N/A] L1497: }
- [N/A] L1498: ```
- [N/A] L1500: #### Output / Response (Example)
- [N/A] L1501: ```json
- [N/A] L1502: {
- [N/A] L1503:   "addressId": "addr_123",
- [N/A] L1504:   "formattedAddress": "Rua X, Lisboa",
- [N/A] L1505:   "geo": {"lat": 38.72, "lng": -9.14},
- [N/A] L1506:   "correlationId": "corr_abc"
- [N/A] L1507: }
- [N/A] L1508: ```
- [N/A] L1510: #### Error Cases
- [N/A] L1511: All errors follow the global error envelope.
- [N/A] L1512: Example:
- [N/A] L1513: ```json
- [N/A] L1514: {
- [N/A] L1515:   "errorCode": "ADDRESS_NOT_RESOLVED",
- [N/A] L1516:   "message": "Unable to resolve placeId",
- [N/A] L1517:   "retryable": true,
- [N/A] L1518:   "correlationId": "corr_abc"
- [N/A] L1519: }
- [N/A] L1520: ```
- [N/A] L1522: ---
- [N/A] L1524: #### Ordering & Duplication
- [N/A] L1525: This contract MUST tolerate:
- [N/A] L1526: - duplicate delivery
- [N/A] L1527: - out-of-order delivery
- [N/A] L1529: If ordering is required, the following key is authoritative:
- [N/A] L1530: NONE
- [N/A] L1532: ---
- [N/A] L1534: #### Side Effects
- [N/A] L1535: This contract MAY trigger:
- [N/A] L1536: ☐ ledger entries
- [N/A] L1537: ☐ entitlement issuance
- [N/A] L1538: ☐ emails / notifications
- [N/A] L1539: ☐ downstream async jobs
- [N/A] L1541: All side effects MUST be idempotent and observable.
- [N/A] L1543: ---
- [N/A] L1545: #### Observability
- [N/A] L1546: This contract MUST emit:
- [N/A] L1547: - success/failure counters
- [N/A] L1548: - latency metrics (p50, p95)
- [N/A] L1549: - structured logs with correlationId and orgId
- [N/A] L1551: ---
- [N/A] L1553: #### Compatibility Rules
- [N/A] L1554: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1555: - Fields may only be removed or redefined in major versions.
- [N/A] L1556: - Consumers MUST tolerate unknown fields.
- [N/A] L1558: ---
- [N/A] L1560: #### Failure Mode
- [N/A] L1561: On uncertainty or partial failure:
- [N/A] L1562: - the contract MUST fail closed
- [N/A] L1563: - no irreversible side effects may be committed
- [N/A] L1565: ---
- [N/A] L1567: #### Notes
- [N/A] L1568: Deduplicação por canonical+geo evita duplicados.
- [N/A] L1569: C08) Loyalty ↔ CRM/Finanças/Promoções
- [N/A] L1570: 	•	pontos gerados por eventos (compra, presença, actividade)
- [N/A] L1571: 	•	redemptions obedecem a guardrails globais + política da organização
- [N/A] L1572: 	•	pontos não alteram ledger financeiro (não é dinheiro) — mas podem gerar descontos via Promoções
- [N/A] L1574: ---
- [N/A] L1576: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1578: **Contract ID:** C08
- [N/A] L1579: **Contract Name:** Loyalty ↔ CRM/Finanças/Promoções
- [N/A] L1580: **Current Version:** v3.0.0
- [N/A] L1581: **Owner:** Domain: Loyalty
- [N/A] L1582: **Primary Consumers:** CRM, Finance, Promotions, ORYA-WebApp
- [N/A] L1584: ---
- [N/A] L1586: #### Purpose
- [N/A] L1587: Define emissão e resgate de pontos de fidelização a partir de eventos canónicos.
- [N/A] L1589: ---
- [N/A] L1591: #### Idempotency
- [N/A] L1592: - **Idempotency Key:** eventId
- [N/A] L1593: - **Scope:** per identity + eventId
- [N/A] L1594: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1595:   duplicate side effects.
- [N/A] L1597: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1599: ---
- [N/A] L1601: #### Input Payload (Example)
- [N/A] L1602: ```json
- [N/A] L1603: {
- [N/A] L1604:   "eventId": "evtlog_123",
- [N/A] L1605:   "eventType": "LOYALTY_EARNED",
- [N/A] L1606:   "orgId": "org_123",
- [N/A] L1607:   "identityId": "id_456",
- [N/A] L1608:   "points": 100,
- [N/A] L1609:   "sourceRef": {"sourceType": "BOOKING", "sourceId": "bk_789"},
- [N/A] L1610:   "correlationId": "corr_abc"
- [N/A] L1611: }
- [N/A] L1612: ```
- [N/A] L1614: #### Output / Response (Example)
- [N/A] L1615: ```json
- [N/A] L1616: {
- [N/A] L1617:   "status": "APPLIED",
- [N/A] L1618:   "balance": 1200,
- [N/A] L1619:   "correlationId": "corr_abc"
- [N/A] L1620: }
- [N/A] L1621: ```
- [N/A] L1623: #### Error Cases
- [N/A] L1624: All errors follow the global error envelope.
- [N/A] L1625: Example:
- [N/A] L1626: ```json
- [N/A] L1627: {
- [N/A] L1628:   "errorCode": "LOYALTY_POLICY_VIOLATION",
- [N/A] L1629:   "message": "Points award violates policy",
- [N/A] L1630:   "retryable": false,
- [N/A] L1631:   "correlationId": "corr_abc"
- [N/A] L1632: }
- [N/A] L1633: ```
- [N/A] L1635: ---
- [N/A] L1637: #### Ordering & Duplication
- [N/A] L1638: This contract MUST tolerate:
- [N/A] L1639: - duplicate delivery
- [N/A] L1640: - out-of-order delivery
- [N/A] L1642: If ordering is required, the following key is authoritative:
- [N/A] L1643: NONE
- [N/A] L1645: ---
- [N/A] L1647: #### Side Effects
- [N/A] L1648: This contract MAY trigger:
- [N/A] L1649: ☐ ledger entries
- [N/A] L1650: ☐ entitlement issuance
- [N/A] L1651: ☐ emails / notifications
- [N/A] L1652: ☐ downstream async jobs
- [N/A] L1654: All side effects MUST be idempotent and observable.
- [N/A] L1656: ---
- [N/A] L1658: #### Observability
- [N/A] L1659: This contract MUST emit:
- [N/A] L1660: - success/failure counters
- [N/A] L1661: - latency metrics (p50, p95)
- [N/A] L1662: - structured logs with correlationId and orgId
- [N/A] L1664: ---
- [N/A] L1666: #### Compatibility Rules
- [N/A] L1667: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1668: - Fields may only be removed or redefined in major versions.
- [N/A] L1669: - Consumers MUST tolerate unknown fields.
- [N/A] L1671: ---
- [N/A] L1673: #### Failure Mode
- [N/A] L1674: On uncertainty or partial failure:
- [N/A] L1675: - the contract MUST fail closed
- [N/A] L1676: - no irreversible side effects may be committed
- [N/A] L1678: ---
- [N/A] L1680: #### Notes
- [N/A] L1681: Pontos não alteram ledger financeiro.
- [N/A] L1682: C09) Activity Feed ↔ EventLog/Chat
- [N/A] L1683: 	•	consumer do EventLog transforma eventos seleccionados em:
- [N/A] L1684: 	•	ActivityItem (UI)
- [N/A] L1685: 	•	mensagem automática no canal “Ops” (Chat interno)
- [N/A] L1687: ⸻
- [N/A] L1689: ---
- [N/A] L1691: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1693: **Contract ID:** C09
- [N/A] L1694: **Contract Name:** Activity Feed ↔ EventLog/Chat
- [N/A] L1695: **Current Version:** v3.0.0
- [N/A] L1696: **Owner:** Domain: Ops Feed / Chat
- [N/A] L1697: **Primary Consumers:** Ops UI, Chat interno, ORYA-WebApp
- [N/A] L1699: ---
- [N/A] L1701: #### Purpose
- [N/A] L1702: Define a materialização do Activity Feed a partir do EventLog e a publicação no canal Ops.
- [N/A] L1704: ---
- [N/A] L1706: #### Idempotency
- [N/A] L1707: - **Idempotency Key:** eventId
- [N/A] L1708: - **Scope:** global
- [N/A] L1709: - **Guarantee:** repeated requests with the same key MUST NOT produce
- [N/A] L1710:   duplicate side effects.
- [N/A] L1712: If idempotency cannot be guaranteed, the contract is considered invalid.
- [N/A] L1714: ---
- [N/A] L1716: #### Input Payload (Example)
- [N/A] L1717: ```json
- [N/A] L1718: {
- [N/A] L1719:   "eventId": "evtlog_123",
- [N/A] L1720:   "eventType": "payment.succeeded",
- [N/A] L1721:   "orgId": "org_123",
- [N/A] L1722:   "correlationId": "corr_abc"
- [N/A] L1723: }
- [N/A] L1724: ```
- [N/A] L1726: #### Output / Response (Example)
- [N/A] L1727: ```json
- [N/A] L1728: {
- [N/A] L1729:   "status": "POSTED",
- [N/A] L1730:   "activityItemId": "act_456",
- [N/A] L1731:   "correlationId": "corr_abc"
- [N/A] L1732: }
- [N/A] L1733: ```
- [N/A] L1735: #### Error Cases
- [N/A] L1736: All errors follow the global error envelope.
- [N/A] L1737: Example:
- [N/A] L1738: ```json
- [N/A] L1739: {
- [N/A] L1740:   "errorCode": "OPS_CHANNEL_UNAVAILABLE",
- [N/A] L1741:   "message": "Unable to post to Ops channel",
- [N/A] L1742:   "retryable": true,
- [N/A] L1743:   "correlationId": "corr_abc"
- [N/A] L1744: }
- [N/A] L1745: ```
- [N/A] L1747: ---
- [N/A] L1749: #### Ordering & Duplication
- [N/A] L1750: This contract MUST tolerate:
- [N/A] L1751: - duplicate delivery
- [N/A] L1752: - out-of-order delivery
- [N/A] L1754: If ordering is required, the following key is authoritative:
- [N/A] L1755: createdAt
- [N/A] L1757: ---
- [N/A] L1759: #### Side Effects
- [N/A] L1760: This contract MAY trigger:
- [N/A] L1761: ☐ ledger entries
- [N/A] L1762: ☐ entitlement issuance
- [N/A] L1763: ☐ emails / notifications
- [N/A] L1764: ☑ downstream async jobs
- [N/A] L1766: All side effects MUST be idempotent and observable.
- [N/A] L1768: ---
- [N/A] L1770: #### Observability
- [N/A] L1771: This contract MUST emit:
- [N/A] L1772: - success/failure counters
- [N/A] L1773: - latency metrics (p50, p95)
- [N/A] L1774: - structured logs with correlationId and orgId
- [N/A] L1776: ---
- [N/A] L1778: #### Compatibility Rules
- [N/A] L1779: - Fields may only be added as OPTIONAL in minor versions.
- [N/A] L1780: - Fields may only be removed or redefined in major versions.
- [N/A] L1781: - Consumers MUST tolerate unknown fields.
- [N/A] L1783: ---
- [N/A] L1785: #### Failure Mode
- [N/A] L1786: On uncertainty or partial failure:
- [N/A] L1787: - the contract MUST fail closed
- [N/A] L1788: - no irreversible side effects may be committed
- [N/A] L1790: ---
- [N/A] L1792: #### Notes
- [N/A] L1793: Consumer dedupe por eventId; replays não duplicam items.
- [N/A] L1795: C10) Stripe Webhooks ↔ Finanças (ingestão e reconciliação) — **FECHADO**
- [N/A] L1796: Regras:
- [N/A] L1797: 	•	Endpoint canónico: `/api/stripe/webhook` (alias `/api/webhooks/stripe` deve apontar para o mesmo handler).
- [N/A] L1798: 	•	Assinatura Stripe obrigatória; rejeitar se `livemode` não corresponder ao modo esperado.
- [N/A] L1799: 	•	Dedupe obrigatório por `stripeEventId` (idempotencyKey global).
- [N/A] L1800: 	•	Resolver `orgId` por `stripeAccountId` (Connect) ou metadata `orgId` no PaymentIntent/Charge.
- [N/A] L1801: 	•	Se `orgId` não for resolvido → guardar evento + DLQ + alerta (sem side‑effects).
- [N/A] L1802: 	•	Persistir evento bruto (`StripeEvent`) com: `stripeEventId`, `type`, `account`, `created`, `livemode`, `requestId?`, `correlationId`.
- [N/A] L1803: 	•	Mapeamento mínimo (SSOT):
- [N/A] L1804: 		–	`payment_intent.succeeded` → Payment.SUCCEEDED + ledger + entitlements
- [N/A] L1805: 		–	`payment_intent.processing` → Payment.PROCESSING
- [N/A] L1806: 		–	`payment_intent.payment_failed` → Payment.FAILED
- [N/A] L1807: 		–	`payment_intent.canceled` → Payment.CANCELLED
- [N/A] L1808: 		–	`charge.refunded` → Payment.REFUNDED/PARTIAL_REFUND + reversões de ledger
- [N/A] L1809: 		–	`charge.dispute.created` → Payment.DISPUTED + Entitlement.SUSPENDED
- [N/A] L1810: 		–	`charge.dispute.closed` → CHARGEBACK_WON/LOST + entitlement update + ledger
- [N/A] L1811: 		–	`balance.available` → trigger reconciliação (fees finais)
- [N/A] L1812: 		–	`payout.paid` / `payout.failed` → atualizar read‑model de Payout (não controla payout)
- [N/A] L1813: 	•	Estados terminais não regredem; apenas transições permitidas pelo state machine (D04.09).
- [N/A] L1815: ---
- [N/A] L1817: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1819: **Contract ID:** C10
- [N/A] L1820: **Contract Name:** Stripe Webhooks ↔ Finanças (ingestão e reconciliação)
- [N/A] L1821: **Current Version:** v1.0.0
- [N/A] L1822: **Owner:** Domain: Finanças
- [N/A] L1823: **Primary Consumers:** Webhook handler, Finance workers, Entitlement issuance, Ledger
- [N/A] L1825: #### Purpose
- [N/A] L1826: Garantir ingestão idempotente de eventos Stripe e reconciliação determinística do estado financeiro.
- [N/A] L1828: #### Idempotency
- [N/A] L1829: - **Idempotency Key:** stripeEventId
- [N/A] L1830: - **Scope:** global
- [N/A] L1831: - **Guarantee:** replays não duplicam side‑effects.
- [N/A] L1833: #### Input Payload (Example)
- [N/A] L1834: ```json
- [N/A] L1835: {
- [N/A] L1836:   "id": "evt_123",
- [N/A] L1837:   "type": "payment_intent.succeeded",
- [N/A] L1838:   "livemode": true,
- [N/A] L1839:   "data": {"object": {"id": "pi_456"}},
- [N/A] L1840:   "created": 1769900000
- [N/A] L1841: }
- [N/A] L1842: ```
- [N/A] L1844: #### Output / Response (Example)
- [N/A] L1845: ```json
- [N/A] L1846: {"status":"ACK","stripeEventId":"evt_123"}
- [N/A] L1847: ```
- [N/A] L1849: #### Error Cases
- [N/A] L1850: - `INVALID_SIGNATURE`
- [N/A] L1851: - `LIVEMODE_MISMATCH`
- [N/A] L1852: - `ORG_UNRESOLVED` (armazenar + DLQ + alerta; **sem side‑effects**)
- [N/A] L1854: #### Ordering & Duplication
- [N/A] L1855: Tolerar duplicados e out‑of‑order.
- [N/A] L1856: Eventos antigos não podem reverter estados terminais.
- [N/A] L1858: #### Side Effects
- [N/A] L1859: ☑ ledger entries
- [N/A] L1860: ☑ entitlement issuance
- [N/A] L1861: ☑ downstream async jobs
- [N/A] L1862: ☑ notifications (quando aplicável)
- [N/A] L1864: #### Observability
- [N/A] L1865: Logs e métricas com `stripeEventId`, `stripeAccountId`, `orgId`, `paymentId`, `correlationId`.
- [N/A] L1867: #### Failure Mode
- [N/A] L1868: Assinatura inválida → 400.
- [N/A] L1869: Org não resolvida → 200 (ACK) + DLQ + alerta; nenhum side‑effect.
- [N/A] L1871: ---
- [N/A] L1873: C11) EventLog + Outbox (schema canónico e versionamento) — **FECHADO**
- [N/A] L1875: Regras:
- [N/A] L1876: 	•	`eventType` em formato `domain.action` (lowercase, sem espaços).
- [N/A] L1877: 	•	`eventVersion` obrigatório (semver).
- [N/A] L1878: 	•	Campos mínimos do EventLog:
- [N/A] L1879: 		–	`eventId` (UUID), `eventType`, `eventVersion`, `orgId`
- [N/A] L1880: 		–	`subjectType`, `subjectId`
- [N/A] L1881: 		–	`actorIdentityId?`, `causationId`, `correlationId`
- [N/A] L1882: 		–	`payload` (PII minimizado), `createdAt`
- [N/A] L1883: 	•	PII: sem email/telefone em claro; usar `identityId`/hash.
- [N/A] L1884: 	•	Qualquer mutação com side‑effects escreve **EventLog + Outbox** na mesma transação.
- [N/A] L1885: 	•	Outbox é append‑only e garante at‑least‑once; consumers são idempotentes.
- [N/A] L1887: ---
- [N/A] L1889: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1891: **Contract ID:** C11
- [N/A] L1892: **Contract Name:** EventLog + Outbox (schema e versionamento)
- [N/A] L1893: **Current Version:** v1.0.0
- [N/A] L1894: **Owner:** Domain: Ops/Platform
- [N/A] L1895: **Primary Consumers:** Workers, CRM, Activity Feed, Search, Analytics
- [N/A] L1897: #### Purpose
- [N/A] L1898: Garantir trilho auditável, versionado e compatível para todos os eventos internos.
- [N/A] L1900: #### Idempotency
- [N/A] L1901: - **Idempotency Key:** eventId
- [N/A] L1902: - **Scope:** global
- [N/A] L1904: #### Input Payload (Example)
- [N/A] L1905: ```json
- [N/A] L1906: {
- [N/A] L1907:   "eventId": "evt_abc",
- [N/A] L1908:   "eventType": "payment.succeeded",
- [N/A] L1909:   "eventVersion": "1.0.0",
- [N/A] L1910:   "orgId": "org_123",
- [N/A] L1911:   "subjectType": "PAYMENT",
- [N/A] L1912:   "subjectId": "pay_456",
- [N/A] L1913:   "correlationId": "corr_789"
- [N/A] L1914: }
- [N/A] L1915: ```
- [N/A] L1917: #### Ordering & Duplication
- [N/A] L1918: At‑least‑once; consumidores idempotentes; ordering não garantido.
- [N/A] L1920: #### Side Effects
- [N/A] L1921: ☑ downstream async jobs
- [N/A] L1922: ☑ materializações (read‑models)
- [N/A] L1924: #### Observability
- [N/A] L1925: EventLog é fonte para métricas e auditoria; payload com PII minimizado.
- [N/A] L1927: ---
- [N/A] L1929: C12) Identity/Auth (SSOT + claim/merge) — **FECHADO**
- [N/A] L1931: Regras:
- [N/A] L1932: 	•	Tipos: `USER` e `GUEST_EMAIL`.
- [N/A] L1933: 	•	Email normalizado: `trim + NFKC + lowercase`; hash HMAC para dedupe.
- [N/A] L1934: 	•	Guest checkout cria/usa `Identity(GUEST_EMAIL)` por email normalizado.
- [N/A] L1935: 	•	Email verificado → **claim automático** para `Identity(USER)`:
- [N/A] L1936: 		–	mover Entitlements para o USER
- [N/A] L1937: 		–	criar registo de merge (auditável)
- [N/A] L1938: 		–	**não** alterar LedgerEntry nem Payment histórico
- [N/A] L1939: 	•	Merge é idempotente e nunca destrói histórico; identidade antiga fica como tombstone.
- [N/A] L1941: ---
- [N/A] L1943: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1945: **Contract ID:** C12
- [N/A] L1946: **Contract Name:** Identity/Auth (SSOT + claim/merge)
- [N/A] L1947: **Current Version:** v1.0.0
- [N/A] L1948: **Owner:** Domain: Identity/Auth
- [N/A] L1949: **Primary Consumers:** Finanças, Entitlements, CRM, Check‑in, Org/RBAC
- [N/A] L1951: #### Idempotency
- [N/A] L1952: - **Idempotency Key:** `emailHash + userId` (claim)
- [N/A] L1953: - **Scope:** global
- [N/A] L1955: #### Failure Mode
- [N/A] L1956: Sem email verificado → claim bloqueado (fail‑closed).
- [N/A] L1958: ---
- [N/A] L1960: C13) Org Context + RBAC (resolução e step‑up) — **FECHADO**
- [N/A] L1962: Regras:
- [N/A] L1963: 	•	`orgId` é obrigatório no path (`/org/:orgId/*`) ou header `X-ORYA-ORG-ID`.
- [N/A] L1964: 	•	Cookies/lastUsedOrg **só** para redirect de UI (nunca para autorização).
- [N/A] L1965: 	•	Qualquer operação sem `orgId` resolve para **403** com `ORG_CONTEXT_REQUIRED`.
- [N/A] L1966: 	•	Step‑up obrigatório em ações críticas (refunds, alterações de fee policy, export PII, cancelamentos).
- [N/A] L1967: 	•	Service roles não podem bypassar isolamento de org.
- [N/A] L1969: ---
- [N/A] L1971: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1973: **Contract ID:** C13
- [N/A] L1974: **Contract Name:** Org Context + RBAC (resolução e step‑up)
- [N/A] L1975: **Current Version:** v1.0.0
- [N/A] L1976: **Owner:** Domain: Security/RBAC
- [N/A] L1977: **Primary Consumers:** Todos os módulos B2B
- [N/A] L1979: #### Failure Mode
- [N/A] L1980: Ambiguidade de org → fail‑closed (403) + audit log.
- [N/A] L1982: ---
- [N/A] L1984: C14) Payout Release + Risk Holds (ops) — **FECHADO**
- [N/A] L1986: Regras:
- [N/A] L1987: 	•	ORYA **não** controla payouts em Stripe Standard; controla **gating operacional**.
- [N/A] L1988: 	•	Release interno é **read‑model** + alerta; não altera Stripe.
- [N/A] L1989: 	•	Pré‑requisitos para “allow new checkouts”:
- [N/A] L1990: 		–	`onboardingStatus=COMPLETE`
- [N/A] L1991: 		–	sem `risk.hold=true`
- [N/A] L1992: 		–	thresholds 19.2.2 não excedidos
- [N/A] L1993: 	•	Se bloqueado: `payoutsBlocked=true`, emitir `risk.flagged` + Ops alert.
- [N/A] L1995: ---
- [N/A] L1997: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L1999: **Contract ID:** C14
- [N/A] L2000: **Contract Name:** Payout Release + Risk Holds
- [N/A] L2001: **Current Version:** v1.0.0
- [N/A] L2002: **Owner:** Domain: Ops/Finanças
- [N/A] L2003: **Primary Consumers:** Payout cron, Admin Ops UI
- [N/A] L2005: #### Idempotency
- [N/A] L2006: - **Idempotency Key:** payoutId ou balance_transaction.id
- [N/A] L2007: - **Scope:** por org
- [N/A] L2009: ---
- [N/A] L2011: C15) Money & Rounding (pricing determinístico) — **FECHADO**
- [N/A] L2013: Regras:
- [N/A] L2014: 	•	Todos os montantes são **inteiros** em minor units (sem floats).
- [N/A] L2015: 	•	Rounding: `round_half_up` em cada passo relevante.
- [N/A] L2016: 	•	Ordem canónica:
- [N/A] L2017: 		1) `gross = sum(lineItems)`
- [N/A] L2018: 		2) `discounts` → `subtotal`
- [N/A] L2019: 		3) `taxes` (se aplicável) sobre `subtotal`
- [N/A] L2020: 		4) `platformFee` (base: `subtotal` por default; override via FeePolicyVersion)
- [N/A] L2021: 		5) `total = subtotal + taxes + fee` (se `feeMode=ADDED`)
- [N/A] L2022: 	•	`pricingSnapshot` é imutável; qualquer cálculo posterior deriva do snapshot + Ledger.
- [N/A] L2024: ---
- [N/A] L2026: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2028: **Contract ID:** C15
- [N/A] L2029: **Contract Name:** Money & Rounding (pricing determinístico)
- [N/A] L2030: **Current Version:** v1.0.0
- [N/A] L2031: **Owner:** Domain: Finanças
- [N/A] L2032: **Primary Consumers:** Finanças, Events, Store, Reservations, Padel
- [N/A] L2034: ---
- [N/A] L2036: C16) Search Index (read‑model derivado) — **FECHADO**
- [N/A] L2038: Regras:
- [N/A] L2039: 	•	Index é read‑model derivado do EventLog (não é owner).
- [N/A] L2040: 	•	Jobs idempotentes por `sourceType+sourceId+version`.
- [N/A] L2041: 	•	Unpublish/disable → remoção/soft‑delete no index.
- [N/A] L2042: 	•	Rebuild completo por job (reprodutível).
- [N/A] L2044: ---
- [N/A] L2046: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2048: **Contract ID:** C16
- [N/A] L2049: **Contract Name:** Search Index (read‑model derivado)
- [N/A] L2050: **Current Version:** v1.0.0
- [N/A] L2051: **Owner:** Domain: Search/Discovery
- [N/A] L2052: **Primary Consumers:** Discover UI, Public Search
- [N/A] L2054: ---
- [N/A] L2056: C17) CRM Ingest + Dedupe (read‑model) — **FECHADO**
- [N/A] L2058: Regras:
- [N/A] L2059: 	•	CRM ingere **apenas** a partir do EventLog.
- [N/A] L2060: 	•	Idempotência por `eventId`; se existir `externalId`, dedupe por `(orgId, externalId)`.
- [N/A] L2061: 	•	Rebuild diário reprodutível; nunca confiar em contadores incrementais sem replay.
- [N/A] L2063: ---
- [N/A] L2065: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2067: **Contract ID:** C17
- [N/A] L2068: **Contract Name:** CRM Ingest + Dedupe
- [N/A] L2069: **Current Version:** v1.0.0
- [N/A] L2070: **Owner:** Domain: CRM
- [N/A] L2071: **Primary Consumers:** CRM UI, Analytics, Ops
- [N/A] L2073: ---
- [N/A] L2075: C18) Media/Uploads (SSOT de ficheiros) — **FECHADO**
- [N/A] L2077: Regras:
- [N/A] L2078: 	•	Todo upload cria `MediaAsset` com owner, orgId, checksum e metadata.
- [N/A] L2079: 	•	Acesso por URLs assinadas com TTL (sem public‑by‑default).
- [N/A] L2080: 	•	Apagar asset remove acesso e invalida URLs; logs/audit obrigatórios.
- [N/A] L2082: ---
- [N/A] L2084: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2086: **Contract ID:** C18
- [N/A] L2087: **Contract Name:** Media/Uploads (SSOT de ficheiros)
- [N/A] L2088: **Current Version:** v1.0.0
- [N/A] L2089: **Owner:** Domain: Platform/Storage
- [N/A] L2090: **Primary Consumers:** Events, Store, Org Profile, Mobile/Web
- [N/A] L2092: ---
- [N/A] L2094: CAUTH.01) Official Email Gate (organização) — **FECHADO**
- [N/A] L2096: Regras:
- [N/A] L2097: 	•	`CAUTH.01` é o contrato canónico do gate de email oficial verificado para ações sensíveis da organização.
- [N/A] L2098: 	•	Escopo: validação de acesso em mutações B2B sensíveis (ex.: payouts, exports financeiros, settings críticos).
- [N/A] L2099: 	•	Condição canónica de verificação:
- [N/A] L2100: 		–	`normalize(officialEmail)` existe;
- [N/A] L2101: 		–	`officialEmailVerifiedAt != null`.
- [N/A] L2102: 	•	Normalização canónica:
- [N/A] L2103: 		–	`trim + NFKC + lowercase`;
- [N/A] L2104: 		–	valor persistido em `Organization.officialEmail` já normalizado.
- [N/A] L2105: 	•	Códigos canónicos de erro:
- [N/A] L2106: 		–	`OFFICIAL_EMAIL_REQUIRED`
- [N/A] L2107: 		–	`OFFICIAL_EMAIL_NOT_VERIFIED`
- [N/A] L2108: 	•	Envelope externo de erro usa `errorCode` (nunca `error`).
- [N/A] L2109: 	•	Fail mode: fail-closed (403) sem side effects.
- [N/A] L2111: ---
- [N/A] L2113: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2115: **Contract ID:** CAUTH.01
- [N/A] L2116: **Contract Name:** Official Email Gate (organização)
- [N/A] L2117: **Current Version:** v1.0.0
- [N/A] L2118: **Owner:** Domain: Security/RBAC + Organization Settings
- [N/A] L2119: **Primary Consumers:** APIs `/org/*`, Finance ops, RBAC write paths
- [N/A] L2121: ---
- [N/A] L2123: #### Purpose
- [N/A] L2124: Definir o gate canónico de email oficial verificado para ações sensíveis de organização.
- [N/A] L2126: ---
- [N/A] L2128: #### Idempotency
- [N/A] L2129: - **Idempotency Key:** N/A (validação sem side effects)
- [N/A] L2130: - **Scope:** per request
- [N/A] L2131: - **Guarantee:** validações repetidas com o mesmo input devolvem o mesmo resultado lógico.
- [N/A] L2133: ---
- [N/A] L2135: #### Input Payload (Example)
- [N/A] L2136: ```json
- [N/A] L2137: {
- [N/A] L2138:   "organizationId": 123,
- [N/A] L2139:   "officialEmail": "finance@org.pt",
- [N/A] L2140:   "officialEmailVerifiedAt": "2026-01-27T10:00:00Z",
- [N/A] L2141:   "reasonCode": "PAYOUTS_SETTINGS",
- [N/A] L2142:   "requestId": "req_abc",
- [N/A] L2143:   "correlationId": "corr_abc"
- [N/A] L2144: }
- [N/A] L2145: ```
- [N/A] L2147: #### Output / Response (Example)
- [N/A] L2148: ```json
- [N/A] L2149: {
- [N/A] L2150:   "ok": true
- [N/A] L2151: }
- [N/A] L2152: ```
- [N/A] L2154: #### Error Cases
- [N/A] L2155: ```json
- [N/A] L2156: {
- [N/A] L2157:   "ok": false,
- [N/A] L2158:   "requestId": "req_abc",
- [N/A] L2159:   "correlationId": "corr_abc",
- [N/A] L2160:   "errorCode": "OFFICIAL_EMAIL_NOT_VERIFIED",
- [N/A] L2161:   "message": "Email oficial por verificar para esta ação.",
- [N/A] L2162:   "email": "finance@org.pt",
- [N/A] L2163:   "verifyUrl": "/organizacao/settings?tab=official-email",
- [N/A] L2164:   "nextStepUrl": "/organizacao/settings?tab=official-email",
- [N/A] L2165:   "reasonCode": "PAYOUTS_SETTINGS",
- [N/A] L2166:   "retryable": false
- [N/A] L2167: }
- [N/A] L2168: ```
- [N/A] L2170: ---
- [N/A] L2172: #### Ordering & Duplication
- [N/A] L2173: Este contrato tolera chamadas duplicadas.
- [N/A] L2174: Ordering não é aplicável para validação do gate.
- [N/A] L2176: ---
- [N/A] L2178: #### Side Effects
- [N/A] L2179: ☐ ledger entries
- [N/A] L2180: ☐ entitlement issuance
- [N/A] L2181: ☐ emails / notifications
- [N/A] L2182: ☐ downstream async jobs
- [N/A] L2184: ---
- [N/A] L2186: #### Observability
- [N/A] L2187: Obrigatório em logs e métricas:
- [N/A] L2188: - `requestId`
- [N/A] L2189: - `correlationId`
- [N/A] L2190: - `organizationId`
- [N/A] L2191: - `reasonCode`
- [N/A] L2193: ---
- [N/A] L2195: #### Compatibility Rules
- [N/A] L2196: - Erros externos DEVEM usar `errorCode` canónico.
- [N/A] L2197: - Campos novos podem ser aditivos (minor), sem quebrar consumers.
- [N/A] L2199: ---
- [N/A] L2201: #### Failure Mode
- [N/A] L2202: Sem email oficial válido/verificado: bloquear ação (403), sem side effects.
- [N/A] L2204: CAUTH.02) Public Auth API Contract Baseline (legacy auth spec migrated) — **FECHADO**
- [N/A] L2206: Regras:
- [N/A] L2207: 	•	Endpoints públicos de autenticação abrangidos:
- [N/A] L2208: 		–	`POST /api/auth/login`
- [N/A] L2209: 		–	`POST /api/auth/send-otp`
- [N/A] L2210: 		–	`POST /api/auth/password/reset-request`
- [N/A] L2211: 		–	`POST /api/auth/refresh`
- [N/A] L2212: 		–	`POST /api/auth/apple/link`
- [N/A] L2213: 		–	`GET /api/auth/me`
- [N/A] L2214: 		–	`POST /api/auth/logout`
- [N/A] L2215: 		–	`POST /api/auth/clear`
- [N/A] L2216: 		–	`GET|POST /api/auth/check-email`
- [N/A] L2217: 	•	Todos os erros externos usam envelope canónico (`errorCode`, `message`, `retryable`, `correlationId`).
- [N/A] L2218: 	•	`send-otp` e `check-email` seguem política anti-enumeração (resposta genérica, sem leak de existência de conta).
- [N/A] L2219: 	•	`/api/auth/refresh` é o único contrato canónico para sincronizar sessão com cookies HttpOnly.
- [N/A] L2220: 	•	`/api/auth/me` é o read-model canónico de estado de autenticação no server.
- [N/A] L2221: 	•	Auth UI/UX (modal, cooldowns, componentes) é não-normativo e vive no Planning.
- [N/A] L2223: ---
- [N/A] L2225: ### Contract Execution Addendum (NORMATIVE)
- [N/A] L2227: **Contract ID:** CAUTH.02
- [N/A] L2228: **Contract Name:** Public Auth API Contract Baseline
- [N/A] L2229: **Current Version:** v1.0.0
- [N/A] L2230: **Owner:** Domain: Identity/Auth
- [N/A] L2231: **Primary Consumers:** WebApp auth UI, Mobile auth clients, internal session middlewares
- [N/A] L2233: #### Purpose
- [N/A] L2234: Definir baseline contratual dos endpoints públicos de autenticação, com anti-enumeração e envelope canónico.
- [N/A] L2236: #### Idempotency
- [N/A] L2237: - **Idempotency Key:** N/A (operações de sessão/auth sem side-effects financeiros)
- [N/A] L2238: - **Scope:** per request
- [N/A] L2240: #### Failure Mode
- [N/A] L2241: Em dúvida de autorização/origem/sessão: fail-closed, sem side effects irreversíveis.
- [N/A] L2243: ### C02.X01 Addon — Stripe Onboarding (Standard)
- [N/A] L2244: C02.X01) Stripe Onboarding (Standard) — **FECHADO**
- [N/A] L2245: - Activação de vendas/payouts exige Organization completar onboarding KYC no Stripe.
- [N/A] L2246: - Implementação: Finanças gera `account_link` (Stripe-hosted) e guarda estado:
- [N/A] L2247:   - `onboardingStatus = PENDING | COMPLETE | RESTRICTED`
- [N/A] L2248: - Guardrail:
- [N/A] L2249:   - se status != COMPLETE → bloquear criação de checkouts pagos (permitir apenas rascunhos/testes).
- [N/A] L2251: ⸻
- [N/A] L2253: ## 05 Domain Decisions (D*)
- [N/A] L2255: 4) Decisions Locked v9 (não avançar sem isto)
- [N/A] L2257: DORG.01) Membership de Organização — fonte única de verdade (FECHADO)
- [N/A] L2258: 	•	Fonte única canónica: `OrganizationGroupMember` + `OrganizationGroupMemberOrganizationOverride`.
- [N/A] L2259: 	•	`OrganizationMember` é legado e não pode ser usado por código de runtime.
- [N/A] L2260: 	•	Leituras/escritas de membership (listar, promover, remover, contar owners, resolver permissões) devem passar pelo modelo de grupo.
- [N/A] L2261: 	•	DB hygiene: tabela legacy `organization_members` removida por migração de cut-line.
- [N/A] L2263: DORG.03A) Módulos da Organização — fonte única + fail-closed (FECHADO)
- [N/A] L2264: 	•	Fonte única de ativação de módulos: `OrganizationModuleEntry.enabled=true`.
- [N/A] L2265: 	•	`RBAC` e `module enabled` são validações separadas e cumulativas:
- [N/A] L2266: 		–	sem membership/permissão => negar;
- [N/A] L2267: 		–	módulo desativado => negar, mesmo que o utilizador tenha role.
- [N/A] L2268: 	•	No perfil público da organização, um módulo só aparece se:
- [N/A] L2269: 		–	estiver ativo, e
- [N/A] L2270: 		–	tiver conteúdo publicável.
- [N/A] L2271: 	•	Toggle de módulo afeta dashboard e perfil público de forma determinística (sem bypass por URL direta).
- [N/A] L2273: DORG.04A + DORG.05A) Contexto de organização explícito e header canónico (FECHADO)
- [N/A] L2274: 	•	APIs de organização aceitam `organizationId` apenas por:
- [N/A] L2275: 		–	path (`/org/:id`), ou
- [N/A] L2276: 		–	query (`organizationId`), ou
- [N/A] L2277: 		–	header canónico `x-orya-org-id`.
- [N/A] L2278: 	•	Cookie não é fonte de verdade para mutações API (apenas fallback UI quando explicitamente permitido).
- [N/A] L2279: 	•	Header legado `x-org-id` está descontinuado; único header válido é `x-orya-org-id`.
- [N/A] L2281: DORG.06A) Notificações Stripe Status — dedupe por organização + estado (FECHADO)
- [N/A] L2282: 	•	Notificações `STRIPE_STATUS` usam dedupe key com fingerprint de estado:
- [N/A] L2283: 		–	`accountId`, `charges_enabled`, `payouts_enabled`, `requirements_due`.
- [N/A] L2284: 	•	Dedupe é por utilizador + organização + fingerprint; retries não podem gerar spam.
- [N/A] L2286: DORG.07A) Webhook Stripe Connect — fail-closed por mapeamento org (FECHADO)
- [N/A] L2287: 	•	`account.updated` só atualiza organização se o mapeamento for inequívoco.
- [N/A] L2288: 	•	Se não houver organização mapeada, ou houver mismatch `organizationId` ↔ `stripeAccountId`, a resposta é erro (não-200).
- [N/A] L2289: 	•	Atualização parcial/silenciosa é proibida; `update_count != 1` é erro operacional.
- [N/A] L2290: 	•	Webhook externo nunca é tratado como verdade sem reconciliação com estado interno.
- [N/A] L2292: DORG.08) Username Registry — normalização e anti-spoof (FECHADO)
- [N/A] L2293: 	•	Normalização canónica obrigatória:
- [N/A] L2294: 		–	lowercase + trim + colapsar espaços + Unicode NFC.
- [N/A] L2295: 	•	Regras de username após normalização:
- [N/A] L2296: 		–	mínimo 4 caracteres, máximo 15.
- [N/A] L2297: 		–	lista de reserved words + blacklist obrigatória.
- [N/A] L2298: 		–	hold de 15 dias após rename/release.
- [N/A] L2299: 	•	Confusables/homoglyphs:
- [N/A] L2300: 		–	fora do MVP para resolução avançada;
- [N/A] L2301: 		–	no MVP: charset permitido + bloquear mistura de scripts.
- [N/A] L2302: 	•	Qualquer escrita de username deve passar por `UsernameRegistry` (sem bypass direto em tabelas de profile/org).
- [N/A] L2304: DORG.09) Perfil Mobile — UI/UX baseline (FECHADO)
- [N/A] L2305: 	•	Escopo: perfil de Utilizador (view pública/própria) + perfil público de Organização (view pública).
- [N/A] L2306: 	•	Padrão comum:
- [N/A] L2307: 		–	App Bar sticky, Hero com avatar/badges, CTA primário visível, Stats row, secções sticky, estados loading/empty/error.
- [N/A] L2308: 		–	acessibilidade mínima: touch targets >= 44pt, contraste AA, dynamic type.
- [N/A] L2309: 	•	Utilizador:
- [N/A] L2310: 		–	stats `Seguidores` + `A seguir`.
- [N/A] L2311: 		–	CTA `Follow/Unfollow` (outro user) e `Editar Perfil` (próprio).
- [N/A] L2312: 	•	Organização:
- [N/A] L2313: 		–	stats apenas `Seguidores`.
- [N/A] L2314: 		–	CTA primário derivado do módulo ativo (`Ver eventos`/`Reservar`/`Ver loja`/`Contactar`).
- [N/A] L2315: 	•	Ordem canónica de blocos org:
- [N/A] L2316: 		–	`HERO -> ABOUT -> EVENTS_AGENDA -> STORE -> SERVICES -> FORMS -> GALLERY -> FAQ -> CONTACT`.
- [N/A] L2317: 	•	Layout de perfil público de organização é controlado por `OrgPublicProfileLayout` versionado (edição apenas no painel org).
- [N/A] L2319: D00) Fora de scope (v1–v3): API pública (terceiros)
- [N/A] L2320: 	•	Não vamos expor API pública/SDK para terceiros nesta fase.
- [N/A] L2321: 	•	Endpoint(s) públicos **first‑party** (ex.: páginas públicas/agenda) são permitidos, read‑only e rate‑limited.
- [N/A] L2322: 	•	Qualquer “Public API” com chaves/SDK é **futuro**: sem documentação externa, sem onboarding de parceiros e **desativado por defeito** em prod até decisão explícita.
- [N/A] L2323: 	•	Integrações externas só via exports e integrações pontuais configuráveis (Fase 2+), sem “public API” aberta.
- [N/A] L2325: D01) Evento base obrigatório para torneios
- [N/A] L2327: Todo torneio de Padel tem eventId obrigatório.
- [N/A] L2328: 	•	Eventos: tickets, SEO, página pública base, sessões, entitlements
- [N/A] L2329: 	•	Padel Torneios: competição, matches, bracket/standings, live ops
- [N/A] L2331: D01.01) Schedule de Evento — invariantes de tempo (FECHADO)
- [N/A] L2332: 	•	`endsAt` é **obrigatório** em toda a stack (criação, edição, ingestão, seed).
- [N/A] L2333: 	•	Regra: `endsAt` **tem de ser depois** de `startsAt` (nunca antes).
- [N/A] L2334: 	•	Default canónico: se `endsAt` faltar ou for inválido, usar **`startsAt + 5h`**.
- [N/A] L2335: 	•	Evento publicado **nunca** pode regressar a `DRAFT`. `DRAFT` nunca é público.
- [N/A] L2336: 	•	Chat de evento: `open_at = startsAt`, `read_only_at = endsAt`, `close_at = endsAt + 24h`.
- [N/A] L2337: 	•	Chat de evento (acesso) — **presença** obrigatória: **Entitlement + check-in consumido**.
- [N/A] L2338: 	•	Definição: **check‑in consumido = entitlement consumido** (`CheckinResultCode.OK` ou `ALREADY_USED`).
- [N/A] L2339: 	•	Entitlement mantém-se como prova única de acesso ao evento; o chat é uma feature de presença.
- [N/A] L2340: 	•	Entrada no chat é por **convite com aceitação explícita**; convite emitido após entitlement consumido (check‑in/claim) se dentro da janela.
- [N/A] L2341: 	•	Convites de chat **expiram** e **não podem ser aceites** após `endsAt + 24h` (janela de participantes).
- [N/A] L2342: 	•	Chat de evento aparece em “Mensagens” **apenas após** convite aceite.
- [N/A] L2343: 	•	CTA “Entrar no chat” na página do evento **e** no bilhete/carteira, apenas após entitlement consumido.
- [N/A] L2344: 	•	Notificação do chat enviada após entitlement consumido (respeita preferências do utilizador).
- [N/A] L2345: 	•	Chat de evento é **exclusivo da app** (não existe chat de evento na web para users).
- [N/A] L2346: 	•	Após `close_at`: chat fica **read‑only** para quem tem acesso; histórico **não expira**.
- [N/A] L2347: 	•	Discovery: eventos `PAST`/`CANCELLED` **não** entram em listas públicas.
- [N/A] L2348: 	•	Mobile checkout: CTA **bloqueado** se `status != ACTIVE` **ou** `endsAt < now`.
- [N/A] L2349: 	•	Wallet: separação “Ativos/Histórico” **baseada em `endsAt`** (ou janela de check‑in).
- [N/A] L2350: 	•	Higiene legacy: executar `scripts/fix_event_ends_at.js` para corrigir eventos com `endsAt <= startsAt`.
- [N/A] L2352: D01.02) Mensagens & Chat — decisões de produto (FECHADO)
- [N/A] L2353: 	•	Mensagens para utilizador final **apenas na app** (sem chat na web).
- [N/A] L2354: 	•	“Inbox” único de Mensagens: eventos + reservas/serviços + chats com organizações + chats entre utilizadores.
- [N/A] L2355: 	•	Chat de evento segue D01.01 (convite aceite, CTA pós‑consumo, app‑only, read‑only após close, histórico permanente).
- [N/A] L2356: 	•	Chat de reservas/serviços: canal **só ativa** com a 1ª mensagem (não criar canal vazio).
- [N/A] L2357: 	•	Chat de serviço (pré‑reserva): **apenas via pedido**; pedido **aprovado por staff** da organização.
- [N/A] L2358: 	•	Chat org‑contact (cliente → organização): **pedido obrigatório**, aprovado por staff.
- [N/A] L2359: 	•	Reserva: organização pode iniciar chat no **detalhe da reserva** (1ª mensagem cria canal).
- [N/A] L2360: 	•	Chat interno da organização: **só canais** (sem mensagens diretas internas); admins criam por defeito; canais automáticos do sistema (Ops, evento, reserva).
- [N/A] L2361: 	•	Canais cliente‑profissional: cliente vê o profissional; admins podem ver/escrever; identidade padrão para admins é “Organização”; identidade pessoal opcional quando necessário; admins **não aparecem** como membros visíveis ao cliente.
- [N/A] L2362: 	•	Mensagens entre utilizadores: só entre amigos/seguidores confirmados; pedidos de mensagem para desconhecidos; grupos por convite.
- [N/A] L2363: 	•	Notificações: push em todas as mensagens por defeito; opção de silenciar por conversa.
- [N/A] L2364: 	•	Conteúdo: **texto apenas** na Fase 1; anexos em fase futura.
- [N/A] L2365: 	•	“Anular envio”: janela de **2 minutos**.
- [N/A] L2366: 	•	Retenção: mensagens guardadas; chats de evento/reserva ficam read‑only após fecho, sem purge.
- [N/A] L2368: D02) Owners (fontes de verdade) — semântica blindada
- [N/A] L2369: 	•	Ticketing / Sessions / Página pública base / Entitlements de acesso: Eventos
- [N/A] L2370: 	•	Convites (EventInvite + InviteToken) + EventAccessPolicy: Eventos
- [N/A] L2371: 	•	Competição / Registos / Brackets / Matches / Resultados: Padel Torneios
- [N/A] L2372: 	•	Agenda / Disponibilidade / Booking / No-show / MatchSlots: Reservas
- [N/A] L2373: 	•	Pagamentos / Fees / Ledger / Refund / Payout / Invoice: Finanças
- [N/A] L2374: 	•	Check-in / Presence logs / Scanner: Check-in
- [N/A] L2375: 	•	Customer + Consent + Timeline + Segmentos: CRM
- [N/A] L2376: 	•	Roles + Scopes + Auditoria RBAC: Equipa
- [N/A] L2377: 	•	Moradas: Address Service
- [N/A] L2378: 	•	Analytics: Derivado (Ledger + EventLog); não é owner de estado transaccional
- [N/A] L2380: Regra: nenhum domínio duplica estado de outro owner. Integração só via contratos.
- [N/A] L2382: **Regra de negócio (fundamental):** **só ORGANIZAÇÕES** podem ser donas de coisas que se vendem/operam (Eventos, Loja/Produtos, Serviços/Reservas). Utilizadores **nunca** “criam/vendem em nome próprio”; apenas atuam como membros de uma Organização no **Painel da Organização** (RBAC). No lado do utilizador, mesmo sendo dono/admin, vê a Organização apenas como público.
- [N/A] L2384: D03) Agenda Engine e conflitos (FECHADO)
- [N/A] L2386: Regra base: **quem marca primeiro ocupa**. Nada sobrepõe automaticamente.
- [N/A] L2387: Conflitos ficam bloqueados; quem chega depois tem de se adaptar.
- [N/A] L2389: Override **só manual** por Owner/Admin, com auditoria e notificações.
- [N/A] L2390: Se o override mexer numa reserva de utilizador, requer **pedido + aceitação** (ver 9.2).
- [N/A] L2392: D03.01 MatchSlot (Padel)
- [N/A] L2393: MatchSlot bloqueia novas marcações no mesmo horário/campo.
- [N/A] L2394: Se já existir reserva/aula, MatchSlot **não** sobrepõe automaticamente; requer override explícito.
- [N/A] L2396: D03.02) Operação de Calendário do Clube/Reservas (FECHADO)
- [N/A] L2397: 	•	Calendário único de clube:
- [N/A] L2398: 		–	reservas, aulas e torneios partilham o mesmo calendário operacional.
- [N/A] L2399: 		–	tudo o que ocupa recurso/campo bloqueia esse recurso no horário.
- [N/A] L2400: 	•	Visibilidade de calendário:
- [N/A] L2401: 		–	Utilizador: mês atual + 3 meses; passado oculto.
- [N/A] L2402: 		–	Organização: até fim do ano + 2 anos; passado em leitura.
- [N/A] L2403: 	•	Permissões:
- [N/A] L2404: 		–	Owner/Admin: tudo.
- [N/A] L2405: 		–	Staff: apenas recursos atribuídos.
- [N/A] L2406: 		–	Trainer: aulas próprias em recursos atribuídos.
- [N/A] L2407: 	•	Override/mudança de reserva:
- [N/A] L2408: 		–	org pede mudança até T-4h.
- [N/A] L2409: 		–	user responde até 24h ou T-2h (o que ocorrer primeiro).
- [N/A] L2410: 		–	sem resposta = recusado; reserva mantém-se.
- [N/A] L2411: 		–	cancelamento pelo org = refund total automático.
- [N/A] L2412: 	•	Guest booking e aulas recorrentes:
- [N/A] L2413: 		–	guest booking permitido apenas por policy e cria Entitlement canónico.
- [N/A] L2414: 		–	aulas recorrentes usam `ClassSeries + ClassSession` com bloqueio explícito na Agenda Engine.
- [N/A] L2416: D04) Finanças determinística (Stripe Connect + Fees ORYA) — decisão única
- [N/A] L2418: > **FECHADO (SSOT):** SSOT financeiro = `Payment` (state machine) + `LedgerEntry` (linhas imutáveis).
- [N/A] L2419: > Tudo o resto (SaleSummary, dashboards, exports) é **derivado**.
- [N/A] L2421: Princípios
- [N/A] L2422: - Stripe Connect obrigatório já (v1.x): cada Organization tem `stripeAccountId`.
- [N/A] L2423: - **Finanças é o único gateway lógico**: nenhum módulo cria PaymentIntents/CheckoutSessions diretamente no Stripe.
- [N/A] L2424:   Endpoints especializados de checkout são permitidos **apenas** se delegarem ao domínio Finanças e respeitarem idempotência/policies canónicas.
- [N/A] L2425: - Idempotência obrigatória em todas as operações: `idempotencyKey` por createCheckout/refund/reconcile.
- [N/A] L2426: - “Pago” só existe quando `Payment.status == SUCCEEDED`.
- [N/A] L2428: D04.00) Stripe Connect — Account Type (FECHADO)
- [N/A] L2429: - ORYA usa **Stripe Connect Standard** como tipo de conta por defeito para Organizações.
- [N/A] L2430: - A conta Stripe é do organizador (autonomia e responsabilidade fiscal/operacional).
- [N/A] L2431: - A ORYA não cria nem gere contas Custom nesta fase.
- [N/A] L2432: - Qualquer excepção (Express/Custom) só por decisão de produto + contrato (fora v1.x).
- [N/A] L2434: D04.00.01) Stripe Funds Flow (FECHADO)
- [N/A] L2435: Objetivo: definir de forma única como o dinheiro flui e onde a ORYA consegue (ou não) aplicar “risk holds”.
- [N/A] L2437: Decisão (v1.x):
- [N/A] L2438: - Modelo: **Destination Charges + Application Fee** (Stripe Connect Standard).
- [N/A] L2439: - A cobrança ao cliente é criada pela ORYA (Finanças) para o evento/serviço (`sourceType/sourceId`), com:
- [N/A] L2440:   - `application_fee_amount` = fee ORYA (conforme FeePolicyVersion)
- [N/A] L2441:   - `transfer_data.destination` = `Organization.stripeAccountId`
- [N/A] L2443: Implicações (normativas):
- [N/A] L2444: - Refunds são iniciados pela ORYA (Finanças) e são idempotentes.
- [N/A] L2445: - Disputes/chargebacks afectam `Payment/Entitlements` conforme D04.09 e Secções 7/8.
- [N/A] L2446: - “Risk hold” em v1.x é **operacional** (step‑up, limits, bloqueio temporário de criação de eventos/checkout); não assume controlo directo de payouts.
- [N/A] L2447: - Se for necessário controlo fino de payouts/transferências (hold real de fundos), isso é **fora v1.x** e requer revisão do flow (ou mudança de account type/contrato).
- [N/A] L2449: Regra: nenhum módulo assume “payout control” fora do que este flow permite.
- [N/A] L2451: D04.01 Política de Fee (Admin) (FECHADO)
- [N/A] L2452: - Config por organização (default) + overrides por `sourceType` (e opcionalmente por `sourceId`).
- [N/A] L2453: - Limites opcionais: min/max, arredondamentos, feeMode (INCLUDED/ADDED/ABSORBED — se aplicável).
- [N/A] L2454: - Qualquer alteração gera nova versão (`feePolicyVersion`), nunca edita retroativamente.
- [N/A] L2456: D04.02 PricingSnapshot (obrigatório) (FECHADO)
- [N/A] L2457: - `pricingSnapshot` é gravado no momento do checkout e nunca muda.
- [N/A] L2458: - Deve incluir, no mínimo:
- [N/A] L2459:   - currency, gross, discounts, taxes (se existirem), platformFee, netToOrgPending (calculado **sem** fees reais do processador)
- [N/A] L2460:   - `processorFeesStatus: PENDING | FINAL`
- [N/A] L2461:   - `processorFeesActual` (nullable até reconciliação Stripe; quando FINAL, é obrigatório)
- [N/A] L2462:   - feeMode resolvido (como a fee é aplicada)
- [N/A] L2463:   - referências: `feePolicyVersion`, `promoPolicyVersion` (se houver), `sourceType/sourceId`
- [N/A] L2464:   - lineItems com preços unitários e quantidades (para auditoria)
- [N/A] L2465: - Regra: **qualquer cálculo futuro** usa o snapshot + o Ledger (SSOT), nunca re‑calcula com regras novas.
- [N/A] L2466: - `netToOrgFinal` **não** vive no snapshot inicial; é sempre derivado de `SUM(entries.amountSigned)` quando `processorFeesStatus=FINAL`.
- [N/A] L2467: - **Proibição de estimativas:** campos do tipo `*Estimate*` são legados e **não** podem ser usados como verdade nem para decisões.
- [N/A] L2468:   Só `processorFeesActual` (quando FINAL) e o Ledger são canónicos.
- [N/A] L2470: D04.03 Fee determinística + versionamento (obrigatório) (FECHADO)
- [N/A] L2471: - Fee calculada em Finanças durante `createCheckout` e congelada no `Payment`.
- [N/A] L2472: - `Payment.feePolicyVersion` obrigatório (incremental ou hash do snapshot).
- [N/A] L2473: - LedgerEntryType (MVP v1.x) — FECHADO
- [N/A] L2474:   - `GROSS`
- [N/A] L2475:   - `PLATFORM_FEE`
- [N/A] L2476:   - `PROCESSOR_FEES_FINAL`
- [N/A] L2477:   - `PROCESSOR_FEES_ADJUSTMENT`
- [N/A] L2478:   - `DISPUTE_FEE`
- [N/A] L2479:   - `DISPUTE_FEE_REVERSAL`
- [N/A] L2480:   - `REFUND_GROSS`
- [N/A] L2481:   - `REFUND_PLATFORM_FEE_REVERSAL`
- [N/A] L2482:   - `REFUND_PROCESSOR_FEES_REVERSAL`
- [N/A] L2483:   - `CHARGEBACK_GROSS`
- [N/A] L2484:   - `CHARGEBACK_PLATFORM_FEE_REVERSAL`
- [N/A] L2485: - Norma de sinais (obrigatória)
- [N/A] L2486:   - `GROSS` é positivo (+)
- [N/A] L2487:   - `PLATFORM_FEE` é negativo (-)
- [N/A] L2488:   - `PROCESSOR_FEES_FINAL` é negativo (-)
- [N/A] L2489:   - `PROCESSOR_FEES_ADJUSTMENT` pode ser + ou - (depende do delta)
- [N/A] L2490:   - `DISPUTE_FEE` é negativo (-)
- [N/A] L2491:   - `DISPUTE_FEE_REVERSAL` é positivo (+)
- [N/A] L2492:   - `REFUND_GROSS` é negativo (-)
- [N/A] L2493:   - `REFUND_PLATFORM_FEE_REVERSAL` é positivo (+)
- [N/A] L2494:   - `REFUND_PROCESSOR_FEES_REVERSAL` é positivo (+)
- [N/A] L2495:   - `CHARGEBACK_GROSS` é negativo (-)
- [N/A] L2496:   - `CHARGEBACK_PLATFORM_FEE_REVERSAL` é positivo (+)
- [N/A] L2497: - Regra FECHADA
- [N/A] L2498:   - `netToOrgFinal = SUM(entries.amountSigned)` por `paymentId` quando `processorFeesStatus=FINAL`.
- [N/A] L2499:   - `netToOrgPending = gross - platformFee` (informativo; não é canónico; sem fees reais do processador).
- [N/A] L2500:   - Refund/chargeback geram entries adicionais no mesmo `paymentId` (append-only); o `netToOrgFinal = SUM(entries.amountSigned)` continua verdadeiro após refund/chargeback.
- [N/A] L2501: - Alterações no Admin não afectam pagamentos antigos.
- [N/A] L2503: D04.04 Ledger SSOT (imutável) + reconciliação (FECHADO)
- [N/A] L2504: - `LedgerEntry` é append‑only (sem update/delete).
- [N/A] L2505: - Cada entrada tem: `entryType`, `amount`, `currency`, `paymentId`, `sourceType/sourceId`, `createdAt`, `causationId`, `correlationId`.
- [N/A] L2506: - Regras:
- [N/A] L2507:   - entradas são geradas apenas por Finanças (write‑owner)
- [N/A] L2508:   - replays são idempotentes (mesma causationId não duplica)
- [N/A] L2509: - Reconciliação (FECHADO):
- [N/A] L2510:   - Fonte única do fee real: `stripe.balance_transaction.fee` (ou equivalente do processor).
- [N/A] L2511:   - Transição:
- [N/A] L2512:     - `processorFeesStatus=PENDING` enquanto não existir `balance_transaction`
- [N/A] L2513:     - `processorFeesStatus=FINAL` quando existir
- [N/A] L2514:   - Entries:
- [N/A] L2515:     - criar `PROCESSOR_FEES_FINAL` quando chega o `balance_transaction`
- [N/A] L2516:     - criar `PROCESSOR_FEES_ADJUSTMENT` se, em reconciliações futuras, o fee real mudar (delta)
- [N/A] L2517:   - Append-only sempre: nunca editar entries antigas.
- [N/A] L2518:   - divergências geram `LedgerReconciliationIssue` (ver 12.4.x)
- [N/A] L2520: D04.05 SaleSummary (se existir) — read model derivado
- [N/A] L2521: - Pode existir para performance/UX, mas:
- [N/A] L2522:   - nunca decide estados (pago/reembolsado)
- [N/A] L2523:   - é re‑gerável a partir de Ledger + Payment
- [N/A] L2524:   - falhas são reparáveis por replay (EventLog/Jobs)
- [N/A] L2525: - Definição (read‑model):
- [N/A] L2526:   - `SaleSummary`: resumo por compra (`purchaseId`/`paymentIntentId`), totais/fees (`subtotal/discount/platformFee/cardFee/stripeFee/total/net`), `status`, owner (`ownerUserId`/`ownerIdentityId`), modo/teste (`mode`/`isTest`) e snapshots de promo (`promoCodeSnapshot/label/type/value`).
- [N/A] L2527:   - `SaleLine`: linhas por ticketType (`ticketTypeId`), `quantity`, `unitPrice`, `gross/net/platformFee` + snapshots de promo.
- [N/A] L2528: - Owner: apenas o consumer de finanças (domain/finance read‑model consumer) escreve; resto é read‑only.
- [N/A] L2530: D04.06 FeeMode e pricing têm um resolvedor único (FECHADO)
- [N/A] L2531: - `computePricing()` (Finanças) decide de forma determinística e versionada:
- [N/A] L2532:   - platform default
- [N/A] L2533:   - org default
- [N/A] L2534:   - override por `sourceType`
- [N/A] L2535:   - override por `sourceId` (opcional)
- [N/A] L2536: - Regra: nenhum módulo força feeMode “por fora”. Se Eventos quiserem “INCLUDED sempre”, isso é configurado como override por `sourceType=TICKET_ORDER` e fica escrito em policy versionada.
- [N/A] L2538: D04.07 Regras de FREE_CHECKOUT (FECHADO)
- [N/A] L2539: - Um checkout é “free” se:
- [N/A] L2540:   - `totalAmount == 0` (após promos/fees) **ou**
- [N/A] L2541:   - `scenario == FREE_CHECKOUT` (explicitamente resolvido por Finanças)
- [N/A] L2542: - Limites e anti‑abuso aplicam-se ao free checkout independentemente de qualquer flag no evento.
- [N/A] L2543: - Bilhetes 0€ só existem por decisão explícita:
- [N/A] L2544:   - `Event.allowZeroPriceTickets` (default false) **ou** policy por TicketType (recomendado).
- [N/A] L2546: D04.07.01 Guardrails de FREE_CHECKOUT (FECHADO)
- [N/A] L2547: - Anti‑abuso é **normativo** e vive em Finanças (não em Eventos):
- [N/A] L2548:   - Limite por `Identity` e por `eventId+ticketTypeId`: default `max=1` (configurável por policy, com guardrails globais).
- [N/A] L2549:   - Rate limit por IP/device + janela (ex.: 10 tentativas/5 min) + cooldown progressivo em falhas.
- [N/A] L2550:   - Step‑up em casos suspeitos: captcha/turnstile, obrigar login, ou bloquear por 15–60 min (policy).
- [N/A] L2551:   - Dedupe por idempotencyKey e por `Identity+sourceId` (não existe “free checkout repetido”).
- [N/A] L2552:   - Audit + EventLog obrigatórios: `free_checkout.denied` com reasonCode (sem PII).
- [N/A] L2553: - Regra: o mesmo conjunto de guardrails aplica-se a `totalAmount==0` e a `scenario==FREE_CHECKOUT`.
- [N/A] L2555: D04.08 Deprecação de `Event.isFree` (anti‑desync) (FECHADO)
- [N/A] L2556: Regra:
- [N/A] L2557: - `Event.isFree` deixa de existir como “fonte de decisão”.
- [N/A] L2558: - A única regra de “free” é a de D04.07.
- [N/A] L2559: - Para UI (“evento grátis”) é sempre derivado:
- [N/A] L2560:   - `derivedIsFree = (min(TicketType.price) == 0 AND não existe TicketType.price > 0)` **ou**
- [N/A] L2561:   - `Event.pricingMode = FREE_ONLY` (flag explícita, se precisares)
- [N/A] L2562: - Qualquer gating (checkout/login/anti‑abuso) **nunca** usa `Event.isFree`.
- [N/A] L2564: Implementação:
- [N/A] L2565: - Remover leituras do flag em UI/checkout.
- [N/A] L2566: - Se o campo ainda existir por compatibilidade, marcá-lo como deprecated e preenchê-lo apenas como read model.
- [N/A] L2567: - Assert em Finanças: se `totalAmount > 0` então `scenario != FREE_CHECKOUT`.
- [N/A] L2569: D04.09 Refunds, cancelamentos e chargebacks (FECHADO)
- [N/A] L2570: Cancelamento de evento:
- [N/A] L2571: - Ao cancelar um evento: **refund automático** para todas as compras elegíveis.
- [N/A] L2572: - Stripe Connect Standard:
- [N/A] L2573:   - o organizador paga os processing fees (quando Stripe não os devolve)
- [N/A] L2574:   - a ORYA devolve a sua `platformFee` (através de entrada de ledger de reversão)
- [N/A] L2575: - O refund é idempotente e auditável (`RefundPolicyVersion` se houver regras variáveis).
- [N/A] L2577: Refund manual (suporte):
- [N/A] L2578: - Só por casos definidos (evento cancelado, falha grave, denúncias, problema técnico confirmado).
- [N/A] L2579: - Não existe “refund porque faltaste”.
- [N/A] L2581: Refund parcial (FECHADO):
- [N/A] L2582: - `Payment=PARTIAL_REFUND` quando apenas alguns lineItems são reembolsados.
- [N/A] L2583: - Ledger adiciona `REFUND_GROSS` + reversões aplicáveis **por item** (append-only; pode haver múltiplos parciais).
- [N/A] L2584: - Em `sourceType=TICKET_ORDER`, revoga apenas os entitlements dos itens refundados (resto mantém ACTIVE).
- [N/A] L2586: Chargeback / dispute:
- [N/A] L2587: - Evento Stripe `dispute.created` → `Payment` entra em estado de disputa e:
- [N/A] L2588:   - Entitlements associados → `SUSPENDED` (bloqueia entrada) até resolução
- [N/A] L2589: - Resolução:
- [N/A] L2590:   - `dispute.won` → `Payment=CHARGEBACK_WON` + reactivar entitlements (se ainda fizer sentido temporalmente)
- [N/A] L2591:   - `dispute.lost` → `Payment=CHARGEBACK_LOST` + `Entitlement=REVOKED` + ledger com `CHARGEBACK_*` (e `DISPUTE_FEE` se aplicável)
- [N/A] L2592: - Fee de disputa (FECHADO):
- [N/A] L2593:   - `DISPUTE_FEE` é debitado à organização por defeito.
- [N/A] L2594:   - Se o processor reembolsar a fee num `CHARGEBACK_WON`, criar `DISPUTE_FEE_REVERSAL` (positivo).
- [N/A] L2595: - `Ticket.status=DISPUTED` entra em `dispute.created` (ou `charge.dispute.created`) e bloqueia entrada.
- [N/A] L2596: - `dispute.won` → volta a `ACTIVE` (se não houver refund/chargeback aplicado).
- [N/A] L2597: - `dispute.lost` → `CHARGEBACK_LOST` (estado final canónico).
- [N/A] L2599: D04.10) Revenda — disputes/refunds (FECHADO v1)
- [N/A] L2600: 	•	Quando houver chargeback/refund do comprador da revenda:
- [N/A] L2601: 		–	Entitlements do novo owner ficam `SUSPENDED` imediatamente.
- [N/A] L2602: 		–	`Ticket.status` passa a `DISPUTED` enquanto investigação decorre.
- [N/A] L2603: 	•	Regra v1:
- [N/A] L2604: 		–	não existe reversão automática de owner.
- [N/A] L2605: 		–	qualquer reversão de owner é apenas manual/admin, com `AuditLog`.
- [N/A] L2606: 	•	Resolução:
- [N/A] L2607: 		–	dispute won -> entitlement volta `ACTIVE` e ticket volta `ACTIVE` (se temporalmente válido).
- [N/A] L2608: 		–	dispute lost -> `CHARGEBACK_LOST` + entitlement `REVOKED`.
- [N/A] L2609: 		–	refund confirmado -> `REFUNDED` + entitlement `REVOKED`.
- [N/A] L2610: 	•	Integração operacional:
- [N/A] L2611: 		–	jobs idempotentes `entitlements.suspend_on_dispute_opened` e `ticket.mark_disputed`.
- [N/A] L2613: ⸻
- [N/A] L2615: D05) RBAC mínimo viável + Role Packs
- [N/A] L2617: Introduzir já: CLUB_MANAGER, TOURNAMENT_DIRECTOR, FRONT_DESK, COACH, REFEREE
- [N/A] L2618: Com mapa fixo para roles/scopes (Secção 11).
- [N/A] L2620: D05.01) Resolução de organização é determinística
- [N/A] L2621: 	•	Em B2B, organizationId vem da rota (/org/:orgId/...) como fonte primária.
- [N/A] L2622: 	•	Cookie pode existir apenas como conveniência (redirect inicial), não como base de autorização.
- [N/A] L2623: 	•	RBAC avalia sempre com orgId explícito.
- [N/A] L2624: 	•	Qualquer fallback (cookie/lastUsedAt) é permitido apenas para redirect/UI. Nunca para autorização.
- [N/A] L2625: 	•	Alias legado (compatibilidade): /organizacao/* → redirect 301 para /org/:orgId/* (apenas UI).
- [N/A] L2627: D05.02) Step-up obrigatório em ações irreversíveis (FECHADO v1)
- [N/A] L2628: 	•	Exige reautenticação/2FA recente + `reasonCode` obrigatório para:
- [N/A] L2629: 		–	refunds;
- [N/A] L2630: 		–	cancelamento de evento/torneio (soft-cancel);
- [N/A] L2631: 		–	alteração de fee policy/overrides;
- [N/A] L2632: 		–	exportação com PII.
- [N/A] L2633: 	•	Todas as ações acima geram `AuditLog` com before/after (payload minimizado RGPD).
- [N/A] L2635: D06) Notificações como serviço (com logs e opt-in)
- [N/A] L2637: Templates, consentimento RGPD, logs de delivery, outbox e preferências.
- [N/A] L2639: D07) sourceType canónico (Finanças/ledger/check-in)
- [N/A] L2641: Todos os checkouts e entitlements usam sourceType canónico e unificado (Secção 7).
- [N/A] L2643: D08) EventAccessPolicy (acesso + convites + identidade + claim entitlements) — definição final
- [N/A] L2645: > **FECHADO (SSOT):** `EventAccessPolicy` é a única fonte de verdade para:
- [N/A] L2646: > 1) modo de acesso (public/invite/unlisted), 2) checkout como convidado, 3) convites por token, 4) compatibilidade de identidade, e 5) check‑in (ver Secção 8).
- [N/A] L2648: D08.01) EventAccessPolicy é a única verdade de acesso (FECHADO)
- [N/A] L2649: - Substitui qualquer combo de flags legacy (`public_access_mode`, `invite_only`, etc.).
- [N/A] L2650: - Modelo canónico (mínimo):
- [N/A] L2651:   - `mode: PUBLIC | INVITE_ONLY | UNLISTED`
- [N/A] L2652:   - `guestCheckoutAllowed: boolean`
- [N/A] L2653:   - `inviteTokenAllowed: boolean`
- [N/A] L2654:   - `inviteIdentityMatch: EMAIL | USERNAME | BOTH`
- [N/A] L2655:   - `inviteTokenTTL: duration` (obrigatório se `inviteTokenAllowed=true`)
- [N/A] L2656:   - `checkin: { requiresEntitlementForEntry, methods[...] }` (ver Secção 8)
- [N/A] L2657: - **Restrição:** `inviteTokenAllowed=true` exige `inviteIdentityMatch=EMAIL|BOTH`.
- [N/A] L2658:   `inviteIdentityMatch=USERNAME` **não** suporta tokens (apenas convites por username existente).
- [N/A] L2659: - **Regra de integridade:** convites por username só podem ser emitidos para utilizadores existentes.
- [N/A] L2660:   Para pessoas sem conta, usar convite por email.
- [N/A] L2661: - **Sem fallback** entre campos. Migração/backfill obrigatório no write‑path (não na leitura).
- [N/A] L2663: D08.02) Convites por token (guest checkout) — versão final (FECHADO)
- [N/A] L2665: Convites permitem checkout como convidado via token **na WebApp e no site público**.
- [N/A] L2666: A app mobile é **login‑only** (sem guest checkout).
- [N/A] L2668: Regras fechadas
- [N/A] L2669: 1) InviteToken one‑time + expira
- [N/A] L2670: - guardar `tokenHash` (nunca token em claro)
- [N/A] L2671: - `expiresAt` (ex.: 7 dias; ou conforme `inviteTokenTTL`)
- [N/A] L2672: - `usedAt` + `usedByIdentityId`
- [N/A] L2674: 2) Match obrigatório de identidade
- [N/A] L2675: - o token fica associado a `emailNormalizado` (e opcionalmente username, se usares BOTH)
- [N/A] L2676: - no checkout guest, o email tem de bater certo (case‑insensitive, normalizado)
- [N/A] L2677: - se `inviteIdentityMatch=USERNAME`, `inviteTokenAllowed` tem de ser **false** (sem tokens)
- [N/A] L2679: 3) Scope do token
- [N/A] L2680: - token é válido só para 1 evento e (opcional) 1 `ticketTypeId` (controlo fino)
- [N/A] L2682: 4) Rate limit + anti‑enumeração
- [N/A] L2683: - limitar tentativas por IP/device
- [N/A] L2684: - respostas indistinguíveis (“token inválido” sem detalhes)
- [N/A] L2686: 5) Entitlement final (SSOT) + claim posterior (FECHADO)
- [N/A] L2687: - compra gera `Entitlement` com `ownerIdentityId = Identity(GUEST_EMAIL)`
- [N/A] L2688: - quando o user criar conta e verificar o mesmo email → claim automático (Secção 7.7)
- [N/A] L2689: - **Propriedade do acesso nunca é OR entre campos.** Resolver sempre via `Entitlement.ownerIdentityId`.
- [N/A] L2691: 6) Eventos VIP (login obrigatório)
- [N/A] L2692: - Para eventos que exijam login: `guestCheckoutAllowed=false` e `mode=INVITE_ONLY` (sem exceções).
- [N/A] L2693: - App mobile é sempre login obrigatório (independente de `guestCheckoutAllowed`).
- [N/A] L2695: 7) Guest Ticket Link (acesso sem conta) — FECHADO
- [N/A] L2696: - Após compra guest, emitir `GuestTicketAccessToken` (guardar **apenas** `tokenHash`).
- [N/A] L2697: - Email de compra deve incluir link `/guest/tickets/[token]`.
- [N/A] L2698: - Expiração: `expiresAt = fim da janela de check‑in` (default: abre `startsAt - 6h`, fecha `endsAt + 6h`; se `endsAt` faltar, fecha `startsAt + 24h`).
- [N/A] L2699: - Segurança: token único + hash, sem PII no link; rate limit em rotas de QR.
- [N/A] L2700: - Se falhar emissão do token, usar fallback seguro (`/`).
- [N/A] L2702: UX recomendada
- [N/A] L2703: - Página de convite (web): “Aceitar convite” → pede nome + email (pré‑preenchido se possível)
- [N/A] L2704: - Pós‑compra (web): “Criar conta para guardar bilhetes e entrar mais rápido” (1 clique)
- [N/A] L2705: - Mobile: login obrigatório; guest checkout não é suportado.
- [N/A] L2707: ⸻
- [N/A] L2709: D08.03 Imutabilidade temporal (depois de haver vendas) (FECHADO)
- [N/A] L2710: - `EventAccessPolicy` é versionada (`policyVersion`) e cada alteração cria **nova versão** (append‑only; sem editar retroativamente).
- [N/A] L2711: - **Lock após a primeira venda/entitlement**: quando existir qualquer `Payment.status=SUCCEEDED` ou qualquer `Entitlement` emitido para o evento:
- [N/A] L2712:   - Campos **bloqueados** (não podem tornar-se mais restritivos nem mudar de semântica): `mode`, `guestCheckoutAllowed`, `inviteTokenAllowed`, `inviteIdentityMatch`, `requiresEntitlementForEntry`.
- [N/A] L2713:   - Permitido apenas:
- [N/A] L2714:     - **Relaxar** regras (ex.: INVITE_ONLY → UNLISTED/PUBLIC) se não quebrar direitos já emitidos.
- [N/A] L2715:     - Ajustar `inviteTokenTTL` apenas para **novos** convites (tokens já emitidos mantêm o seu `expiresAt`).
- [N/A] L2716:     - **Adicionar** métodos de check‑in (nunca remover) para compatibilidade operacional.
- [N/A] L2717:     - Reentrada/undo só podem **relaxar**:
- [N/A] L2718:       – `checkin.allowReentry`: apenas `false → true`
- [N/A] L2719:       – `maxEntries`, `reentryWindowMinutes`, `undoWindowMinutes`: apenas aumentar
- [N/A] L2720: - Snapshot aplicado:
- [N/A] L2721:   - `Entitlement.policyVersionApplied` passa a **obrigatório** para `sourceType=TICKET_ORDER|PADEL_REGISTRATION|BOOKING` quando associado a um evento.
- [N/A] L2722:   - Check-in valida por defeito contra `policyVersionApplied` armazenado no Entitlement. A policy corrente só pode relaxar regras ou adicionar métodos; nunca pode apertar constraints após emissão.
- [N/A] L2724: D09) Merchant of Record + fiscalidade (decisão “top”)
- [N/A] L2725: 	•	MoR por defeito é a Organização (Connected Account)
- [N/A] L2726: 	•	Organização é responsável por IVA / fatura ao consumidor final
- [N/A] L2727: 	•	ORYA cobra fee de plataforma e emite fatura B2B da fee à Organização (ou documento equivalente)
- [N/A] L2728: 	•	Excepção futura (enterprise): ORYA como MoR só por contrato/config explícita (fora v1.x)
- [N/A] L2730: D09.01) Faturação “não obrigatória” (posição v3) — sem risco para a ORYA
- [N/A] L2732: Regra:
- [N/A] L2733: 	•	ORYA não obriga a emitir fatura dentro da ORYA.
- [N/A] L2734: 	•	ORYA obriga SEMPRE a:
- [N/A] L2735: 		•	registo de movimentos (ledger + exports)
- [N/A] L2736: 		•	exports (CSV/PDF) por período
- [N/A] L2737: 		•	configuração explícita: “Como esta organização emite faturação?”
- [N/A] L2738: 		•	“0€ tickets” não podem existir “por acidente”.
- [N/A] L2739: 		•	Anti-abuso é central em Finanças (rate limits, 1 por user por event, etc.).
- [N/A] L2741: Config “Emissão de faturação” (OrganizationSettings):
- [N/A] L2742: 	•	Software externo (recomendado) — campo para “nome do software” + notas
- [N/A] L2743: 	•	Manual / fora da ORYA — checklist de responsabilidade + confirmação
- [N/A] L2744: 	•	(mais tarde) Integrações opcionais PT (Fase 2) para facilitar, não para obrigar
- [N/A] L2746: Objetivo:
- [N/A] L2747: 	•	ser tooling de gestão, não “motor de incumprimento”
- [N/A] L2748: 	•	proteger ORYA legalmente sem matar adoção
- [N/A] L2750: Acesso e Convites (obrigatório v1)
- [N/A] L2751: 	•	O evento define EventAccessPolicy.
- [N/A] L2752: 	•	Convites são regidos por policy + EventInvite (ou equivalente).
- [N/A] L2753: 	•	Checkout e página pública respeitam apenas a policy canónica.
- [N/A] L2754: 	•	UI deve reflectir exactamente as regras (sem “promessas”).
- [N/A] L2756: 	Acesso Público — Deprecação de campos legacy (sem fallback)
- [N/A] L2758: Regra:
- [N/A] L2759: 	•	EventAccessPolicy é a única fonte de verdade.
- [N/A] L2760: 	•	Campos legacy (ex.: inviteOnly / publicAccessMode / publicTicketTypeIds) ficam READ-ONLY (deprecated) e deixam de ser lidos por UI/API.
- [N/A] L2761: 	•	Se existir payload antigo, converte-se para EventAccessPolicy na escrita (write-path), nunca na leitura (read-path).
- [N/A] L2763: Migração:
- [N/A] L2764: 	1) Backfill único: para cada Event, gerar EventAccessPolicy canónica.
- [N/A] L2765: 	2) Toggle de rollout:
- [N/A] L2766: 		•	Fase A: ler ambos, mas COMPARAR e alertar se divergirem (sem mudar UX).
- [N/A] L2767: 		•	Fase B: UI/API lê apenas policy canónica; legacy só para export/debug.
- [N/A] L2768: 		•	Fase C: remover fallback e remover campos legacy do schema.
- [N/A] L2770: Guardrail:
- [N/A] L2771: 	•	Architecture test falha se algum módulo importar/ler os campos legacy.
- [N/A] L2773: D09.02) Padrões UX Globais (B2B) — para sentir “premium” em todas as ferramentas
- [N/A] L2775: A) Unified Search (top bar)
- [N/A] L2776: Uma barra de pesquisa global que aceita:
- [N/A] L2777: 	•	ID (bookingId, paymentId, entitlementId, registrationId)
- [N/A] L2778: 	•	email / nome (cliente)
- [N/A] L2779: 	•	evento/torneio
- [N/A] L2780: E retorna resultados agrupados por tipo com ações rápidas.
- [N/A] L2782: B) Context Drawer (painel lateral universal)
- [N/A] L2783: Ao clicar em qualquer entidade (booking/payment/user/match):
- [N/A] L2784: 	•	abre drawer lateral com:
- [N/A] L2785: 		•	resumo
- [N/A] L2786: 		•	ações rápidas (permitidas por RBAC)
- [N/A] L2787: 		•	links cruzados (Finanças ↔ Reservas ↔ CRM ↔ Check-in ↔ Padel)
- [N/A] L2788: 		•	audit log da entidade
- [N/A] L2789: 		•	eventos relevantes do EventLog (timeline curta)
- [N/A] L2790: Objetivo: “não navegar por 8 páginas para resolver 1 problema”.
- [N/A] L2792: C) Command Palette (⌘K)
- [N/A] L2793: Ações instantâneas:
- [N/A] L2794: 	•	Criar torneio / Criar evento / Criar bloqueio
- [N/A] L2795: 	•	Mover match / Reatribuir campo
- [N/A] L2796: 	•	Reembolsar / Abrir disputa
- [N/A] L2797: 	•	Abrir cliente / Ver ledger
- [N/A] L2798: Keyboard-first onde faz sentido.
- [N/A] L2800: D) Operação “ops mode”
- [N/A] L2801: Views rápidas para staff:
- [N/A] L2802: 	•	“Hoje” (reservas, check-ins, pendentes split-payment, alertas)
- [N/A] L2803: 	•	“Agora” (o que está a decorrer)
- [N/A] L2804: 	•	“Pendentes críticos” (pagamentos falhados, disputas, no-shows)
- [N/A] L2805: Tudo com filtros por filial/unidade.
- [N/A] L2807: E) Estados e feedback consistentes
- [N/A] L2808: Todos os módulos usam os mesmos estados:
- [N/A] L2809: 	•	loading / empty / error / success
- [N/A] L2810: 	•	toasts consistentes + logs (para suporte)
- [N/A] L2812: D09.03) Loja — ownership consistente (FECHADO v1–v3)
- [N/A] L2813: 	•	Apenas ORGANIZAÇÕES podem ser owners de Store/Produtos/Checkout.
- [N/A] L2814: 	•	Regra de modelo:
- [N/A] L2815: 		–	`ownerOrganizationId` obrigatório;
- [N/A] L2816: 		–	`ownerUserId` nulo no modelo canónico atual.
- [N/A] L2817: 	•	Qualquer hipótese de “user store” é decisão de produto futura (fora do core v1–v3).
- [N/A] L2819: D10) Jobs/Queues + Outbox (motor enterprise sem overkill) — definição final
- [N/A] L2821: > **FECHADO:** Tudo o que é assíncrono, re‑tentável, ou depende de webhooks externos passa por Jobs/Queues.
- [N/A] L2822: > A entrega de eventos internos é garantida por Outbox + idempotência (evita “eventos perdidos”).
- [N/A] L2824: D10.01 Jobs/Queues (obrigatório)
- [N/A] L2825: - Sistema de jobs com:
- [N/A] L2826:   - queue, retries, backoff, e DLQ
- [N/A] L2827:   - prioridades (ex.: pagamentos/entitlements > notificações)
- [N/A] L2828:   - dedupe por `idempotencyKey`
- [N/A] L2829: - Tudo assíncrono passa por jobs:
- [N/A] L2830:   - notificações, exports, ingest CRM, sync Stripe, indexação/search
- [N/A] L2831:   - replays do EventLog, reminders (ex.: split payment T‑48/36/24), reconciliations
- [N/A] L2832: - Estado efémero com TTL (holds, locks, rate‑limits) vive em Redis; DB guarda apenas estado final/auditável.
- [N/A] L2834: D10.02 Outbox (obrigatório)
- [N/A] L2835: - Padrão:
- [N/A] L2836:   - Dentro da mesma transação DB que altera estado, escrever `OutboxEvent` (append‑only).
- [N/A] L2837:   - Worker lê Outbox e publica para:
- [N/A] L2838:     - Job queue (SQS) / consumidores internos
- [N/A] L2839:     - EventBus (quando existir)
- [N/A] L2840: - Campos mínimos:
- [N/A] L2841:   - `eventId` (UUID), `eventType`, `payload`, `createdAt`, `publishedAt`, `attempts`, `nextAttemptAt`
- [N/A] L2842:   - `causationId` / `correlationId`
- [N/A] L2843: - Garantias:
- [N/A] L2844:   - pelo menos uma vez (at‑least‑once) + consumidores idempotentes
- [N/A] L2845:   - sem “eventos perdidos” mesmo com crash entre write e publish
- [N/A] L2847: D10.03 EventBus na AWS — introdução faseada (sem overkill)
- [N/A] L2848: Fase 1:
- [N/A] L2849: - EventLog + Outbox + consumers no worker + SQS para jobs críticos
- [N/A] L2850: - simplicidade e custo baixo
- [N/A] L2851: - **Higienização:** remover legacy (tabelas/colunas/flags antigas), sem fallback; só fica o modelo final do SSOT.
- [N/A] L2853: Fase 2/3 (fan‑out real / múltiplos serviços):
- [N/A] L2854: - Introduzir EventBridge para routing serverless
- [N/A] L2855: - Regras/targets por tipo de evento
- [N/A] L2856: - Mantém EventLog como trilho e base de auditoria
- [N/A] L2858: ⸻
- [N/A] L2860: D11) Moradas — Address Service (SSOT) + Apple Maps como provider único
- [N/A] L2862: > **FECHADO (SSOT):** Todos os módulos consomem e escrevem moradas **apenas** via Address Service. Nunca há “moradas por módulo”.
- [N/A] L2864: Regra
- [N/A] L2865: - Todos os módulos (Eventos / Reservas / Loja / Serviços / Padel) consomem e escrevem moradas APENAS via Address Service (SSOT).
- [N/A] L2866: - O SSOT guarda SEMPRE:
- [N/A] L2867:   - `addressId`
- [N/A] L2868:   - `formattedAddress` (para UI)
- [N/A] L2869:   - `canonical` (estruturado: `countryCode` ISO‑3166‑1, region, locality, postalCode, street, number, etc.)
- [N/A] L2870:   - `geo` (lat, lng)
- [N/A] L2871:   - `sourceProvider` (ex.: `APPLE_MAPS` / `MANUAL`)
- [N/A] L2872:   - `sourceProviderPlaceId` (quando existir)
- [N/A] L2873:   - `confidenceScore` + `validationStatus` (`RAW | NORMALIZED | VERIFIED`)
- [N/A] L2874: - Nunca há “moradas locais” por módulo. Só referências a `addressId`.
- [N/A] L2876: Provider (decisão v9)
- [N/A] L2877: - **Provider único:** Apple Maps (autocomplete + geocode/reverse) via server token.
- [N/A] L2878: - Regra: o client **não** usa providers como fonte de verdade; tudo passa pelo Address Service (protege keys, rate limits e consistência).
- [N/A] L2879: - Exceção permitida: reverse geocode **no device** apenas como hint de UX (não é SSOT). A normalização e persistência continuam no backend.
- [N/A] L2881: Proteções (obrigatório)
- [N/A] L2882: - Rate limiting por IP/user/org + quotas por módulo (para não estourar limites Apple).
- [N/A] L2883: - Cache em 2 níveis:
- [N/A] L2884:   - Redis (TTL curto) por query (autocomplete) e por placeId/geo (geocode)
- [N/A] L2885:   - cache persistente por `addressId` (TTL longo) e dedupe por canonical+geo
- [N/A] L2886: - Circuit breaker do provider Apple:
- [N/A] L2887:   - se Apple falhar acima de `errorRateThreshold` (ex.: 20% em 2 min) → entrar em `cooldownMinutes` (ex.: 10)
- [N/A] L2888:   - durante cooldown, re-test Apple em background (probe) e só volta quando estabilizar
- [N/A] L2889: - Quotas “hard” por organização e por módulo:
- [N/A] L2890:   - ao exceder quota → degrade gracioso (só `resolvePlace` por placeId já em cache; sem autocomplete novo)
- [N/A] L2891:   - emitir `ops.alert` com orgId + módulo + métrica de consumo
- [N/A] L2893: Implementação (o que fazer)
- [N/A] L2894: 1) AddressNormalizeJob
- [N/A] L2895: - Quando Address Service recebe input manual/autocomplete:
- [N/A] L2896:   - parse + normaliza (libpostal + regras internas)
- [N/A] L2897:   - geocode (Apple)
- [N/A] L2898:   - grava `canonical+geo+confidence`
- [N/A] L2900: 2) Deduplication
- [N/A] L2901: - Se canonical+geo (arredondado) coincidir, reusa `addressId` existente (evita duplicados).
- [N/A] L2903: 3) UI (front)
- [N/A] L2904: - Autocomplete sempre passa por Address Service.
- [N/A] L2905: - Front recebe sugestões normalizadas + “confidence”.
- [N/A] L2907: ⸻
- [N/A] L2909: D12) Split Payment Padel — regra default (48/24) + resolução determinística
- [N/A] L2911: Objetivo: proteger a organização de buracos operacionais e dar saídas dignas ao utilizador.
- [N/A] L2913: Regra base:
- [N/A] L2914: 	•	inscrição em dupla só fica CONFIRMED quando ambos pagam
- [N/A] L2915: 	•	existe estado pendente até T-24h do início do torneio
- [N/A] L2916: 	•	matchmaking (open matchmaking pool) só opera na janela T-48h → T-24h
- [N/A] L2918: Estados canónicos (PadelRegistration):
- [N/A] L2919: 	•	PENDING_PARTNER (falta parceiro / convite ainda não aceite)
- [N/A] L2920: 	•	PENDING_PAYMENT (parceiro definido, falta pagamento)
- [N/A] L2921: 	•	MATCHMAKING (entrou no pool, aguardando emparelhamento)
- [N/A] L2922: 	•	CONFIRMED (dupla paga, vaga garantida)
- [N/A] L2923: 	•	EXPIRED (não regularizado até T-24h)
- [N/A] L2924: 	•	CANCELLED (ação explícita do utilizador/admin)
- [N/A] L2925: 	•	REFUNDED (quando aplicável, com policy versionada)
- [N/A] L2927: Ações permitidas por janela temporal (contrato + UX):
- [N/A] L2928: 	1)	Antes de T-48h:
- [N/A] L2929: 		•	convidar, trocar parceiro
- [N/A] L2930: 		•	pagar ambos (captain pays / pay both)
- [N/A] L2931: 		•	entrar em matchmaking (opcional)
- [N/A] L2932: 	2)	T-48h → T-24h:
- [N/A] L2933: 		•	matchmaking ON
- [N/A] L2934: 		•	troca de parceiro ON (com regras)
- [N/A] L2935: 		•	pagar ambos ON
- [N/A] L2936: 		•	sair do matchmaking ON
- [N/A] L2937: 	3)	Depois de T-24h:
- [N/A] L2938: 		•	ou CONFIRMED ou EXPIRED (determinístico)
- [N/A] L2940: Parceiro sem conta:
- [N/A] L2941: 	•	parceiro pode ser só por email
- [N/A] L2942: 	•	o pedido de pagamento fica associado ao email
- [N/A] L2943: 	•	quando o utilizador cria conta com esse email, vê o pagamento pendente e consegue concluir
- [N/A] L2945: Reminders (Jobs):
- [N/A] L2946: 	•	T-48h (entra janela matchmaking)
- [N/A] L2947: 	•	T-36h (pendente)
- [N/A] L2948: 	•	T-24h (última chamada + lock/resolve)
- [N/A] L2949: 	•	T-23h (estado final + próximos passos)
- [N/A] L2951: Resolução aos T-24h:
- [N/A] L2952: 	•	se não estiver CONFIRMED:
- [N/A] L2953: 		•	inscrição → EXPIRED
- [N/A] L2954: 		•	vaga libertada
- [N/A] L2955: 		•	reembolso automático do que tiver sido pago (menos taxa de reembolso), segundo RefundPolicyVersion
- [N/A] L2957: Refund fee:
- [N/A] L2958: 	•	definida como policy object versionado (RefundPolicyVersion) e auditável
- [N/A] L2959: 	•	sempre exibida ao utilizador antes de confirmar a inscrição (transparência)
- [N/A] L2961: Auditoria:
- [N/A] L2962: 	•	todas as mudanças de estado e ações críticas geram EventLog + Audit trail.
- [N/A] L2964: D12.05) Ops — Prisma env auto-load (FECHADO)
- [N/A] L2965: 	•	Prisma CLI deve ler variáveis automaticamente do `.env` (root), sem `set -a`, `source` ou inline envs.
- [N/A] L2966: 	•	Nota operacional: DATABASE_URL via pooler (6543) + DIRECT_URL direto (5432) e ambos com `sslmode=require`.
- [N/A] L2968: D13) Loyalty Points (pontos) — semi-normalizado + guardrails globais
- [N/A] L2969: 	•	sem wallet monetária nesta fase
- [N/A] L2970: 	•	pontos por organização (e opcional por sub-organização)
- [N/A] L2971: 	•	taxa semi-normalizada: 100 pontos ≈ 1€ de “valor percebido” (config global)
- [N/A] L2972: 	•	guardrails globais (caps e ranges) para evitar discrepâncias abusivas
- [N/A] L2973: 	•	Implementação (v9):
- [N/A] L2974: 		–	state change → outbox → worker idempotente (events: LOYALTY_EARNED / LOYALTY_SPENT)
- [N/A] L2975: 		–	payload mínimo: { ledgerId }
- [N/A] L2976: 		–	idempotencyKey: eventId (único por ledgerId+eventType)
- [N/A] L2977: 		–	guardrails globais: pontos/regra 1–5000; max/dia 20000; max/user 200000; custo reward 100–500000
- [N/A] L2979: D14) Multi-Organizações (empresa mãe → filiais)
- [N/A] L2980: 	•	OrganizationGroup (mãe) agrega Organizations (filiais)
- [N/A] L2981: 	•	RBAC suporta: permissões na mãe, permissões por filial, e papéis herdáveis/limitados (Secção 11)
- [N/A] L2983: D15) Macro + Micro Analytics (obrigatório)
- [N/A] L2984: 	•	dashboards financeiros e operacionais com drill-down por dimensões
- [N/A] L2985: 	•	sempre derivados do Ledger + dimensões (sem duplicar estado “financeiro” fora de Finanças)
- [N/A] L2987: D16) Ops Feed (Activity Feed) é first-class
- [N/A] L2988: 	•	eventos operacionais são publicados no EventBus e gravados no EventLog
- [N/A] L2989: 	•	um consumer gera Activity Feed + posts automáticos no canal “Ops” do chat interno
- [N/A] L2991: ⸻
- [N/A] L2993: D17) Integrações Apple — roadmap e guardrails (sem custos extra)
- [N/A] L2995: Objetivo
- [N/A] L2996: 	•	Integrar profundamente com o ecossistema Apple (UX + distribuição), MAS sem criar dependências pagas fora do Apple Developer Program.
- [N/A] L2998: V1 (fazer já)
- [N/A] L2999: 	•	Sign in with Apple (OAuth/OpenID) como método suportado (e obrigatório em iOS se existirem logins de terceiros).
- [N/A] L3000: 	•	APNs para push nativo iOS (token-based auth).
- [N/A] L3001: 	•	Deep links universal links (para eventos / bilhetes / perfil público).
- [N/A] L3002: 	•	Share sheets iOS (partilha de links do perfil público e eventos).
- [N/A] L3004: V1.5 (quando Tickets estiver sólido — ainda **online**)
- [N/A] L3005: 	•	Apple Wallet / PassKit para bilhetes:
- [N/A] L3006: 		–	O passe pode carregar um QR que resolve para `EntitlementQrToken` (lookup online por `tokenHash`).
- [N/A] L3007: 		–	Updates do passe (mudança de owner, cancelamento, horário, venue) via Jobs.
- [N/A] L3008: 		–	Revogação/suspensão via Jobs (disputes/chargebacks) e reflectida no passe.
- [N/A] L3010: **Offline signed QR  — FECHADO como Fase 3:**
- [N/A] L3011: 	•	A validação offline (assinatura criptográfica local) requer:
- [N/A] L3012: 		–	payload versionado e assinado
- [N/A] L3013: 		–	gestão de chaves (public keys + rotação)
- [N/A] L3014: 		–	lista de revogação/suspensão sincronizada por job
- [N/A] L3015: 		–	política explícita de fallback para online
- [N/A] L3017: V2 (só se fizer sentido e sem custo extra)
- [N/A] L3018: 	•	App Clips para “entrada rápida” em eventos:
- [N/A] L3019: 		–	check-in / Apple Wallet add / compra rápida (Apple Pay)
- [N/A] L3020: 		–	ativação por QR/NFC no recinto
- [N/A] L3021: 	•	MapKit / Apple Maps:
- [N/A] L3022: 		–	alinha com D11: Apple é o provider único no Address Service.
- [N/A] L3023: 		–	se houver limites/termos que afectem o autocomplete, o Address Service aplica rate limits, cache e cooldown controlado.
- [N/A] L3025: Key management
- [N/A] L3026: 	•	Certificados/keys Apple (APNs, Pass Type ID) vivem em AWS Secrets Manager + rotação.
- [N/A] L3027: 	•	Build e signing automatizado em CI com permissões mínimas.
- [N/A] L3029: 5) Mapa de Domínio (owners + integrações)
- [N/A] L3031: > Nota: este mapa lista as entidades **mínimas e normativas** para execução; não é exaustivo. Entidades adicionais podem existir, desde que respeitem os owners e contratos.
- [N/A] L3033: Entidades core (owner):
- [N/A] L3035: Reservas
- [N/A] L3036: 	•	CalendarResource, ReservationResource, ReservationProfessional
- [N/A] L3037: 	•	Booking, Availability, CalendarBlock/Override, Service
- [N/A] L3038: 	•	(fase 2) Waitlist, RecurringRule, OpenMatch
- [N/A] L3040: Eventos
- [N/A] L3041: 	•	Event, Session (se aplicável)
- [N/A] L3042: 	•	TicketType, TicketOrder
- [N/A] L3043: 	•	(fase 2) EventSeries
- [N/A] L3045: Padel Torneios
- [N/A] L3046: 	•	Tournament, PadelRegistration, Match, Bracket/Standings, MatchState
- [N/A] L3047: 	•	TournamentRuleSetVersion (novo)
- [N/A] L3048: 	•	TournamentFormatTemplate (novo)
- [N/A] L3050: Finanças
- [N/A] L3051: 	•	Payment, LedgerEntry, Refund, RefundPolicyVersion, Invoice, Payout
- [N/A] L3052: 	•	FeePolicy + FeePolicyVersionSnapshot
- [N/A] L3053: 	•	(fase 2) Subscription, MembershipPlan (via Stripe Billing)
- [N/A] L3055: Check-in
- [N/A] L3056: 	•	Entitlement, EntitlementQrToken, EntitlementCheckin
- [N/A] L3057: 	•	ScannerDevice (fase 2)
- [N/A] L3058: 	•	AccessIntegration (fase 3: portas/catracas)
- [N/A] L3060: CRM
- [N/A] L3061: 	•	CustomerProfile, Consent, TimelineEvent, Segments
- [N/A] L3062: 	•	(fase 2) Lead, Campaign, Automation
- [N/A] L3064: Equipa
- [N/A] L3065: 	•	OrganizationGroupMember, OrganizationGroupMemberOrganizationOverride, OrganizationMemberPermission, OrganizationAuditLog
- [N/A] L3066: 	•	RolePack, CustomRole (fase 2)
- [N/A] L3068: Promoções
- [N/A] L3069: 	•	Promotion, PromoCode, PromoPolicyVersion, Redemption
- [N/A] L3071: Notificações
- [N/A] L3072: 	•	NotificationTemplate, NotificationPreference, NotificationDeliveryLog, NotificationOutbox
- [N/A] L3074: Perfil Público / Username
- [N/A] L3075: 	•	UsernameRegistry, OrgPublicProfileLayout
- [N/A] L3077: Pesquisa & Discovery
- [N/A] L3078: 	•	SearchIndexItem (read model), SearchIndexJob
- [N/A] L3079: Infra transversal
- [N/A] L3080: 	•	EventLog, IdempotencyKey (padrão)
- [N/A] L3081: 	•	Job, JobAttempt, DLQ (novo)
- [N/A] L3083: Address Service
- [N/A] L3084: 	•	Address (canónico), Place (opcional), GeoPoint
- [N/A] L3086: Loyalty
- [N/A] L3087: 	•	LoyaltyPolicy, LoyaltyPointLedgerEntry, RewardCatalog
- [N/A] L3089: Multi-org
- [N/A] L3090: 	•	OrganizationGroup, OrganizationGroupMember (obrigatório)
- [N/A] L3092: Analytics (derivado)
- [N/A] L3093: 	•	AnalyticsMaterializedView (opcional, derivado)
- [N/A] L3094: 	•	“fact tables” geradas por job (opcional; não owner)
- [N/A] L3096: ⸻
- [N/A] L3098: 7) Entitlements e sourceType (canónico e unificado)
- [N/A] L3100: > **FECHADO (SSOT):** Entitlement + Identity são a única fonte de verdade de “quem tem direito a quê”. Tickets/Bookings/Registos são *origens* (source), não “provas” de acesso.
- [N/A] L3102: 7.1 Modelo de Identidade (FECHADO)
- [N/A] L3103: - `Identity` é o “dono” canónico de coisas (tickets, bookings, etc.).
- [N/A] L3104: - Tipos:
- [N/A] L3105:   - `USER` (userId)
- [N/A] L3106:   - `GUEST_EMAIL` (emailNormalizado + emailHash)
- [N/A] L3107: - Permite:
- [N/A] L3108:   - compras como convidado (guest checkout) quando permitido pela `EventAccessPolicy` **na WebApp e no site** (app mobile é login‑only)
- [N/A] L3109:   - claim/merge posterior para user (quando o email for verificado)
- [N/A] L3110:   - RGPD delete/anonymize sem destruir ledger (ledger mantém apenas IDs/pseudónimos)
- [N/A] L3112: 7.2 Entitlement states (FECHADO)
- [N/A] L3113: `PENDING | ACTIVE | REVOKED | EXPIRED | SUSPENDED`
- [N/A] L3114: - `PENDING`: criado mas ainda não “válido” (ex.: pagamento em processamento, hold de reserva).
- [N/A] L3115: - `ACTIVE`: válido para uso (entrada/consumo).
- [N/A] L3116: - `REVOKED`: invalidado por política (refund concluído, cancelamento, ação admin, violação).
- [N/A] L3117: - `EXPIRED`: passou a janela temporal (evento já ocorreu / reserva já passou / TTL).
- [N/A] L3118: - `SUSPENDED`: bloqueado temporariamente (chargeback, fraude, investigação, disputa).
- [N/A] L3120: > **Regra:** “USADO/CONSUMIDO” não é um estado. Consumo é metadata (ver 7.3) para evitar drift e conflitos.
- [N/A] L3122: 7.3 Consumo (check‑in / presença) como metadata (FECHADO)
- [N/A] L3123: - Campos recomendados no Entitlement (ou em `EntitlementConsumption`):
- [N/A] L3124:   - `consumedAt` (nullable)
- [N/A] L3125:   - `consumedByIdentityId` (quem consumiu; tipicamente igual ao owner, mas pode existir “transfer/scan”)
- [N/A] L3126:   - `consumedByDeviceId` / `scannerId` (auditoria)
- [N/A] L3127:   - `consumedLocation` (opcional)
- [N/A] L3128:   - `consumedMethod` (`QR`, `MANUAL`, `NFC` futuro)
- [N/A] L3129: - Idempotência: consumo idempotente por `(entitlementId, scannerId, timeWindow)`.
- [N/A] L3131: 7.4 Entitlement unificado (escopo)
- [N/A] L3132: Cobre:
- [N/A] L3133: - Ticket (Eventos)
- [N/A] L3134: - Booking (Reservas)
- [N/A] L3135: - Padel registration (Padel)
- [N/A] L3136: - Loja (fase 2: pickup/fulfillment + digital goods)
- [N/A] L3138: Campos mínimos (write model):
- [N/A] L3139: - `sourceType`, `sourceId`
- [N/A] L3140: - `ownerIdentityId` (**SSOT**)
- [N/A] L3141: - `status` (enum FECHADO)
- [N/A] L3142: - `validFrom`, `validUntil` (ou derivado do evento/reserva)
- [N/A] L3143: - `createdAt`, `updatedAt`
- [N/A] L3144: - `policyVersionApplied` (**obrigatório** quando `entitlement.eventId != null` e existe `EventAccessPolicy` para esse `eventId`; opcional apenas quando não há policy aplicável)
- [N/A] L3146: 7.5 sourceType canónico (FECHADO)
- [N/A] L3147: Lista oficial:
- [N/A] L3148: - `TICKET_ORDER`
- [N/A] L3149: - `BOOKING`
- [N/A] L3150: - `PADEL_REGISTRATION`
- [N/A] L3151: - `STORE_ORDER`
- [N/A] L3152: - (fase 2) `SUBSCRIPTION`, `MEMBERSHIP`
- [N/A] L3154: Regra:
- [N/A] L3155: - Ledger e check‑in guardam apenas `sourceType` canónico.
- [N/A] L3156: - Não criar “sourceType por módulo” fora desta lista; se precisares, adiciona aqui com versionamento.
- [N/A] L3158: Separação de enums (SSOT D07):
- [N/A] L3159: - `FinanceSourceType` = lista acima (SSOT para Finanças/ledger/check‑in).
- [N/A] L3160: - `AgendaSourceType` = `EVENT`, `TOURNAMENT`, `MATCH`, `SOFT_BLOCK`, `HARD_BLOCK` (apenas agenda/check‑in).
- [N/A] L3161: - Normalização deve escolher o enum certo por domínio (finance vs agenda).
- [N/A] L3163: 7.6 Segurança de Entitlements (mínimo v1–v2)
- [N/A] L3164: - QR tokens nunca reversíveis (guardar **hash**, nunca token em claro) + expiração.
- [N/A] L3165: - `EntitlementQrToken` separado (rota de rotação/revogação).
- [N/A] L3166: - Endpoints de scanner com rate limit + detecção de abuso.
- [N/A] L3167: - Refund/chargeback/cancelamento → evento interno que move Entitlement para `REVOKED` ou `SUSPENDED` (job idempotente).
- [N/A] L3168: - Logs mínimos (sem PII) + auditoria forte para ações admin/scanner.
- [N/A] L3170: 7.7 Claim automático (guest → user) (FECHADO)
- [N/A] L3171: Quando um utilizador cria conta e **verifica o email**:
- [N/A] L3172: - Job/flow idempotente:
- [N/A] L3173:   - encontra `Identity(GUEST_EMAIL)` daquele email
- [N/A] L3174:   - move (claim) todos os entitlements elegíveis para `Identity(USER)`
- [N/A] L3175:   - escreve `AuditLog` + `EventLog` (idempotencyKey = `emailHash+userId+batchVersion`)
- [N/A] L3176: - Regra: o claim nunca altera o ledger; apenas ownership lógico de acesso.
- [N/A] L3177: - WebApp: executar claim **automaticamente no login** (callback/useUser).
- [N/A] L3178: - Mobile (app): não executa claim automático (app é login‑only e não suporta guest checkout).
- [N/A] L3180: 7.8 Matriz de verdade (Payment × Ticket × Entitlement) — **FECHADO**
- [N/A] L3181: Nota (escopo):
- [N/A] L3182: 	•	Aplica-se a `sourceType=TICKET_ORDER` (Ticket). Para `BOOKING` e `PADEL_REGISTRATION`, substituir “Ticket” pelo registo de origem equivalente (Booking/PadelRegistration) com estados canónicos correspondentes.
- [N/A] L3183: Regras canónicas (evitar drift entre módulos):
- [N/A] L3184: 	•	Payment=SUCCEEDED ⇒ Ticket=ACTIVE ⇒ Entitlement=ACTIVE
- [N/A] L3185: 	•	Payment=REFUNDED ⇒ Ticket=REFUNDED ⇒ Entitlement=REVOKED
- [N/A] L3186: 	•	Payment=PARTIAL_REFUND ⇒ Ticket=ACTIVE (itens refundados como REFUNDED) ⇒ Entitlement=REVOKED apenas nos itens refundados
- [N/A] L3187: 	•	Payment=DISPUTED ⇒ Ticket=DISPUTED ⇒ Entitlement=SUSPENDED
- [N/A] L3188: 	•	Payment=CHARGEBACK_LOST ⇒ Ticket=CHARGEBACK_LOST ⇒ Entitlement=REVOKED
- [N/A] L3189: 	•	Payment=CHARGEBACK_WON ⇒ Ticket=ACTIVE ⇒ Entitlement=ACTIVE (se ainda fizer sentido temporalmente)
- [N/A] L3190: 	•	Payment=FAILED/CANCELLED ⇒ Ticket não emitido (ou CANCELLED) ⇒ Entitlement não emitido
- [N/A] L3192: ⸻
- [N/A] L3194: 8) Check‑in (QR) — SSOT e quando NÃO usar (definição final)
- [N/A] L3196: > **FECHADO (SSOT):** `EventAccessPolicy` é a única fonte de verdade da política de acesso **e** de check‑in.
- [N/A] L3197: > Campos legacy `Event.checkinPolicy` e `EventSessionAccessPolicyOverride (tabela futura; não é campo legado)` são **removidos** do write‑path e não podem ser usados como norma.
- [N/A] L3199: 8.1 Onde vive (write model)
- [N/A] L3200: - `EventAccessPolicy` contém um bloco `checkin` (ou tabela normalizada equivalente):
- [N/A] L3201:   - `requiresEntitlementForEntry: boolean`
- [N/A] L3203: > Compatibilidade: quaisquer campos legacy/clients que ainda usem `requiresTicketForEntry` devem mapear 1:1 para `requiresEntitlementForEntry` (ticket = entitlement), até serem removidos.
- [N/A] L3204:   - `methods: QR_TICKET | QR_REGISTRATION | QR_BOOKING | MANUAL` (array/enum)
- [N/A] L3205:   - `scannerRequired: boolean` (se precisares de obrigar device)
- [N/A] L3206:   - `allowReentry: boolean`
- [N/A] L3207:   - `reentryWindowMinutes: number`
- [N/A] L3208:   - `maxEntries: number`
- [N/A] L3209:   - `undoWindowMinutes: number`
- [N/A] L3210:   - `policyVersion` (versão da policy)
- [N/A] L3211: - Se no futuro for necessário override por sessão:
- [N/A] L3212:   - criar `EventSessionAccessPolicyOverride` (tabela explícita)
- [N/A] L3213:   - **nunca** reintroduzir `EventSessionAccessPolicyOverride (tabela futura; não é campo legado)` como campo solto.
- [N/A] L3215: 8.2 Onde é obrigatório (v9)
- [N/A] L3216: - Bilhetes de eventos (entrada)
- [N/A] L3217: - Torneios Padel (validação de inscrição / entrada, conforme regra do torneio)
- [N/A] L3219: 8.3 Onde pode ser opcional (v9)
- [N/A] L3220: - Reservas de serviços (ex.: cabeleireiro) **não precisam** de QR/check‑in.
- [N/A] L3221: - Alternativas “simples”:
- [N/A] L3222:   - “Marcar como concluída” (organização)
- [N/A] L3223:   - “Confirmar presença” (utilizador)
- [N/A] L3224: - QR opcional pode existir como camada extra (fase 2), mas não é requisito do core.
- [N/A] L3226: 8.4 Defaults recomendados (norma)
- [N/A] L3227: - Eventos com bilhete: `requiresEntitlementForEntry=true`, `methods=[QR_TICKET]`
- [N/A] L3228: - Torneios Padel:
- [N/A] L3229:   - se tiverem “entrada controlada”: `requiresEntitlementForEntry=true`, `methods=[QR_REGISTRATION]`
- [N/A] L3230:   - se não tiverem controlo de entrada: `requiresEntitlementForEntry=false` (mas mantém entitlement para histórico)
- [N/A] L3231: - Reservas:
- [N/A] L3232:   - default: `methods=[MANUAL]`
- [N/A] L3233:   - opcional: `methods=[QR_BOOKING]` apenas para organizações que activem “check‑in em serviços”
- [N/A] L3235: 8.5 Regra principal (idempotência e SSOT)
- [N/A] L3236: - Check‑in nunca decide “tem direito” por campos do Ticket/Booking.
- [N/A] L3237: - Check‑in resolve sempre:
- [N/A] L3238:   1) `Entitlement` por QR token
- [N/A] L3239:  2) valida `status==ACTIVE` e janela temporal
- [N/A] L3240:  3) valida compatibilidade com `EventAccessPolicy.checkin` (método permitido)
- [N/A] L3241:  4) grava consumo (metadata) + `EventLog` + `AuditLog` (quando aplicável)
- [N/A] L3243: 8.5.1 Contrato de consumo (mundo real) — **FECHADO v1**
- [N/A] L3244: - Default v1: **1 check-in por Entitlement** (consumo único).
- [N/A] L3245: - Um segundo scan (mesmo QR) resulta em:
- [N/A] L3246:   - `allow=false`
- [N/A] L3247:   - `reasonCode=ALREADY_CONSUMED`
- [N/A] L3248:   - emitir `checkin.duplicate` no Ops Feed
- [N/A] L3249: - **Reentrada (excepção por policy):**
- [N/A] L3250:   - `EventAccessPolicy.checkin.allowReentry=true`
- [N/A] L3251:   - `reentryWindowMinutes` (default: 15)
- [N/A] L3252:   - `maxEntries` (default: 1; se >1, incrementa contador e audita sempre)
- [N/A] L3253: - **Undo (erro humano):**
- [N/A] L3254:   - permitido **apenas** para roles `CHECKIN_RW` (ou superior) + motivo obrigatório
- [N/A] L3255:   - janela curta `undoWindowMinutes` (default: 10)
- [N/A] L3256:   - escreve `AuditLog` + `EventLog` (`checkin.undo`) + mantém histórico (append-only)
- [N/A] L3257: - A “verdade” do acesso continua a ser `Entitlement.status` + metadata (`consumedAt`, `consumedByDeviceId`, contadores).
- [N/A] L3259: 8.5.2 Multi‑sessão / multi‑day (FECHADO v1)
- [N/A] L3260: - Em eventos com sessões, a regra v1 é **1 Entitlement por sessão**.
- [N/A] L3261: - O check‑in valida sempre contra a sessão (sessionId) ou janela temporal da sessão.
- [N/A] L3262: - `allowReentry/maxEntries` **não** dão acesso a sessões futuras; só controlam reentrada dentro da **mesma sessão**.
- [N/A] L3264: 8.6 Modo “Recinto” (rede fraca) — **FECHADO**
- [N/A] L3265: - Scanner pode fazer prefetch de uma allow‑list (hashes) por evento/sessão com TTL curto.
- [N/A] L3266: - Se não houver rede:
- [N/A] L3267:   - valida contra allow‑list (TTL) + regista como `offline_pending_sync`
- [N/A] L3268:   - sincroniza assim que voltar rede e gera EventLog normalizado
- [N/A] L3269: - Não substitui “offline signed QR” (Fase 3). É apenas fallback operacional.
- [N/A] L3271: ⸻
- [N/A] L3273: 10) Sub-navegação TO-BE (rotas canónicas)
- [N/A] L3275: Regra: todas as rotas B2B são **/org/:orgId/*** (orgId explícito).
- [N/A] L3276: Alias PT (legado/UX): /organizacao/:orgId/* faz redirect 301 para /org/:orgId/*.
- [N/A] L3278: 10.1 Serviços
- [N/A] L3280: /org/:orgId/servicos
- [N/A] L3281: 	•	?tab=overview
- [N/A] L3282: 	•	?tab=disponibilidade
- [N/A] L3283: 		•	?tab=precos (tarifários e regras)
- [N/A] L3284: 	•	?tab=profissionais
- [N/A] L3285: 	•	?tab=recursos
- [N/A] L3286: 	•	?tab=politicas
- [N/A] L3287: 	•	?tab=integracoes
- [N/A] L3289: Alias:
- [N/A] L3290: /organizacao/:orgId/servicos → /org/:orgId/servicos
- [N/A] L3292: 10.2 Seguidores
- [N/A] L3294: /org/:orgId/perfil/seguidores
- [N/A] L3295: 	•	?tab=followers
- [N/A] L3296: 	•	?tab=pedidos
- [N/A] L3298: Alias:
- [N/A] L3299: /organizacao/:orgId/perfil/seguidores → /org/:orgId/perfil/seguidores
- [N/A] L3301: 10.3 Check-in
- [N/A] L3303: /org/:orgId/checkin
- [N/A] L3304: 	•	?tab=scanner
- [N/A] L3305: 	•	?tab=lista
- [N/A] L3306: 	•	?tab=sessoes
- [N/A] L3307: 	•	?tab=logs
- [N/A] L3308: 	•	?tab=dispositivos (fase 2)
- [N/A] L3310: Alias:
- [N/A] L3311: 	•	AS-IS /organizacao/:orgId/scan → /org/:orgId/checkin?tab=scanner
- [N/A] L3313: 10.4 Finanças (macro/micro)
- [N/A] L3315: /org/:orgId/financas
- [N/A] L3316: 	•	?tab=overview (bolo)
- [N/A] L3317: 	•	?tab=ledger (movimentos)
- [N/A] L3318: 	•	?tab=dimensoes (recurso/profissional/cliente/produto/filial)
- [N/A] L3319: 	•	?tab=payouts
- [N/A] L3320: 	•	?tab=refunds_disputes
- [N/A] L3321: 	•	?tab=assinaturas (fase 2)
- [N/A] L3323: Alias:
- [N/A] L3324: /organizacao/:orgId/financas → /org/:orgId/financas
- [N/A] L3326: 10.5 Analytics
- [N/A] L3328: /org/:orgId/analytics
- [N/A] L3329: 	•	?tab=dashboard
- [N/A] L3330: 	•	?tab=ocupacao
- [N/A] L3331: 	•	?tab=conversao
- [N/A] L3332: 	•	?tab=no_show
- [N/A] L3333: 	•	?tab=coortes (fase 3)
- [N/A] L3335: Alias:
- [N/A] L3336: /organizacao/:orgId/analytics → /org/:orgId/analytics
- [N/A] L3338: ⸻
- [N/A] L3340: 11) RBAC v2 — roles, scopes e role packs
- [N/A] L3342: 11.1 Roles “reais”
- [N/A] L3344: OWNER, CO_OWNER, ADMIN, STAFF, TRAINER, PROMOTER, VIEWER
- [N/A] L3346: 11.2 Scopes (mapeados ao repo)
- [N/A] L3347: 	•	EVENTS_* → EVENTOS
- [N/A] L3348: 	•	PADEL_* → TORNEIOS
- [N/A] L3349: 	•	RESERVAS_* → RESERVAS
- [N/A] L3350: 	•	FINANCE_* → FINANCEIRO
- [N/A] L3351: 	•	CRM_* → CRM
- [N/A] L3352: 	•	SHOP_* → LOJA
- [N/A] L3353: 	•	TEAM_* → STAFF
- [N/A] L3354: 	•	SETTINGS_* → DEFINICOES
- [N/A] L3355: 	•	CHECKIN_* → EVENTOS/TORNEIOS (até existir módulo próprio)
- [N/A] L3357: 11.3 Role Packs (presets)
- [N/A] L3358: 	•	CLUB_MANAGER → ADMIN + PADEL_*, RESERVAS_*, CHECKIN_*, CRM_RW, TEAM_R, SETTINGS_R
- [N/A] L3359: 	•	TOURNAMENT_DIRECTOR → STAFF + PADEL_*, EVENTS_RW, CHECKIN_RW, RESERVAS_R
- [N/A] L3360: 	•	FRONT_DESK → STAFF + CHECKIN_*, RESERVAS_RW, EVENTS_R, CRM_R
- [N/A] L3361: 	•	COACH → TRAINER + RESERVAS_RW, PADEL_R, CRM_R
- [N/A] L3362: 	•	REFEREE → STAFF + PADEL_RW (matches/live), EVENTS_R, CHECKIN_R
- [N/A] L3364: 11.4 Multi-Organizações (mãe/filiais)
- [N/A] L3365: 	•	permissões podem existir:
- [N/A] L3366: 	•	ao nível do OrganizationGroup (mãe)
- [N/A] L3367: 	•	ao nível de cada Organization (filial)
- [N/A] L3368: 	•	UI mostra claramente “estás na mãe” vs “estás na filial X”
- [N/A] L3369: 	•	auditoria separa por entidade e por âmbito
- [N/A] L3371: 11.5 Roadmap CHECKIN module
- [N/A] L3372: 	•	Conteúdo movido para `docs/planning_registry_v1.md` (bloco de roadmap/check-in, não-normativo).
- [N/A] L3374: ⸻
- [N/A] L3376: 12) Infra do Produto (EventBus, EventLog, Idempotência, Auditoria, Jobs)
- [N/A] L3378: 12.1 EventBus (pub/sub)
- [N/A] L3379: 	•	publish/subscribe interno
- [N/A] L3380: 	•	idempotência por evento
- [N/A] L3381: 	•	consumers tolerantes a replays
- [N/A] L3383: 12.2 EventLog (obrigatório)
- [N/A] L3384: 	•	log técnico do bus
- [N/A] L3385: 	•	trilho de auditoria do sistema
- [N/A] L3386: 	•	base para ingest no CRM, Activity Feed, troubleshooting
- [N/A] L3388: PII e retenção:
- [N/A] L3389: 	•	IDs e metadados mínimos
- [N/A] L3390: 	•	retenção 90–180 dias (config)
- [N/A] L3391: 	•	auditoria RBAC pode reter mais com payload reduzido
- [N/A] L3393: [Movido para secção apropriada no template 00–07]
- [N/A] L3395: 12.3 Idempotência transversal
- [N/A] L3397: Obrigatório em:
- [N/A] L3398: 	•	checkout/refunds
- [N/A] L3399: 	•	check-in
- [N/A] L3400: 	•	live updates (padel)
- [N/A] L3401: 	•	criação/alteração crítica (reservas/eventos)
- [N/A] L3402: 	•	split-payment reminders/expirations
- [N/A] L3404: ---
- [N/A] L3406: [Movido para secção apropriada no template 00–07]
- [N/A] L3408: 12.4 Jobs & Queues (obrigatório)
- [N/A] L3409: 	•	queue (AWS SQS recomendado) + retries + backoff + DLQ
- [N/A] L3410: 	•	observabilidade por job (status, tentativas, payload mínimo)
- [N/A] L3411: 	•	usos:
- [N/A] L3412: 	•	emails/push
- [N/A] L3413: 	•	ingest CRM
- [N/A] L3414: 	•	geração de PDF/exports
- [N/A] L3415: 	•	sync Stripe
- [N/A] L3416: 	•	indexação Search
- [N/A] L3417: 	•	split-payment deadlines
- [N/A] L3418: 	•	revogação de entitlements em disputes
- [N/A] L3420: 	12.4.x Jobs de Reconciliação (obrigatório v1)
- [N/A] L3422: Princípio:
- [N/A] L3423: 	•	Contadores incrementais (soldQuantity, métricas CRM, materializações/aggregates) são READ MODELS.
- [N/A] L3424: 	•	A “verdade” está nos registos base (Tickets/Orders/Ledger/Interactions).
- [N/A] L3426: Jobs mínimos:
- [N/A] L3427: 	1) ticketing.reconcile_sold_quantities (hourly/daily)
- [N/A] L3428: 		•	recalcula vendidos por TicketType a partir de ordens pagas e entitlements válidos:
- [N/A] L3429: 			–	base: Payments SUCCEEDED por sourceType=TICKET_ORDER (Finanças SSOT)
- [N/A] L3430: 			–	excluir: entitlements REVOKED/SUSPENDED quando aplicável (policy)
- [N/A] L3431: 			–	sem depender de “estados inventados” no Ticket
- [N/A] L3432: 		•	se drift > threshold → corrigir + emitir evento ops.alert + log de auditoria
- [N/A] L3433: 	2) crm.rebuild_customer_counters (daily)
- [N/A] L3434: 		•	rebuild determinístico a partir de CrmInteraction
- [N/A] L3437: Outputs:
- [N/A] L3438: 	•	tabela de “drifts” + dashboard no Admin (14.1) com alerts e links.
- [N/A] L3440: 12.5 Activity Feed + Canal “Ops” (alertas automáticos)
- [N/A] L3442: Eventos mínimos recomendados (MVP):
- [N/A] L3443: 	•	booking.created, booking.cancelled, booking.no_show
- [N/A] L3444: 	•	payment.succeeded, payment.failed
- [N/A] L3445: 	•	subscription.failed (fase 2)
- [N/A] L3446: 	•	ticket.order.created
- [N/A] L3447: 	•	padel.registration.created, padel.registration.expired
- [N/A] L3448: 	•	checkin.success, checkin.denied, checkin.duplicate
- [N/A] L3449: 	•	refund.created, refund.succeeded, chargeback.opened
- [N/A] L3450: 	•	review.negative / moderation.flagged (fase 2/3 com moderação)
- [N/A] L3451: 	•	inventory.low_stock (fase 2)
- [N/A] L3453: 12.6 Guardrails de Arquitetura (obrigatório v1)
- [N/A] L3454: 	•	Architecture Tests
- [N/A] L3455: 	•	falhar build se alguém importar Stripe fora de Finanças
- [N/A] L3456: 	•	falhar build se alguém escrever entidades fora do “owner” (podes fazer via wrappers ou lint rules)
- [N/A] L3457: 	•	Contract Tests
- [N/A] L3458: 	•	cada contrato tem testes unit e “golden tests” nos módulos `domain/*` (perto do owner)
- [N/A] L3459: 	•	Anti-drift migrations
- [N/A] L3460: 	•	pipeline que falha se schema Prisma divergir do DB (staging)
- [N/A] L3462: [Movido para secção apropriada no template 00–07]
- [N/A] L3464: [Movido para secção apropriada no template 00–07]
- [N/A] L3466: [Movido para secção apropriada no template 00–07]
- [N/A] L3468: 12.7 Timezone canónica (FECHADO)
- [N/A] L3469: - Todas as janelas temporais e jobs com T‑X (reminders, locks, expirations) são calculadas na **timezone do evento** (IANA, ex.: `Europe/Lisbon`).
- [N/A] L3470: - Em Reservas (sem evento), usa‑se a timezone da **organização/recurso** (também IANA).
- [N/A] L3471: - Regra: guardar timestamps canónicos em UTC + timezone original; UI apenas converte para visualização.
- [N/A] L3473: ⸻
- [N/A] L3475: 13) Pesquisa & Discovery (infra sem overkill) — **FECHADO**
- [N/A] L3477: v1 (Fase 1)
- [N/A] L3478: 	•	Postgres full-text + trigram + filtros por tipo
- [N/A] L3479: 	•	index unificado derivado (owners continuam Eventos/Padel/Reservas/Serviços)
- [N/A] L3480: 	•	rebuild por jobs + replay a partir de EventLog (idempotente)
- [N/A] L3482: v2 (quando houver volume)
- [N/A] L3483: 	•	Typesense/Meilisearch alimentado por jobs a partir de EventLog
- [N/A] L3485: 13.1 Ranking (v1) — **FECHADO**
- [N/A] L3486: ADITAMENTO FECHADO: ranking mínimo e observabilidade para produção v1.
- [N/A] L3487: - Sinais mínimos (ordenados por impacto):
- [N/A] L3488:   - relevância textual (match exato + trigram)
- [N/A] L3489:   - proximidade (geo) quando aplicável
- [N/A] L3490:   - janela temporal (a acontecer / hoje / esta semana)
- [N/A] L3491:   - popularidade (views, likes, going)
- [N/A] L3492:   - qualidade (org score + `risk.flagged`)
- [N/A] L3493:   - penalizações por spam de keywords
- [N/A] L3494: - Observabilidade mínima:
- [N/A] L3495:   - CTR por posição
- [N/A] L3496:   - zero‑result rate
- [N/A] L3497:   - top queries (sem PII)
- [N/A] L3498: - Anti‑abuso:
- [N/A] L3499:   - keyword stuffing → downrank com `reasonCode=RANKING_SPAM_KEYWORDS`
- [N/A] L3500:   - org com `risk.flagged` → downrank com `reasonCode=RANKING_RISK_FLAGGED`
- [N/A] L3502: ⸻
- [N/A] L3504: 13.2 Ranking Unificado v2 (Personalização Total) — **FECHADO**
- [N/A] L3505: ADITAMENTO FECHADO: ranking canónico único para eventos em todas as superfícies.
- [N/A] L3507: - **Engine único**: usado por **Agora, Descobrir, Mapa, Pesquisa** (eventos).
- [N/A] L3508: - **Categorias canónicas** via `Event.interestTags` (sem matching por texto).
- [N/A] L3509:   - Lista canónica: `padel, concertos, festas, viagens, bem_estar, gastronomia, aulas, workshops`.
- [N/A] L3510:   - **Fallback** se `interestTags` vazio:
- [N/A] L3511:     - `PADEL → padel`
- [N/A] L3512:     - `PARTY → festas`
- [N/A] L3513:     - `TALK → workshops`
- [N/A] L3514:     - `OTHER/VOLUNTEERING → bem_estar`
- [N/A] L3515: - **Sinais comportamentais** (SSOT): `user_event_signals`
- [N/A] L3516:   - `CLICK`, `VIEW`, `DWELL`, `FAVORITE`, `PURCHASE`
- [N/A] L3517: - **Afinidade social**:
- [N/A] L3518:   - org seguida → boost
- [N/A] L3519:   - amigos (mutual follows) com tickets → boost
- [N/A] L3520: - **Contexto real**:
- [N/A] L3521:   - distância + janela temporal (live/soon/semana)
- [N/A] L3522: - **Feedback explícito**:
- [N/A] L3523:   - `HIDE_EVENT` remove/penaliza
- [N/A] L3524:   - `HIDE_CATEGORY` e `HIDE_ORG` penalizam/ocultam
- [N/A] L3525: - **Pesos iniciais** (v2):
- [N/A] L3526:   - `preference=0.35`, `behavior=0.25`, `social=0.20`, `context=0.15`, `recency=0.05`
- [N/A] L3527:   - negativos via multiplicador (`NEGATIVE_MULTIPLIER`)
- [N/A] L3528: - **Razões explicáveis** (`rank.reasons`):
- [N/A] L3529:   - `PREF_MATCH`, `BEHAVIOR_PURCHASE`, `BEHAVIOR_FAVORITE`
- [N/A] L3530:   - `SOCIAL_ORG_FOLLOW`, `SOCIAL_FRIENDS_GOING`
- [N/A] L3531:   - `CONTEXT_NEARBY`, `CONTEXT_SOON`
- [N/A] L3532:   - `NEGATIVE_HIDE_CATEGORY`, `NEGATIVE_HIDE_ORG`, `NEGATIVE_HIDE_EVENT`
- [N/A] L3533: - **Ingestão canónica** de sinais:
- [N/A] L3534:   - `POST /api/me/events/signals`
- [N/A] L3535: - **Endpoints**: `GET /api/explorar/list` e `GET /api/eventos/list` usam ranking unificado.
- [N/A] L3537: ⸻
- [N/A] L3539: 14) Governança & Ferramentas Internas (Admin, Billing, Support, Analytics)
- [N/A] L3541: 14.1 Admin global (admin.orya.pt)
- [N/A] L3542: 	•	gestão de organizações (KYC leve, settings globais)
- [N/A] L3543: 	•	fee policies globais + overrides
- [N/A] L3544: 	•	feature flags
- [N/A] L3545: 	•	health/ops dashboard (jobs, DLQ, falhas)
- [N/A] L3546: 	•	dispute tooling (visibilidade e trilhos)
- [N/A] L3547: 	•	gestão de templates de notificações
- [N/A] L3549: 14.1.1 SLIs mínimos (MVP) — **FECHADO**
- [N/A] L3550: Finanças
- [N/A] L3551: 	•	webhook failure rate (5 min) + retries/DLQ count
- [N/A] L3552: 	•	tempo até `processorFeesStatus=FINAL` (p50/p95 por dia)
- [N/A] L3553: Check-in
- [N/A] L3554: 	•	latência do `Checkin.consume` (p50/p95)
- [N/A] L3555: 	•	rácio `checkin.denied` e `checkin.duplicate` por evento
- [N/A] L3556: Jobs/Queues
- [N/A] L3557: 	•	DLQ size + oldest message age
- [N/A] L3558: 	•	retry rate por jobType (top N)
- [N/A] L3559: Read Models / Anti-drift
- [N/A] L3560: 	•	drift count diário (crm + sold_quantities) + severidade (threshold)
- [N/A] L3561: Alertas (Ops)
- [N/A] L3562: 	•	alerta automático quando qualquer SLI ultrapassa threshold, com link directo para logs + entidade (eventId/paymentId/orgId)
- [N/A] L3564: 18) Nota final (regra de ouro)
- [N/A] L3566: Se uma decisão não estiver aqui, não está decidida.
- [N/A] L3567: Se uma implementação contradizer D02/D04/D03, é bug de arquitectura, não é “trade-off”.
- [N/A] L3569: ⸻
- [N/A] L3571: ## 06 Production Gates (SLI/SLO, go-live, release gates)
- [N/A] L3573: ### 06.0 P0 endpoints (guardrails)
- [N/A] L3574: Lista canónica de rotas P0 usada pelos gates de envelope/erro.
- [N/A] L3575: Atualizar apenas quando uma rota P0 for adicionada/removida.
- [N/A] L3577: <!-- P0_ENDPOINTS_START -->
- [N/A] L3578: - `app/api/payments/intent/route.ts`
- [N/A] L3579: - `app/api/checkout/status/route.ts`
- [N/A] L3580: - `app/api/checkout/resale/route.ts`
- [N/A] L3581: - `app/api/convites/[token]/checkout/route.ts`
- [N/A] L3582: - `app/api/cobrancas/[token]/checkout/route.ts`
- [N/A] L3583: - `app/api/store/checkout/route.ts`
- [N/A] L3584: - `app/api/store/checkout/prefill/route.ts`
- [N/A] L3585: - `app/api/servicos/[id]/checkout/route.ts`
- [N/A] L3586: - `app/api/organizacao/reservas/[id]/checkout/route.ts`
- [N/A] L3587: - `app/api/padel/pairings/[id]/checkout/route.ts`
- [N/A] L3588: - `app/api/admin/payments/refund/route.ts`
- [N/A] L3589: - `app/api/admin/payments/dispute/route.ts`
- [N/A] L3590: - `app/api/admin/payments/reprocess/route.ts`
- [N/A] L3591: - `app/api/admin/refunds/list/route.ts`
- [N/A] L3592: - `app/api/admin/refunds/retry/route.ts`
- [N/A] L3593: - `app/api/organizacao/refunds/list/route.ts`
- [N/A] L3594: - `app/api/organizacao/payouts/status/route.ts`
- [N/A] L3595: - `app/api/organizacao/payouts/list/route.ts`
- [N/A] L3596: - `app/api/organizacao/payouts/summary/route.ts`
- [N/A] L3597: - `app/api/organizacao/payouts/settings/route.ts`
- [N/A] L3598: - `app/api/organizacao/payouts/connect/route.ts`
- [N/A] L3599: - `app/api/organizacao/payouts/webhook/route.ts`
- [N/A] L3600: - `app/api/admin/payouts/list/route.ts`
- [N/A] L3601: - `app/api/admin/payouts/[id]/route.ts`
- [N/A] L3602: - `app/api/admin/payouts/[id]/block/route.ts`
- [N/A] L3603: - `app/api/admin/payouts/[id]/unblock/route.ts`
- [N/A] L3604: - `app/api/admin/payouts/[id]/cancel/route.ts`
- [N/A] L3605: - `app/api/admin/payouts/[id]/force-release/route.ts`
- [N/A] L3606: - `app/api/internal/reconcile/route.ts`
- [N/A] L3607: - `app/api/internal/outbox/dlq/route.ts`
- [N/A] L3608: - `app/api/internal/outbox/replay/route.ts`
- [N/A] L3609: - `app/api/internal/worker/operations/route.ts`
- [N/A] L3610: - `app/api/internal/reprocess/purchase/route.ts`
- [N/A] L3611: - `app/api/internal/reprocess/payment-intent/route.ts`
- [N/A] L3612: - `app/api/internal/reprocess/stripe-event/route.ts`
- [N/A] L3613: - `app/api/internal/checkout/timeline/route.ts`
- [N/A] L3614: - `app/api/internal/checkin/consume/route.ts`
- [N/A] L3615: - `app/api/cron/operations/route.ts`
- [N/A] L3617: - `app/api/stripe/webhook/route.ts`
- [N/A] L3618: - `app/api/webhooks/stripe/route.ts`
- [N/A] L3619: <!-- P0_ENDPOINTS_END -->
- [N/A] L3621: ## Operational SLIs, SLOs & Alerting (NORMATIVE)
- [N/A] L3623: This section defines the minimum observability and alerting standards
- [N/A] L3624: required for production operation of the ORYA platform.
- [N/A] L3626: Dashboards without actionable thresholds are insufficient.
- [N/A] L3628: ---
- [N/A] L3630: ### O01 — Alert Classification
- [N/A] L3631: Alerts are classified as:
- [N/A] L3632: - **PAGER:** requires immediate human intervention
- [N/A] L3633: - **TICKET:** requires investigation but not immediate action
- [N/A] L3635: ---
- [N/A] L3637: ### O02 — Core Domain SLIs & Thresholds
- [N/A] L3639: #### Payments & Ledger
- [N/A] L3640: | SLI | Threshold | Window | Alert |
- [N/A] L3641: |----|----|----|----|
- [N/A] L3642: | Payment webhook failure rate | >2% | 5 min | PAGER |
- [N/A] L3643: | Ledger reconciliation lag | >15 min | 1 h | TICKET |
- [N/A] L3644: | Processor fee unresolved | >30 min | rolling | TICKET |
- [N/A] L3645: | Duplicate payment detection | >0 | immediate | PAGER |
- [N/A] L3647: ---
- [N/A] L3649: #### Entitlements & Access
- [N/A] L3650: | SLI | Threshold | Window | Alert |
- [N/A] L3651: |----|----|----|----|
- [N/A] L3652: | Entitlement issuance failure | >1% | 5 min | PAGER |
- [N/A] L3653: | Check-in validation latency (p95) | >300 ms | 10 min | TICKET |
- [N/A] L3654: | Duplicate check-in attempts | spike | rolling | TICKET |
- [N/A] L3656: ---
- [N/A] L3658: #### Async Jobs & Outbox
- [N/A] L3659: | SLI | Threshold | Window | Alert |
- [N/A] L3660: |----|----|----|----|
- [N/A] L3661: | DLQ depth | >0 | 10 min | PAGER |
- [N/A] L3662: | Job retry exhaustion | >0 | immediate | PAGER |
- [N/A] L3663: | Job processing latency (p95) | >5 min | 15 min | TICKET |
- [N/A] L3665: ---
- [N/A] L3667: ### O03 — Logging & Correlation
- [N/A] L3668: All logs MUST include:
- [N/A] L3669: - `correlationId`
- [N/A] L3670: - `orgId`
- [N/A] L3671: - domain entity identifiers
- [N/A] L3673: Logs without correlation context are non-compliant.
- [N/A] L3675: ---
- [N/A] L3677: ### O04 — Incident Readiness
- [N/A] L3678: For each PAGER alert, the following MUST exist:
- [N/A] L3679: - documented runbook
- [N/A] L3680: - clear ownership
- [N/A] L3681: - rollback or mitigation steps
- [N/A] L3683: Production without runbooks is forbidden.
- [N/A] L3685: ---
- [N/A] L3687: 17.1 Escopo de Produção (Cut Line v1.x) — **FECHADO**
- [N/A] L3688: ADITAMENTO FECHADO: delimita o que entra em produção v1.0 e o que fica bloqueado.
- [N/A] L3690: A) IN (obrigatório para v1.0)
- [N/A] L3691: 	•	Eventos: criar/publicar/listar + gestão básica
- [N/A] L3692: 	•	Tickets: compra + emissão/entitlement
- [N/A] L3693: 	•	Finanças: checkout + webhooks + ledger append‑only + reconciliação
- [N/A] L3694: 	•	Entitlements: criação + revogação
- [N/A] L3695: 	•	Check‑in: scanner + consumo + logs
- [N/A] L3696: 	•	Org onboarding Stripe Connect Standard (KYC) — C02.X01
- [N/A] L3697: 	•	RBAC mínimo (org scopes críticos)
- [N/A] L3698: 	•	Notificações essenciais (transaccionais + operacionais)
- [N/A] L3699: 	•	DSAR básico operativo (19.4)
- [N/A] L3700: 	•	Trust & Safety mínimo operativo (19.2)
- [N/A] L3701: 	•	Observabilidade mínima (SLIs + alertas críticos 14.1.1)
- [N/A] L3702: 	•	Discovery/ranking avançado (Ranking Unificado v2)
- [N/A] L3704: B) OUT (consta neste SSOT, mas fica bloqueado/feature‑flagged em v1.0)
- [N/A] L3705: 	•	QR offline assinado (S2) e validação offline
- [N/A] L3706: 	•	Automações CRM complexas e campanhas
- [N/A] L3707: 	•	Funcionalidades sociais não essenciais (comunidade)
- [N/A] L3708: 	•	Marketplace avançado e integrações enterprise
- [N/A] L3710: C) Regra de execução (hard)
- [N/A] L3711: 	•	Tudo o que está OUT: UI escondida + endpoints protegidos + feature flag obrigatória + **403 por defeito**.
- [N/A] L3712: 	•	Qualquer activação exige aprovação explícita + `SafetyCase` quando aplicável (19.2).
- [N/A] L3714: D) Definição de Done para Go‑Live v1.0
- [N/A] L3715: 	•	Todos os itens IN operacionais **e** 19.0 Go‑Live Gate cumprido.
- [N/A] L3716: 	•	Cut‑line aplicado e verificado por testes (19.6).
- [N/A] L3718: ⸻
- [N/A] L3720: 19.0 Go‑Live Gate (Fase 1) — **FECHADO**
- [N/A] L3721: Pré‑requisitos mínimos antes de abrir produção real:
- [N/A] L3722: - Documentos legais publicados e linkados (19.1).
- [N/A] L3723: - Onboarding B2B para payouts completo (KYC + aceites).
- [N/A] L3724: - DSAR básico ativo (19.4).
- [N/A] L3725: - Trust & Safety mínimo (19.2).
- [N/A] L3726: - Runbooks de suporte + escalação definidos (19.3).
- [N/A] L3727: - Alertas críticos ativos (SLIs 14.1.1) + dashboards básicos.
- [N/A] L3728: - Backups configurados + **1º teste de restore** executado (19.3).
- [N/A] L3729: - Release gates ativos (19.6) + guardrails 12.6.
- [N/A] L3731: 19.3 Suporte & Operação (quando falha às 02:00) — **FECHADO**
- [N/A] L3732: 19.3.0 Kill Switches & Degraded Modes (NORMATIVE)
- [N/A] L3733: The platform MUST support operational kill switches to limit blast radius.
- [N/A] L3735: Examples include:
- [N/A] L3736: - disabling new checkouts while allowing check-in
- [N/A] L3737: - pausing payouts while preserving ledger integrity
- [N/A] L3738: - freezing promotions or codes during abuse spikes
- [N/A] L3740: Kill switches MUST:
- [N/A] L3741: - be reversible
- [N/A] L3742: - be auditable
- [N/A] L3743: - not violate SSOT or ledger invariants
- [N/A] L3745: Degraded operation is preferred over full outage.
- [N/A] L3747: - Support Playbook (runbooks) obrigatório:
- [N/A] L3748:   - Pagamento preso (PROCESSING / REQUIRES_ACTION)
- [N/A] L3749:   - Webhook falhou / DLQ a crescer
- [N/A] L3750:   - Check‑in lento / rede instável no recinto
- [N/A] L3751:   - Erro em refunds/chargebacks
- [N/A] L3752:   - Incidente de segurança (conta comprometida / fraude)
- [N/A] L3753: - Modos operacionais:
- [N/A] L3754:   - “Recinto” (check‑in): prioridade operacional, UX de fallback e mensagens claras.
- [N/A] L3755:   - “Finance ops”: triagem de disputes/refunds com logs e trilho de auditoria.
- [N/A] L3756: - Escalação (SLA interno):
- [N/A] L3757:   - L1 suporte → L2 operações → engenharia on‑call → decisão (admin).
- [N/A] L3758: - Observabilidade mínima (sempre ligada):
- [N/A] L3759:   - Logs, métricas, tracing onde possível; dashboards por domínio (Finanças, Jobs, Check‑in, Address).
- [N/A] L3760:   - Alertas críticos (pagers) quando:
- [N/A] L3761:     - DLQ > 0 por mais de X min
- [N/A] L3762:     - webhook failure rate acima de threshold
- [N/A] L3763:     - taxa de `payment.processing` > threshold
- [N/A] L3764:     - `processorFeesStatus` não fecha dentro de janela (p95)
- [N/A] L3765:     - drift jobs acusam inconsistências acima de threshold
- [N/A] L3766: - Backups & Restore (targets internos):
- [N/A] L3767:   - RPO/RTO normativos (targets operacionais):
- [N/A] L3768:     - DB transaccional: RPO ≤ 1h, RTO ≤ 4h
- [N/A] L3769:     - Config/policies (fee policies, access policies): RPO ≤ 15m, RTO ≤ 2h
- [N/A] L3770:     - Logs/EventLog (auditoria): RPO ≤ 24h, RTO ≤ 12h
- [N/A] L3771:   - Backups automáticos + retenção por política.
- [N/A] L3772:   - **Teste de restore inicial** obrigatório no Go‑Live.
- [N/A] L3774: 19.3.1 Backups reais (Supabase → AWS) — **FECHADO**
- [N/A] L3775: Como o DB está em Supabase na Fase 1, a estratégia de backup é:
- [N/A] L3776: - Primário: PITR/Backups geridos pelo Supabase (conforme plano).
- [N/A] L3777: - Secundário (AWS): export automatizado para S3 (diário) + retenção por policy:
- [N/A] L3778:   - dumps encriptados (KMS) + versioning + lifecycle (ex.: 30/90/365 dias conforme classe).
- [N/A] L3779: - Restore:
- [N/A] L3780:   - runbook para restore via Supabase + validação pós‑restore (smoke tests).
- [N/A] L3781:   - 1º restore test obrigatório antes do Go‑Live (19.0).
- [N/A] L3783: 19.6 Qualidade & Release Gates (DoD “produção”) — **FECHADO**
- [N/A] L3784: - Nenhum release sem:
- [N/A] L3785:   - Contract tests a passar (golden tests) — ver 12.6
- [N/A] L3786:   - Architecture tests a passar (owners, Stripe só em Finanças, etc.) — ver 12.6
- [N/A] L3787:   - Idempotência verificada nos fluxos críticos (checkout/refund/fulfillment/check‑in)
- [N/A] L3788:   - SLIs/alertas actualizados e dashboards válidos (14.1.1)
- [N/A] L3789:   - Runbooks actualizados para mudanças de comportamento
- [N/A] L3790: - Golden Set (obrigatório) — **FECHADO** (ADITAMENTO)
- [N/A] L3791:   - `createCheckout` idempotente: replay com o mesmo `idempotencyKey` **não** duplica `Payment`/`LedgerEntry`
- [N/A] L3792:   - Webhooks fora de ordem não corrompem estados (`Payment`/`Refund`/`Dispute`)
- [N/A] L3793:   - Refund parcial revoga **apenas** os entitlements correctos
- [N/A] L3794:   - `dispute.created` suspende entitlement + bloqueia entrada (se aplicável) + cria `SafetyCase` com `reasonCode=RISK_DISPUTE_CREATED`
- [N/A] L3795:   - Claim guest → user não duplica ownership nem tickets
- [N/A] L3796:   - Check‑in duplicate gera `reasonCode=CHECKIN_DUPLICATE` + audit em `EventLog`
- [N/A] L3797:   - Reconciliação ledger vs processor detecta divergência e gera alerta crítico
- [N/A] L3798: - Regressões automáticas (alertas):
- [N/A] L3799:   - divergência ledger vs processor (reconciliação)
- [N/A] L3800:   - pagamentos presos acima do normal
- [N/A] L3801:   - falhas em jobs críticos / DLQ
- [N/A] L3802:   - spikes de `checkin.denied`/`duplicate`
- [N/A] L3803:   - spikes de `free_checkout.denied` (anti‑abuso)
- [N/A] L3805: 19.7 Hardening (Fase 2/3) — **FECHADO**
- [N/A] L3806: - DR “game days” (semestral):
- [N/A] L3807:   - simular indisponibilidade de componentes críticos (fila/jobs, storage, compute)
- [N/A] L3808:   - validar recuperação e impacto em RPO/RTO
- [N/A] L3809: - Restore tests recorrentes + exports assinados.
- [N/A] L3810: - Observabilidade avançada (tracing end‑to‑end, SLOs por domínio).
- [N/A] L3811: - Risk engine mais sofisticado (modelos e regras dinâmicas).
- [N/A] L3812: - Automação de DSAR e auditorias internas periódicas.
- [N/A] L3814: ## 07 Normative Appendices (só referência normativa)
- [N/A] L3816: Apêndice A — Policy Defaults v1 (FECHADO)
- [N/A] L3818: A1) Rate Limits (segurança/anti‑abuso) — FECHADO
- [N/A] L3819: - Login:
- [N/A] L3820:   - 10 tentativas / 10 min por IP
- [N/A] L3821:   - 5 tentativas / 10 min por emailHash/identity
- [N/A] L3822:   - cooldown progressivo: 15 min → 60 min em falhas repetidas
- [N/A] L3823: - Reset password / magic link:
- [N/A] L3824:   - 3 pedidos / 30 min por emailHash
- [N/A] L3825: - createCheckout (Finanças):
- [N/A] L3826:   - 10 tentativas / 5 min por identityId + sourceId
- [N/A] L3827:   - 30 tentativas / 5 min por IP (hard cap)
- [N/A] L3828: - InviteToken validate/claim:
- [N/A] L3829:   - 10 tentativas / 10 min por IP/device
- [N/A] L3830: - Check‑in (scanner API):
- [N/A] L3831:   - 120 scans/min por deviceId (burst), média 60/min
- [N/A] L3832:   - 10 “denied” consecutivos → step‑up (re‑auth do staff) + throttle 5 min
- [N/A] L3834: A2) TTLs e janelas — FECHADO
- [N/A] L3835: - InviteToken TTL default: 7 dias (salvo override em EventAccessPolicy)
- [N/A] L3836: - EntitlementQrToken TTL default: 24h (rotacionável por job) + revogação imediata em disputa/refund
- [N/A] L3837: - Allow‑list “Modo Recinto” TTL: 2h (prefetch) + validade máxima offline: 30 min sem sync
- [N/A] L3838: - Username cooldown (rename): 15 dias (já definido; reafirmar FECHADO)
- [N/A] L3839: - Retenção de “offline_pending_sync” (check‑in): 7 dias
- [N/A] L3841: A3) FREE_CHECKOUT guardrails — FECHADO
- [N/A] L3842: - Default max por Identity e por (eventId + ticketTypeId): 1
- [N/A] L3843: - Rate limit FREE_CHECKOUT: 5 tentativas / 10 min por identityId; 10 / 10 min por IP
- [N/A] L3844: - Step‑up obrigatório (captcha/turnstile) quando:
- [N/A] L3845:   - ≥3 falhas em 10 min, ou
- [N/A] L3846:   - padrão suspeito (múltiplos identities no mesmo device/IP)
- [N/A] L3848: A4) SLIs/SLOs e Alert Thresholds — FECHADO
- [N/A] L3849: - API (p95):
- [N/A] L3850:   - leitura: p95 < 400ms
- [N/A] L3851:   - escrita crítica (checkout/checkin): p95 < 800ms
- [N/A] L3852: - Taxa de erro (5xx):
- [N/A] L3853:   - alerta amarelo: >1% em 5 min
- [N/A] L3854:   - alerta vermelho: >3% em 5 min
- [N/A] L3855: - Jobs:
- [N/A] L3856:   - fila crítica (payments/entitlements): atraso > 2 min → alerta
- [N/A] L3857:   - DLQ > 0 em jobs críticos → alerta imediato
- [N/A] L3858: - Webhooks Stripe:
- [N/A] L3859:   - eventos não reconciliados > 15 min → alerta
- [N/A] L3861: A5) SLA Suporte e Trust & Safety — FECHADO
- [N/A] L3862: - Pagamentos/Check‑in (P0): triagem ≤ 1h, mitigação ≤ 4h
- [N/A] L3863: - Fraude/Chargeback (P1): triagem ≤ 24h, acção ≤ 72h
- [N/A] L3864: - Denúncias conteúdo/comportamento (P2): triagem ≤ 24h, resolução ≤ 7 dias
- [N/A] L3865: - Comunicação incidentes:
- [N/A] L3866:   - P0/P1: status page + aviso às orgs afectadas em ≤ 2h
- [N/A] L3868: A6) Retenção por classe (RGPD by design) — FECHADO
- [N/A] L3869: - EventLog técnico (sem PII): 180 dias
- [N/A] L3870: - Audit logs (acções críticas): 2 anos (payload minimizado)
- [N/A] L3871: - Logs de delivery de notificações: 90 dias
- [N/A] L3872: - Dados financeiros/ledger/invoices: 10 anos (obrigação fiscal/contabilística)
- [N/A] L3873: - PII não essencial: apagar/anonimizar após 24 meses de inactividade (salvo obrigação legal)
- [N/A] L3875: A7) Risk Flags (heurísticas base) — FECHADO
- [N/A] L3876: - Chargeback rate por org:
- [N/A] L3877:   - >1% em 30 dias → flag amarela
- [N/A] L3878:   - >2% em 30 dias → flag vermelha + step‑up + suspensão de vendas até revisão
- [N/A] L3879: - Anomalia de vendas:
- [N/A] L3880:   - >3× média diária (7 dias) em <2h → alerta + revisão
- [N/A] L3881: - QR abuse:
- [N/A] L3882:   - ≥20 denied em 10 min no mesmo evento/device → throttle + re‑auth do staff
- [N/A] L3884: A8) Environment Baseline (prod + CI) — FECHADO
- [N/A] L3885: Fonte normativa consolidada de envs críticos (origem: especificação legacy migrada):
- [N/A] L3886: - Core runtime:
- [N/A] L3887:   - `DATABASE_URL`
- [N/A] L3888:   - `DIRECT_URL`
- [N/A] L3889:   - `QR_SECRET_KEY`
- [N/A] L3890:   - `ORYA_CRON_SECRET`
- [N/A] L3891:   - `REDIS_URL` (produção)
- [N/A] L3892: - Supabase:
- [N/A] L3893:   - `SUPABASE_URL`
- [N/A] L3894:   - `SUPABASE_ANON_KEY`
- [N/A] L3895:   - `SUPABASE_SERVICE_ROLE`
- [N/A] L3896:   - `NEXT_PUBLIC_SUPABASE_URL`
- [N/A] L3897:   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- [N/A] L3898: - Stripe:
- [N/A] L3899:   - `STRIPE_SECRET_KEY_LIVE`, `STRIPE_SECRET_KEY_TEST`
- [N/A] L3900:   - `STRIPE_WEBHOOK_SECRET_LIVE`, `STRIPE_WEBHOOK_SECRET_TEST`
- [N/A] L3901:   - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_LIVE`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST`
- [N/A] L3902: - Apple Sign-In / APNS / Maps:
- [N/A] L3903:   - `APPLE_SIGNIN_*`
- [N/A] L3904:   - `APNS_*`
- [N/A] L3905:   - `APPLE_MAPS_*`
- [N/A] L3907: Guardrails:
- [N/A] L3908: - Secrets MUST stay out of git and be managed via Secrets Manager/SSM in produção.
- [N/A] L3909: - `*_PRIVATE_KEY_BASE64` MUST be single-line base64.
- [N/A] L3910: - `SINGLE_DB_MODE=1` força runtime de DB para `APP_ENV=prod`.
- [N/A] L3911: - Paid checkout sem publishable key deve falhar explicitamente com `CONFIG_STRIPE_KEY_MISSING`.
- [N/A] L3912: - Snapshot operacional PROD/LOCAL e runbooks de custo ficam em Planning (não-normativo).
- [N/A] L3914: A9) Cutover Guardrails (Store Big-Bang compatibility) — FECHADO
- [N/A] L3915: Guardrails normativos mínimos para cutovers destrutivos de domínio:
- [N/A] L3916: - Pré-condições obrigatórias:
- [N/A] L3917:   - janela de manutenção ativa
- [N/A] L3918:   - deploy freeze aplicado
- [N/A] L3919:   - backup/restore validados
- [N/A] L3920: - Gates obrigatórios pré-change:
- [N/A] L3921:   - `npm run gate:api-contract`
- [N/A] L3922:   - `npm run gate:api-ui-coverage`
- [N/A] L3923:   - `npm run typecheck`
- [N/A] L3924:   - `npm run test`
- [N/A] L3925:   - `npm --prefix apps/mobile test -- --runInBand`
- [N/A] L3926: - Fail-hard policy:
- [N/A] L3927:   - qualquer guardrail/gate falhado bloqueia reabertura.
- [N/A] L3928: - Rollback:
- [N/A] L3929:   - restore integral + redeploy da versão anterior + verificação de consistência pós-restore.
- [N/A] L3931: A10) Roadmap Infra Supabase -> AWS (decisão de direção) — FECHADO
- [N/A] L3932: - Fase 1:
- [N/A] L3933:   - Supabase mantém DB/Auth.
- [N/A] L3934:   - Compute/queues/storage/observabilidade correm em AWS.
- [N/A] L3935: - Fase 2:
- [N/A] L3936:   - migração de Postgres para AWS (RDS/Aurora) com cutover planeado.
- [N/A] L3937: - Fase 2/3:
- [N/A] L3938:   - migração de Auth para AWS (Cognito ou serviço próprio), preservando `Identity` como SSOT.
- [N/A] L3939: - Objetivo final:
- [N/A] L3940:   - operação 100% AWS com descontinuação controlada de dependências legadas.
- [N/A] L3942: ---
- [N/A] L3944: ## Critical Flow Sequences (REFERENCE)
- [N/A] L3946: This appendix documents the authoritative interpretation of the most
- [N/A] L3947: critical system flows. It does not introduce new behavior but clarifies
- [N/A] L3948: expected execution order.
- [N/A] L3950: ---
- [N/A] L3952: ### F1 — Checkout → Payment → Ledger → Entitlement
- [N/A] L3953: 1. Checkout intent is created
- [N/A] L3954: 2. Payment is initialized (state machine)
- [N/A] L3955: 3. Processor confirmation received (possibly async)
- [N/A] L3956: 4. Ledger entries appended
- [N/A] L3957: 5. Entitlement issued only after ledger truth
- [N/A] L3958: 6. User access derives exclusively from entitlement
- [N/A] L3960: ---
- [N/A] L3962: ### F2 — Webhook Out-of-Order Handling
- [N/A] L3963: 1. Webhook received
- [N/A] L3964: 2. Event validated and deduplicated
- [N/A] L3965: 3. Ledger reconciliation applied
- [N/A] L3966: 4. Payment state updated if applicable
- [N/A] L3967: 5. No mutation of historical ledger entries
- [N/A] L3969: ---
- [N/A] L3971: ### F3 — Check-In Validation
- [N/A] L3972: 1. QR or identifier scanned
- [N/A] L3973: 2. Entitlement resolved
- [N/A] L3974: 3. Org context validated
- [N/A] L3975: 4. Duplicate check-in detected or denied
- [N/A] L3976: 5. Audit log appended
- [N/A] L3978: ---
- [N/A] L3980: ### F4 — Guest Purchase → Claim Flow
- [N/A] L3981: 1. Guest checkout completed
- [N/A] L3982: 2. Entitlement issued to GUEST_EMAIL identity
- [N/A] L3983: 3. Verification link sent
- [N/A] L3984: 4. Identity upgraded to USER
- [N/A] L3985: 5. Entitlement re-bound without mutation
- [N/A] L3987: ---
- [N/A] L3989: ---

## Source: docs/planning_registry_v1.md
- [N/A] L1: # ORYA Planning Registry (NÃO-NORMATIVO)
- [N/A] L3: Atualizado: 2026-02-11
- [N/A] L5: ## Propósito
- [N/A] L6: - Este documento agrega planeamento, backlog e itens “a fazer”.
- [N/A] L7: - Não define autoridade arquitetural, contratos ou regras fechadas.
- [N/A] L8: - A fonte normativa continua a ser apenas `docs/ssot_registry_v1.md`.
- [N/A] L10: ## Regra de Migração para o SSOT
- [N/A] L11: - Um item deste documento só entra no SSOT após aprovação explícita do owner.
- [N/A] L12: - Quando aprovado, deve ser convertido em regra/decisão/contrato com linguagem normativa e identificador claro (`D*`, `C*`, `I*`).
- [N/A] L14: ## Estados de Revisão
- [N/A] L15: - `PENDENTE_OWNER`: ainda não revisto.
- [N/A] L16: - `APROVADO_PARA_SSOT`: aprovado para migração normativa.
- [N/A] L17: - `REJEITADO`: não entra no SSOT.
- [N/A] L18: - `MANTER_PLANEAMENTO`: continua apenas como planeamento.
- [N/A] L20: ## Bloco P1 — Padel Clube (Planeamento)
- [N/A] L21: - Estado do bloco: `EM_REVISAO_BLOCO_1`
- [N/A] L22: - Objetivo: separar claramente o que pode virar norma no SSOT do que permanece roadmap.
- [N/A] L24: ### P1.1 Candidatos a Norma (revisão owner)
- [N/A] L25: - Item: Padel Clube consome Agenda Engine de Reservas e não cria agenda própria.
- [N/A] L26:   Origem: `blueprint legado (removido)`
- [N/A] L27:   Proposta de destino: SSOT (se aprovado) como reforço de boundary de domínio.
- [N/A] L28:   Estado: `PENDENTE_OWNER`
- [N/A] L29: - Item: Pagamentos de reservas do clube via Finanças (`createCheckout`) e sem intents Stripe fora de Finanças.
- [N/A] L30:   Origem: `blueprint legado (removido)`
- [N/A] L31:   Proposta de destino: SSOT (se aprovado) como reforço de contrato C2.
- [N/A] L32:   Estado: `PENDENTE_OWNER`
- [N/A] L33: - Item: Integração torneios ↔ agenda via `MatchSlot hard-block` / `CalendarBlock` respeitando D3/D3.1.
- [N/A] L34:   Origem: `blueprint legado (removido)`
- [N/A] L35:   Proposta de destino: SSOT (se aprovado) como clarificação de execução em Padel Clube.
- [N/A] L36:   Estado: `PENDENTE_OWNER`
- [N/A] L37: - Item: Aulas no domínio Padel são integração com Serviços/Reservas (sem duplicação de lógica).
- [N/A] L38:   Origem: `blueprint legado (removido)`
- [N/A] L39:   Proposta de destino: SSOT (se aprovado) como regra de ownership.
- [N/A] L40:   Estado: `PENDENTE_OWNER`
- [N/A] L42: ### P1.2 Planeamento / Backlog (não normativo)
- [N/A] L43: - Item: Agenda premium (dia/semana, drag & drop avançado, camadas operacionais).
- [N/A] L44:   Origem: `blueprint legado (removido)`
- [N/A] L45:   Estado: `MANTER_PLANEAMENTO`
- [N/A] L46: - Item: Otimização de ocupação (open matches, waitlist) na evolução do clube.
- [N/A] L47:   Origem: `blueprint legado (removido)`
- [N/A] L48:   Estado: `MANTER_PLANEAMENTO`
- [N/A] L49: - Item: Experiência do jogador no clube (portal/app, perfil com estatísticas, gamificação local).
- [N/A] L50:   Origem: `blueprint legado (removido)`
- [N/A] L51:   Estado: `MANTER_PLANEAMENTO`
- [N/A] L52: - Item: Conteúdo/comunidade local do clube e integrações federação para fases futuras.
- [N/A] L53:   Origem: `blueprint legado (removido)`
- [N/A] L54:   Estado: `MANTER_PLANEAMENTO`
- [N/A] L56: ## Bloco P2 — Padel Torneios (Planeamento)
- [N/A] L57: - Item: Formatos adicionais (Americano/Mexicano).
- [N/A] L58:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L59:   Estado: `PENDENTE_OWNER`
- [N/A] L60: - Item: Double elimination e formatos avançados.
- [N/A] L61:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L62:   Estado: `PENDENTE_OWNER`
- [N/A] L63: - Item: Circuitos/etapas com ranking cumulativo.
- [N/A] L64:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L65:   Estado: `PENDENTE_OWNER`
- [N/A] L66: - Item: Operação live avançada (árbitro mobile, monitor/TV enriquecido).
- [N/A] L67:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L68:   Estado: `PENDENTE_OWNER`
- [N/A] L69: - Item: Streaming integrado avançado.
- [N/A] L70:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L71:   Estado: `PENDENTE_OWNER`
- [N/A] L73: ## Bloco P3 — Integração Entre Ferramentas (Planeamento)
- [N/A] L74: - Item: Fluxos avançados de cross-promotion (reservas ↔ torneios ↔ aulas).
- [N/A] L75:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L76:   Estado: `PENDENTE_OWNER`
- [N/A] L77: - Item: Hub Padel com atalhos operacionais e KPIs expandidos.
- [N/A] L78:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L79:   Estado: `PENDENTE_OWNER`
- [N/A] L80: - Item: Camada de integração por eventos para cenários de produto.
- [N/A] L81:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L82:   Estado: `PENDENTE_OWNER`
- [N/A] L84: ## Bloco P4 — Gaps e Hardening (Planeamento)
- [N/A] L85: - Item: Operação offline ampliada para torneios (além do fallback atual).
- [N/A] L86:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L87:   Estado: `PENDENTE_OWNER`
- [N/A] L88: - Item: Lock states adicionais e matriz de permissões por estado live.
- [N/A] L89:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L90:   Estado: `PENDENTE_OWNER`
- [N/A] L91: - Item: Métricas operacionais adicionais (funis e atrasos por court).
- [N/A] L92:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L93:   Estado: `PENDENTE_OWNER`
- [N/A] L95: ## Bloco P5 — Roadmap / Epics / Tarefas (Planeamento)
- [N/A] L96: - Item: Epics de execução por sprint para evolução Padel.
- [N/A] L97:   Origem: `blueprint legado (removido)` (anexo Padel, secções roadmap/checklist/epics).
- [N/A] L98:   Estado: `PENDENTE_OWNER`
- [N/A] L99: - Item: Tarefas por epic com critérios de aceitação operacionais.
- [N/A] L100:   Origem: `blueprint legado (removido)` (anexo Padel, secções de tarefas).
- [N/A] L101:   Estado: `PENDENTE_OWNER`
- [N/A] L102: - Item: Sequenciamento de fases não normativas (F2/F3) para priorização.
- [N/A] L103:   Origem: `blueprint legado (removido)` (anexo Padel).
- [N/A] L104:   Estado: `PENDENTE_OWNER`
- [N/A] L106: ## Bloco P6 — Estudos e Benchmark (Planeamento)
- [N/A] L107: - Item: Comparativo competitivo (Playtomic/Padel Manager/Tournify/PadelTeams).
- [N/A] L108:   Origem: `blueprint legado (removido)` (anexo Padel, análise comparativa).
- [N/A] L109:   Estado: `PENDENTE_OWNER`
- [N/A] L110: - Item: Recomendações de evolução (rating, gamificação, comunidade).
- [N/A] L111:   Origem: `blueprint legado (removido)` (anexo Padel, recomendações).
- [N/A] L112:   Estado: `PENDENTE_OWNER`
- [N/A] L114: ## Notas Operacionais
- [N/A] L115: - Este documento pode ser reorganizado por prioridade/impacto sem alterar o SSOT.
- [N/A] L116: - Sempre que um item migrar para norma, registar no topo: `Migrado para SSOT: <id>`.
