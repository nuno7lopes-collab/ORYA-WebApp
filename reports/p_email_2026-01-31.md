# Email & Domain — admin@orya.pt (PROD) — 2026-01-31

## DNS / Route53
- HostedZoneId: Z01063466077T62XP3HQ
- Delegation NS:
  - ns-633.awsdns-15.net
  - ns-430.awsdns-53.com
  - ns-1234.awsdns-26.org
  - ns-1742.awsdns-25.co.uk
- Public NS (dig @8.8.8.8):
  - ns-1742.awsdns-25.co.uk.
  - ns-430.awsdns-53.com.
  - ns-1234.awsdns-26.org.
  - ns-633.awsdns-15.net.
- MX (public): orya.pt → Google Workspace (ASPMX + ALT1..ALT4)
  - Route53 changeId: /change/C075166522VBSLVJDUBN5

## ACM
- eu-west-1: arn:aws:acm:eu-west-1:495219734037:certificate/ad0e6d9f-cbb2-41a4-a2f7-6f8c27e0885e — ISSUED
- us-east-1: arn:aws:acm:us-east-1:495219734037:certificate/ca75794b-551c-4c4c-9597-6255df3239d8 — ISSUED

## SES Domain (eu-west-1)
- Domain identity: orya.pt — VERIFIED
  - Verification token: 0y4ad62rMoAkI7HIwRLnZfn6bp9S03YYsxHvN3wuGjY=
  - TXT record: _amazonses.orya.pt
  - Route53 changeId: /change/C05493821G068ZI8JVBA6
- DKIM: ENABLED + VERIFIED
  - Tokens:
    - eccgjmgo5jwgcyomh5m2f3f6qu5nnk27
    - 3h5jfafsovozffvgjb7ick5udv7sfrph
    - k7dqo43l2o6giiuflkuzrc7uksve2nre
  - CNAME records: <token>._domainkey.orya.pt → <token>.dkim.amazonses.com
  - Route53 changeId: /change/C036900213JZ4UJUTSNN6
- MAIL FROM: mail.orya.pt (UseDefaultValue)
  - MX: mail.orya.pt → feedback-smtp.eu-west-1.amazonses.com
  - TXT: "v=spf1 include:amazonses.com -all"
  - Route53 changeId: /change/C06428372FTCN4EBDJF2A
- DMARC:
  - TXT: _dmarc.orya.pt → "v=DMARC1; p=none; rua=mailto:admin@orya.pt; fo=1"
  - Route53 changeId: /change/C0088534H5MSSDH5QTR0
- SNS topics:
  - Bounce: arn:aws:sns:eu-west-1:495219734037:orya-ses-bounce
  - Complaint: arn:aws:sns:eu-west-1:495219734037:orya-ses-complaint
  - Delivery: arn:aws:sns:eu-west-1:495219734037:orya-ses-delivery
- SES account status:
  - ProductionAccessEnabled: false (sandbox)

## SES Inbound (admin@orya.pt) — fallback/archive
- MX (domain): orya.pt → inbound-smtp.eu-west-1.amazonaws.com (prio 10)
  - Route53 changeId: /change/C04141311078MW6FEP6DR
- S3 bucket: orya-mail-inbound-prod (private, SSE-S3)
- SNS topic: arn:aws:sns:eu-west-1:495219734037:orya-ses-inbound
- Receipt rule set: orya-inbound (ACTIVE)
- Receipt rule: orya-inbound-store
  - Actions: S3 (bucket, prefix inbound/), Lambda forwarder, SNS publish

## Forwarding to Google Workspace (final delivery)
- Lambda: arn:aws:lambda:eu-west-1:495219734037:function:orya-ses-forwarder
- Role: arn:aws:iam::495219734037:role/orya-ses-forwarder-role
- Logic:
  - If header `X-Orya-Forwarded: 1` exists → drop (prevents loop)
  - Adds `X-Orya-Forwarded: 1` on forward
  - Sends via SES `SendRawEmail` to admin@orya.pt
  - From: admin@orya.pt, Reply-To: original sender (avoids DMARC spoofing)
  - Logs: requestId, sesMessageId, s3Key, toAddress

## WorkMail (eu-west-1) — provisioned but NOT final delivery
- Organization: orya-workmail-prod
  - OrganizationId: m-b327733ef828476dbee49804acfe6159
  - ARN: arn:aws:workmail:eu-west-1:495219734037:organization/m-b327733ef828476dbee49804acfe6159
- User/mailbox:
  - UserId: efe3d39a-e966-4fea-8f8b-cdd72dd3d64a
  - Email: admin@orya.pt
  - State: ENABLED, MailboxProvisionedDate: 2026-01-31T17:21:00Z
- Receipt Rule no longer uses WorkMailAction (final delivery is Google Workspace via Lambda).

## Lambda forwarder (active)
- Forwarder configured via SES receipt rule (not S3 notification).
- Env: FORWARD_TO=admin@orya.pt, SOURCE_EMAIL=admin@orya.pt, BUCKET_NAME=orya-mail-inbound-prod, OBJECT_PREFIX=inbound/

## Support Case (SES production)
- Attempted create-case via AWS Support API: FAILED
  - Reason: SubscriptionRequiredException (no Premium Support)
  - Action needed: open SES production access case via AWS Console or enable Support plan.

## Test (end-to-end)
- SES send-email MessageId (initial): 0102019c150219e3-6148f300-b8b2-422a-adf3-4e1e5b1f91ab-000000
- SES send-email MessageId (WorkMail test): 0102019c1513af8b-5107e850-b234-486b-8337-99ee17060736-000000
- S3 inbound objects:
  - inbound/o4v5stulgqtvt19oqkb77dqhp0koi4uqq5lflh01
  - inbound/cmnm4dcnp4eva9okfb96k8n55b5mns99h33leq81
  - inbound/57tpjb5v3thtmvvjievihlbu9qngv5aoht9s7v81
- External inbound (Gmail → admin@orya.pt):
  - S3 key: inbound/s6bhbiti7217o1jv37bh5avlghisantnup2d9qg1
  - LastModified: 2026-01-31T17:39:23Z
  - Headers (from S3 object):
    - From: Nuno Lopes <nl7nunolopes7@gmail.com>
    - Subject: Test-inbound 17:06
    - Message-ID: <CAC0cV-zu7AkDh=Cvyzb=TLTZd+kqueNdhr+zWAg9O-g2RbvPCw@mail.gmail.com>
    - Date: Sat, 31 Jan 2026 17:39:09 +0000
- External inbound (Gmail → admin@orya.pt) — 17:52 test:
  - S3 key (original): inbound/u14pl0ipqlbnrr41f1orbjqd3vv5th10dduepkg1
  - S3 key (forwarded copy with X-Orya-Forwarded): inbound/2di5n0qucdmj32fij3dndmfnts7asd6gkkirb2o1
  - Lambda requestIds:
    - e66b16d8-e9e7-4977-b972-94e196e0e9b7 (processed original, forwarded)
    - c03ace09-6289-43f0-9518-82c9208be6a3 (drop-forwarded)
  - SES forward MessageId: 0102019c152f6413-822cc932-d9a7-48a7-b9de-04bb1c311152-000000
- Google Workspace delivery proof: pending manual inbox confirmation.
- Re-send archive to Google (post-MX change):
  - inbound/2di5n0qucdmj32fij3dndmfnts7asd6gkkirb2o1 → 0102019c1539bb4d-ce057db1-4c9d-4ca4-aa0c-989f9431b73b-000000
  - inbound/57tpjb5v3thtmvvjievihlbu9qngv5aoht9s7v81 → 0102019c1539c34d-e9a9ad70-72e7-4b85-90b4-1b1a30046827-000000
  - inbound/AMAZON_SES_SETUP_NOTIFICATION → 0102019c1539cb13-cd9d9f33-69f0-45a6-af46-54505fbd86b6-000000
  - inbound/cmnm4dcnp4eva9okfb96k8n55b5mns99h33leq81 → 0102019c1539d2c0-55b95d90-dd62-46d8-b22d-56601c1d6036-000000
  - inbound/o4v5stulgqtvt19oqkb77dqhp0koi4uqq5lflh01 → 0102019c1539da81-05d81e02-a4b3-437e-8ae2-e0cae45dc79d-000000
  - inbound/s6bhbiti7217o1jv37bh5avlghisantnup2d9qg1 → 0102019c1539e22d-633ae171-cbbf-4731-89ff-b91b35752de0-000000
  - inbound/u14pl0ipqlbnrr41f1orbjqd3vv5th10dduepkg1 → 0102019c1539e9ed-9e76b5b9-3b2f-409d-a7de-b610ba682649-000000
- External 3× test subjects pending (Test-admin-inbound-1/2/3) once sent by Nuno.

## Secrets Manager (prod)
Created/updated:
- orya/prod/SES_REGION
- orya/prod/SES_SMTP_USERNAME
- orya/prod/SES_SMTP_PASSWORD
- orya/prod/SES_IDENTITY_DOMAIN
- orya/prod/SES_MAIL_FROM_DOMAIN
- orya/prod/SES_BOUNCE_TOPIC_ARN
- orya/prod/SES_COMPLAINT_TOPIC_ARN
- orya/prod/SES_DELIVERY_TOPIC_ARN
- orya/prod/SES_INBOUND_SNS_TOPIC_ARN
- orya/prod/SES_INBOUND_BUCKET
- orya/prod/SES_RECEIPT_RULE_SET
- orya/prod/SES_RECEIPT_RULE
- orya/prod/WORKMAIL_ORG_ID
- orya/prod/WORKMAIL_ORG_ARN
- orya/prod/WORKMAIL_ADMIN_USERNAME
- orya/prod/WORKMAIL_ADMIN_PASSWORD

## Notes
- Inbound mail is working via SES+S3. Forwarder is active; delivery to Google Workspace requires manual inbox confirmation.
- Loop guard: header `X-Orya-Forwarded: 1` drops re-entry (prevents infinite loops). Expect at most one extra inbound copy for forwarded messages.
- External senders should work once MX propagated (already OK). Deliveries verified via S3; inbox confirmation pending.
 - IMPORTANT: MX now points to Google Workspace, so new inbound should arrive directly in Gmail. SES inbound is retained only for archive/fallback.
