# P1 Closeout Report — 2026-01-29
Atualizado: 2026-01-30

## Status
- P1 code + unit tests: DONE
- Infra/CI artifacts: DONE (skeletons + workflows + scripts)
- E2E P1 flows: BLOCKED (requires prod secrets + admin session + Stripe/Resend/APNS)
- Mobile/A11y/Perf QA: BLOCKED (requires device farm + Lighthouse/axe)

## Key changes (P1)
- Refunds/chargebacks: ledger append-only + dispute.closed processing + refund email outbox.
- Ops feed: admin dashboard now shows recent ops items.
- Runbooks: domain runbooks added (payments/refunds, check-in, reservas, notifications) + metrics/alerts + incident/rollback.
- Ops health: includes outbox/operations/payment counts.
- RBAC: added access matrix tests; guardrails remain.
- Infra/CI: ECS/ALB/ECR skeleton, task defs, deploy workflow, render script.

## Tests
- `npm run typecheck`: **PASS**.
- `npm run lint`: **PASS**.
- `npm run test:coverage`: **PASS** (303 tests, 103 files).
```
Test Files  103 passed (103)
Tests       303 passed (303)
```
Nota: logs de erro em testes são mensagens esperadas de paths de retry (sem falhas).

## DB evidence (sample, local DB)
```
select id,purchase_id,payment_intent_id,status,total_cents,platform_fee_cents,stripe_fee_cents
from app_v3.sale_summaries order by created_at desc limit 3;
```
Result:
```
 id |             purchase_id              |          payment_intent_id           | status | total_cents | platform_fee_cents | stripe_fee_cents 
----+--------------------------------------+--------------------------------------+--------+-------------+--------------------+------------------
  4 | pur_0adfa3a2331bc0c594094c60ed6e4942 | pur_0adfa3a2331bc0c594094c60ed6e4942 | PAID   |           0 |                  0 |                0
  3 | pur_790111c3d20a253c2bdca808c1b764d8 | pur_790111c3d20a253c2bdca808c1b764d8 | PAID   |           0 |                  0 |                0
  2 | pur_87b246001d8e37a3133c1d9abc19902c | pi_3Sv10b8Z8GNlpSy21R0Icszx          | PAID   |        1515 |                 30 |                0
```

```
select entry_type, amount, causation_id
from app_v3.ledger_entries
where payment_id = 'pur_87b246001d8e37a3133c1d9abc19902c'
order by created_at;
```
Result:
```
 entry_type      | amount | causation_id
----------------+--------+------------------------------------------------------------
 GROSS          |   1500 | checkout:pur_87b246001d8e37a3133c1d9abc19902c:gross
 PLATFORM_FEE   |    -30 | checkout:pur_87b246001d8e37a3133c1d9abc19902c:platform_fee
 PROCESSOR_FEES_FINAL | -74 | stripe:balance_tx:txn_3Sv10b8Z8GNlpSy21aiJJjZb
```

```
select id, status, processor_fees_status
from app_v3.payments
where id = 'pur_87b246001d8e37a3133c1d9abc19902c';
```
Result:
```
 id |  status   | processor_fees_status
----+-----------+----------------------
 pur_87b246001d8e37a3133c1d9abc19902c | SUCCEEDED | FINAL
```

## E2E P1 (BLOCKED)
### Bloqueios
- Requer Secrets Manager `orya/prod/*` com valores reais.
- Requer sessão admin em prod para /api/admin/*.
- Requer Stripe test data para disputes/refunds reais.
- APNS envs para push real (APNS_TEAM_ID, APNS_KEY_ID, APNS_PRIVATE_KEY_BASE64, APNS_TOPIC).

### Como desbloquear
1) `npm run dev` com envs (Supabase/Stripe/Resend/APNS).
2) Executar flows:
   - Admin refund -> status -> ledger -> entitlement.
   - Dispute created/closed (Stripe) -> payment status -> ledger.
   - Ops feed + notifications.
3) Guardar requestIds/correlationIds em `reports/p1_closeout_2026-01-29.md`.

## Runbooks atualizados
- `docs/runbooks/payments-refunds.md`
- `docs/runbooks/checkin.md`
- `docs/runbooks/reservas.md`
- `docs/runbooks/notifications.md`
- `docs/runbooks/metrics-alerts.md`
- `docs/runbooks/payments-incident.md`
- `docs/runbooks/db-migrations.md`
- `docs/runbooks/cron-recovery.md`
- `docs/runbooks/deploy-rollback.md`

## Infra/CI artifacts
- `infra/ecs/orya-ecs-stack.yaml`
- `infra/ecs/route53-acm.yaml`
- `infra/ecs/taskdef-web.json`
- `infra/ecs/taskdef-worker.json`
- `.github/workflows/deploy-ecs.yml`
- `scripts/render-taskdef.py`
- `scripts/run-e2e-p1.sh`
- `scripts/run-devicefarm.sh`
- `scripts/run-lighthouse.sh`
- `scripts/run-axe.sh`
- `docs/deploy/ci_cd.md`
- `docs/deploy/cost-optimization.md`
- `docs/observability/sentry-integration.md`

## CloudWatch / Sentry samples
- BLOCKED: requer acesso ao ambiente/console (não disponível localmente).

## RequestIds / correlationIds
- BLOCKED: pendente de E2E em ambiente com servidor + secrets.

## When secrets arrive (one-liner)
```bash
./scripts/run-e2e-p1.sh
```
Then capture requestIds (≥3 per flow) and update `reports/p1_closeout_2026-01-29.md` + `docs/v10_execution_checklist.md`.
