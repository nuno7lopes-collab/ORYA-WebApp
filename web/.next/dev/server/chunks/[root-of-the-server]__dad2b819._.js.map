{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/nuno/orya/ORYA-WebApp/lib/env.ts"],"sourcesContent":["// Central helper for server-side environment variables (server-only).\n// ⚠️ Não importar este módulo em componentes com \"use client\".\nconst required = [\n  \"SUPABASE_URL\",\n  \"SUPABASE_ANON_KEY\",\n  \"SUPABASE_SERVICE_ROLE\",\n  \"DATABASE_URL\",\n  \"STRIPE_SECRET_KEY\",\n  \"STRIPE_WEBHOOK_SECRET\",\n  \"QR_SECRET_KEY\",\n  \"RESEND_API_KEY\",\n] as const;\n\ntype EnvKey = (typeof required)[number];\n\nfunction getEnv(key: EnvKey): string {\n  const value = process.env[key];\n  if (!value) {\n    throw new Error(`Missing env var: ${key}`);\n  }\n  return value;\n}\n\nfunction getOptionalUrlEnv(...keys: string[]) {\n  for (const key of keys) {\n    const value = process.env[key];\n    if (typeof value === \"string\" && value.trim().length > 0) {\n      return value.trim().replace(/\\/+$/, \"\"); // remove trailing slash para URLs previsíveis\n    }\n  }\n  return \"\";\n}\n\nfunction parseBoolean(raw: unknown, fallback: boolean) {\n  if (typeof raw === \"boolean\") return raw;\n  if (typeof raw === \"string\") {\n    const normalized = raw.trim().toLowerCase();\n    if ([\"1\", \"true\", \"yes\", \"on\"].includes(normalized)) return true;\n    if ([\"0\", \"false\", \"no\", \"off\"].includes(normalized)) return false;\n  }\n  return fallback;\n}\n\nfunction parseNumber(raw: unknown, fallback: number) {\n  const n = Number(raw);\n  return Number.isFinite(n) ? n : fallback;\n}\n\nexport const env = {\n  supabaseUrl: getEnv(\"SUPABASE_URL\"),\n  supabaseAnonKey: getEnv(\"SUPABASE_ANON_KEY\"),\n  serviceRoleKey: getEnv(\"SUPABASE_SERVICE_ROLE\"),\n  dbUrl: getEnv(\"DATABASE_URL\"),\n  stripeSecretKey: getEnv(\"STRIPE_SECRET_KEY\"),\n  stripeWebhookSecret: getEnv(\"STRIPE_WEBHOOK_SECRET\"),\n  qrSecretKey: getEnv(\"QR_SECRET_KEY\"),\n  resendApiKey: getEnv(\"RESEND_API_KEY\"),\n  resendFrom:\n    process.env.RESEND_FROM ??\n    process.env.RESEND_FROM_EMAIL ??\n    \"no-reply@orya.pt\",\n  appBaseUrl: getOptionalUrlEnv(\"APP_BASE_URL\", \"NEXT_PUBLIC_BASE_URL\", \"NEXT_PUBLIC_SITE_URL\", \"VERCEL_URL\"),\n  uploadsBucket:\n    process.env.SUPABASE_STORAGE_BUCKET_UPLOADS ??\n    process.env.SUPABASE_STORAGE_BUCKET ??\n    \"uploads\",\n  avatarsBucket: process.env.SUPABASE_STORAGE_BUCKET_AVATARS ?? \"\",\n  eventCoversBucket: process.env.SUPABASE_STORAGE_BUCKET_EVENT_COVERS ?? \"\",\n  storageSignedUrls: parseBoolean(process.env.SUPABASE_STORAGE_SIGNED_URLS, false),\n  storageSignedTtlSeconds: parseNumber(process.env.SUPABASE_STORAGE_SIGNED_TTL_SECONDS, 60 * 60 * 24 * 30), // 30 dias\n};\n"],"names":[],"mappings":"AAAA,sEAAsE;AACtE,+DAA+D;;;;;AAC/D,MAAM,WAAW;IACf;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAID,SAAS,OAAO,GAAW;IACzB,MAAM,QAAQ,QAAQ,GAAG,CAAC,IAAI;IAC9B,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM,CAAC,iBAAiB,EAAE,KAAK;IAC3C;IACA,OAAO;AACT;AAEA,SAAS,kBAAkB,GAAG,IAAc;IAC1C,KAAK,MAAM,OAAO,KAAM;QACtB,MAAM,QAAQ,QAAQ,GAAG,CAAC,IAAI;QAC9B,IAAI,OAAO,UAAU,YAAY,MAAM,IAAI,GAAG,MAAM,GAAG,GAAG;YACxD,OAAO,MAAM,IAAI,GAAG,OAAO,CAAC,QAAQ,KAAK,8CAA8C;QACzF;IACF;IACA,OAAO;AACT;AAEA,SAAS,aAAa,GAAY,EAAE,QAAiB;IACnD,IAAI,OAAO,QAAQ,WAAW,OAAO;IACrC,IAAI,OAAO,QAAQ,UAAU;QAC3B,MAAM,aAAa,IAAI,IAAI,GAAG,WAAW;QACzC,IAAI;YAAC;YAAK;YAAQ;YAAO;SAAK,CAAC,QAAQ,CAAC,aAAa,OAAO;QAC5D,IAAI;YAAC;YAAK;YAAS;YAAM;SAAM,CAAC,QAAQ,CAAC,aAAa,OAAO;IAC/D;IACA,OAAO;AACT;AAEA,SAAS,YAAY,GAAY,EAAE,QAAgB;IACjD,MAAM,IAAI,OAAO;IACjB,OAAO,OAAO,QAAQ,CAAC,KAAK,IAAI;AAClC;AAEO,MAAM,MAAM;IACjB,aAAa,OAAO;IACpB,iBAAiB,OAAO;IACxB,gBAAgB,OAAO;IACvB,OAAO,OAAO;IACd,iBAAiB,OAAO;IACxB,qBAAqB,OAAO;IAC5B,aAAa,OAAO;IACpB,cAAc,OAAO;IACrB,YACE,QAAQ,GAAG,CAAC,WAAW,IACvB,QAAQ,GAAG,CAAC,iBAAiB,IAC7B;IACF,YAAY,kBAAkB,gBAAgB,wBAAwB,wBAAwB;IAC9F,eACE,QAAQ,GAAG,CAAC,+BAA+B,IAC3C,QAAQ,GAAG,CAAC,uBAAuB,IACnC;IACF,eAAe,QAAQ,GAAG,CAAC,+BAA+B,IAAI;IAC9D,mBAAmB,QAAQ,GAAG,CAAC,oCAAoC,IAAI;IACvE,mBAAmB,aAAa,QAAQ,GAAG,CAAC,4BAA4B,EAAE;IAC1E,yBAAyB,YAAY,QAAQ,GAAG,CAAC,mCAAmC,EAAE,KAAK,KAAK,KAAK;AACvG"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///Users/nuno/orya/ORYA-WebApp/lib/prisma.ts"],"sourcesContent":["// lib/prisma.ts\nimport { Prisma, PrismaClient } from \"@prisma/client\";\nimport { PrismaPg } from \"@prisma/adapter-pg\";\nimport { Pool } from \"pg\";\nimport { env } from \"@/lib/env\";\n\n// Toggle de logs verbose (queries) via env: PRISMA_LOG_QUERIES=true\nconst enableQueryLog = process.env.PRISMA_LOG_QUERIES === \"true\";\nconst logLevels: (Prisma.LogLevel | Prisma.LogDefinition)[] =\n  process.env.NODE_ENV === \"development\"\n    ? enableQueryLog\n      ? [\"query\", \"error\", \"warn\"]\n      : [\"error\", \"warn\"]\n    : [\"error\"];\n\n// Evitar múltiplas instâncias em dev (hot reload)\nconst globalForPrisma = globalThis as unknown as {\n  prisma?: PrismaClient;\n};\n\n// Pool e adapter para usar o client engine (\"library\") com Postgres\nconst pool = new Pool({\n  connectionString: env.dbUrl,\n  ssl:\n    process.env.NODE_ENV === \"production\"\n      ? undefined\n      : { rejectUnauthorized: false },\n});\n\nconst adapter = new PrismaPg(pool);\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    adapter,\n    log: logLevels,\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;AAChB;AACA;AACA;AACA;;;;;;;;;;AAEA,oEAAoE;AACpE,MAAM,iBAAiB,QAAQ,GAAG,CAAC,kBAAkB,KAAK;AAC1D,MAAM,YACJ,uCACI,iBACE;IAAC;IAAS;IAAS;CAAO,GAC1B;IAAC;IAAS;CAAO,GACnB;AAEN,kDAAkD;AAClD,MAAM,kBAAkB;AAIxB,oEAAoE;AACpE,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,mHAAG,CAAC,KAAK;IAC3B,KACE,sCACI,0BACA;QAAE,oBAAoB;IAAM;AACpC;AAEA,MAAM,UAAU,IAAI,8JAAQ,CAAC;AAEtB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf;IACA,KAAK;AACP;AAEF,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 200, "column": 0}, "map": {"version":3,"sources":["file:///Users/nuno/orya/ORYA-WebApp/lib/supabaseServer.ts"],"sourcesContent":["import \"server-only\";\nimport { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\nimport { env } from \"@/lib/env\";\n\nfunction decodeBase64Cookie(raw: string) {\n  const BASE64_PREFIX = \"base64-\";\n  if (!raw.startsWith(BASE64_PREFIX)) return raw;\n\n  const base = raw.slice(BASE64_PREFIX.length);\n  const encodings: BufferEncoding[] = [\"base64url\", \"base64\"];\n\n  for (const enc of encodings) {\n    try {\n      return Buffer.from(base, enc).toString(\"utf-8\");\n    } catch {\n      /* try next */\n    }\n  }\n\n  // Se não conseguirmos decodificar, tratamos como cookie ausente para evitar JSON.parse de strings inválidas\n  return undefined;\n}\n\n/**\n * Server-side Supabase client (SSR + Route Handlers)\n * - Safe cookie reading\n * - Safe cookie writing\n * - Prevents JSON parse errors\n * - No profile fetching here\n */\nexport async function createSupabaseServer() {\n  const cookieStore = (await cookies());\n\n  const supabase = createServerClient(\n    env.supabaseUrl,\n    env.supabaseAnonKey,\n    {\n      cookies: {\n        get(name: string) {\n          try {\n            // Só devolvemos cookies do Supabase (sb-*) e ignoramos o resto\n            if (!name.startsWith(\"sb-\")) return undefined;\n            const raw = cookieStore.get(name)?.value;\n            if (!raw) return undefined;\n\n            // Se for um chunk (sb-*.0, sb-*.1, ...), deixamos intacto para o combinador do Supabase tratar\n            const isChunk = /\\.\\d+$/.test(name);\n            return isChunk ? raw : decodeBase64Cookie(raw);\n          } catch {\n            return undefined;\n          }\n        },\n        set(name: string, value: string, options: Record<string, unknown>) {\n          try {\n            cookieStore.set({ name, value, ...options });\n          } catch {\n            /* ignore errors for RSC */\n          }\n        },\n        remove(name: string, options: Record<string, unknown>) {\n          try {\n            cookieStore.set({ name, value: \"\", ...options, maxAge: 0 });\n          } catch {\n            /* ignore */\n          }\n        },\n      },\n    }\n  );\n\n  return supabase;\n}\n\n\nexport async function getCurrentUser() {\n  const supabase = await createSupabaseServer();\n\n  try {\n    const { data, error } = await supabase.auth.getUser();\n\n    if (error || !data?.user) {\n      return { user: null, error };\n    }\n\n    return { user: data.user, error: null };\n  } catch (err) {\n    return { user: null, error: err };\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEA,SAAS,mBAAmB,GAAW;IACrC,MAAM,gBAAgB;IACtB,IAAI,CAAC,IAAI,UAAU,CAAC,gBAAgB,OAAO;IAE3C,MAAM,OAAO,IAAI,KAAK,CAAC,cAAc,MAAM;IAC3C,MAAM,YAA8B;QAAC;QAAa;KAAS;IAE3D,KAAK,MAAM,OAAO,UAAW;QAC3B,IAAI;YACF,OAAO,OAAO,IAAI,CAAC,MAAM,KAAK,QAAQ,CAAC;QACzC,EAAE,OAAM;QACN,YAAY,GACd;IACF;IAEA,4GAA4G;IAC5G,OAAO;AACT;AASO,eAAe;IACpB,MAAM,cAAe,MAAM,IAAA,4IAAO;IAElC,MAAM,WAAW,IAAA,iMAAkB,EACjC,mHAAG,CAAC,WAAW,EACf,mHAAG,CAAC,eAAe,EACnB;QACE,SAAS;YACP,KAAI,IAAY;gBACd,IAAI;oBACF,+DAA+D;oBAC/D,IAAI,CAAC,KAAK,UAAU,CAAC,QAAQ,OAAO;oBACpC,MAAM,MAAM,YAAY,GAAG,CAAC,OAAO;oBACnC,IAAI,CAAC,KAAK,OAAO;oBAEjB,+FAA+F;oBAC/F,MAAM,UAAU,SAAS,IAAI,CAAC;oBAC9B,OAAO,UAAU,MAAM,mBAAmB;gBAC5C,EAAE,OAAM;oBACN,OAAO;gBACT;YACF;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAgC;gBAC/D,IAAI;oBACF,YAAY,GAAG,CAAC;wBAAE;wBAAM;wBAAO,GAAG,OAAO;oBAAC;gBAC5C,EAAE,OAAM;gBACN,yBAAyB,GAC3B;YACF;YACA,QAAO,IAAY,EAAE,OAAgC;gBACnD,IAAI;oBACF,YAAY,GAAG,CAAC;wBAAE;wBAAM,OAAO;wBAAI,GAAG,OAAO;wBAAE,QAAQ;oBAAE;gBAC3D,EAAE,OAAM;gBACN,UAAU,GACZ;YACF;QACF;IACF;IAGF,OAAO;AACT;AAGO,eAAe;IACpB,MAAM,WAAW,MAAM;IAEvB,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAEnD,IAAI,SAAS,CAAC,MAAM,MAAM;YACxB,OAAO;gBAAE,MAAM;gBAAM;YAAM;QAC7B;QAEA,OAAO;YAAE,MAAM,KAAK,IAAI;YAAE,OAAO;QAAK;IACxC,EAAE,OAAO,KAAK;QACZ,OAAO;YAAE,MAAM;YAAM,OAAO;QAAI;IAClC;AACF"}},
    {"offset": {"line": 301, "column": 0}, "map": {"version":3,"sources":["file:///Users/nuno/orya/ORYA-WebApp/app/api/explorar/list/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { createSupabaseServer } from \"@/lib/supabaseServer\";\nimport { Prisma, EventTemplateType } from \"@prisma/client\";\n\nconst DEFAULT_PAGE_SIZE = 12;\n\ntype ExploreItem = {\n  id: number;\n  type: \"EVENT\";\n  slug: string;\n  title: string;\n  shortDescription: string | null;\n  startsAt: string;\n  endsAt: string;\n  location: {\n    name: string | null;\n    city: string | null;\n    lat: number | null;\n    lng: number | null;\n  };\n  coverImageUrl: string | null;\n  isFree: boolean;\n  priceFrom: number | null;\n  categories: string[];\n  hostName: string | null;\n  hostUsername: string | null;\n  status: \"ACTIVE\" | \"CANCELLED\" | \"PAST\" | \"DRAFT\";\n  isHighlighted: boolean;\n};\n\ntype ExploreResponse = {\n  items: ExploreItem[];\n  pagination: {\n    nextCursor: number | null;\n    hasMore: boolean;\n  };\n};\n\nfunction resolveStatus(event: {\n  status: string;\n  endsAt: Date | string | null;\n  isDeleted?: boolean;\n}): ExploreItem[\"status\"] {\n  if (event.status === \"CANCELLED\") return \"CANCELLED\";\n  if (event.status === \"DRAFT\") return \"DRAFT\";\n\n  const now = Date.now();\n  const endDate =\n    event.endsAt instanceof Date\n      ? event.endsAt.getTime()\n      : event.endsAt\n        ? new Date(event.endsAt).getTime()\n        : null;\n\n  if (endDate && endDate < now) return \"PAST\";\n  return \"ACTIVE\";\n}\n\nfunction clampTake(value: number | null): number {\n  if (!value || Number.isNaN(value)) return DEFAULT_PAGE_SIZE;\n  return Math.min(Math.max(value, 1), 50);\n}\n\nexport async function GET(req: NextRequest) {\n  const { searchParams } = new URL(req.url);\n\n  const typeParam = searchParams.get(\"type\"); // event | all\n  const categoriesParam = searchParams.get(\"categories\"); // comma separated\n  const cityParam = searchParams.get(\"city\");\n  const searchParam = searchParams.get(\"q\");\n  const cursorParam = searchParams.get(\"cursor\");\n  const limitParam = searchParams.get(\"limit\");\n  const priceMinParam = searchParams.get(\"priceMin\");\n  const priceMaxParam = searchParams.get(\"priceMax\");\n  const dateParam = searchParams.get(\"date\"); // today | upcoming | all | day | weekend\n  const dayParam = searchParams.get(\"day\"); // YYYY-MM-DD opcional\n\n  const take = clampTake(limitParam ? parseInt(limitParam, 10) : DEFAULT_PAGE_SIZE);\n  const cursorId = cursorParam ? Number(cursorParam) : null;\n\n  const priceMin = priceMinParam ? Math.max(0, parseFloat(priceMinParam)) : 0;\n  const priceMaxRaw = priceMaxParam ? parseFloat(priceMaxParam) : null;\n  const priceMax = Number.isFinite(priceMaxRaw) ? priceMaxRaw : null;\n\n  const priceMinCents = Math.round(priceMin * 100);\n  const priceMaxCents = priceMax !== null ? Math.round(priceMax * 100) : null;\n\n  const categoryFilters = (categoriesParam || \"\")\n    .split(\",\")\n    .map((c) => c.trim().toUpperCase())\n    .filter(Boolean);\n\n  const where: Prisma.EventWhereInput = {\n    status: { in: [\"PUBLISHED\", \"DATE_CHANGED\"] },\n    isTest: { not: true },\n    isDeleted: false,\n  };\n\n  const listingFilter: Prisma.EventWhereInput = {\n    organizerId: { not: null },\n    organizer: { status: \"ACTIVE\", publicListingEnabled: { not: false } },\n  };\n  where.AND = Array.isArray(where.AND) ? [...where.AND, listingFilter] : [listingFilter];\n\n  if (typeParam === \"event\") {\n    // Sem filtro extra: todos os eventos publicados entram.\n  }\n\n  const normalizedCity = cityParam?.trim();\n  const applyCityFilter = normalizedCity && normalizedCity.toLowerCase() !== \"portugal\";\n\n  if (applyCityFilter) {\n    where.locationCity = {\n      contains: normalizedCity,\n      mode: \"insensitive\",\n    };\n  }\n\n  if (searchParam) {\n    const q = searchParam.trim();\n    where.OR = [\n      { title: { contains: q, mode: \"insensitive\" } },\n      { description: { contains: q, mode: \"insensitive\" } },\n      { locationName: { contains: q, mode: \"insensitive\" } },\n      { locationCity: { contains: q, mode: \"insensitive\" } },\n    ];\n  }\n\n  // Categorias principais: Padel vs Eventos gerais (tudo o resto)\n  if (categoryFilters.length > 0) {\n    const hasPadel = categoryFilters.includes(\"PADEL\");\n    const hasGeneral = categoryFilters.includes(\"GERAL\");\n    const andFilters: Prisma.EventWhereInput[] = [];\n\n    if (hasPadel && !hasGeneral) {\n      andFilters.push({ templateType: \"PADEL\" });\n    } else if (!hasPadel && hasGeneral) {\n      andFilters.push({\n        OR: [{ templateType: { not: \"PADEL\" } }, { templateType: null }],\n      });\n    } else if (!hasPadel && !hasGeneral) {\n      const mapToTemplate: Record<string, EventTemplateType> = {\n        OUTRO: \"OTHER\",\n        FESTA: \"PARTY\",\n        CONCERTO: \"OTHER\",\n        PALESTRA: \"TALK\",\n        ARTE: \"OTHER\",\n        COMIDA: \"OTHER\",\n        DRINKS: \"OTHER\",\n        VOLUNTARIADO: \"VOLUNTEERING\",\n      };\n      const templateTypes = categoryFilters\n        .map((c) => mapToTemplate[c])\n        .filter((v): v is EventTemplateType => Boolean(v));\n\n      if (templateTypes.length > 0) {\n        andFilters.push({ templateType: { in: templateTypes } });\n      }\n    }\n\n    if (andFilters.length > 0) {\n      where.AND = Array.isArray(where.AND) ? [...where.AND, ...andFilters] : andFilters;\n    }\n  }\n\n  if (dateParam === \"today\") {\n    const startOfDay = new Date();\n    startOfDay.setHours(0, 0, 0, 0);\n    const endOfDay = new Date();\n    endOfDay.setHours(23, 59, 59, 999);\n    where.startsAt = { gte: startOfDay, lte: endOfDay };\n  } else if (dateParam === \"upcoming\") {\n    const now = new Date();\n    where.startsAt = { gte: now };\n  } else if (dateParam === \"weekend\") {\n    const now = new Date();\n    const day = now.getDay(); // 0 domingo ... 6 sábado\n    let start = new Date(now);\n    let end = new Date(now);\n    if (day === 0) {\n      // domingo: só hoje a partir de agora\n      start = now;\n      end.setHours(23, 59, 59, 999);\n    } else {\n      const daysToSaturday = (6 - day + 7) % 7;\n      start.setDate(now.getDate() + daysToSaturday);\n      start.setHours(0, 0, 0, 0);\n      end = new Date(start);\n      end.setDate(start.getDate() + 1); // domingo\n      end.setHours(23, 59, 59, 999);\n    }\n    where.startsAt = { gte: start, lte: end };\n  } else if (dateParam === \"day\" && dayParam) {\n    const day = new Date(dayParam);\n    if (!Number.isNaN(day.getTime())) {\n      const startOfDay = new Date(day);\n      startOfDay.setHours(0, 0, 0, 0);\n      const endOfDay = new Date(day);\n      endOfDay.setHours(23, 59, 59, 999);\n      where.startsAt = { gte: startOfDay, lte: endOfDay };\n    }\n  }\n\n  // Filtro de preço (priceMax === null significa sem limite superior)\n  const priceFilters: Prisma.EventWhereInput[] = [];\n  if (priceMinCents > 0 && priceMaxCents !== null) {\n    priceFilters.push({\n      isFree: false,\n      ticketTypes: {\n        some: {\n          price: {\n            gte: priceMinCents,\n            lte: priceMaxCents,\n          },\n        },\n      },\n    });\n  } else if (priceMinCents > 0) {\n    priceFilters.push({\n      isFree: false,\n      ticketTypes: {\n        some: {\n          price: {\n            gte: priceMinCents,\n          },\n        },\n      },\n    });\n  } else if (priceMaxCents !== null) {\n    priceFilters.push({\n      OR: [\n        { isFree: true },\n        {\n          ticketTypes: {\n            some: {\n              price: {\n                lte: priceMaxCents,\n              },\n            },\n          },\n        },\n      ],\n    });\n  }\n\n  if (priceFilters.length > 0) {\n    where.AND = Array.isArray(where.AND) ? [...where.AND, ...priceFilters] : priceFilters;\n  }\n\n  const query: Prisma.EventFindManyArgs = {\n    where,\n    orderBy: [{ startsAt: \"asc\" }, { id: \"asc\" }],\n    take: take + 1,\n    include: {\n      ticketTypes: {\n        select: {\n          price: true,\n          status: true,\n        },\n      },\n      organizer: {\n        select: {\n          publicName: true,\n        },\n      },\n    },\n  };\n\n  if (cursorId) {\n    query.skip = 1;\n    query.cursor = { id: cursorId };\n  }\n\n  try {\n    const events = await prisma.event.findMany(query);\n\n    let viewerId: string | null = null;\n    try {\n      const supabase = await createSupabaseServer();\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      viewerId = user?.id ?? null;\n    } catch {\n      viewerId = null;\n    }\n\n    let nextCursor: number | null = null;\n    if (events.length > take) {\n      const nextItem = events.pop();\n      nextCursor = nextItem?.id ?? null;\n    }\n\n    const ownerIds = Array.from(\n      new Set(\n        events\n          .map((e) => e.ownerUserId)\n          .filter((v): v is string => typeof v === \"string\" && v.length > 0),\n      ),\n    );\n    const owners =\n      ownerIds.length > 0\n        ? await prisma.profile.findMany({\n            where: { id: { in: ownerIds } },\n            select: { id: true, username: true, fullName: true },\n          })\n        : [];\n    const ownerMap = new Map(owners.map((o) => [o.id, o]));\n\n    let orderedEvents = events;\n    if (viewerId && events.length > 0 && searchParam && searchParam.trim().length >= 1) {\n      const organizerIds = Array.from(\n        new Set(\n          events\n            .map((event) => event.organizerId)\n            .filter((id): id is number => typeof id === \"number\"),\n        ),\n      );\n      if (organizerIds.length > 0) {\n        const rows = await prisma.organizer_follows.findMany({\n          where: { follower_id: viewerId, organizer_id: { in: organizerIds } },\n          select: { organizer_id: true },\n        });\n        if (rows.length > 0) {\n          const followedIds = new Set(rows.map((row) => row.organizer_id));\n          const followed: typeof events = [];\n          const rest: typeof events = [];\n          events.forEach((event) => {\n            if (event.organizerId && followedIds.has(event.organizerId)) {\n              followed.push(event);\n            } else {\n              rest.push(event);\n            }\n          });\n          orderedEvents = [...followed, ...rest];\n        }\n      }\n    }\n\n    const items: ExploreItem[] = orderedEvents.map((event) => {\n      const mappedType: ExploreItem[\"type\"] = \"EVENT\";\n      const status = resolveStatus({\n        status: event.status,\n        endsAt: event.endsAt,\n        isDeleted: false,\n      });\n\n      const ticketPrices = Array.isArray(event.ticketTypes)\n        ? event.ticketTypes\n            .map((t) => (typeof t.price === \"number\" ? t.price : null))\n            .filter((p): p is number => p !== null)\n        : [];\n\n      let priceFrom: number | null = null;\n      if (event.isFree) {\n        priceFrom = 0;\n      } else if (ticketPrices.length > 0) {\n        priceFrom = Math.min(...ticketPrices) / 100;\n      }\n\n      const ownerProfile = event.ownerUserId ? ownerMap.get(event.ownerUserId) : null;\n      const hostName = event.organizer?.publicName ?? ownerProfile?.fullName ?? null;\n      const hostUsername = ownerProfile?.username ?? null;\n\n      const templateToCategory: Record<string, string> = {\n        PARTY: \"FESTA\",\n        PADEL: \"PADEL\",\n        TALK: \"PALESTRA\",\n        VOLUNTEERING: \"VOLUNTARIADO\",\n        OTHER: \"GERAL\",\n      };\n      const categories =\n        event.templateType != null\n          ? [templateToCategory[String(event.templateType)] ?? \"GERAL\"]\n          : [\"GERAL\"];\n\n      return {\n        id: event.id,\n        type: mappedType,\n        slug: event.slug,\n        title: event.title,\n        shortDescription: event.description?.slice(0, 200) ?? null,\n        startsAt: event.startsAt ? new Date(event.startsAt).toISOString() : \"\",\n        endsAt: event.endsAt ? new Date(event.endsAt).toISOString() : \"\",\n        location: {\n          name: event.locationName ?? null,\n          city: event.locationCity ?? null,\n          lat: event.latitude ?? null,\n          lng: event.longitude ?? null,\n        },\n        coverImageUrl: event.coverImageUrl ?? null,\n        isFree: event.isFree,\n        priceFrom,\n        categories,\n        hostName,\n        hostUsername,\n        status,\n        isHighlighted: false,\n      };\n    });\n\n    return NextResponse.json<ExploreResponse>({\n      items,\n      pagination: {\n        nextCursor,\n        hasMore: nextCursor !== null,\n      },\n    });\n  } catch (error) {\n    console.error(\"[api/explorar/list] erro:\", error);\n    // Em caso de erro, devolve lista vazia mas não rebenta o frontend\n    return NextResponse.json<ExploreResponse & { error?: string }>(\n      {\n        items: [],\n        pagination: { nextCursor: null, hasMore: false },\n        error: error instanceof Error ? error.message : \"Erro desconhecido\",\n      },\n      { status: 200 },\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}