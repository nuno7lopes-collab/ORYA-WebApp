# P1 Closeout — 2026-01-30

## Status
PARTIAL — infra/build/deploy/migrations done; E2E P1 still BLOCKED (no runnable prod E2E harness / credentials).

## Infra / Build / Deploy (prod)
- CodeBuild project: `orya-build-push`
  - FAILED (old source): `orya-build-push:7e364eb9-fa80-46a8-826b-17909718ed43`
  - FAILED (env build): `orya-build-push:c804c972-4dd1-42af-a42f-46137c58bef3`
  - SUCCEEDED: `orya-build-push:c9964591-3f96-436f-97d2-dd3ba3ad5da1`
- ECR images pushed:
  - `495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-web:20260130212036`
  - `495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-worker:20260130212036`
- CloudFormation stack: `orya-prod` (CREATE_COMPLETE)
  - StackId: `arn:aws:cloudformation:eu-west-1:495219734037:stack/orya-prod/cb6eba20-fe22-11f0-952b-0697982cf3cf`
  - ALB DNS: `orya-prod-alb-353292592.eu-west-1.elb.amazonaws.com`
  - Web URL: `https://orya-prod-alb-353292592.eu-west-1.elb.amazonaws.com`
  - TaskRoleArn: `arn:aws:iam::495219734037:role/orya-ecs-task-role`
- Healthcheck:
  - OK 200 at `/api/internal/ops/health` (via ALB, cron-secret header)

## Email admin@orya.pt (prod)
- DNS/ACM OK; SES domain verified + DKIM + DMARC + inbound configured.
- Forwarding to Google Workspace: Lambda forwarder active (S3 → Lambda → SES SendRawEmail).
- Test send MessageId: `0102019c150219e3-6148f300-b8b2-422a-adf3-4e1e5b1f91ab-000000`
- Inbound stored in S3: `orya-mail-inbound-prod/inbound/o4v5stulgqtvt19oqkb77dqhp0koi4uqq5lflh01`
- Inbox confirmation (Google Workspace): pending manual confirmation.
- SES Production access: BLOCKED (support case requires premium support).
- Evidence: `reports/p_email_2026-01-31.md`

## Test env isolation (test.orya.pt)
- Seed test concluído (profile/env=test + org test + eventos test).
- Provas DB:
  - `test_orgs = 1`, `prod_orgs = 2`, `prod_with_test_slug = 0`
  - Eventos test (últimos 5): `Cinema Open Air`, `Yoga & Sound Bath`, `Techno Warehouse`, `ORYA Run Club`, `Sunset Rooftop Porto`
- Evidence: `reports/test_env_isolation_2026-01-31.md`

## Commits (infra/build fixes)
- `83893a8` fix: server-only boundary — organizationOfficialEmail -> api route; prevent pg/tls in client bundle
- `46a9d63` fix: allow build-time env fallbacks
- `04b1907` fix: deploy-cf az discovery under set -u
- `1300a2c` fix: make ECR repos optional in CFN
- `bf981bf` fix: set ALB health check to ops health
- `8282fba` fix: pass health check path to CFN deploy
- `37a1083` docs: update infra + p1 closeout status

## Migrations
- Applied (after resolving “already exists”):
  - `20260129160535_outbox_dedupe_claim` (dedupe_key existed)
  - `20260129195025_payment_events_unique_indexes` (index existed)
- Newly applied:
  - `20260130155341_cron_heartbeat`
  - `20260130192015_outbox_created_at_idx`

## Vitest
- `npx vitest run` — PASS (106 files, 313 tests, 17.33s) — logs only from test fixtures.

## E2E P1
BLOCKED — no runnable prod E2E harness; `scripts/run-e2e-p1.sh` is placeholder and needs real flows + credentials.

Required to unblock:
1) Provide a real E2E runner (or scripted curl flow) for payments/refunds/ops-feed.
2) Provide prod test accounts + org + Stripe test mode creds or real test sandbox.
3) Execute flows and capture ≥3 requestIds per flow for the report.

## Evidence
- Infra summary + request IDs: `reports/p_infra_2026-01-30.md`.
