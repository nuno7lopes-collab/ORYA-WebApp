AWSTemplateFormatVersion: "2010-09-09"
Description: ORYA prod ECS/Fargate + ECR + ALB + EventBridge (cost-first)

Parameters:
  EnvironmentName:
    Type: String
    Default: prod
  VpcId:
    Type: AWS::EC2::VPC::Id
  PublicSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  PrivateSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  ServiceSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  AssignPublicIp:
    Type: String
    Default: ENABLED
    AllowedValues:
      - ENABLED
      - DISABLED
  CreateALB:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
  EnableWorker:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
  EnableOutboxSchedule:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  AlbCertificateArn:
    Type: String
    Default: ""
    Description: ACM certificate ARN for app/admin domains
  HostedZoneId:
    Type: String
    Default: ""
    Description: Route53 hosted zone id for app/admin records (optional)
  AppDomain:
    Type: String
    Default: ""
    Description: app domain (e.g. app.orya.pt)
  AdminDomain:
    Type: String
    Default: ""
    Description: admin domain (e.g. admin.orya.pt)
  CreateDnsRecords:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  WebImage:
    Type: String
    Description: ECR image URI for web (e.g. 495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-web:latest)
  WorkerImage:
    Type: String
    Description: ECR image URI for worker (e.g. 495219734037.dkr.ecr.eu-west-1.amazonaws.com/orya-worker:latest)
  WebDesiredCount:
    Type: Number
    Default: 1
  WorkerDesiredCount:
    Type: Number
    Default: 1
  TaskCpu:
    Type: String
    Default: "512"
  TaskMemory:
    Type: String
    Default: "1024"
  LogsRetentionDays:
    Type: Number
    Default: 30
  HealthCheckPath:
    Type: String
    Default: /api/internal/ops/health
  OutboxSchedule:
    Type: String
    Default: rate(1 minute)
  SecretsPrefix:
    Type: String
    Default: orya/prod
  BudgetNotificationEmail:
    Type: String
    Default: ""
  LogIngestThresholdBytes:
    Type: Number
    Default: 50000000
  CreateEcrRepos:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

Conditions:
  HasALB: !Equals [!Ref CreateALB, "true"]
  NoALB: !Equals [!Ref CreateALB, "false"]
  UseWorker: !Equals [!Ref EnableWorker, "true"]
  UseOutboxSchedule: !And [!Equals [!Ref EnableWorker, "true"], !Equals [!Ref EnableOutboxSchedule, "true"]]
  HasBudgetEmail: !Not [!Equals [!Ref BudgetNotificationEmail, ""]]
  CreateEcr: !Equals [!Ref CreateEcrRepos, "true"]
  HasHostedZone: !Not [!Equals [!Ref HostedZoneId, ""]]
  HasAppDomain: !Not [!Equals [!Ref AppDomain, ""]]
  HasAdminDomain: !Not [!Equals [!Ref AdminDomain, ""]]
  CreateDns: !And [!Equals [!Ref CreateDnsRecords, "true"], !Condition HasHostedZone, !Condition HasALB]
  CreateAppDns: !And [!Condition CreateDns, !Condition HasAppDomain]
  CreateAdminDns: !And [!Condition CreateDns, !Condition HasAdminDomain]

Resources:
  EcrRepoWeb:
    Type: AWS::ECR::Repository
    Condition: CreateEcr
    Properties:
      RepositoryName: orya-web
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 5 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 5
                },
                "action": { "type": "expire" }
              }
            ]
          }
  EcrRepoWorker:
    Type: AWS::ECR::Repository
    Condition: CreateEcr
    Properties:
      RepositoryName: orya-worker
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 5 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 5
                },
                "action": { "type": "expire" }
              }
            ]
          }

  LogGroupWeb:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/orya/${EnvironmentName}/web"
      RetentionInDays: !Ref LogsRetentionDays
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
  LogGroupWorker:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/orya/${EnvironmentName}/worker"
      RetentionInDays: !Ref LogsRetentionDays
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  BudgetAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "orya-${EnvironmentName}-budget-alerts"

  BudgetAlertsSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasBudgetEmail
    Properties:
      TopicArn: !Ref BudgetAlertsTopic
      Protocol: email
      Endpoint: !Ref BudgetNotificationEmail

  BudgetMonthly20:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub "orya-${EnvironmentName}-monthly-20"
        BudgetLimit:
          Amount: 20
          Unit: USD
        BudgetType: COST
        TimeUnit: MONTHLY
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 20
          Subscribers:
            - SubscriptionType: SNS
              Address: !Ref BudgetAlertsTopic

  BudgetMonthly50:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub "orya-${EnvironmentName}-monthly-50"
        BudgetLimit:
          Amount: 50
          Unit: USD
        BudgetType: COST
        TimeUnit: MONTHLY
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: FORECASTED
            ComparisonOperator: GREATER_THAN
            Threshold: 50
          Subscribers:
            - SubscriptionType: SNS
              Address: !Ref BudgetAlertsTopic

  LogIngestAlarmWeb:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "orya-${EnvironmentName}-log-ingest-web"
      Namespace: AWS/Logs
      MetricName: IncomingBytes
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: !Ref LogIngestThresholdBytes
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: LogGroupName
          Value: !Ref LogGroupWeb
      AlarmActions:
        - !Ref BudgetAlertsTopic

  LogIngestAlarmWorker:
    Type: AWS::CloudWatch::Alarm
    Condition: UseWorker
    Properties:
      AlarmName: !Sub "orya-${EnvironmentName}-log-ingest-worker"
      Namespace: AWS/Logs
      MetricName: IncomingBytes
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: !Ref LogIngestThresholdBytes
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: LogGroupName
          Value: !Ref LogGroupWorker
      AlarmActions:
        - !Ref BudgetAlertsTopic

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "orya-${EnvironmentName}"
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: HasALB
    Properties:
      GroupDescription: ORYA ALB SG
      VpcId: !Ref VpcId
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  ServiceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ORYA ECS Service SG
      VpcId: !Ref VpcId
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      SecurityGroupIngress:
        - !If
          - HasALB
          - IpProtocol: tcp
            FromPort: 3000
            ToPort: 3000
            SourceSecurityGroupId: !Ref ALBSecurityGroup
          - IpProtocol: tcp
            FromPort: 3000
            ToPort: 3000
            CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: HasALB
    Properties:
      Name: !Sub "orya-${EnvironmentName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: !Ref PublicSubnets
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: HasALB
    Properties:
      Name: !Sub "orya-${EnvironmentName}-tg"
      Port: 3000
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckEnabled: true
      HealthCheckPath: !Ref HealthCheckPath
      Matcher:
        HttpCode: "200-399"
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  Listener443:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasALB
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref AlbCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  AppDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CreateAppDns
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref AppDomain
      Type: A
      AliasTarget:
        DNSName: !GetAtt LoadBalancer.DNSName
        HostedZoneId: !GetAtt LoadBalancer.CanonicalHostedZoneID

  AdminDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CreateAdminDns
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref AdminDomain
      Type: A
      AliasTarget:
        DNSName: !GetAtt LoadBalancer.DNSName
        HostedZoneId: !GetAtt LoadBalancer.CanonicalHostedZoneID

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: orya-ecs-exec-role
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: orya-ecs-exec-secrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/*"

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: orya-ecs-task-role
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: orya-ecs-task-secrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin*"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"

  WebTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: orya-web
      RequiresCompatibilities: [FARGATE]
      NetworkMode: awsvpc
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: orya-web
          Image: !Ref WebImage
          PortMappings:
            - ContainerPort: 3000
              Protocol: tcp
          Environment:
            - Name: NODE_ENV
              Value: production
          Secrets:
            - Name: DATABASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:DATABASE_URL::"
            - Name: DIRECT_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:DIRECT_URL::"
            - Name: APP_BASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:APP_BASE_URL::"
            - Name: NEXT_PUBLIC_BASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:NEXT_PUBLIC_BASE_URL::"
            - Name: ORYA_CRON_SECRET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ORYA_CRON_SECRET::"
            - Name: QR_SECRET_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:QR_SECRET_KEY::"
            - Name: INTERNAL_SECRET_HEADER
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:INTERNAL_SECRET_HEADER::"
            - Name: ICS_SECRET_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ICS_SECRET_KEY::"
            - Name: PWA_MANIFEST_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:PWA_MANIFEST_URL::"
            - Name: MAPKIT_JS_KEY_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:MAPKIT_JS_KEY_ID::"
            - Name: MAPKIT_JS_ORIGIN
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:MAPKIT_JS_ORIGIN::"
            - Name: MAPKIT_JS_PRIVATE_KEY_BASE64
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:MAPKIT_JS_PRIVATE_KEY_BASE64::"
            - Name: MAP_PROVIDER
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:MAP_PROVIDER::"
            - Name: CLOUDWATCH_LOG_GROUP
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:CLOUDWATCH_LOG_GROUP::"
            - Name: CLOUDWATCH_LOG_RETENTION_DAYS
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:CLOUDWATCH_LOG_RETENTION_DAYS::"
            - Name: CLOUDWATCH_METRICS_NAMESPACE
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:CLOUDWATCH_METRICS_NAMESPACE::"
            - Name: LOG_LEVEL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:LOG_LEVEL::"
            - Name: LOG_FORMAT
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:LOG_FORMAT::"
            - Name: XRAY_DAEMON_ADDRESS
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:XRAY_DAEMON_ADDRESS::"
            - Name: XRAY_ENABLED
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:XRAY_ENABLED::"
            - Name: ALERTS_SNS_TOPIC_ARN
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ALERTS_SNS_TOPIC_ARN::"
            - Name: S3_SECRETS_BUCKET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:S3_SECRETS_BUCKET::"
            - Name: NEXTAUTH_SECRET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:NEXTAUTH_SECRET::"
            - Name: NEXTAUTH_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:NEXTAUTH_URL::"
            - Name: SUPABASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:SUPABASE_URL::"
            - Name: SUPABASE_SERVICE_ROLE
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:SUPABASE_SERVICE_ROLE::"
            - Name: SUPABASE_ANON_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:SUPABASE_ANON_KEY::"
            - Name: NEXT_PUBLIC_SUPABASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:NEXT_PUBLIC_SUPABASE_URL::"
            - Name: NEXT_PUBLIC_SUPABASE_ANON_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:NEXT_PUBLIC_SUPABASE_ANON_KEY::"
            - Name: STRIPE_SECRET_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments:STRIPE_SECRET_KEY::"
            - Name: STRIPE_WEBHOOK_SECRET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments:STRIPE_WEBHOOK_SECRET::"
            - Name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments:NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY::"
            - Name: APPLE_SIGNIN_SERVICE_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_SIGNIN_SERVICE_ID::"
            - Name: APPLE_SIGNIN_REDIRECT_URI
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_SIGNIN_REDIRECT_URI::"
            - Name: APPLE_SIGNIN_TEAM_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_SIGNIN_TEAM_ID::"
            - Name: APPLE_SIGNIN_KEY_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_SIGNIN_KEY_ID::"
            - Name: APPLE_SIGNIN_PRIVATE_KEY_BASE64
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_SIGNIN_PRIVATE_KEY_BASE64::"
            - Name: APPLE_PAY_CERTIFICATE_BASE64
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_PAY_CERTIFICATE_BASE64::"
            - Name: APPLE_PAY_DOMAIN_VERIFICATION_FILE
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_PAY_DOMAIN_VERIFICATION_FILE::"
            - Name: APPLE_PAY_MERCHANT_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APPLE_PAY_MERCHANT_ID::"
            - Name: APNS_TEAM_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APNS_TEAM_ID::"
            - Name: APNS_KEY_ID
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APNS_KEY_ID::"
            - Name: APNS_PRIVATE_KEY_BASE64
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APNS_PRIVATE_KEY_BASE64::"
            - Name: APNS_TOPIC
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/apple:APNS_TOPIC::"
            - Name: ADMIN_TOTP_ENCRYPTION_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ADMIN_TOTP_ENCRYPTION_KEY::"
            - Name: ADMIN_USER_IDS
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ADMIN_USER_IDS::"
            - Name: ADMIN_ACTION_IP_ALLOWLIST
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ADMIN_ACTION_IP_ALLOWLIST::"
            - Name: ADMIN_BREAK_GLASS_TOKEN
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ADMIN_BREAK_GLASS_TOKEN::"
            - Name: ADMIN_MFA_REQUIRED
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ADMIN_MFA_REQUIRED::"
            - Name: INFRA_READ_ONLY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:INFRA_READ_ONLY::"
            - Name: SES_REGION
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email:SES_REGION::"
            - Name: SES_IDENTITY_DOMAIN
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email:SES_IDENTITY_DOMAIN::"
            - Name: SES_SMTP_USERNAME
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email:SES_SMTP_USERNAME::"
            - Name: SES_SMTP_PASSWORD
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/email:SES_SMTP_PASSWORD::"
            - Name: STAGING_ADMIN_EMAIL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:STAGING_ADMIN_EMAIL::"
            - Name: STAGING_ADMIN_PASSWORD
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:STAGING_ADMIN_PASSWORD::"
            - Name: STAGING_ADMIN_SESSION
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:STAGING_ADMIN_SESSION::"
            - Name: DEVICE_FARM_PROVIDER
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:DEVICE_FARM_PROVIDER::"
            - Name: DEVICE_FARM_USER
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:DEVICE_FARM_USER::"
            - Name: DEVICE_FARM_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/admin:DEVICE_FARM_KEY::"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroupWeb
              awslogs-region: eu-west-1
              awslogs-stream-prefix: ecs
          HealthCheck:
            Command:
              - CMD-SHELL
              - "curl -sf -H \"x-orya-cron-secret: ${ORYA_CRON_SECRET}\" http://localhost:3000${HealthCheckPath} || exit 1"
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 60

  WorkerTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: orya-worker
      RequiresCompatibilities: [FARGATE]
      NetworkMode: awsvpc
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: orya-worker
          Image: !Ref WorkerImage
          Command: ["node", "scripts/operations-loop.js"]
          Environment:
            - Name: NODE_ENV
              Value: production
          Secrets:
            - Name: DATABASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:DATABASE_URL::"
            - Name: DIRECT_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:DIRECT_URL::"
            - Name: ORYA_CRON_SECRET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/app:ORYA_CRON_SECRET::"
            - Name: SUPABASE_URL
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:SUPABASE_URL::"
            - Name: SUPABASE_SERVICE_ROLE
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/supabase:SUPABASE_SERVICE_ROLE::"
            - Name: STRIPE_SECRET_KEY
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments:STRIPE_SECRET_KEY::"
            - Name: STRIPE_WEBHOOK_SECRET
              ValueFrom: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretsPrefix}/payments:STRIPE_WEBHOOK_SECRET::"
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroupWorker
              awslogs-region: eu-west-1
              awslogs-stream-prefix: ecs

  WebServiceAlb:
    Type: AWS::ECS::Service
    Condition: HasALB
    DependsOn: Listener443
    Properties:
      ServiceName: !Sub "orya-${EnvironmentName}-web"
      Cluster: !Ref ECSCluster
      DesiredCount: !Ref WebDesiredCount
      LaunchType: FARGATE
      TaskDefinition: !Ref WebTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: !Ref ServiceSubnets
          SecurityGroups:
            - !Ref ServiceSecurityGroup
      LoadBalancers:
        - ContainerName: orya-web
          ContainerPort: 3000
          TargetGroupArn: !Ref TargetGroup
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  WebServiceNoAlb:
    Type: AWS::ECS::Service
    Condition: NoALB
    Properties:
      ServiceName: !Sub "orya-${EnvironmentName}-web"
      Cluster: !Ref ECSCluster
      DesiredCount: !Ref WebDesiredCount
      LaunchType: FARGATE
      TaskDefinition: !Ref WebTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: !Ref ServiceSubnets
          SecurityGroups:
            - !Ref ServiceSecurityGroup
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  WorkerService:
    Type: AWS::ECS::Service
    Condition: UseWorker
    Properties:
      ServiceName: !Sub "orya-${EnvironmentName}-worker"
      Cluster: !Ref ECSCluster
      DesiredCount: !Ref WorkerDesiredCount
      LaunchType: FARGATE
      TaskDefinition: !Ref WorkerTaskDefinition
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: !Ref AssignPublicIp
          Subnets: !Ref ServiceSubnets
          SecurityGroups:
            - !Ref ServiceSecurityGroup
      Tags:
        - Key: Project
          Value: ORYA
        - Key: Env
          Value: !Ref EnvironmentName

  EventsRunTaskRole:
    Type: AWS::IAM::Role
    Condition: UseOutboxSchedule
    Properties:
      RoleName: orya-eventbridge-run-task
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: orya-run-task
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecs:RunTask
                Resource: "*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - !GetAtt ECSTaskExecutionRole.Arn
                  - !GetAtt ECSTaskRole.Arn

  OutboxScheduleRule:
    Type: AWS::Events::Rule
    Condition: UseOutboxSchedule
    Properties:
      Name: !Sub "orya-${EnvironmentName}-outbox"
      ScheduleExpression: !Ref OutboxSchedule
      State: ENABLED
      Targets:
        - Arn: !Sub "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/${ECSCluster}"
          RoleArn: !GetAtt EventsRunTaskRole.Arn
          Id: outbox-run-task
          EcsParameters:
            TaskDefinitionArn: !Ref WorkerTaskDefinition
            TaskCount: 1
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                Subnets: !Ref ServiceSubnets
                SecurityGroups:
                  - !Ref ServiceSecurityGroup
                AssignPublicIp: !Ref AssignPublicIp

Outputs:
  ClusterName:
    Value: !Ref ECSCluster
  WebServiceName:
    Value: !If [HasALB, !Ref WebServiceAlb, !Ref WebServiceNoAlb]
  WorkerServiceName:
    Value: !If [UseWorker, !Ref WorkerService, ""]
  LoadBalancerDNS:
    Condition: HasALB
    Value: !GetAtt LoadBalancer.DNSName
  WebURL:
    Value: !If
      - HasALB
      - !Sub "https://${LoadBalancer.DNSName}"
      - ""
  TaskRoleArn:
    Value: !GetAtt ECSTaskRole.Arn
